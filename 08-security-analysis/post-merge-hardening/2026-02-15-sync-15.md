> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 15 sync 15, 101 commits)

**Merge commit:** 186925fdd | **Range:** 0726aa52e..186925fdd

101 upstream commits (9 security-relevant, 92 non-security). Triage: 62 initially flagged, 12 demoted by reviewer, 50 deep-analyzed; 9 confirmed security-relevant. Large refactor sync (10,849 lines changed across 29 new files).

**HIGH — Input sanitization & injection prevention (3):**

1. **`a2fe3b661`** — **fix(gateway): harden chat.send message input sanitization:** Implements null byte rejection and unsafe control character filtering in `sanitizeChatSendMessageInput()` (`src/gateway/server-methods/chat.ts:78`). Strips control characters (0x00-0x1F, 0x7F) while preserving tab/newline/CR. Applies NFC Unicode normalization via `stripDisallowedChatControlChars()` (`:67`) to prevent homograph attacks. New test file validates null bytes, control chars, and Unicode normalization.

2. **`aa56045b4`** — **fix(agents): harden transcript tool-call block sanitization:** Adds validation that tool-call blocks have non-empty `id` and `name` fields via `hasToolCallId()` and `hasToolCallName()` (`src/agents/session-transcript-repair.ts:65,69`). Prevents tool-call spoofing and injection in transcript repair. Shared validator `hasNonEmptyStringField()` (`:61`) ensures 1+ characters after trim. `repairToolCallInputs()` (`:112`) now rejects blocks with missing/blank fields. New e2e test confirms rejection.

3. **`c8733822c`** — **fix(tools): normalize structured write/edit text params:** Adds `extractStructuredText()` (`src/agents/pi-tools.read.ts:109`) to recursively extract text from nested structures (arrays, objects with text/content fields). `normalizeTextLikeParam()` (`:148`) flattens structured text blocks before tool execution, preventing tool-call loops and metadata injection. Supports 6-level nesting depth with type-based extraction. Relates to Audit 2 Claim 7 (shell injection via incomplete regex).

**MEDIUM — Path validation & config injection prevention (3):**

4. **`b37346103`** — **refactor(security): share scan path helpers:** Extracts `isPathInside()` and `extensionUsesSkippedScannerPath()` to shared `src/security/scan-paths.ts` (`:3,10`). Consolidates directory containment checks to prevent symlink escapes and parent directory traversal. Removes duplicate path validation from plugin install and security audit modules. Addresses Audit 1 Claim 6 (path traversal in agent dirs).

5. **`e93764350`** — **refactor(install): share safe install path helpers:** Extracts `unscopedPackageName()` (`:3`) and `resolveSafeInstallDir()` (`:19`) to `src/infra/install-safe-path.ts`. Consolidates path traversal prevention for plugin and hook installation. Validates that resolved paths remain within designated base directories. Addresses Audit 1 Claim 6 (path traversal in agent dirs).

6. **`8ec0ef586`** — **fix(gateway/config): merge config.patch object arrays by id:** Implements ID-based array merging in `applyMergePatch()` (`src/config/merge-patch.ts:42`) with validators `isObjectWithStringId()` (`:9`) and `mergeObjectArraysById()` (`:16`). Prevents config injection by matching array elements by ID rather than position. Blocks replacement attacks on security-critical config objects. Falls back to positional merge only if elements lack string IDs. Addresses Audit 2 Claim 1 (config injection RCE via setupCommand).

**LOW — Defense-in-depth hardening (3):**

7. **`b5c81f732`** — **refactor(gateway): share bearer auth helper:** Centralizes HTTP Bearer token extraction and validation in `authorizeGatewayBearerRequestOrReply()` (`src/gateway/http-auth-helpers.ts:7`). Unifies auth failure response handling across OpenAI and OpenResponses HTTP handlers. Reduces token leakage risk through consistent error path handling.

8. **`86a156db2`** — **fix(media-understanding): treat binary application mimes as non-text:** Expands `isBinaryMediaMime()` (`src/media-understanding/apply.ts:320`) to cover application/* types (zip, gzip, RAR, 7z) and vendor formats. Prevents text extraction from binary payloads that could contain malicious content. Maintains text-extraction eligibility for vendor+json/xml formats.

9. **`9255f3665`** — **fix(tui): harden searchable select ANSI-safe highlighting:** Adds ANSI escape sequence constants (`src/tui/components/searchable-select-list.ts:14-15`) and `splitAnsiParts()` method for safe ANSI code parsing. Hardens `smartFilter()` (`:83`) to strip ANSI codes before text matching, preventing terminal escape injection.

**Audit claims cross-reference:**
- **Audit 1 Claim 6** (path traversal in agent dirs): Addressed by `b37346103` + `e93764350` — shared path validation helpers
- **Audit 2 Claim 1** (config injection RCE): Addressed by `8ec0ef586` — ID-based config array merging
- **Audit 2 Claim 7** (shell injection via incomplete regex): Addressed by `c8733822c` — text param normalization

**Line shifts (system-prompt.ts, +19 lines from sandbox workspace guidance at 352-359):**
- `:351-357` → `:362-366` (safety/self-preservation section)
- `:377,381` → `:387,391` (identity line)
- `:408-412` → `:419-423` (tool narration policy)
- `:430-432` → `:441-442` (config.apply warning)
- `:552-572` → `:565-582` (SOUL.md reference/logic)
- `:553-555` → `:566-569` (validContextFiles guard)
- `:575-590` → `:589-604` (silent reply rules)
- `:164-612` → `:164-625` (buildAgentSystemPrompt range)

**Line shifts (browser/server.ts, middleware extracted to server-middleware.ts):**
- `:133` → `:59` (bind 127.0.0.1)
- `:117-124` → extracted to `src/browser/server-middleware.ts:24-35` (auth middleware)
- `:79-166` → `:25-136` (full server range)

**Non-security commits (92):**

| Category | Count | Examples |
|----------|-------|---------|
| Refactoring/deduplication | 15 | `8a50936d3`, `b289441e6`, `cc15b8c6a`, `28014de97`, `f1a76e1a3`, `f33031bc9`, `d31e0dee5`, `fef86e475` |
| Test consolidation/coverage | 8 | `758fbc2fc`, `21082f7e3`, `bce02d7a9`, `024119459`, `870b1d50d`, `24e9dccea` |
| TUI/UX fixes | 4 | `9f2cb3b58`, `cd53387c9`, `1712a71a3`, `a378fac08` |
| Agent/gateway fixes | 5 | `909b5411b`, `17588f51f`, `3182a117c`, `616658d4b`, `a3e2d0563` |
| CLI/build fixes | 5 | `277b2de49`, `31a16157f`, `a47b08d55`, `7a63b046d`, `ae599243f` |
| Feature additions | 1 | `2c8b92105` (suppressToolErrors config) |
| Memory/queue fixes | 2 | `17b680951`, `d6f1e7ae9` |
| Changelog/docs | 4 | `7a23ac290`, `9606884ca`, `b9f4c124f`, `f3a474af3` |
| Platform-specific | 2 | `fa8aa8438`, `4c4d2558e` |
| Sandbox/prompt | 1 | `2bf330777` (workspace guidance — caused line shifts above) |
| Demoted from flagged | 12 | `3faf5ada2`, `3b08f3058`, `8725c2b19`, `d815c7caf`, `fa1aca83e`, `f29567b43`, `cbf712b7b`, `b6f2c3b74`, `1eb023b26`, `f832f3dcc`, `d355fecd4`, `379b44558` |
| Remaining safe | 33 | CI, style, Android, Windows, docs, changelog |

**Gap status: 1 closed, 3 remain open** — no gaps closed in this sync. See [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
