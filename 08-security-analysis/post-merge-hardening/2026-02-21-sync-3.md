## Feb 21 Sync 3 Hardening (4 security-relevant, 14 non-security)

**Merge range:** `40c2c90da..c01e486fc` (18 commits)

### Security-Relevant Commits

| SHA | Summary | Security Impact |
|-----|---------|-----------------|
| `07039dc08` | Gateway: harden trusted proxy X-Forwarded-For parsing (#22429) | Fixes IP spoofing by taking last (trusted proxy) entry instead of first (spoofable) entry in X-Forwarded-For chain. `parseForwardedForClientIp()` at `src/gateway/net.ts:149` now uses `entries?.at(-1)` and filters empty strings. |
| `35be87b09` | fix(tui): strip inbound metadata blocks from user messages (#22345) | Consolidates metadata sanitization to canonical `stripInboundMetadata` function from `src/auto-reply/reply/strip-inbound-meta.ts`. Removed `stripInboundMetadataBlocks` from `src/shared/chat-envelope.ts` (27 lines deleted). Improves consistency of untrusted input handling. |
| `be756b9a8` | Memory: fix async sync close race | Prevents use-after-close race condition in memory manager. Added early return if `this.closed` at `src/memory/manager.ts:382` in `sync()` method (line 377), and `close()` now awaits pending sync before closing (lines 603-612). |
| `7417c3626` | fix(cron): honor maxConcurrentRuns in timer loop (#22413) | Fixes resource exhaustion by properly enforcing concurrency limits. New `resolveRunConcurrency()` at `src/cron/service/timer.ts:41` returns configured limit, used in worker pool pattern (lines 304-320). Prevents DoS from runaway cron execution. |

### Non-Security Commits

| SHA | Summary | Category |
|-----|---------|----------|
| `c01e486fc` | chore: credit co-author for #21458 | Chores |
| `cd6bbe8ce` | Session: enforce startup sequence on bare reset greeting | Features |
| `93c2f20a2` | Memory: surface explicit memory_search unavailable status | Features |
| `1cc226357` | TUI: bound chat-log growth to prevent render overflows | Fixes |
| `222784098` | Gateway/TUI: filter heartbeat ACK noise in chat events | Fixes |
| `d583399c9` | Hooks: persist session memory on /reset | Features |
| `544c213d4` | Memory/QMD: diversify mixed-source search results | Features |
| `d7a7ebb75` | TUI: dedupe duplicate backspace events in input | Fixes |
| `18b4b4770` | TUI: guide pairing-required recovery in disconnect state | Features |
| `c0d5fc8d1` | CLI: default pairing channel for pairing commands | Features |
| `338ae269d` | test(memory): avoid stmt mock shape flake | Tests |
| `665221a1f` | test(memory): mock sqlite stmt with all+get for busy case | Tests |
| `e90eedb0a` | test(memory): fix sqlite busy mock to match implementation | Tests |
| `1ded4c672` | test(memory): fix TS types after vitest/ts updates | Tests |

### Audit Cross-Reference

None of the tracked audit claims (Audit 1 items 1-8, Audit 2 items 1-8, or the 3 legitimate gaps) are directly affected by this sync. The commits represent independent hardening and bug fixes.

### Key Line Number Changes

| File | Symbol | Old Line | New Line | Notes |
|------|--------|----------|----------|-------|
| `src/gateway/net.ts` | `parseForwardedForClientIp` | ~147 | 149 | X-Forwarded-For hardening |
| `src/gateway/chat-sanitize.ts` | `stripEnvelopeFromContent` | ~8 | 6 | Uses canonical metadata stripper |
| `src/shared/chat-envelope.ts` | `stripInboundMetadataBlocks` | ~64 | **REMOVED** | Moved to strip-inbound-meta.ts |
| `src/memory/manager.ts` | `sync` | ~376 | 377 | Added closed check |
| `src/memory/manager.ts` | `close` | ~600 | 603 | Added pending sync await |
| `src/cron/service/timer.ts` | `resolveRunConcurrency` | N/A | 41 | NEW function |
| `src/cron/service/timer.ts` | `onTimer` | ~230 | 194 | Concurrency control added |
| `src/cron/service/timer.ts` | timer loop | ~422 | 308 | Updated in resource-usage.md |

### Files Updated

- `explain-clawdbot/06-optimizations/resource-usage.md` — timer loop reference: 422 → 308

---

**Gap status link:** [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status) (1 closed, 3 remain open)
