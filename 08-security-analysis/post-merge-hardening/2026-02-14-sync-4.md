> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 14 sync 4, 21 upstream commits)

**Merge commit:** `2ab7715d1` | **Range:** `aa7fbf048..2ab7715d1`

**MEDIUM — WebSocket Security & Log Sanitization (1):**

1. **`d637a2635`** (PR [#15592](https://github.com/openclaw/openclaw/pull/15592)) — **Gateway: sanitize WebSocket log headers:** Added `sanitizeLogValue()` in `src/gateway/server/ws-connection.ts:40-54` which removes control characters (U+0000-U+001F, U+007F-U+009F), Unicode format characters (Cf category), collapses whitespace, and truncates to 300 chars max using `truncateUtf16Safe()`. Applied to `forwardedFor`, `requestOrigin`, `requestHost`, `requestUserAgent`, and close `reason` before logging. Prevents log injection via crafted headers and control character sequences in WebSocket connection logs.

**LOW — Auth Flow (1):**

2. **`86e4fe0a7`** (PR [#15406](https://github.com/openclaw/openclaw/pull/15406)) — **Auth: land codex oauth onboarding flow:** Adds OpenAI Codex OAuth provider onboarding (`src/commands/openai-codex-oauth.ts`, 183 lines with 98-line test file). Uses existing OAuth infrastructure with proper state verification. No security posture change — follows established patterns.

**LOW — Windows Environment Injection Hardening (5):**

3. **`e97aa4542`** — **fix(windows): handle undefined environment variables in runCommandWithTimeout:** `src/process/exec.ts:98-99` now filters `undefined` values from environment entries and coerces all values to strings via `String(value)`. Prevents Windows `spawn()` from receiving literal `undefined` as environment variable value, which could cause unpredictable behavior.

4. **`23b1b5156`** — **fix(windows): normalize env entries for spawn:** `src/process/exec.ts:116-120` normalizes environment via intermediate `mergedEnv` variable before filtering. Ensures consistent environment merging across platforms.

5. **`d7fb01afa`** — **fix(windows): resolve command execution and binary detection issues:** Three changes: (a) `src/process/exec.ts:138-140` adds `shell: true` on Windows for consistent command execution; (b) `src/shared/config-eval.ts:121` (`hasBinary()`, called from `src/agents/skills/config.ts:99` and `src/hooks/config.ts:70`) — `hasBinary()` now checks Windows executable extensions (`.exe`, `.cmd`, `.bat`) in addition to extensionless binaries. Prevents binary detection failures on Windows where executables require extensions. (Implementation extracted to `src/shared/config-eval.ts` by subsequent sync 7 refactor.)

6. **`ff0ce3284`** + **`1c36bec97`** — **Apply Copilot suggestions for PATHEXT support:** Refines `hasBinary()` — PATHEXT logic now at `src/shared/config-eval.ts:110-115` (`windowsPathExtensions()`) — to read `PATHEXT` environment variable (falling back to `.EXE;.CMD;.BAT;.COM`) instead of hardcoded extensions. Respects system-configured executable extensions. (Implementation extracted to `src/shared/config-eval.ts` by subsequent sync 7 refactor.)

**NON-SECURITY (notable):**

7. **`397011bd7`** (PR [#11770](https://github.com/openclaw/openclaw/pull/11770)) — **fix: increase image tool maxTokens from 512 to 4096:** `src/agents/tools/image-tool.ts` now uses `maxTokens: 4096` for image descriptions. Token budget adjustment — no security posture change.

8. **`b3b49bed8`** (PR [#14941](https://github.com/openclaw/openclaw/pull/14941)) — **fix(slack): override video/* MIME to audio/* for voice messages:** Slack-specific MIME type handling fix for voice messages. No security relevance.

9. **`3d921b615`** (PR [#13421](https://github.com/openclaw/openclaw/pull/13421)) — **fix(slack): apply limit parameter to emoji-list action:** Ensures `limit` parameter is applied to Slack emoji list requests. API correctness fix.

10. **`7ec60d644`** — **fix: use relayAbort helper for addEventListener to preserve AbortError reason:** Signal handling improvement in WebSocket code.

11. **`5ac8d1d2b`** + **`d9c582627`** — **perf: use .abort.bind() instead of arrow closures to prevent memory leaks:** Memory leak fix for AbortSignal usage. 7174-related.

12. **`1eccfa893`** — **perf(test): trim duplicate e2e suites and harden signal hooks:** Test cleanup and hardening.

13. **`45b9aad0f`** — **fix(imessage): prevent rpc spawn in tests:** Test infrastructure fix.

**Line number shifts in this sync:** `ws-connection.ts` +35 lines (sanitizeLogValue function + imports): old 6-10→21-25, old 21→42 (sanitizeLogValue insertion), old 179-186→214-221 (close handler sanitized variables). All references updated in documentation.

**CVE status:** 5 published advisories — all pre-existing, none patched in this merge. WebSocket header sanitization (`d637a2635`) adds defense-in-depth for log injection attacks.

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation, bootstrap/memory .md scanning — unchanged) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
