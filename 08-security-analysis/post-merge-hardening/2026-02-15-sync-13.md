> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 15 sync 13, 94 commits)

**Merge commit:** `cf04208cb` | **Range:** `6f5710031..cf04208cb` | **94 non-merge commits** (41 flagged, 53 safe)

**Security relevance: HIGH** — 14 security-relevant commits across sandbox containment, QMD scope bypass, media hardening, TUI injection, memory recall poisoning, and Windows spawn hardening.

### Security-Relevant Commits (14)

#### Sandbox & Path Containment Chain (5 commits)

1. **`424c718bc`** — **fix(security): apply tools.fs.workspaceOnly to sandbox file tools:** Extended `workspaceOnly` guard in `createOpenClawCodingTools()` (`src/agents/pi-tools.ts:1387-1415`) to sandboxed read/write/edit tools. Previously only applied to non-sandboxed tools, allowing bind-mount escape where operator-configured mounts like `/agent:/host-secrets:ro` could leak files outside workspace. **Addresses Audit 1 Claim 6 (path traversal), Audit 2 Claim 2 (arbitrary write).**

2. **`914b9d1e7`** — **fix(agents): block workspaceOnly apply_patch delete symlink escape:** Updated `applyPatch()` in `src/agents/apply-patch.ts:1819` to pass `allowFinalSymlink: true` only for unlink operations. New `assertNoSymlinkEscape()` in `src/agents/sandbox-paths.ts:1897-1906` permits unlinking final symlinks outside workspace (safe — removes link, not target) but blocks write-through-symlink traversal. **Addresses Audit 1 Claim 6, Audit 2 Claim 2.**

3. **`4a44da7d9`** — **fix(security): default apply_patch workspace containment:** Changed `apply_patch` default from `workspaceOnly: false` to `workspaceOnly !== false` in `src/agents/pi-tools.ts:3687` and `src/agents/apply-patch.ts:3510`. Operators must explicitly opt out to allow outside-workspace writes. Secure by default. **Addresses Audit 1 Claim 6, Audit 2 Claim 2.**

4. **`726ff36fd` + `eafda6f52`** — **Sandbox: bind-aware filesystem path resolver:** New `resolveSandboxFsPathWithMounts()` in `src/agents/sandbox/fs-paths.ts` parses `docker.binds` config and maps container absolute paths to host paths, respecting `ro`/`rw` flags. `SandboxFsBridgeImpl` in `src/agents/sandbox/fs-bridge.ts:9077-9168` now uses mount-aware resolution and enforces write-access checks per mount. Previously sandbox file tools ignored bind mounts. **Addresses Audit 1 Claim 6 (path traversal via bind mounts).**

5. **`683aa09b5`** — **refactor(media): harden localRoots bypass:** `localRoots: "any"` in `src/web/media.ts:2315-2323` now requires `sandboxValidated` flag + explicit `readFile` override. New `normalizeWorkspaceDir()` in `src/agents/workspace-dir.ts:2137-2153` rejects filesystem roots as workspace, preventing `/` as implicit media root. **Related to Audit 2 Claim 3 (log traversal), Legitimate Gap #3 (outPath validation).**

#### QMD & Memory Hardening (3 commits)

6. **`f9bb748a6`** — **fix(memory): prevent QMD scope deny bypass:** Added `rawKeyPrefix` field to `SessionSendPolicyMatch` type in `src/config/types.base.ts:680` and updated `isQmdScopeAllowed()` in `src/memory/qmd-scope.ts:760-792` to match against full agent-prefixed session keys. QMD scope `deny` rules on `agent:main:discord:` were previously bypassable via session key normalization.

7. **`ed7d83bcf`** — **fix(memory/lancedb): require explicit opt-in for auto-capture:** Changed `autoCapture` default from opt-out to opt-in (`autoCapture === true`) in `extensions/memory-lancedb/config.ts:2944`. Prevents automatic capture of all user/assistant messages without explicit consent. **Related to Audit 2 Claim 5 (self-approving agent).**

8. **`61725fb37`** — **fix(memory/lancedb): harden recall against prompt injection:** New `looksLikePromptInjection()` at `extensions/memory-lancedb/index.ts:215` detects and skips capturing payloads like "Ignore previous instructions". New `formatRelevantMemoriesContext()` at `:227` escapes `<>&"'` and marks recalled memories as "untrusted historical data". Auto-capture now only processes user messages (not assistant), preventing self-poisoning. **Related to Audit 2 Claim 5.**

#### Media & Discord Hardening (3 commits)

9. **`725741486`** — **fix(discord): harden voice message media loading:** New `materializeVoiceMessageInput()` at `src/discord/send.outbound.ts:1064-1076` routes all voice media through `loadWebMediaRaw()` applying SSRF guards and allowed-root checks before handing to ffmpeg. Blocks SSRF (`rtsp://`, private IPs) and path traversal. **Addresses Audit 2 Claim 3 (log traversal), Audit 2 Claim 4 (DNS rebinding SSRF).**

10. **`b79e7fdb7` + `edb06170f` + `6863b9dbe`** — **fix(image): workspace/sandbox media allowlist:** Extended image tool `localRoots` to include workspace dir (after resolving and rejecting filesystem roots) in `src/agents/tools/image-tool.ts:~364` and added state workspace/sandbox dirs to `getDefaultLocalRoots()` in `src/web/media.ts:8612-8621`. **Related to Legitimate Gap #3 (outPath validation).**

11. **`cf04208cb`** — **fix(allowlist): canonicalize Slack/Discord DM allowFrom:** Migrated legacy `dm.allowFrom` to canonical `allowFrom` in `src/auto-reply/reply/commands-allowlist.ts:254`. `handleAllowlistCommand()` at lines 405-644 reads from both locations during migration but writes only to canonical path. Prevents allowlist bypass via dual-location manipulation.

#### TUI Injection Prevention (2 commits)

12. **`de02b0720`** — **fix(tui): harden render sanitization for narrow terminals:** Enhanced `sanitizeRenderableText()` in `src/tui/tui-formatters.ts:93-117` with codepoint-based control character stripping, binary line redaction (12+ replacement char threshold), and aggressive token breaking (max 32 chars). Prevents terminal escape sequence injection and DoS.

13. **`750a7146e`** — **fix(tui): sanitize binary-heavy history text before render:** Added `sanitizeRenderableText()` calls in `src/tui/components/tool-execution.ts:1522-1547` (`formatArgs()`, `extractText()`). Prevents binary data corruption, ANSI injection, and terminal crashes from malformed tool outputs.

#### Process Hardening (1 commit)

14. **`a7eb0dd9a`** — **fix(security): harden Windows child process spawning:** Removed all `shell: process.platform === "win32"` auto-enabling in `src/process/exec.ts`. New `shouldSpawnWithShell()` at `:32` always returns `false`. On Windows, `shell: true` routes argv through `cmd.exe`, enabling injection via untrusted args. Updated `runCommandWithTimeout()` at `:137-141`. **Addresses Audit 2 Claim 7 (shell injection).**

#### Infrastructure Hardening (1 commit)

15. **`444a910d9`** — **fix(infra): avoid req.destroy(err) in request body limiters:** Removed `Error` arg from `req.destroy()` in `src/infra/http-body.ts:2299-2330`. Prevents process crash when no error listener exists for payload-too-large responses.

---

### Non-Security Commits (from flagged, 27)

| SHA | Message | Category |
|-----|---------|----------|
| `7572070f4` | chore(tui): add sanitizer regressions for narrow width safety | Test |
| `d6a635ed4` | chore(tui): replace control-char regex with codepoint sanitizer | Refactor (covered by de02b0720) |
| `7d7ab8a09` | fix(tui): preserve streamed text across tool boundary deltas | UI bug |
| `61228639c` | fix(tui): preserve active stream during concurrent run finals | UI bug |
| `7b697d612` | fix(config): stop defaulting slack/discord dm.policy | Config |
| `3ca74f8e6` | chore(changelog): note memory-lancedb injection hardening | Changelog |
| `68c78c4b4` | fix: deliver tool result media when verbose is off | Media delivery |
| `2a8360928` | Subagents: retain announce queue items on send failure | Message retry |
| `2dfbb407b` | Memory/QMD: self-heal null-byte collection metadata | DB recovery |
| `dabfcbe94` | Skills: clean up remote node cache on disconnect | Memory leak |
| `48fef2786` | Outbound: bound directory cache memory growth | Memory leak |
| `6d0cd54ac` | Slack: bound thread starter cache growth | Memory leak |
| `414b7db8a` | Auto-reply: bound abort memory map growth | Memory leak |
| `fc8f59261` | Gateway: bound agent run sequence tracking | Memory leak |
| `d0ff8c341` | refactor(usage): share claude window builder | Refactor |
| `9f368ac9e` | fix: media allowlist finalize | Media fix (covered by b79e7fdb7) |
| `ceae46ce3` | fix(test): make sandbox fs-path expectations cross-platform | Test |
| `decf2b518` | Memory: reduce watcher FD pressure for markdown sync | FD leak |
| `d171686f7` | TUI: honor gateway bind mode for local connection URL | TUI display |
| `7e065d90f` | perf(test): keep single media server and fast cleanup | Test perf |
| `410422999` | refactor(gateway): share config restart sentinel builder | Refactor |
| `f58d4cad8` | refactor(agents): dedupe claude oauth parsing | Refactor |
| `21ee5c0aa` | Changelog: note sandbox bind-mount file tool fix | Changelog |

### Safe Commits (53)

Demoted by triage or originally safe: 14 demoted (changelog-only, version bumps, `perf(test)`, lockfile, Swift codegen, extension refactors) + 39 originally safe (test infrastructure, platform fixes, CI, docs, dependency bumps). 1 promoted by triage (`df820f031` — null-byte metadata self-heal, reclassified as non-security DB recovery above).

---

### Audit Cross-Reference

| Audit Claim | Commits | Impact |
|-------------|---------|--------|
| **Audit 1 Claim 6** (Path traversal) | `424c718bc`, `914b9d1e7`, `4a44da7d9`, `726ff36fd` | **STRENGTHENED** — workspace containment now default, bind-mount aware, symlink escape blocked |
| **Audit 2 Claim 2** (Arbitrary write via outPath) | `914b9d1e7`, `4a44da7d9`, `424c718bc` | **STRENGTHENED** — apply_patch defaults to workspace containment |
| **Audit 2 Claim 3** (Log traversal) | `725741486`, `683aa09b5` | **STRENGTHENED** — media path validation extended to voice messages and localRoots |
| **Audit 2 Claim 4** (DNS rebinding SSRF) | `725741486` | **STRENGTHENED** — voice media routed through SSRF guards |
| **Audit 2 Claim 5** (Self-approving agent) | `ed7d83bcf`, `61725fb37` | **RELATED** — memory auto-capture requires opt-in, recall injection hardened |
| **Audit 2 Claim 7** (Shell injection) | `a7eb0dd9a` | **STRENGTHENED** — Windows `shell: true` fully removed from spawn |

### Legitimate Gap Cross-Reference

| Gap | Status | Commits |
|-----|--------|---------|
| Gap #1 (Gateway env blocklist) | Remains closed | — |
| Gap #2 (Pipe-delimited token format) | Open | — |
| Gap #3 (outPath validation) | Partially mitigated | `683aa09b5`, `b79e7fdb7` — localRoots hardening + image allowlist |
| Gap #4 (Bootstrap/memory .md scanning) | Open | `f9bb748a6` — QMD scope deny bypass prevented |

### Memory Bounding Commits (5)

Five commits address long-running process memory growth (not direct security, but prevent resource exhaustion DoS):

| SHA | Message | Target |
|-----|---------|--------|
| `48fef2786` | Outbound: bound directory cache memory growth | Directory cache |
| `6d0cd54ac` | Slack: bound thread starter cache growth | Thread starter cache |
| `414b7db8a` | Auto-reply: bound abort memory map growth | Abort map |
| `fc8f59261` | Gateway: bound agent run sequence tracking | Run sequence |
| `decf2b518` | Memory: reduce watcher FD pressure | File descriptors |

### Line Number Shifts

`cli-credentials.ts` 383-437→352-397, 388-389→358-362, 408-409→377. `pi-tools.ts` 215-217→233-236, 297→301, 308→312. `sandbox-paths.ts` 55-82→66-98. `server-methods/config.ts` 107-108→214. `ws-connection.ts` 39-54→40-54. `qmd-manager.ts` 355-371→415-421, 1006-1012→1080-1086. `process/exec.ts` 103-108→119-120, 119→139, 114-141→133-162. `web/media.ts` 42-69→47-77. `attachments.ts` 26-30→27-29, 224-228→182-189. `apply-patch.ts` 47-49→81-86, 274→273. `manager-sync-ops.ts` 262-296→277-318. `send-policy.ts` 23-91→23-131. All verified via grep.

**CVE status:** 30 published advisories — all pre-existing, none newly patched in this merge.

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation — Gap #3 further mitigated, bootstrap/memory .md scanning — Gap #4 strengthened by scope deny bypass fix) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
