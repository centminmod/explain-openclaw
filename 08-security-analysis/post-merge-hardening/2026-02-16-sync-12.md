> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 16 Sync 12 Hardening (21 commits, 3 security-relevant)

**Merge commit:** 568fd337b | **Range:** 1b76c3c38..568fd337b

### Commits

| SHA | Message | Files | Category |
|-----|---------|-------|----------|
| `887b209db` | fix(security): harden sandbox docker config validation | 7 prod + 4 test | Security |
| `6254e96ac` | fix(security): harden prompt path sanitization (OC-19) | 3 prod + 1 test | Security |
| `1b6704ef5` | docs: update sandbox bind mount guidance | 2 docs | Docs |
| `cd44a0d01` | fix: supervise PTY processes (#14257) | 27 prod + 5 test | Reliability |
| `07be14c02` | refactor(gateway): dedupe chat session abort flow | 1 prod | Refactor |
| `1d7b2bc9c` | refactor(slack): dedupe slash reply delivery | 1 prod | Refactor |
| (15 others) | Refactors for code sharing | ~20 prod | Refactor |

### Security-Relevant Commits

1. **`887b209db`** — **fix(security): harden sandbox docker config validation**

   New `validateSandboxSecurity()` function (`src/agents/sandbox/validate-sandbox-security.ts:185`) enforces runtime security checks when creating sandbox containers:

   - `BLOCKED_HOST_PATHS` denylist (line 13) blocks: `/etc`, `/private/etc`, `/proc`, `/sys`, `/dev`, `/root`, `/boot`, `/var/run/docker.sock`, `/private/var/run/docker.sock`, `/run/docker.sock`
   - Blocks dangerous network modes: `host` throws at runtime (network check in validate function)
   - Blocks dangerous security profiles: `seccompProfile: "unconfined"` and `apparmorProfile: "unconfined"` rejected at both Zod schema level (`src/config/zod-schema.agent-runtime.ts:128-180`) and runtime
   - Path traversal protection: `normalizeHostPath()` (line 56) resolves `..` sequences and `//` normalization
   - Symlink escape blocking: `validateBindMounts()` (line 125) uses `realpathSync()` to resolve symlinks before checking against denylist
   - Ancestor mount detection: `getBlockedBindReason()` (line 68) detects ancestor mounts (e.g., `/run:/run` exposes Docker socket)
   - Security audit integration: `collectSandboxDangerousConfigFindings()` (`src/security/audit-extra.sync.ts:588`) flags dangerous configs with severity `critical`

   Test coverage: 146 lines in `validate-sandbox-security.test.ts`, 115 lines in `sandbox-create-args.e2e.test.ts`, 51 lines in `config.sandbox-docker.test.ts`

   **Addresses Audit 1 Claim 6** (path traversal in agent dirs), **Audit 2 Claim 2** (arbitrary write via screen_record outPath — analogous threat model), **Gap 3** (outPath validation — analogous sandbox path validation).

2. **`6254e96ac`** — **fix(security): harden prompt path sanitization (OC-19)**

   New `sanitizeForPromptLiteral()` function (`src/agents/sanitize-for-prompt.ts:16`) strips Unicode control and format characters before embedding untrusted strings into LLM prompts:

   - Regex `/[\p{Cc}\p{Cf}\u2028\u2029]/gu` removes:
     - ASCII control characters (CR, LF, NUL, tab)
     - Unicode format characters (bidi overrides like U+202E, zero-width chars)
     - Line/paragraph separators (U+2028, U+2029)
   - Applied to workspaceDir at `src/agents/system-prompt.ts:382`
   - Applied to sandbox paths (containerWorkspaceDir, workspaceDir, agentWorkspaceMount, browserNoVncUrl) at lines 488, 491, 496, 502
   - Applied at workspace resolution (`src/agents/workspace-run.ts:89,105`) with warning log when stripping detected

   Test coverage: 53 lines in `sanitize-for-prompt.test.ts` including newline injection, bidi override, and sandbox path sanitization scenarios

   **Mitigates prompt injection** via malicious directory names containing control characters. Orthogonal to audit claims but addresses same threat model as Audit 1 Claim 7 (webhook signature bypass) and Audit 2 Claim 6 (token field shifting) where unexpected character sequences enable attacks.

3. **`1b6704ef5`** — **docs: update sandbox bind mount guidance**

   Documentation-only change removing dangerous Docker socket bind mount examples:
   - Updates `docs/gateway/sandboxing.md` and `docs/channels/groups.md`
   - Replaces `/var/run/docker.sock:/var/run/docker.sock` example with safe alternative `/var/data/myapp:/data:ro`

   **Documentation hardening** to prevent foot-gun configurations. Supports defensive posture against Audit 1 Claim 6 and Audit 2 Claim 2.

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `cd44a0d01` | fix: supervise PTY processes (#14257) | 27 prod + 5 test | Large reliability refactor introducing `ProcessSupervisor` architecture for PTY lifecycle management. No auth/access control changes. |
| `07be14c02` | refactor(gateway): dedupe chat session abort flow | 1 prod | Pure deduplication, no security boundary changes |
| `1d7b2bc9c` | refactor(slack): dedupe slash reply delivery | 1 prod | Pure deduplication, no security changes |

### Audit Cross-Reference

| Audit Claim | Commits | Status |
|-------------|---------|--------|
| Audit 1 Claim 6 (Path traversal in agent dirs) | `887b209db` | **STRENGTHENED** — BLOCKED_HOST_PATHS denylist, symlink resolution, ancestor mount detection |
| Audit 2 Claim 2 (Arbitrary write via outPath) | `887b209db` | **ANALOGOUS** — same threat model (path-based escape) addressed by sandbox bind mount hardening |
| Gap 3 (outPath validation) | `887b209db` | **ANALOGOUS** — sandbox validation blocks dangerous paths at container creation boundary |

**Unaffected Claims:** Audit 1 Claims 1-5, 7-8; Audit 2 Claims 1, 3-5, 7-8; Gap 1 (closed), Gap 2.

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
