> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 15 sync 6 (30 commits)

**Merge commit:** d3483590f | **Range:** fbd56ae56..d3483590f

**Security relevance: HIGH** — 10 security-relevant commits spanning SSRF hardening, LFI prevention, webhook fail-closed enforcement, TLS trust-on-first-use for mobile, and system.run command consistency validation.

---

### Security-Relevant Commits

#### 1. cb3290fca — fix(node-host): enforce system.run rawCommand/argv consistency

Adds `validateSystemRunCommandConsistency()` in new file `src/infra/system-run-command.ts` (~106 lines) to prevent approval bypass when `rawCommand` doesn't match `argv`. The gateway approval flow in `src/gateway/node-invoke-system-run-approval.ts:143` now calls this validation before forwarding to node-host. `src/node-host/invoke.ts:499-512` rejects mismatched requests with `INVALID_REQUEST` before any execution occurs. Replaces the removed `formatCommand()` helper with the validated `consistency.shellCommand` and `consistency.cmdText` outputs. E2E test in `src/gateway/server.node-invoke-approval-bypass.e2e.test.ts` verifies rejection.

**Addresses:** Audit 2 Claim 1 (Config injection RCE via setupCommand) — prevents command injection via rawCommand/argv mismatch. Related advisory: [GHSA-gv46-4xfq-jv58](../official-security-advisories.md#ghsa-gv46-4xfq-jv58-remote-code-execution-via-node-invoke-approval-bypass).

#### 2. bfa7d21e9 — fix(security): harden tlon Urbit requests against SSRF

Major SSRF protection for the Tlon/Urbit integration (18 files). New `extensions/tlon/src/urbit/base-url.ts` (~49 lines) validates Urbit base URLs and blocks private network hostnames by default. `extensions/tlon/src/onboarding.ts` adds explicit `allowPrivateNetwork` flag requiring user consent for LAN/localhost Urbit ships. `extensions/tlon/src/urbit/auth.ts` passes `ssrfPolicy` through to authentication requests. New `extensions/tlon/src/urbit/fetch.ts` centralizes fetch with SSRF guards. Refactored `extensions/tlon/src/urbit/channel-client.ts` (248 lines, replaces `http-api.ts`) with integrated protection. SSRF test in `extensions/tlon/src/urbit/auth.ssrf.test.ts` blocks private IPs by default, allows only with explicit flag.

**Addresses:** Audit 2 Claim 4 (DNS rebinding SSRF via web-fetch) at extension level. Related advisory: [GHSA-wfp2-v9c7-fh79](../official-security-advisories.md#ghsa-wfp2-v9c7-fh79-ssrf-via-attachmentmedia-url-hydration).

#### 3. 71f357d94 — bluebubbles: harden local media path handling against LFI (#16322)

Comprehensive path traversal prevention in `extensions/bluebubbles/src/media-send.ts` (157 lines added). New functions: `expandHomePath()` (tilde expansion), `resolveConfiguredPath()` (enforces absolute paths, rejects empty entries), `isPathInsideRoot()` (normalized path containment check with Windows case-insensitive support), `resolveMediaLocalRoots()` (reads allowlist from config), `assertLocalMediaPathAllowed()` (validates against `mediaLocalRoots` allowlist, reads file content via `O_RDONLY|O_NOFOLLOW` to prevent symlink attacks, then resolves `realpath` and re-validates). New `mediaLocalRoots` config field in `extensions/bluebubbles/src/types.ts` and `src/config/zod-schema.providers-core.ts`. 256-line test suite covers traversal attempts, symlink rejection, empty roots, and tilde expansion.

**Addresses:** Path traversal / LFI analogous to Audit 2 Claim 3 (Log traversal via logs.tail). Related advisory: [GHSA-pchc-86f6-8758](../official-security-advisories.md#ghsa-pchc-86f6-8758-bluebubbles-webhook-auth-bypass-via-loopback-proxy-trust) (related BlueBubbles hardening).

#### 4. 29b587e73 — fix(voice-call): fail closed when Telnyx webhook public key missing

Enforces fail-closed behavior: `extensions/voice-call/src/config.ts` now requires `telnyx.publicKey` when Telnyx is configured, unless `skipSignatureVerification=true` is explicitly set. `extensions/voice-call/src/providers/telnyx.ts` added 13 lines for explicit key presence validation. New test in `extensions/voice-call/src/providers/telnyx.test.ts` (47 lines) verifies rejection when public key is missing. Documentation updated in `docs/plugins/voice-call.md` and `extensions/voice-call/README.md`.

**Addresses:** Audit 1 Claim 7 (Webhook signature bypass). Related advisory: [GHSA-3m3q-x3gj-f79x](../official-security-advisories.md#ghsa-3m3q-x3gj-f79x-voice-call-webhook-verification-bypass-behind-proxy).

#### 5. ff11d8793 — fix(voice-call): require Twilio signature in ngrok loopback mode

Strengthens webhook security: `extensions/voice-call/src/webhook-security.ts` (20 lines changed) clarifies that `allowNgrokFreeTierLoopbackBypass` does NOT bypass signature verification — it only trusts forwarded headers to reconstruct the public ngrok URL that Twilio used for signing. `extensions/voice-call/src/config.ts` documentation comment updated. Test in `webhook-security.test.ts` validates signatures are enforced even in ngrok compatibility mode.

**Addresses:** Audit 1 Claim 7 (Webhook signature bypass) — closes the ngrok loopback gap. Related advisory: [GHSA-3m3q-x3gj-f79x](../official-security-advisories.md#ghsa-3m3q-x3gj-f79x-voice-call-webhook-verification-bypass-behind-proxy).

#### 6. 054366dea — fix(security): require explicit trust for first-time TLS pins

Major mobile security hardening across Android and iOS (16 files). Android `GatewayTls.kt` (~68 lines added) now requires explicit user confirmation before trusting new TLS certificates via `GatewayTrustPromptAlert`. iOS `GatewayConnectionController.swift` (276 lines changed) implements the same trust-on-first-use prompt. New `GatewayTrustPromptAlert.swift` (42 lines) provides the alert UI. `GatewaySettingsStore.swift` (63 lines) adds pin management. Tests in `GatewayConnectionSecurityTests.swift` and `GatewaySettingsStoreTests.swift` (72 new lines) verify the trust flow.

**Addresses:** Gateway TLS security — foundational for Audit 1 Claim 8 (Insufficient token expiry validation), since TLS pinning is prerequisite for secure token transport.

#### 7. 7cc6add9b — test(web): add SSRF guard cases

Regression tests in `src/web/media.test.ts` (22 lines) block private network URLs (`127.0.0.1:8080`) and cloud metadata hostnames (`metadata.google.internal`), validating the SSRF defense at the web media layer.

**Addresses:** Audit 2 Claim 4 (DNS rebinding SSRF via web-fetch) — regression testing.

#### 8. 09e216008 — test(browser): add file-chooser traversal regression

Regression test in `src/browser/server.agent-contract-form-layout-act-commands.test.ts` (17 lines) blocks path traversal (`../../../../etc/passwd`) and absolute paths outside uploads directory in the file-chooser endpoint.

**Addresses:** Path traversal analogous to Audit 2 Claim 3 (Log traversal).

#### 9. baa3bf270 — fix(webchat): filter NO_REPLY token from streaming and final replies (#16286)

Filters internal `NO_REPLY` control token from visible output in `src/gateway/server-chat.ts` (20 lines changed). Agent event handler strips the token from streaming text and final replies, preventing information disclosure of internal control flow to webchat users. Test in `server-chat.agent-events.test.ts` (82 lines) validates both streaming and final message filtering.

**Addresses:** Information disclosure — internal control tokens should not be visible to users.

#### 10. 078642b30 — fix(discord): defer component interactions to prevent timeout (#16287)

Defensive programming in `src/discord/monitor/agent-components.ts` (43 lines changed): defers Discord interaction responses before async agent processing, preventing timeout failures that could leave the Discord integration in an inconsistent state. Also adds keyboard event handling in `src/tui/tui-event-handlers.ts` (14 lines) and `src/tui/components/chat-log.ts` (10 lines). Tests in `agent-components.test.ts` (21 lines) verify deferred state.

**Addresses:** Operational resilience — prevents timeout-induced inconsistent state in Discord integration.

---

### Commit Chain: 29b587e73 + ff11d8793 (voice-call webhook hardening)

Both by steipete@gmail.com, sharing CHANGELOG.md changes. Together they close the voice-call webhook verification gap:
- `29b587e73` ensures Telnyx webhooks fail closed without a public key
- `ff11d8793` ensures Twilio signatures are verified even in ngrok loopback mode

### Commit Chain: cb3290fca + bfa7d21e9 (system.run + SSRF)

Both by steipete@gmail.com, sharing CHANGELOG.md. Different security surfaces but same author in sequence.

---

### Non-Security Commits (20 total)

| SHA | Message | Files |
|-----|---------|-------|
| 8e5689a84 | feat(telegram): add sendPoll support (#16193) (#16209) | 21 — feature addition |
| 571c195c5 | fix: support moltbot legacy state dir | 4 — adds `.moltbot` to legacy dir names |
| 69ba9a056 | fix: add memory search health check to openclaw doctor (#16294) | 3 — diagnostic tooling |
| c16bc7127 | fix: add discord routing debug logging (#16202) | 3 — debug output only |
| 478af8170 | Return user-facing message if API return 429 (#10415) | 10 — error messaging |
| ff32f4345 | Discord: prefer gateway guild id in verbose log | 2 — logging preference |
| d3483590f | perf(test): stub readability in cf-markdown tests | 1 — test optimization |
| 7582e93a8 | perf(test): speed up raw-body reply test | 1 — test performance |
| fc5d147d1 | fix(test-harness): annotate vitest mocks to avoid TS2742 | 2 — TypeScript fix |
| dee3abfcd | refactor(test): share browser control server harness | 3 — test harness |
| 60898821f | refactor(test): share telegram create bot harness | 10 — test harness |
| ae97f8f79 | refactor(test): share doctor e2e harness | 5 — test harness |
| 709c225b2 | fix(podman): bootstrap config and token | 3 — container setup |
| 81b5e2766 | feat(podman): add optional Podman setup and documentation (#16273) | 8 — container setup |
| 69f809dca | fix: restore deterministic review workflow | 4 — CI workflow |
| 5a313c83b | fix(tui): use available terminal width (#16109) (#16238) | 3 — TUI formatting |
| 68b00a538 | CI: add dirty label auto-response | 1 — GitHub automation |
| a3c9bc792 | docs(podman): add gateway.mode=local troubleshooting note | 1 — docs only |
| d714ac779 | refactor(agents): dedupe transient error copy (#16324) | 4 — DRY improvement |
| 3e6d1e9cf | docs: update changelog | 1 — docs only |

---

### Line Number Shifts

| File | Old | New | Context |
|------|-----|-----|---------|
| `src/config/paths.ts` | `:87-105` | `:88-106` | `resolveUserPath()` — 1-line comment added above at line 20 |
| `src/node-host/invoke.ts` | `:44-174` | `:45-175` | `blockedEnvKeys` + `sanitizeEnv()` — 1-line import added at line 34 |

---

### New CVE Added

- **[GHSA-pchc-86f6-8758](../official-security-advisories.md#ghsa-pchc-86f6-8758-bluebubbles-webhook-auth-bypass-via-loopback-proxy-trust)** (HIGH) — BlueBubbles webhook auth bypass via loopback proxy trust. Fixed in v2026.2.13. Commit `71f357d94` in this sync hardens related BlueBubbles media path handling.

---

### Audit Cross-Reference

| Audit | Claim | Addressed By |
|-------|-------|-------------|
| Audit 1 #7 | Webhook signature bypass | `29b587e73` (Telnyx fail-closed), `ff11d8793` (Twilio ngrok enforcement) |
| Audit 1 #8 | Insufficient token expiry validation | `054366dea` (TLS trust-on-first-use — foundational) |
| Audit 2 #1 | Config injection RCE via setupCommand | `cb3290fca` (rawCommand/argv consistency) |
| Audit 2 #3 | Log traversal via logs.tail | `71f357d94` (LFI hardening), `09e216008` (file-chooser traversal test) |
| Audit 2 #4 | DNS rebinding SSRF | `bfa7d21e9` (Tlon SSRF hardening), `7cc6add9b` (SSRF regression tests) |

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
