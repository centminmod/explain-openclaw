> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 18 Sync 8 (26 commits, 3 security)

**Merge commit:** d7c6136c1 | **Range:** a8f8f15c2..d7c6136c1

### Security: Sandbox Environment Variable Sanitization + API Key Rotation

Three commits harden the sandbox boundary and credential handling:

1. **`5487c9ade`** — feat(security): add sandbox env sanitization helpers + tests
   - `src/agents/sandbox/sanitize-env-vars.ts:62` — `sanitizeEnvVars()` function with 17 blocked patterns (lines 1-17)
   - Blocks: API keys, tokens, passwords, secrets (suffix-based blocking for `*_API_KEY`, `*_TOKEN`, `*_PASSWORD`, `*_PRIVATE_KEY`, `*_SECRET`)
   - Value validation: null bytes, 32KB+ length, base64-encoded credentials (lines 35-47)
   - Optional strict mode with explicit allowlist (PATH, HOME, USER, SHELL, NODE_ENV, etc.)
   - Files: 1 prod + 1 test

2. **`638853c6d`** — fix(security): sanitize sandbox env vars before docker launch
   - `src/agents/sandbox/docker.ts:273` — `envSanitization = sanitizeEnvVars(params.cfg.env ?? {})`
   - Logs blocked variables with `[Security]` prefix (lines 274-279)
   - Only passes `envSanitization.allowed` to Docker `--env` flags (line 284)
   - Files: 1 prod + 0 test

3. **`2e91552f0`** — feat(agents): add generic provider api key rotation (#19587)
   - `src/agents/api-key-rotation.ts:40` — `executeWithApiKeyRotation()` cycles keys on 429/quota errors
   - `src/agents/live-auth-keys.ts:100` — `collectProviderApiKeys()` supports Anthropic, Google, OpenAI
   - `src/agents/live-auth-keys.ts:150` — `isApiKeyRateLimitError()` detects quota_exceeded, resource_exhausted
   - Integrated into Gemini embeddings (`src/memory/embeddings-gemini.ts`) and media transcription (`src/media-understanding/runner.entries.ts`)
   - Files: 5 prod + 0 test + 3 docs

**Audit Impact:**
- **Strengthens Gap 1 (Gateway-side env var blocklist):** Adds sandbox-level sanitization as defense-in-depth
- **Strengthens Audit 2 Claim 8 (Env variable injection / LD_PRELOAD):** Directly sanitizes env vars at Docker launch boundary
- **Indirectly supports Audit 1 Claim 4 (Token refresh race condition):** Key rotation provides fallback during rate limits

### Security-Relevant Commits

| SHA | Message | Files | Audit Cross-Ref |
|-----|---------|-------|-----------------|
| `5487c9ade` | feat(security): add sandbox env sanitization helpers + tests | 1 prod + 1 test | Gap 1, Audit 2 Claim 8 |
| `638853c6d` | fix(security): sanitize sandbox env vars before docker launch | 1 prod | Gap 1, Audit 2 Claim 8 |
| `2e91552f0` | feat(agents): add generic provider api key rotation (#19587) | 5 prod + 3 docs | Audit 1 Claim 4 (indirect) |

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `d7c6136c1` | test: add sonnet 4.6 and opus 4.6 setup-token model tests | 1 test | Test-only |
| `71ad357bb` | test: remove obsolete mesh test file | 1 test | Test-only |
| `5a31da8ee` | chore: format imports in gateway and session tools | 3 prod | Style/format |
| `f6f5cda6c` | style: format subagent command files | 2 prod | Style/format |
| `b8b43175c` | style: align formatting with oxfmt 0.33 | 926 prod + 193 test | Style/format (mass) |
| `31f9be126` | style: run oxfmt and fix gate failures | 925 prod + 194 test | Style/format (mass) |
| `345920044` | docs: reorder unreleased changelog by user-impact highlights | 1 doc | Docs-only |
| `985ec71c5` | CLI: resolve parent/subcommand option collisions (#18725) | 8 prod + 7 test + 2 doc | CLI refactor, no security flags affected |
| `972d1b74d` | Revert "Add mesh orchestration gateway methods..." | 7 prod | Removes code |
| `01672a8f2` | Revert "Add mesh auto-planning..." | 9 prod + 3 test + 2 doc | Removes code |
| `81db05962` | fix(subagents): always read latest assistant/tool output on subagent completion | 3 prod | Subagent fix |
| `0dd97feb4` | fix(subagents): include tool role in subagent completion output | 3 prod | Subagent fix |
| `fa4f66255` | fix(subagents): return completion message for manual session spawns | 9 prod | Subagent fix |
| `e2dd827ca` | fix: guarantee manual subagent spawn sends completion message | 5 prod | Subagent fix |
| `5bd95bef5` | fix(protocol): regenerate swift gateway models | 2 prod | Protocol/model |
| `6dcc052bb` | fix: stabilize model catalog and pi discovery auth storage compatibility | 29 prod + 12 test | Model catalog fix |
| `653add918` | chore: bump workspace dependencies | 2 prod | Dependency bump |
| `414b996b0` | fix(agents): make image resize logs single-line with size | 2 prod | Logging fix |
| `f42e13c17` | feat(telegram): add forum topic creation support (#17035) | 7 prod | Telegram feature |
| `76949001e` | fix: compact skill paths in prompt (#14776) | 1 prod | Skill path fix |
| `4f2c57eb4` | feat(skills): compact skill paths with ~ to reduce prompt tokens | 2 prod | Prompt optimization |
| `cfd384ead` | feat(skills): improve descriptions with routing logic (#14577) | 14 prod | Skill routing |
| `9cce40d12` | feat(skills): Add 'Use when / Don't use when' routing blocks (#14521) | 6 prod | Skill routing |

**Note:** Two mass-formatting commits (`b8b43175c`, `31f9be126`) reformat 1119 files each with oxfmt 0.33. Two revert commits remove the mesh orchestration feature (deleted `src/gateway/server-methods/mesh.ts` and `src/gateway/protocol/schema/mesh.ts`).

### Audit Cross-Reference

| Claim/Gap | Status | Notes |
|-----------|--------|-------|
| Audit 1 Claim 4 (Token refresh race) | Unaffected | Key rotation provides fallback but doesn't change race handling |
| Audit 2 Claim 8 (Env injection / LD_PRELOAD) | **Strengthened** | Sandbox-level sanitization added |
| Gap 1 (Gateway-side env blocklist) | **Strengthened** | Defense-in-depth: gateway blocklist + sandbox sanitization |
| Gap 2 (Pipe-delimited token) | Unaffected | No changes to token format |
| Gap 3 (outPath validation) | Unaffected | No changes to screen_record |

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
