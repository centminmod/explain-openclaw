> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 16 sync 5, 21 commits)

**Merge commit:** `e58884925` | **Range:** `f37b7032d..e58884925` | **21 non-merge commits** (1 security-relevant, 20 test/infrastructure refactors)

**Security relevance: LOW** — 1 security-observable commit (plugin LLM hooks) + 20 test refactors. No security boundary changes.

### Security-Relevant Commits (1)

#### Plugin Observability (1 commit)

1. **`7c822d039`** (2026-02-15) — **feat(plugins): expose llm input/output hook payloads:** Adds `llm_input` and `llm_output` plugin hooks that expose full LLM prompts, system prompts, conversation history, image counts, assistant responses, and usage metadata to plugins. Hooks run in parallel (fire-and-forget) via new `runLlmInput()` and `runLlmOutput()` functions in `src/plugins/hooks.ts`. Implementation adds 51 lines to `src/agents/pi-embedded-runner/run/attempt.ts` at lines 957-981 (llm_input hook) and lines 1132-1155 (llm_output hook). New event types `PluginHookLlmInputEvent` and `PluginHookLlmOutputEvent` defined in `src/plugins/types.ts` expose sensitive prompt/response data. While non-blocking (errors logged but don't halt execution), this creates new data exposure surface for observability vs privacy tradeoff. Operators should be aware that third-party plugins can now observe all LLM interactions. Relates to plugin RBAC considerations (Audit 2, Claim 5 - self-approving agent).

### Non-Security Commits (20)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| e58884925 | refactor(test): reuse pi embedded subscribe session harness | 3 | Test harness deduplication only |
| a1ff0e476 | refactor(test): dedupe sessions_spawn thinking assertions | 1 | Test refactoring - extracts helper types/functions |
| 8e7b7a2b2 | refactor(test): dedupe commands e2e wizard setup | 2 | Test setup refactoring only |
| d9d93485d | refactor(test): share tool hook handler ctx | 1 | Test refactoring only |
| 5fb4032fb | refactor(test): share overflow compaction mocks | 3 | Test mock extraction only |
| 3c6cff575 | refactor(config): share agent sandbox schema | 1 | Config schema extraction, no behavior change |
| 511719424 | refactor(test): dedupe terminal restore stubs | 1 | Test stub extraction only |
| 8cd20e220 | refactor(infra): share jsonl transcript reader | 1 | Infrastructure refactoring only |
| c92bcf24c | refactor(infra): dedupe device pairing token updates | 1 | Infrastructure refactoring only |
| 0c7785151 | fix(agents): mark required-param tool errors as non-retryable | 3 | Error classification, no security impact |
| 50abdaf33 | refactor(infra): dedupe openclaw root candidate scan | 1 | Infrastructure refactoring only |
| 012b674f3 | refactor(infra): share isTailnetIPv4 helper | 2 | Infrastructure helper extraction only |
| c9bb6bd0d | refactor(infra): extract json file + async lock helpers | 3 | Infrastructure helper extraction only |
| ff4f59ec9 | feat(image-tool): support multiple images in a single tool call | 2 | Feature addition - adds `maxImages` cap (default 20) |
| 27deda222 | fix(test): drop unused gateway e2e PluginRegistry imports | 3 | Test cleanup only |
| c3812a1ff | refactor(test): share gateway e2e registry helper | 5 | Test helper extraction only |
| 84601bf96 | fix(test): fix pi embedded subscribe harness typing | 1 | Test type fix only |
| aabe4d9b4 | refactor(test): reuse env snapshot helper | 2 | Test helper extraction only |
| 856e1a318 | refactor(test): share skills e2e helper | 3 | Test helper extraction only |
| 595845471 | refactor(test): share auth profile order fixtures | 5 | Test fixture extraction only |

### Line Number Shifts

| File | Old Line | New Line | Context |
|------|----------|----------|---------|
| `src/agents/pi-embedded-runner/run/attempt.ts` | 212-216 | 288 | `execOverrides` passed to tool creation |
| `src/agents/pi-embedded-runner/run/attempt.ts` | 562-567 | 662 | `sanitizeToolUseResultPairing()` call after truncation |
| `src/agents/pi-embedded-runner/run/attempt.ts` | 778-779 | 893 | `sanitizeAntigravityThinkingBlocks()` call at orphaned repair |

### Audit Cross-Reference

**Affected Claims/Gaps:**

1. **Audit 2, Claim 5** (Self-approving agent/no RBAC): Commit `7c822d039` introduces plugin hooks that can observe all LLM I/O without agent approval or per-plugin permission gating. The hook payloads include `systemPrompt`, `historyMessages`, and `prompt` (see `attempt.ts:965-967`), meaning any installed plugin gains full visibility into the agent's operational context — system prompts, conversation history, and tool results. While hooks are "fire-and-forget" (cannot modify behavior), this goes beyond simple observability: it creates a surveillance surface where plugins bypass agent-level approval controls entirely. Operators should note that all installed plugins independently receive complete prompt/response data without RBAC boundaries.

**Unaffected Claims:**

- Audit 1 Claims 1-8: No changes to sandbox containment, path validation, or execution controls
- Audit 2 Claims 1-4, 6-8: No changes to SSRF guards, log traversal, or process spawning
- Legitimate Gaps 1-3: No changes to token format, outPath validation, or input sanitization

**Gap status:** Unchanged — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
