> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 17 sync 4 (120 commits)

**Merge commit:** ff7a73511 | **Range:** e0ba7bced..ff7a73511

> Large refactor: 22,153 lines changed (21,347 insertions, 806 deletions). Slack Block Kit (40+ commits), Linq iMessage channel, Mattermost reactions, Telegram polling, Docker infrastructure, account factory RBAC. Phase 4 verified all documented file paths.

### Security-Relevant Commits (23)

| SHA | Message | Files | Audit Cross-Ref |
|-----|---------|-------|-----------------|
| `ae0b110e4` | fix(security): set 0o600 on remaining session file write paths | 3 prod | **Claim 5** — file permissions |
| `b2d622cfa` | fix: clear stale device-auth token on token mismatch | 1 prod | **Claims 1-4** — token lifecycle |
| `153794080` | fix: support OAuth for Gemini media understanding | 3 prod | **Claim 2** — OAuth implementation |
| `3379b9d34` | fix: support OAuth for Gemini embedding API | 1 prod | **Claim 2** — OAuth implementation |
| `38c96bc53` | fix: validate base64 image data before API submission | 1 prod + 1 test | **Claim 7** — input validation |
| `0b8b95f2c` | fix(update): prevent gateway crash loop after failed self-update | 2 prod + 1 test | DoS prevention |
| `9aa8db5c8` | fix(doctor,configure): skip gateway auth for loopback-only setups | 2 prod + 1 test | Auth configuration |
| `d24340d75` | channels: migrate extension account listing to factory | 5 prod | **Claim 5** — RBAC centralization |
| `59384001a` | channels: migrate core channel account listing to factory | 5 prod | **Claim 5** — RBAC centralization |
| `5544ab820` | channels: add createAccountListHelpers factory | 3 prod | **Claim 5** — RBAC centralization |
| `556b531a1` | Fix Telegram poll action wiring | 3 prod + 2 test | **Claim 5** — per-account action gating |
| `a03fec2a3` | fix: use per-account action config for Discord and Telegram gating | 4 prod | **Claim 5** — per-account action gating |
| `4640999e7` | test: add per-account action gating tests for Discord and Telegram handlers | 2 prod + 2 test | **Claim 5** — RBAC test coverage |
| `5a3a448bc` | feat(commands): add /subagents spawn command | 5 prod + 1 test | New exec path — requires review |
| `de900bace` | fix: reset announceRetryCount in replaceSubagentRunAfterSteer | 1 prod | Subagent loop guard |
| `a6c741eb4` | fix(announce): break infinite retry loop with max attempts and expiry (#18264) | 1 prod + 1 test | DoS prevention |
| `e368c3650` | feat: add llms.txt discovery as default agent behavior | 2 prod | System prompt — prompt injection surface |
| `838259331` | fix(discord): add media dedup production code for messaging tool pipeline | 12 prod + 2 test | **Claim 2** — media handling |
| `bcab2469d` | feat: LLM-based query expansion for FTS mode | 5 prod | Memory — availability |
| `65aedac20` | fix: enable FTS fallback when no embedding provider available (#17725) | 6 prod | Memory — graceful degradation |
| `d4c057f8c` | feat(inbound-meta): expose sender_id in trusted system metadata | 1 prod + 1 test | Metadata exposure |
| `60bd154e5` | fix: parse webhook URL pathname instead of raw string match | 1 prod | **Claim 4** — URL parsing hardening |
| `34b18ea9d` | fix: respect OPENCLAW_HOME for isolated gateway instances | 1 prod | Path isolation |

### Commit Details

1. **`ae0b110e4`** — Sets `0o600` (owner read/write only) on remaining session file write paths.
   - `src/agents/pi-embedded-runner/session-manager-init.ts` — session init file writes
   - `src/auto-reply/reply/session.ts:95` — session state writes
   - `src/gateway/server-methods/sessions.ts:493` — gateway session file creation
   - **Directly strengthens Audit 1 Claim 5** (insufficient file permission checks)

2. **`b2d622cfa`** — Clears cached device-auth token when mismatch detected.
   - `src/gateway/client.ts:205` — token precedence logic now clears stale stored tokens
   - Prevents stale token reuse after invalidation

3. **`153794080` + `3379b9d34`** — OAuth support for Gemini media understanding and embedding API.
   - `src/infra/gemini-auth.ts` (NEW) — Gemini-specific OAuth helper
   - `src/media-understanding/providers/google/inline-data.ts` — OAuth-based media access
   - `src/memory/embeddings-gemini.ts` — OAuth-based embedding access
   - Strengthens Audit 1 Claim 2 (OAuth implementation)

4. **`38c96bc53`** — Validates base64 image data before API submission.
   - `src/agents/tool-images.ts` — rejects malformed base64 payloads
   - Input validation hardening

5. **`0b8b95f2c`** — Prevents gateway crash loop after failed self-update.
   - `src/gateway/server-methods/update.ts` — crash loop detection
   - `src/infra/update-runner.ts` — update failure handling
   - DoS prevention for update-related failures

6. **`d24340d75` + `59384001a` + `5544ab820`** — Account listing factory pattern.
   - Centralizes account enumeration into `createAccountListHelpers` factory
   - Consolidates authorization across Discord, Slack, Telegram, Signal, iMessage, and extension channels
   - **Strengthens Audit 2 Claim 5** (RBAC enforcement) by eliminating inconsistent per-channel implementations

7. **`556b531a1` + `a03fec2a3` + `4640999e7`** — Per-account action gating for Discord and Telegram.
   - `src/agents/tools/telegram-actions.ts` — per-account poll action authorization
   - `src/agents/tools/discord-actions.ts` — per-account Discord action authorization
   - `src/channels/plugins/actions/telegram.ts` + `discord.ts` — gating enforcement
   - **Strengthens Audit 2 Claim 5** (self-approving agent / no RBAC)

8. **`5a3a448bc`** — New `/subagents spawn` command.
   - `src/agents/subagent-spawn.ts` (NEW) — subagent spawning logic
   - `src/agents/tools/sessions-spawn-tool.ts` — tool interface (86 lines, timeout normalization at :48-58)
   - New exec path requiring authorization checks

9. **`de900bace` + `a6c741eb4`** — Subagent loop guards.
   - `src/agents/subagent-registry.ts` — resets announceRetryCount on steer, adds max attempts + expiry
   - Prevents infinite announcement retry loops (DoS prevention)

10. **`e368c3650`** — Adds llms.txt discovery as default agent behavior.
    - `src/agents/system-prompt.ts:150-166` — new llms.txt guidance section (+17 lines inserted)
    - `src/agents/tools/web-fetch.ts` — llms.txt URL construction
    - System prompt surface change — llms.txt content from external sites could contain injection payloads

11. **`838259331`** — Discord media deduplication in messaging tool pipeline.
    - 14 files including `src/agents/pi-embedded-runner/run.ts`, `src/discord/send.ts`
    - Prevents duplicate media from overwhelming storage or causing message corruption

12. **`bcab2469d` + `65aedac20`** — Memory FTS query expansion and fallback.
    - `src/memory/query-expansion.ts` (NEW) — LLM-based query expansion
    - `src/memory/manager.ts`, `src/memory/embeddings.ts` — FTS fallback when no embedding provider
    - Availability improvement with new query expansion surface

13. **`d4c057f8c`** — Exposes `sender_id` in trusted system metadata.
    - `src/auto-reply/reply/inbound-meta.ts` — adds sender_id to metadata available to agents

14. **`60bd154e5`** — Parses webhook URL pathname instead of raw string match.
    - Hardening for URL parsing accuracy

15. **`34b18ea9d`** — Respects `OPENCLAW_HOME` for isolated gateway instances.
    - Path isolation for multi-instance deployments

### Docker Infrastructure Commits (6)

| SHA | Message |
|-----|---------|
| `27a4868c2` | fix: move Chromium install after pnpm install and use playwright-core/cli.js |
| `d6aa9adec` | feat(docker): add optional Chromium + Xvfb install in Docker image |
| `8b14052eb` | fix: capture init script exit codes instead of swallowing via pipe |
| `53af9f743` | feat(docker): add init script support via /openclaw-init.d/ |
| `717caa97f` | fix: remove stderr suppression so install failures are visible in build logs |
| `2ab6313d9` | fix(docker): ensure memory-lancedb deps installed in Docker image |

### Non-Security Commits (91)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `ff7a73511` | refactor(onboarding): share allowlist merge helpers | 2 | Refactor |
| `1dfacd4dd` | fix(status): avoid bot+app token warning for mattermost | 1 | UX fix |
| `82861968c` | fix(mattermost): address review feedback on reactions PR | 2 | Review feedback |
| `2a2372cd6` | feat(mattermost): add emoji reactions support | 5 | Feature |
| `b57d29d83` | fix(slack): extract text and media from forwarded message attachments | 3 | Feature |
| `4928717b9` | fix: handle Qwen 3 reasoning field in Ollama responses | 2 | Provider fix |
| `46bf210e0` | fix: always drop orphaned OpenAI reasoning blocks in session history | 2 | Provider fix |
| `e33017982` | Update README.md | 1 | Docs |
| `e759b4cd5` | Update README.md | 1 | Docs |
| `572cfb7a5` | Update README.md | 1 | Docs |
| `57aef596b` | Revise Android installation link in README | 1 | Docs |
| `0a02b9163` | Handle Telegram poll vote updates for agent context | 2 | Feature |
| `5cbfaf5cc` | Add Telegram polls action to config typing | 2 | Feature |
| `b2fe44b1e` | Fix lint in telegram poll action handler | 1 | Lint |
| `c43e95e01` | Default Telegram polls to public | 1 | Config default |
| `afd354c48` | fix: add catalog validation to `models set` command | 2 | CLI validation |
| `671f91312` | feat: support per-model thinkingDefault override in models config | 3 | Feature |
| `4df970d71` | fix: improve error for unconfigured local providers (ollama/vllm) (#17328) | 2 | UX |
| `6e1edc7d6` | fix: correct Sparkle appcast version for 2026.2.15 | 1 | Version fix |
| `0ee348069` | fix(cron): preserve model fallbacks when agent overrides primary | 2 | Cron fix |
| `bb5ce3b02` | CLI: preserve message send components payload | 2 | CLI fix |
| `63fb99807` | fix: address code review feedback | 2 | Review feedback |
| `aeec95f87` | fix(gateway): include deliveryContext in update.run restart sentinel (#18239) | 2 | Gateway fix |
| `d43c11c76` | test: update tests and comments to reflect new autoSelectFamily default | 2 | Test update |
| `c762bf71f` | fix(telegram): enable autoSelectFamily by default for Node.js 22+ | 2 | Platform fix |
| `3ec936d1b` | fix(daemon): prefer current node and add macOS version manager paths to service PATH | 3 | Daemon fix |
| `1a8548df1` | fix(daemon): prefer current node (process.execPath) and add macOS version manager paths to service PATH | 3 | Daemon fix |
| `59eac34c2` | changelog: add channel health monitor entry | 1 | Changelog |
| `30ee12e40` | gateway: wire channel health monitor into startup with configurable interval | 4 | Feature |
| `497e2d76a` | feat(gateway): add channel health monitor with auto-restart | 6 | Feature |
| `68489a213` | gateway: expose isManuallyStopped and resetRestartAttempts on ChannelManager | 2 | Feature |
| `b91e43714` | feat(linq): add interactive onboarding adapter | 5 | Feature |
| `1d81cc4f1` | feat(linq): add read receipts, typing indicators, and User-Agent header | 4 | Feature |
| `d4a142fd8` | feat: add Linq channel — real iMessage via API, no Mac required | 10 | Feature |
| `95024d167` | fix: log error on auto-end failure instead of swallowing | 1 | Error handling |
| `4c0a74130` | fix: apply oxfmt 0.32.0 formatting (match CI version) | 15 | Formatting |
| `d56c04a3b` | fix: apply oxfmt formatting | 12 | Formatting |
| `3eec5e54b` | fix(voice-call): auto-end call when media stream disconnects | 3 | Voice-call fix |
| `a5c94b8e7` | fix: log error on reaper endCall failure instead of swallowing | 1 | Error handling |
| `390c503b5` | feat(voice-call): add configurable stale call reaper | 5 | Feature |
| `47f8c9209` | test: add tests for extraArgs filtering logic | 1 | Test |
| `cc3c25e41` | fix: apply oxfmt 0.32.0 formatting (match CI version) | 8 | Formatting |
| `2977f7325` | fix: add extraArgs to sandbox browser config and apply oxfmt formatting | 5 | Config + formatting |
| `039fc1e04` | feat(browser): add extraArgs config for custom Chrome launch arguments | 4 | Feature |
| `0764999e2` | fix: document intentional non-persistence of initialMessage deletion | 1 | Docs |
| `0291ce30a` | fix: apply oxfmt 0.32.0 formatting (match CI version) | 6 | Formatting |
| `dd319d05d` | fix: apply oxfmt formatting | 5 | Formatting |
| `2c6db5755` | feat(voice-call): pre-cache inbound greeting for instant playback | 4 | Feature |
| `6757a9fed` | fix(telegram): clean up update offset on channels remove --delete (#18233) | 2 | Telegram fix |
| `59e0e7e4f` | Onboarding: fix webchat URL loopback and canonical session | 3 | Onboarding fix |
| `a02bcb362` | fix(test): add missing media dedup state fields to mock contexts | 1 | Test |
| `c7681c3cf` | test(media-dedup): add missing coverage for Discord media dedup wiring | 1 | Test |
| `4641e452d` | fix(docs): update English fallback links after file reorganization | 3 | Docs |
| `84764eea5` | fix(docs): remove dead references to railway, render and northflank | 4 | Docs |
| `97bdfb6aa` | docs: scaffold full es and pt-BR doc routes with localized placeholders | 8 | Docs |
| `72676d318` | docs: replace english locale mirrors with translated landing pages | 5 | Docs |
| `8bccf9e8e` | docs: expand es and pt-BR docs trees | 12 | Docs |
| `1faf8e8e9` | Slack: add external select flow for large arg menus | 5 | Slack feature |
| `7a4efbb03` | Slack: capture workflow button interaction metadata | 3 | Slack feature |
| `bd20c1e24` | Slack: include stacked modal lifecycle context | 3 | Slack feature |
| `ce973332f` | Slack: add media block fallback text handling | 2 | Slack feature |
| `7aaf1547d` | Slack: escape mrkdwn in interaction confirmations | 2 | Slack feature |
| `a7c1b8aea` | Slack: attribute interaction confirmations and structured selects | 3 | Slack feature |
| `9fcb93dd1` | Slack: add rich text previews for modal inputs | 2 | Slack feature |
| `05ab14708` | Slack: expand advanced modal controls payloads and confirms | 3 | Slack feature |
| `5bbbc3e3e` | Slack: show picker values in interaction confirmations | 2 | Slack feature |
| `5f9a04604` | Slack: add header and context blocks to arg menus | 2 | Slack feature |
| `7c5529a15` | Slack: enrich modal input payload normalization | 2 | Slack feature |
| `d1aa2323b` | Slack: update action rows for select interactions | 2 | Slack feature |
| `1bfdd4e23` | Slack: add overflow menus for slash arg choices | 2 | Slack feature |
| `296ba8e93` | Slack: enrich block action context payloads | 2 | Slack feature |
| `7e42408ad` | Slack: dedupe normalized interaction selections | 2 | Slack feature |
| `6e790303d` | Slack: validate runtime blocks in send and edit paths | 3 | Slack feature |
| `c01c6b707` | Slack: expand interaction payload normalization coverage | 3 | Slack feature |
| `ac969e602` | Slack: add modal private metadata utilities | 2 | Slack feature |
| `82d132f1b` | Slack: add send blocks behavior tests | 2 | Slack feature |
| `e8a1d4171` | Slack: guard select option value length in slash menus | 2 | Slack feature |
| `c943ffab7` | Slack: reject blocks plus media in send paths | 2 | Slack feature |
| `10d876e31` | Slack: validate blocks input shape centrally | 2 | Slack feature |
| `e023c84d7` | Slack: infer interaction channel type from channel ID | 2 | Slack feature |
| `378e18b75` | Slack: support blocks in plugin edit action | 3 | Slack feature |
| `3912a2264` | Slack: support blocks in plugin send action | 3 | Slack feature |
| `08bc1dce6` | Slack: support Block Kit blocks in editMessage | 3 | Slack feature |
| `c9684a267` | Slack: support Block Kit blocks in sendMessage actions | 3 | Slack feature |
| `bd17587b2` | Slack: route modal interactions via private metadata | 3 | Slack feature |
| `d57cbcf71` | Slack: use static_select for large slash arg menus | 2 | Slack feature |
| `cf0ca47a8` | Slack: capture Block Kit view closed events | 2 | Slack feature |
| `e7cded82b` | Slack: capture Block Kit modal submissions | 3 | Slack feature |
| `21ba564fb` | Slack: fix CI typing for interaction handler | 1 | CI fix |
| `55b70aa8b` | Slack: register interaction event handler | 3 | Slack feature |
| `9419d029c` | Slack: enrich Block Kit interaction events | 3 | Slack feature |

### Line Number Shifts

| File | Old Ref | New Ref | Context |
|------|---------|---------|---------|
| `src/agents/system-prompt.ts` | :168-638 (677 lines) | :185-701 (701 lines) | `buildAgentSystemPrompt()` range (+17 at :147, +1 at :546) |
| `src/agents/system-prompt.ts` | :331-338 | :354-361 | Reasoning format tags |
| `src/agents/system-prompt.ts` | :373 | :396 | Self-preservation instruction |
| `src/agents/system-prompt.ts` | :397,401 | :420,424 | Identity line |
| `src/agents/system-prompt.ts` | :432-435 | :454-457 | Tool Call Style / narration policy |
| `src/agents/system-prompt.ts` | :454-455 | :477-478 | `config.apply` warning |
| `src/agents/system-prompt.ts` | :583-592 | :615-624 | SOUL.md reference |
| `src/agents/system-prompt.ts` | :603-613 | :627-637 | Silent reply rules |
| `src/agents/system-prompt.ts` | :604 | :628 | `SILENT_REPLY_TOKEN` usage |
| `src/slack/monitor/slash.ts` | :181-182 | :338-342 | Fail-closed channel type |
| `src/slack/monitor/slash.ts` | :183 | :341 | `normalizeSlackChannelType()` |
| `src/agents/tools/sessions-spawn-tool.ts` | :102-111 | :48-58 | Timeout normalization (file refactored from ~320 to 86 lines) |
| `src/memory/manager.ts` | :31 | :32 | `SNIPPET_MAX_CHARS` |
| `src/cron/isolated-agent/run.ts` | :327-356 | :340-369 | Cron hook wrapping section |
| `src/cron/isolated-agent/run.ts` | :350-356 | :363-369 | `buildSafeExternalPrompt()` call |
| `src/gateway/client.ts` | :191 | :205 | Token precedence |
| `src/gateway/client.ts` | :254 | :268 | Device auth |

### Audit Cross-Reference

| Claim/Gap | Status |
|-----------|--------|
| **Audit 1, Claim 1** (Plaintext OAuth token storage) | Partially addressed — `153794080`/`3379b9d34` add proper OAuth for Gemini |
| **Audit 1, Claim 2** (OAuth state validation) | Strengthened — `153794080`/`3379b9d34` implement proper OAuth flows |
| **Audit 1, Claim 4** (Token refresh race condition) | Addressed — `b2d622cfa` clears stale cached tokens |
| **Audit 1, Claim 5** (File permission checks) | **DIRECTLY ADDRESSED** — `ae0b110e4` sets 0o600 on remaining session paths |
| **Audit 2, Claim 2** (Media handling) | Strengthened — `838259331` adds media dedup |
| **Audit 2, Claim 4** (SSRF/URL parsing) | Strengthened — `60bd154e5` hardens webhook URL parsing |
| **Audit 2, Claim 5** (Self-approving agent / no RBAC) | **SUBSTANTIALLY STRENGTHENED** — 6 commits centralize account factory RBAC + per-account action gating |
| **Audit 2, Claim 7** (Input validation) | Strengthened — `38c96bc53` validates base64 image data |
| **Gap 1** (Gateway env var blocklist) | Previously CLOSED — not affected |
| **Gap 2** (Pipe-delimited token format) | Not addressed |
| **Gap 3** (outPath validation) | Not addressed |
| **Gap 4** (Bootstrap/memory .md scanning) | Not addressed |

**Unaffected claims:** Audit 1 Claims 3 (hardcoded OAuth secret), 6 (path traversal), 7 (webhook signature bypass), 8 (token expiry). Audit 2 Claims 1 (config injection), 3 (log traversal), 6 (token pipe injection), 8 (env var injection). All remain at their prior status.

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
