> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 19 Sync 9 — 51 Commits

**Merge commit:** 3904d7ca0 | **Range:** 8c5101575..3904d7ca0

### Security-Relevant Commits

| SHA | Message | Files | Impact |
|-----|---------|-------|--------|
| 49d0def6d | fix(security): harden imessage remote scp/ssh handling | 6 prod + 2 test | SSH/SCP command injection prevention via `normalizeScpRemoteHost()` |
| a7c0aa94d | refactor(security): share safe temp media path builder | 5 prod + 1 test | Path traversal prevention via centralized `buildRandomTempFilePath()` |
| 981d26648 | security(gateway): block webchat session mutators | 1 prod + 1 test | Webchat clients blocked from `sessions.patch`/`sessions.delete` |
| d51929ecb | fix: block ISATAP SSRF bypass via shared host/ip guard | 5 prod + 2 test | ISATAP-embedded private IPv4 detection (`:5efe:` marker) |
| 45db2aa0c | Security: disable plugin runtime command execution primitive | 4 prod + 1 test | `runtime.system.runCommandWithTimeout` throws security error |
| c275932aa | fix(security): OC-22 prevent Zip Slip and symlink following in skill packaging | 1 prod + 1 test | Archive extraction path validation |
| 7255c20dd | fix(docker): harden docker-setup mount validation | 2 prod + 1 test | Multiline injection blocking in `OPENCLAW_EXTRA_MOUNTS` |
| 8e6d1e636 | LINE/Security: harden inbound media temp-file naming | 2 prod + 1 test | `crypto.randomUUID()` replaces external `messageId` in temp paths |
| ba7be018d | fix(security): remove lobster windows shell fallback | 2 prod + 1 test | Direct Node spawn replaces shell execution |
| bf3f8ec42 | refactor(media): unify safe local file reads | 3 prod + 3 test | `readLocalFileSafely()` with symlink rejection, path traversal blocking |
| cdb00fe24 | fix(feishu): isolate temp download writes in mkdtemp dirs | 1 prod + 0 test | `mkdtemp` isolation prevents temp file races |
| c82109915 | Feishu: harden temp media download paths | 1 prod + 1 test | Same class as 8e6d1e636 — crypto-random temp paths |
| ee1d6427b | fix(security): enforce symlink-safe skill packaging | 3 prod + 1 test | Symlink following prevention in archive extraction |
| b4dbe0329 | refactor: unify restart gating and update availability sync | 13 prod + 12 test | **[REGRESSION]** `commands.restart` now defaults to `true` |

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| de656e319 | fix(otel): complete diagnostics-otel OpenTelemetry v2 API migration (#12897) | 2 prod + 1 test | API migration, no security impact |
| 1faa7a87a | lobster: parse windows cmd shim paths with rooted tokens (#20833) | 1 prod + 1 test | Path parsing refactor |
| 771af4091 | chore(ci): fix main check blockers and stabilize tests | 2 prod + 2 test | Test stabilization |
| 70900feaa | refactor(daemon): share service arg types across backends | 5 prod + 0 test | Type extraction |
| be7462af1 | Gateway: clarify launchctl domain bootstrap error (#13795) | 1 prod + 1 test | UX improvement |
| 88f698974 | fix(otel): sanitize OTLP endpoint URL resolution (#13791) | 1 prod + 1 test | URL parsing fix |
| 02123e591 | refactor(lobster): extract windows spawn resolver | 2 prod + 0 test | Code extraction |
| 3904d7ca0 | deps: migrate request to @cypress/request (#20836) | 2 prod + 0 test | Dependency update |
| 942ed8927 | deps: update overrides for minimatch and fast-xml-parser (#20832) | 2 prod + 0 test | Dependency update |

*(Plus 7 test-only commits deduplicated during triage)*

### Key Security Changes

#### 1. SSH/SCP Command Injection Prevention (`49d0def6d`)

New module `src/infra/scp-host.ts` introduces `normalizeScpRemoteHost()` which validates remote host tokens to prevent option injection attacks (e.g., `-oProxyCommand=whoami`). The function only accepts safe `host` or `user@host` forms, rejecting spaces, options, path separators, and multiple `@` signs.

- `src/infra/scp-host.ts:15` — `normalizeScpRemoteHost()` function
- `src/config/zod-schema.providers-core.ts:808` — `remoteHost` field uses `.refine(isSafeScpRemoteHost, ...)`
- `src/infra/ssh-tunnel.ts:138` — `StrictHostKeyChecking` changed from `accept-new` to `yes`

#### 2. Path Traversal Prevention via Centralized Temp Paths (`a7c0aa94d`)

Introduces shared `buildRandomTempFilePath()` utility in `src/plugin-sdk/temp-path.ts` to replace ad-hoc temp path construction across Feishu and LINE channels.

- `src/plugin-sdk/temp-path.ts:5` — `sanitizePrefix()` strips non-alphanumeric chars
- `src/plugin-sdk/temp-path.ts:10` — `sanitizeExtension()` validates extension format
- `src/plugin-sdk/temp-path.ts:23` — `buildRandomTempFilePath()` combines sanitizers + crypto UUID

#### 3. ISATAP SSRF Bypass Fix (`d51929ecb`)

Closes SSRF bypass using ISATAP-embedded private IPv4 addresses (RFC 5214). Adds ISATAP rule to `EMBEDDED_IPV4_RULES` to detect and block addresses like `2001:db8:1234::5efe:127.0.0.1`.

- `src/infra/net/ssrf.ts:27` — `BLOCKED_HOSTNAMES` adds `localhost.localdomain`
- `src/infra/net/ssrf.ts:203` — ISATAP rule detects `:5efe:` IID marker
- `src/infra/net/ssrf.ts:333` — `isBlockedHostnameOrIp()` unified guard function

#### 4. Plugin Runtime Command Execution Disabled (`45db2aa0c`)

Disables `runtime.system.runCommandWithTimeout` for security hardening. Extensions must now use fixed-purpose runtime APIs instead of arbitrary command execution.

- `src/plugins/runtime/index.ts:235` — `runtimeCommandExecutionDisabled` stub throws error
- `src/plugins/runtime/types.ts:187` — API marked as `@deprecated`

#### 5. Docker Mount Validation Hardening (`7255c20dd`)

Adds input validation for `OPENCLAW_EXTRA_MOUNTS` and `OPENCLAW_HOME_VOLUME` environment variables. Blocks multiline injection attacks.

- `docker-setup.sh` — Rejects control characters in mount specs
- `src/docker-setup.test.ts` — Test coverage for injection cases

#### 6. Webchat Session Mutator Blocking (`981d26648`)

Webchat clients can no longer call `sessions.patch` or `sessions.delete` gateway methods. They are restricted to `chat.send` for session-scoped updates.

- `src/gateway/server-methods/sessions.ts:243` — webchat check for `sessions.patch`
- `src/gateway/server-methods/sessions.ts:369` — webchat check for `sessions.delete`

### REGRESSION WARNING

**`b4dbe0329`** inverts the default for `commands.restart` from `false` to `true`. The `/restart` command and gateway restart tool are now **enabled by default**.

**Action required:** Deployers who want restart disabled must explicitly set:
```yaml
commands:
  restart: false
```

- `src/config/commands.ts:65` — `isRestartEnabled()` returns `true` unless `restart===false`
- `src/config/zod-schema.session.ts:132` — `restart: z.boolean().optional().default(true)`

### Audit Cross-Reference

| Claim | Status |
|-------|--------|
| Threat model Section 2 (Untrusted content) | **Affected** — ISATAP SSRF bypass closed, SSRF protection consolidated |
| Threat model Section 3 (Network exposure) | **Affected** — SSH/SCP command injection prevented |
| Threat model Section 4 (Local disk + secrets) | **Affected** — Path traversal in temp files prevented |
| Hardening checklist Section 4 (Require auth) | **Affected** — Webchat session mutator guard added |
| Hardening checklist Section 7 (Minimize tool blast radius) | **Affected** — Restart now enabled by default (regression) |
| Hardening checklist Section 13 (Never let AI modify security-critical config) | Not affected |

### Phase 6c: CVE/GHSA Check

30 advisories found. Relevant to this sync:
- GHSA-xxvh-5hwj-42pp (CVE-2026-27007) — Sandbox config hash
- GHSA-2qj5-gwg2-xwc4 (CVE-2026-27001) — CWD path injection
- GHSA-w235-x559-36mg (CVE-2026-27002) — Docker bind mount injection
- GHSA-v892-hwpg-jwqp — Zip Slip in archive extraction

**Gap status:** No gaps closed in this sync. — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
