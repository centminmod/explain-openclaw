> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 15 sync 14) — 37 upstream commits

**Merge commit:** cdeedd809 | **Range:** a6608ca09..cdeedd809

**Security relevance: MEDIUM** — 12 security-relevant fix commits with 7 companion tests and 1 password-related UI security fix. No audit claims fully addressed; incremental hardening across OAuth, webhooks, allowlists, memory, and plugin installation. Audit 1 Claim 2 (CSRF/OAuth state) tangentially strengthened.

### Security-Relevant Commits

1. **Password exposure prevention** (`a32403180`): `applySettingsFromUrl()` in `ui/src/ui/app-settings.ts:108-111` no longer hydrates password parameters from URLs. Prevents credential leakage via URL sharing/logging.

2. **OAuth CSRF protection hardened** (`cdeedd809` + `6c0dca30b`): Manual OAuth flow now enforces state parameter validation. New `parseManualOAuthInput()` function (`src/commands/chutes-oauth.ts:18-41`) validates the state parameter matches expected value, rejecting with "Invalid OAuth state" on mismatch. Test (`cdeedd809`) asserts state is extracted and passed in redirect URL. Tangentially strengthens Audit 1 Claim 2.

3. **File path alias bypass closed** (`032842a74` + `53e4d37cf`): Read tool handler now accepts both `path` and `file_path` parameters (`src/agents/pi-embedded-subscribe.handlers.tools.ts:79-82`). Previously, using the `file_path` alias could bypass tool-start path validation checks. Regression test added (`53e4d37cf`).

4. **Cron job startup replay protection** (`7b89e68d1` + `bb6758567`): Interrupted jobs no longer replayed on startup. Tracks interrupted jobs in `startupInterruptedJobIds` set (`src/cron/service/ops.ts:370,378`) and passes as `skipJobIds` to `runMissedJobs()` (`src/cron/service/timer.ts:376-377`). Prevents duplicate execution of critical jobs. Regression test added (`bb6758567`).

5. **Discord allowlist null-safety** (`7b4984e73` + `66414b28b`): Empty guild channel maps no longer bypass allowlist checks. New helper `hasConfiguredDiscordChannels()` (`src/discord/monitor/allow-list.ts:311-314`) returns true only if channels exist and have entries. Used in `resolveDiscordChannelConfig()` (line 342) and fallback variant (line 488). Regression test added (`66414b28b`).

6. **Memory query ranking corruption fixed** (`04a88a6ee` + `46a3c1606`): Multi-collection QMD queries now handled via dedicated `runQueryAcrossCollections()` method (`src/memory/qmd-manager.ts:1322-1361`). When `collectionNames.length > 1` and mode is `query`, queries each collection separately and deduplicates by best score, preventing ranking corruption from mixed-collection results. New `listManagedCollectionNames()` (lines 1364-1376) deduplicates collection names. Regression test added (`46a3c1606`).

7. **Signal group ID case sensitivity preserved** (`8647a1ebe` + `4587175fb`): Removed `.toLowerCase()` call in `src/channels/plugins/normalize/signal.ts:14-17`. Signal group IDs are base64-encoded and case-sensitive; lowercasing breaks group message routing. Test covers mixed-case preservation (`4587175fb`).

8. **Telegram webhook timeout-safe** (`f032ade9c` + `69a1ab231`): Webhook callback now has a 10-second timeout to prevent hanging and retry storms from Telegram. Added `TELEGRAM_WEBHOOK_CALLBACK_TIMEOUT_MS = 10_000` constant (`src/telegram/webhook.ts:22`) and passes `onTimeout: "return"` + `timeoutMilliseconds` (lines 60-61) to `webhookCallback()`. Test asserts options are passed (`69a1ab231`).

9. **LLM empty-chunk timeout classification** (`eb846c95b` + `79aaab403`): Empty-chunk stream failures now classified as timeouts rather than generic errors. Added regex `/without sending (?:any )?chunks?/i` to `ERROR_PATTERNS.timeout` (`src/agents/pi-embedded-helpers/errors.ts:597`). Prevents false error categorization for transient network issues. Regression test added (`79aaab403`).

10. **Plugin install file: URL validation** (`981d57213`): New `resolveFileNpmSpecToLocalPath()` function (`src/cli/plugins-cli.ts:47-71`) validates `file:` npm spec URLs, rejecting hostnames and malformed paths before `resolveUserPath()` (line 545). Prevents file: URL injection attacks during plugin installation. Supply chain adjacent.

11. **Memory dirty-state isolation** (`7addb519d` + `44bbb4ddf`): Added `purpose?: "default" | "status"` parameter to `MemoryIndexManager.get()` (`src/memory/manager.ts:104`) and constructor (line 146). Logic at line 181-182: `this.dirty = this.sources.has("memory") && (statusOnly ? !meta : true)` prevents dirty-state pollution when index is reused for status queries. Regression test added (`44bbb4ddf`).

### Non-Security Commits (17 safe + 4 demoted)

| SHA | Message | Files |
|-----|---------|-------|
| b5ab92eef | chore(changelog): note read tool file_path alias warning fix | 1 |
| 7dea9a131 | chore(changelog): note tui light-theme contrast fix | 1 |
| 2c962ef8f | fix(tui): keep assistant text contrast theme-adaptive | 2 |
| 70cf0e4d4 | chore(changelog): note cron interrupted-start replay fix | 1 |
| 58548c729 | docs(changelog): mark 2026.2.14 released | 1 |
| c3e87da2d | chore(changelog): note discord empty channels allowlist fix | 1 |
| 202b06b27 | chore(changelog): note qmd multi-collection query fix | 1 |
| cab25b583 | chore(changelog): note signal group-id normalization fix | 1 |
| 36b80c4f3 | chore(changelog): note telegram webhook timeout retry-storm fix | 1 |
| c1feda14f | docs(changelog): reorder 2026.2.14 notes | 1 |
| f20262999 | chore(changelog): document empty-chunk timeout handling | 1 |
| ddfdd20d7 | docs: update Slack/Discord allowFrom references | 4 |
| d7c0bbd7c | chore(changelog): note stable memory status dirty reporting | 1 |
| c14eb2b60 | test(tui): cover assistant default-foreground theme behavior | 1 |
| 2690dfa77 | test: quiet docker onboard e2e noise | 2 |
| 107cc0314 | ci: reduce docker e2e log brittleness | 2 |
| e720e022e | test: stabilize sessions_spawn e2e mocks | 7 |

### Line Number Shifts

| File | Old | New | Context |
|------|-----|-----|---------|
| `src/telegram/webhook.ts` | `:30` | `:31` | `webhookSecret` optional type |
| `src/telegram/webhook.ts` | `:40` | `:41` | binding default `127.0.0.1` |
| `src/telegram/webhook.ts` | `:41-47` | `:42-48` | secret mandatory enforcement |
| `src/memory/qmd-manager.ts` | `:415-421` | `:418-424` | readFile .md + symlink validation |
| `src/memory/qmd-manager.ts` | `:1080-1086` | `:1126-1132` | `buildCollectionFilterArgs()` |

### Audit Cross-Reference

- **Audit 1 Claim 2 (CSRF/OAuth state):** Tangentially strengthened by `cdeedd809` + `6c0dca30b` (state validation in manual OAuth flow). Does not fully address the original claim about missing CSRF protection in the primary OAuth flow.
- **No other claims directly addressed.** No legitimate gaps closed.

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
