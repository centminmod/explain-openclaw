# Post-Merge Hardening: Feb 21 Sync 4

**Date:** 2026-02-21
**Commit Range:** `20552f8db`..`c2f562891` (11 commits)
**Merge SHA:** `e68f44d58`
**Security-Relevant:** 3 commits
**Non-Security:** 8 commits

---

## Security-Relevant Commits

| SHA | Message | Description |
|-----|---------|-------------|
| `e7eba01ef` | Security: disable sandbox container --no-sandbox by default (#22451) | Hardens browser sandbox by removing `--no-sandbox` and `--disable-setuid-sandbox` Chrome flags from defaults. These flags are now only enabled when `ALLOW_NO_SANDBOX=1` env var is explicitly set. File: `scripts/sandbox-browser-entrypoint.sh:14,49-53`. |
| `8877bfd11` | gateway: trust-proxy-aware X-Forwarded-For resolution (#22466) | Fixes IP spoofing via X-Forwarded-For header. Adds `trustedProxies` parameter to `parseForwardedForClientIp()` (line 149) and `resolveGatewayClientIp()` (line 255). New `isTrustedProxyAddress()` function at line 235 walks the proxy chain backwards, returning first untrusted IP instead of blindly trusting the rightmost entry. File: `src/gateway/net.ts`. |
| `58f7b7638` | Security: add per-wrapper IDs to untrusted-content markers (#19009) | Prevents boundary marker spoofing attacks (fixes #10927). Adds `randomBytes` crypto import, `createExternalContentMarkerId()` (line 54), and modifies markers to include unique 16-char hex IDs. `replaceMarkers()` (line 143) now strips markers with or without IDs to handle legacy and spoofed markers. Files: `src/security/external-content.ts`. |

---

## Non-Security Commits

| SHA | Message |
|-----|---------|
| `c2f562891` | Fix formatting (#22474) |
| `3002be76e` | docs: add custom spellcheck dictionary and fix docs typos (#22457) |
| `3b8d7b2e4` | deps: remove dead root dependency (#22471) |
| `569191fff` | extensions: fix MSTeams OneDrive fallback mention handling (#22472) |
| `d3bb92470` | chore(deadcode): add deadcode scanning and remove unused lockfile deps (#22468) |
| `0fe8f07e0` | Docs: add changelog entry for PR #19009 (#22464) |
| `45fff13b1` | TUI: strip only leading inbound metadata (#22461) |
| `59167f86c` | test: correct trusted proxy X-Forwarded-For expectation |

---

## Audit Cross-Reference

All 16 audit claims unchanged by this sync. The 3 legitimate gaps remain open.

### Key Security Changes

1. **Browser Sandbox Hardening (e7eba01ef):** Chrome now runs with sandboxing enabled by default. The `--no-sandbox` flags are only applied when `ALLOW_NO_SANDBOX=1` is explicitly set.

2. **X-Forwarded-For Spoofing Prevention (8877bfd11):** Gateway IP resolution now validates the proxy chain when `trustedProxies` is configured. Instead of blindly trusting the rightmost X-Forwarded-For entry, it walks backwards through the chain and returns the first IP NOT in the trusted proxy list.

3. **Content Boundary Marker Spoofing Prevention (58f7b7638):** External content wrappers now use cryptographically random 16-character hex IDs to pair start/end markers. This prevents malicious content from injecting fake boundary markers that could confuse the sanitizer.

---

## Line Number Shifts

### `src/gateway/net.ts`

| Symbol | Old Line | New Line | Notes |
|--------|----------|----------|-------|
| `parseForwardedForClientIp()` | 149 | 149 | Signature changed (added `trustedProxies` param) |
| `isTrustedProxyAddress()` | 210 | 235 | Function moved down |
| `resolveGatewayClientIp()` | 230 | 255 | Function moved down |

### `src/security/external-content.ts`

| Symbol | Old Line | New Line | Notes |
|--------|----------|----------|-------|
| `EXTERNAL_CONTENT_START` | 47 | 51 | Renamed to `EXTERNAL_CONTENT_START_NAME` |
| `createExternalContentMarkerId()` | N/A | 54 | NEW function |
| `replaceMarkers()` | 127 | 143 | Moved down, now handles ID attribute |

---

## Related Issues

- **#10927** — Fixed by 58f7b7638 (untrusted-content marker spoofing)
- **#19009** — PR implementing the marker ID fix

---

> **Gap status:** [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status) (1 closed, 3 remain open)
