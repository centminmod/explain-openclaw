> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-merge hardening notes (Feb 15, 2026 — sync 2, 30 commits)

**Merge commit:** `493f6f458` | **Range:** `ec7db11d9..493f6f458`

### Security-Relevant Commits (10)

#### 1. `3aa94afcf` — fix(security): harden archive extraction (#16203)

**Scope:** 19 files — `src/infra/archive.ts`, `src/infra/tmp-openclaw-dir.ts`, `src/browser/paths.ts` (NEW), `src/browser/routes/path-output.ts`, `src/browser/routes/agent.act.ts`, `src/browser/pw-tools-core.downloads.ts`, plus tests.

Major security hardening commit addressing path traversal in archive extraction and browser file operations:

- **Archive path traversal prevention (`src/infra/archive.ts`):** New `validateArchiveEntryPath()` (line 86) rejects entries with `..` traversal, absolute paths, and Windows drive paths. New `resolveCheckedOutPath()` (line 120) ensures output stays within destination directory using `path.resolve()` + prefix check with trailing separator. Both zip and tar extraction now validate every entry path before extraction. Tar extraction also rejects symbolic links and hard links via filter callback.
- **Browser download path confinement (`src/browser/paths.ts`, NEW):** New `resolvePathWithinRoot()` and `resolvePathsWithinRoot()` functions provide path confinement for upload/download operations. Validates that resolved paths stay within designated root directories.
- **Download filename sanitization (`src/browser/pw-tools-core.downloads.ts`):** New `sanitizeDownloadFileName()` (line 20) applies `path.posix.basename()` + `path.win32.basename()` to strip traversal from `suggestedFilename()` (untrusted server input). Strips control characters and limits to 200 chars.
- **Browser endpoint path validation (`src/browser/routes/agent.act.ts`):** POST `/download` and related endpoints now use `resolvePathWithinRoot()` (lines 460, 500) instead of passing `body.path` directly. Prevents arbitrary file write via download endpoints.
- **Tmp dir hardening (`src/infra/tmp-openclaw-dir.ts`):** Symlink detection via `lstatSync()`, ownership verification via `isSecureDirForUser()` (line 49), group/other write protection check (mode & 0o022).

**Addresses:** Tracked issues #3277 (archive path traversal), #8696 (Playwright download traversal), #8516 (browser endpoint arbitrary write). Partially addresses Legitimate Gap #3 (outPath validation — browser paths now validated; nodes-tool outPath still unvalidated).

#### 2. `35c0e66ed` — fix(security): harden hooks module loading

**Scope:** 11 files — `src/config/zod-schema.hooks.ts`, `src/hooks/loader.ts`, `src/gateway/server/ws-connection/message-handler.ts`, `src/config/types.hooks.ts`, `src/config/validation.ts`, `src/config/config.hooks-module-paths.test.ts`, plus tests.

- **Module path validation (`src/config/zod-schema.hooks.ts`):** New `isSafeRelativeModulePath()` function and `SafeRelativeModulePathSchema` rejects absolute paths, `~` paths, `:` (protocol/drive), and `..` traversal segments in hook handler module declarations.
- **Workspace-relative module loading (`src/hooks/loader.ts`):** Handler module resolution now enforces workspace-relative paths. Computes `path.relative(baseDir, modulePath)` and rejects any result that starts with `..` or is absolute, confining hooks to the workspace directory.
- **Scope clearing on unauthenticated connections (`src/gateway/server/ws-connection/message-handler.ts`):** When a WebSocket client does not present a device identity, scopes are now explicitly cleared (line 434) to prevent self-declared permissions from persisting.

#### 3. `6f7d31c42` — fix(security): harden plugin/hook npm installs

**Scope:** 10 files — `src/infra/npm-registry-spec.ts` (NEW), `src/plugins/install.ts`, `src/hooks/install.ts`, `src/agents/skills-install.ts`, plus tests.

- **npm spec validation (`src/infra/npm-registry-spec.ts`, NEW):** New `validateRegistryNpmSpec()` function rejects URLs, git refs, `file:` protocol specs, and whitespace in npm install arguments. Only allows registry `name@version` format. Prevents supply chain attacks via malicious npm spec injection.
- **Plugin/hook install hardening:** `src/plugins/install.ts` and `src/hooks/install.ts` now call `validateRegistryNpmSpec()` before `npm pack`. Temp dir cleanup via `try/finally`. Uses `--ignore-scripts` for npm pack.
- **Skill archive extraction:** `src/agents/skills-install.ts` now calls `extractArchiveSafe()` (lines 331, 342) from `src/infra/archive.ts` instead of raw `unzip`/`tar` commands, inheriting all the path traversal protections.

#### 4. `18e8bd68c` — fix(security): block hook manifest path escapes

**Scope:** 3 files — `src/hooks/workspace.ts`, `src/hooks/workspace.test.ts`, `src/hooks/install.ts`.

- **`resolveContainedDir()` (`src/hooks/workspace.ts`):** New function prevents hook manifest paths from escaping the package directory. Resolves the candidate path and verifies it stays within the allowed base using prefix checking with trailing separator.

#### 5. `a0361b8ba` — fix(security): restrict hook transform module loading

**Scope:** 7 files — `src/gateway/hooks-mapping.ts`, `src/hooks/loader.ts`, `src/gateway/hooks-mapping.test.ts`, plus tests.

- **Transform module confinement (`src/gateway/hooks-mapping.ts`):** `resolveHookMappings()` now takes a `configDir` option. Transform modules are confined to `configDir/hooks/transforms/` directory using `resolveContainedPath()` and `resolveOptionalContainedPath()` functions that verify resolved paths stay within the designated directory.

#### 6. `28d9dd7a7` — fix(macos): harden openclaw deep links

**Scope:** 5 files — macOS deep link handling.

- Deep link agent policy hardening prevents unauthorized agent actions via `openclaw://` URL scheme on macOS.

#### 7. `8025e7c6c` — fix(discord): respect gateway TLS config in exec approvals handler (#16216)

**Scope:** 1 file — `src/discord/monitor/exec-approvals.ts`.

- Discord exec approvals handler now uses `buildGatewayConnectionDetails()` (line 270) instead of constructing the gateway URL directly, ensuring TLS configuration is properly respected for WebSocket connections.

#### 8. `00a089088` — fix(media): bound input media payload sizes

**Scope:** 3 files — `src/media/input-files.ts`, `src/media/server.test.ts`, `src/media/input-files.fetch-guard.test.ts`.

- **Streaming payload size limits (`src/media/input-files.ts`):** New `readResponseWithLimit()` (line 206) enforces byte-level limits on streaming HTTP responses to prevent memory exhaustion from oversized media downloads.
- **Base64 size estimation:** New `estimateBase64DecodedBytes()` (line 113) and `rejectOversizedBase64Payload()` (line 123) validate base64 payload sizes before attempting decode, preventing DoS via large base64 strings in image/file inputs.

#### 9. `842499d6c` — test(security): reject hook archives with traversal entries (#16224)

Test coverage for zip and tar traversal rejection in the archive extraction hardening from `3aa94afcf`.

#### 10. `3d0a41b58` — test(gateway): isolate device identity in auth e2e

Test coverage verifying that gateway scopes are properly cleared when no device identity is presented (testing the scope-clearing behavior from `35c0e66ed`).

### Non-Security Commits (20)

| SHA | Summary | Files |
|-----|---------|-------|
| `493f6f458` | perf(test): speed up browser test suites | 6 |
| `57f40a5da` | perf(test): speed up config tests | 6 |
| `788ea6e9d` | fix: suppress false duplicate plugin id warning for symlinked extensions | 2 |
| `1a7e180e6` | refactor(media): normalize inbound MediaType/MediaTypes defaults (#16233) | 1 |
| `4b1cadaec` | refactor(media): normalize inbound media type defaults (#16228) | 5 |
| `e53a221e5` | chore: format changelog | 1 |
| `644bef157` | docs: clarify hook transform module path constraints | 1 |
| `3a67721da` | docs(security): fix canvas host docs formatting | 0 |
| `6a386a788` | docs(security): clarify canvas host exposure and auth | 13 |
| `9a134c8a1` | perf(test): tune parallel vitest worker split | 1 |
| `ce0eddd38` | test: isolate test home before runtime imports | 1 |
| `7d3e5788e` | fix: stop enforcing \<final\> for ollama (#16191) | 3 |
| `74193ff75` | fix(ollama): remove Ollama from isReasoningTagProvider (#2279) | 2 |
| `c76288bdf` | fix(slack): download all files in multi-image messages (#15447) | 7 |
| `ef70a55b7` | refactor(reply): clarify explicit reply tags in off mode (#16189) | 8 |
| `d69b32a07` | docs(changelog): clarify hooks transform dir restriction | 1 |
| `d73b48b32` | fix(ts): map plugin-sdk subpaths | 1 |
| `ec399aadd` | perf(test): parallelize unit-isolated | 6 |
| `3bbd29bef` | perf(gateway): cache session list transcript fields | 3 |
| `6543ce717` | perf(test): avoid plugin-sdk barrel imports | 23 |

### Commit Chains

1. **Hooks/plugin security hardening chain:** `35c0e66ed` → `a0361b8ba` → `18e8bd68c` → `6f7d31c42` — Progressive confinement of hook module loading, transform modules, manifest paths, and npm installs. `842499d6c` provides test coverage.
2. **Archive extraction + browser path chain:** `3aa94afcf` (archive hardening + browser paths) ← `6f7d31c42` (skills-install now uses extractArchiveSafe)
3. **Gateway auth chain:** `35c0e66ed` (scope clearing) ← `3d0a41b58` (test coverage)

### Line Number Shifts

| File | Old | New | Context |
|------|-----|-----|---------|
| `src/infra/archive.ts` | 81,89 | 86 | `validateArchiveEntryPath()` (new function) |
| `src/infra/archive.ts` | 112 | 168+ | `extractArchive()` with full validation |
| `src/infra/tmp-openclaw-dir.ts` | 24-50 | 31-100 | `resolvePreferredOpenClawTmpDir()` with symlink/ownership checks |
| `src/browser/routes/path-output.ts` | 1-29 | 1 (reexport) | Implementation moved to `src/browser/paths.ts` |
| `src/browser/pw-tools-core.downloads.ts` | 20-24 | 50 | `buildTempDownloadPath()` |
| `src/browser/pw-tools-core.downloads.ts` | 182-183 | 212-213 | `suggestedFilename()` usage |
| `src/browser/routes/agent.act.ts` | 447-480 | 450-518 | Download path validation (now uses `resolvePathWithinRoot`) |
| `src/discord/monitor/exec-approvals.ts` | 235-239 | 270-273 | Gateway URL construction (now TLS-aware) |
| `src/media/input-files.ts` | 101 | 104 | `DEFAULT_INPUT_IMAGE_MAX_BYTES` |
| `src/media/input-files.ts` | 149 | 179 | User-Agent header |
| `src/media/input-files.ts` | 197-254 | 260-321 | PDF-to-image rendering |
| `src/config/io.ts` | 343-362 | `backup-rotation.ts:3` | `rotateConfigBackups` extracted |
| `src/config/io.ts` | 370-413 | 376-390 | `appendConfigWriteAuditRecord` |
| `src/config/io.ts` | 849-1067 | 820-1045 | `writeConfigFile` |
| `src/config/io.ts` | 919 | 890 | 0o700 mkdir |
| `src/config/io.ts` | 1027,919 | 998,890 | 0o600/0o700 file permissions |
| `src/config/validation.ts` | 86-131 | 90-133 | `validateConfigObjectRaw` |
| `src/agents/skills-install.ts` | 255-279 | 316-342 | `extractArchive` (now calls `extractArchiveSafe`) |
| `src/plugins/install.ts` | 59-115 | 61-140 | `validatePluginId` + `resolveSafeInstallDir` |
| `src/plugins/loader.ts` | 211-296 | 235-336 | jiti plugin loader |
| `src/slack/monitor/message-handler/prepare.ts` | 445-448 | 455-461 | `buildUntrustedChannelMetadata` |
| `src/commands/signal-install.ts` | 124 | 221 | User-Agent header |
| `src/hooks/install.ts` | 55-97 | 56-105 | `validateHookId` + `resolveSafeInstallDir` |

### Audit Cross-Reference

- **Audit 2 Claim 2** (arbitrary write via outPath): Browser download paths now validated via `resolvePathWithinRoot()`. Nodes-tool `outPath` (Gap #3) remains unvalidated.
- **Legitimate Gap #3** (outPath validation): Partially mitigated — browser file operations now confined. nodes-tool `screen_record` outPath still unvalidated.
- **No other audit claims directly affected.**

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
