> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 16 Sync 14 Hardening (80 commits, 7 security-relevant)

**Merge commit:** dbcd23ee1 | **Range:** bf16c1208..beb77229c

### Commits

| SHA | Message | Files | Category |
|-----|---------|-------|----------|
| `beb77229c` | fix (security/line): fail closed when webhook auth is missing | 2 prod | Security |
| `eed02a2b5` | fix (security/gateway): preserve control-ui scopes in bypass mode | 1 prod + 1 test | Security |
| `ee10feb80` | fix (security/pairing): scope pairing stores by account | 1 prod + 1 test | Security |
| `2363e1b08` | fix(security): restrict skill download target paths | 7 prod + 2 doc | Security |
| `c6c53437f` | fix(security): scope session tools and webhook secret fallback | 10 prod + 5 test + 6 doc | Security |
| `d95be2c38` | fix: preserve sandbox allow-all semantics | 1 prod + 2 test | Security |
| `6957354d4` | fix (telegram/whatsapp): use account-scoped pairing allowlists | 6 prod | Security |
| (73 others) | Refactors, tests, perf improvements, features | ~150 prod + ~80 test | Non-security |

### Security-Relevant Commits

1. **`beb77229c`** — **fix (security/line): fail closed when webhook auth is missing**

   Implements fail-closed security for LINE channel by requiring both channel access token AND channel secret before allowing webhook operation:

   - `extensions/line/src/channel.ts:574-589` — `collectStatusIssues()` reports missing token or secret as config issues per account
   - `extensions/line/src/channel.ts:628-639` — `startAccount()` in the gateway section trims and validates both `channelAccessToken` and `channelSecret`, throwing explicit errors when either is empty
   - `src/line/monitor.ts:132-139` — monitor layer validates trimmed token and secret, throws "LINE webhook mode requires a non-empty channel access token/secret" when missing

   **Prevents unauthorized webhook access** by failing closed when credentials are incomplete. Previously, only the token was checked, allowing operation with missing secret. Relevant to **Audit 1 Claim 7** (webhook signature bypass).

2. **`eed02a2b5`** — **fix (security/gateway): preserve control-ui scopes in bypass mode**

   Fixes a scope bypass issue in gateway authentication where control-ui scopes were being incorrectly cleared:

   - `src/gateway/server/ws-connection/message-handler.ts:430-435` — adds `!allowControlUiBypass` guard before clearing scopes
   - Scopes are now preserved for legitimate control-ui clients even in bypass mode

   **Preserves authorization scopes** for legitimate control-ui clients while maintaining bypass security. Relevant to **Audit 2 Claim 5** (self-approving agent).

3. **`ee10feb80`** — **fix (security/pairing): scope pairing stores by account**

   Implements account-scoped isolation for pairing stores, preventing cross-account pairing data leakage:

   - `src/pairing/pairing-store.ts:69-78` — new `safeAccountKey()` sanitizes accountId for safe use in file paths (rejects empty, strips traversal chars)
   - `src/pairing/pairing-store.ts:81-95` — `resolveAllowFromPath()` includes sanitized accountId in allowlist file paths, creating per-account allowlists
   - `src/pairing/pairing-store.test.ts` — account isolation test coverage

   **Prevents cross-tenant data leakage** in multi-tenant deployments by scoping pairing stores to specific accounts. Users paired on one account cannot access another account's data. Relevant to **Audit 2 Claim 5**.

4. **`2363e1b08`** — **fix(security): restrict skill download target paths**

   Major security hardening for skill installation that prevents path traversal attacks:

   - `src/infra/path-safety.ts:1-20` — new `isWithinDir()` and `resolveSafeBaseDir()` functions for path validation
   - `src/infra/install-safe-path.ts:1-25` — new safe-path utilities for installation
   - `src/agents/skills-install-download.ts:1-376` — new dedicated module for secure skill downloads
   - `src/agents/skills-install.ts:104-147` — refactored to use safe-path validation

   **Prevents path traversal attacks** during skill installation. Downloaded skills cannot escape their target directories. Closes **Legitimate Gap #3** (outPath validation) and relevant to **Audit 1 Claim 6** (path traversal in agent dirs).

5. **`c6c53437f`** — **fix(security): scope session tools and webhook secret fallback**

   Implements session tools visibility scoping to control cross-session access:

   - `src/agents/tools/sessions-access.ts:1-240` — new access control module: `resolveSessionToolsVisibility()` (line 23), `resolveEffectiveSessionToolsVisibility()` (line 33), `resolveSandboxSessionToolsVisibility()` (line 48), with `SessionToolsVisibility` type (line 9: self/tree/agent/all)
   - `src/config/types.tools.ts:458-472` — `sessions.visibility` configuration schema with JSDoc describing each level
   - Sandboxed sessions default to "tree" visibility (self + spawned only, clamped at line 42)

   **Controls cross-session access** with configurable visibility levels. Prevents sandboxed sessions from accessing arbitrary other sessions. Relevant to **Audit 2 Claim 5**.

6. **`d95be2c38`** — **fix: preserve sandbox allow-all semantics**

   Fixes a regression where empty sandbox tool allowlist was interpreted as "allow nothing" instead of "allow all":

   - `src/agents/sandbox/tool-policy.ts:91-98` — guards image-tool injection with `expandedAllow.length > 0` (line 94) to preserve allow-all semantics when allowlist is empty

   **Preserves security semantics** — an empty allowlist means "allow everything", not "allow nothing". Prevents accidental denial-of-service in sandboxed sessions. Relevant to **Audit 2 Claim 1** (config injection).

7. **`6957354d4`** — **fix (telegram/whatsapp): use account-scoped pairing allowlists**

   Propagates account-scoped pairing allowlists to Telegram/WhatsApp message handlers:

   - `src/telegram/bot-handlers.ts` — multiple handler updates propagating `accountId` through pairing flows (lines 48, 175, 233, 268, 321, 341)
   - `src/telegram/bot-message-context.ts` — `accountId` threaded through context at multiple call sites (lines 151, 172, 276, 508, 754)
   - `src/web/inbound/access-control.ts` — account-scoped allowlist lookup via `accountId` (lines 39, 46, 93)

   **Completes account isolation** from `ee10feb80` by ensuring all messaging channels use account-scoped pairing lookups. Relevant to **Audit 2 Claim 5**.

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `d19b74692` | feat(skills): add cross-platform install fallback | 5 prod + 3 test | Adds fallback for non-brew environments using same safe-path mechanisms. |
| `b6305e972` | test(skills): split installer security coverage | 5 test | Test-only refactoring for installer security. |
| `799049f58` | fix (agents/sandbox): clarify container-vs-host workspace paths in prompt | 1 prod + 1 test | Improves prompt clarity, reduces confusion risk. |
| `1a03aad24` | refactor(sessions): split access and resolution helpers | 5 prod + 2 test | Refactoring that maintains security semantics. |
| `053affffe` | fix(cron): pass agent-level skill filter to isolated cron sessions | 1 prod + 1 test | Enforces skill restrictions in isolated cron sessions. |
| (68 others) | Tests, perf improvements, Discord UI, memory fixes | ~140 prod + ~75 test | No security boundary changes. |

### Audit Cross-Reference

| Audit Claim | Commits | Status |
|-------------|---------|--------|
| Audit 1 Claim 6 (Path traversal in agent dirs) | `2363e1b08` | **STRENGTHENED** — new safe-path validation prevents skill download traversal |
| Audit 1 Claim 7 (Webhook signature bypass) | `beb77229c` | **STRENGTHENED** — LINE webhook now fails closed when credentials missing |
| Audit 2 Claim 5 (Self-approving agent) | `ee10feb80`, `c6c53437f`, `6957354d4` | **STRENGTHENED** — account-scoped pairing and session visibility controls |
| Gap 3 (outPath validation) | `2363e1b08` | **STRENGTHENED** — path validation in skill download targets |

**Unaffected Claims:** Audit 1 Claims 1-5, 8; Audit 2 Claims 1-4, 6-8; Gap 1 (closed), Gap 2.

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
