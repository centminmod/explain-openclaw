> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 15 sync 12) — 80 upstream commits

**Merge commit:** `8181f51db` | **Range:** `ff9629add..8181f51db` | **78 non-merge commits** (31 flagged, 47 safe)

**Security relevance: LOW** — 5 security-adjacent commits. No direct audit claim overlap. Primary changes: file-lock refactor to plugin-sdk, exec approval timeout centralization, workspace bootstrap onboarding state persistence, exec notification token bloat reduction, LINE webhook handler extraction with shared verification.

### Security-Adjacent Commits (5)

| Severity | Commit | Description |
|----------|--------|-------------|
| **LOW** | `52bfe5060` | **File-lock refactor to plugin-sdk:** Implementation moved from `src/infra/file-lock.ts` to `src/plugin-sdk/file-lock.ts` (192 lines). Original file now re-exports types and functions. Security behavior unchanged — PID-based stale lock detection, atomic file operations preserved. Used for credential file locking. |
| **LOW** | `ea0ef1870` | **Centralize exec approval timeout:** New `DEFAULT_EXEC_APPROVAL_TIMEOUT_MS = 120_000` constant at `src/infra/exec-approvals.ts:85`. Centralizes previously scattered timeout values. Defense-in-depth for approval flow consistency. |
| **LOW** | `28b78b25b` | **Persist bootstrap onboarding state:** New `workspace-state.json` tracking via `resolveWorkspaceStatePath()` at `src/agents/workspace.ts:143`, `readWorkspaceOnboardingState()` at `:186-202`, `writeWorkspaceOnboardingState()` at `:204-218`. Records which bootstrap files have been acknowledged. Causes +122 line shift in `workspace.ts` affecting `loadWorkspaceBootstrapFiles()` (278-332 → 400-454) and `filterBootstrapFilesForSession()` (336-344 → 458-466). |
| **LOW** | `dec685970` | **Reduce prompt token bloat in exec notifications:** New `compactNotifyOutput()` at `src/agents/bash-tools.exec-runtime.ts:218-230` truncates pending exec output. `DEFAULT_PENDING_MAX_OUTPUT` reduced from 200,000 to 30,000 chars at `:117`. Reduces context window consumption from long-running commands. |
| **LOW** | `2493455f0` | **Extract LINE webhook handler:** New `src/line/webhook-node.ts` (129 lines) with `createLineNodeWebhookHandler()` and `src/line/webhook-utils.ts` with shared `parseLineWebhookBody()` and `isLineWebhookVerificationRequest()`. Extracts webhook handling from monolithic file into focused modules. Shared verification logic improves consistency — relates to Audit 1 Claim 7 (webhook signature verification) defense-in-depth. |

### Non-Security Commits (73)

73 commits covering: test infrastructure refactoring (test suite consolidation, mock improvements), CI/pipeline optimizations, Slack/Discord/Telegram provider improvements, documentation and changelog updates, dependency version bumps, performance improvements, UI/UX refinements, and new provider features. No security-relevant behavioral changes.

### Line Number Shifts

| File | Old Reference | New Reference | Cause |
|------|--------------|---------------|-------|
| `src/agents/bash-tools.exec.ts` | `:298` (validateHostEnv) | `:300` | +2 lines from new ExecToolDefaults fields |
| `src/agents/bash-tools.exec.ts` | `:301` (mergedEnv) | `:303` | Same cause |
| `src/agents/workspace.ts` | `:278-332` (loadWorkspaceBootstrapFiles) | `:400-454` | +122 lines from onboarding state management |
| `src/agents/workspace.ts` | `:336-344` (filterBootstrapFilesForSession) | `:458-466` | Same cause |
| `src/memory/qmd-manager.ts` | `:346-353` (readFile .md check + symlink) | `:355-371` | +9 lines from expanded validation logic |
| `src/agents/pi-embedded-helpers/bootstrap.ts` | `:84` (DEFAULT_BOOTSTRAP_MAX_CHARS) | `:85` | +1 line from new totalMaxChars constant |
| `src/agents/pi-embedded-helpers/bootstrap.ts` | `:162-191` (buildBootstrapContextFiles) | `:187-239` | +25 lines from totalMaxChars budget logic |
| `src/agents/bootstrap-files.ts` | `:21-60` (resolveBootstrapFilesForRun) | `:25-66` | +4 lines from expanded function |

All shifts verified via `grep -n` against current source.

### Audit Cross-Reference

No audit claims directly addressed by commits in this sync. Commit `2493455f0` (LINE webhook extraction) provides defense-in-depth for Audit 1 Claim 7 (webhook signature verification) through improved code organization of verification logic.

### CVE/GHSA Status

No new advisories published. All 30+ existing advisories remain documented in [Official Security Advisories](../official-security-advisories.md).

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
