> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status) | [Official Security Advisories](../official-security-advisories.md)

## Feb 20 sync 5 (39 commits)

**Merge commit:** ca2b9a2c8 | **Range:** 469e24563..083298ab9

### Security-Relevant Commits (6)

| SHA | Message | Files | Audit Cross-Ref |
|-----|---------|-------|-----------------|
| `ee519086f` | Feature/default messenger delivery target (openclaw#16985) | 25 prod + 1 test + 1 doc | Operator-controlled `defaultTo` field — minimal format validation |
| `dece0fa14` | fix: add customBindHost to gateway config validation (openclaw#20318) | 1 prod + 1 doc | Schema gap closure — +1 line shift in zod-schema.ts |
| `c1ac37a64` | Config: expose Pi compaction tuning values (openclaw#21568) | 5 prod + 2 test + 1 doc | Integer bounds enforcement for compaction tuning |
| `29ad0736f` | fix(gateway): tolerate legacy paired metadata in ws upgrade checks (#21447) | 1 prod + 1 test + 1 doc | **ESCALATED** — conditional auth bypass for legacy paired devices |
| `525d6e067` | Gateway: align pairing scope checks for read access | 4 prod + 4 test | **ESCALATED** — Audit 2 Claim 5 (RBAC): operator scope hierarchy via `roleScopesAllow()` |
| `38b4fb5d5` | fix(auth/session): preserve override reset behavior and repair oauth profile-id drift (openclaw#18820) | 11 prod + 4 test + 1 doc | **ESCALATED** — Audit 1 Claims 1, 4: OAuth profile-id drift repair |

### Commit Details

1. **`ee519086f`** — **NEW FEATURE** Default messenger delivery target.
   - `src/config/zod-schema.providers-core.ts:117` — `defaultTo` in `TelegramAccountSchemaBase`
   - `src/config/zod-schema.providers-core.ts:344` — `defaultTo` in `DiscordAccountSchema`
   - `src/config/zod-schema.providers-whatsapp.ts:44` — `defaultTo` in `WhatsAppSharedSchema`
   - `src/infra/outbound/targets.ts` — `resolveOutboundTarget()` falls back to per-channel `resolveDefaultTo` resolver when no explicit `to` target is provided

   **Security implications:**
   - Operator-controlled field with `z.string().optional()` only — no hostname, phone, or ID format validation applied
   - A misconfigured `defaultTo` silently routes all unaddressed invocations to the wrong recipient
   - Telegram schema accepts `string|number`; no type coercion guard beyond the optional string constraint

2. **`dece0fa14`** — **HARDENING** `customBindHost` added to Zod schema.
   - `src/config/zod-schema.ts:407` — `customBindHost: z.string().optional()` added to gateway object
   - Closes schema gap: field was used at runtime but not declared, so `.strict()` (at line 666) would reject configs using it
   - Single-line insertion shifts all lines below position 407 by +1; stale refs updated in this sync across 5 doc files

3. **`c1ac37a64`** — **HARDENING** Pi compaction tuning exposed with bounds enforcement.
   - `src/config/zod-schema.agent-defaults.ts:94` — `reserveTokens: z.number().int().nonnegative()`
   - `src/config/zod-schema.agent-defaults.ts:95` — `keepRecentTokens: z.number().int().positive()`
   - `src/agents/pi-settings.ts:56` — `applyPiCompactionSettingsFromConfig()` replaces two-call pattern
   - Runtime helpers `toNonNegativeInt`/`toPositiveInt` with finiteness guards and `Math.floor()` truncation prevent integer overflow

4. **`29ad0736f`** — **ESCALATED** Legacy paired device bypass in WS upgrade checks.
   - `src/gateway/server/ws-connection/message-handler.ts:715` — `hasLegacyPairedMetadata = paired.roles === undefined && paired.scopes === undefined`
   - `src/gateway/server/ws-connection/message-handler.ts:722` — `if (!hasLegacyPairedMetadata)` skips ALL role-upgrade and scope-upgrade enforcement for the connection

   **Security implications:**
   - Any device whose pairing record has both `roles: undefined` AND `scopes: undefined` bypasses role and scope upgrade enforcement during WS connections
   - Intended regression fix for devices paired before roles/scopes metadata was introduced
   - Bypass condition is broad: a device presenting a minimal pairing record (no roles, no scopes) triggers this path
   - Mitigating factor: reaching the WS upgrade handler requires a valid initial pairing token; this bypass only affects the upgrade enforcement step

5. **`525d6e067`** — **ESCALATED** Operator scope hierarchy via `roleScopesAllow()`.
   - `src/shared/operator-scope-compat.ts:28` — `roleScopesAllow()` exported (**NEW FILE**, 46 lines)
   - `src/infra/device-pairing.ts:404` — replaces removed local scopesAllow() with `roleScopesAllow()` for upgrade-check path
   - `src/infra/device-pairing.ts:435` — `roleScopesAllow()` for existing scope validation
   - `src/gateway/server/ws-connection/message-handler.ts:747` — `roleScopesAllow()` for scope check in WS handler

   **Security implications:**
   - `operator.read` is now satisfied by `operator.write` OR `operator.admin` — operator role uses hierarchical coverage
   - Non-operator roles still require exact scope match (no hierarchy)
   - Scope hierarchy aligns with principle of least privilege for read access: write and admin implicitly grant read
   - Relates to **Audit 2 Claim 5** (Self-approving agent / RBAC) — scope check correctness strengthened

6. **`38b4fb5d5`** — **ESCALATED** OAuth profile-id drift repair.
   - `src/agents/auth-profiles/order.ts:40` — `isValidProfile()` helper validates: credential exists, provider matches, auth mode compatible, token non-expired
   - `src/agents/auth-profiles/order.ts:87` — `allBaseProfilesMissing = baseOrder.every((profileId) => !store.profiles[profileId])`
   - `src/agents/auth-profiles/order.ts:88-90` — Fallback: scans all stored credentials for matching provider when all configured profile IDs are missing from auth store

   **Security implications:**
   - Repairs credential starvation from profile-id drift: misconfigured profile IDs in config no longer cause silent auth failure
   - Fallback filtered by `isValidProfile()` — expired tokens and wrong-provider credentials excluded from fallback results
   - `writeOAuthCredentials` refactored to return `profileId` (not void) — enables callers to track which profile received the write
   - Relates to **Audit 1 Claims 1, 4** (OAuth token storage, token refresh race) — correctness fix ensures valid credentials are always selected when available

### Non-Security Commits (33)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `10dab4f2c` | fix(anthropic): preserve pi-ai default betas when injecting anthropic-beta header (openclaw#19789) | 1 prod + 1 e2e test + 1 doc | Header injection correctness fix, no auth bypass |
| `14a3af212` | Format: align memory imports | 1 prod + 1 test | Import reformatting, no logic changes |
| `164d47865` | fix(cli): correct --verbose / -v option syntax in acp commands (#21303) | 3 prod + 4 test + 1 doc | CLI option syntax correction |
| `21448508a` | fix: Grok web_search extracts output_text blocks at top level (openclaw#20508) | 1 prod + 1 e2e test + 1 doc | Response parsing correctness fix |
| `5542a4362` | Memory: share ENOENT helpers | 6 prod + 4 test + 1 doc | Memory subsystem refactor — no auth changes |
| `57f0ac21e` | fix(heartbeat): constrain 24-hour sentinel to 24:00 only in regex (#21410) | 1 prod + 1 doc | Regex tightening — strictly more restrictive |
| `59e58bf81` | fix: strip unsupported JSON Schema keywords for Claude via Cloud Code Assist (openclaw#20124) | 1 prod + 1 e2e test + 1 doc | Schema sanitization correctness fix |
| `7b81383d4` | fix(signal): preserve case for Base64 group IDs in target normalization (openclaw#10623) | 1 prod + 1 test + 1 doc | Outbound policy correctness fix |
| `86f207adb` | fix: clean tool schemas and thinking blocks for google-antigravity (openclaw#19732) | 1 prod + 1 test + 1 doc | Strips thinking blocks before sending to provider |
| `8f80e2a46` | fix(macos): set release bundle ID so Sparkle auto-update works (#19750) | 1 prod script + 1 doc | Bundle ID fix for Sparkle signature verification |
| `aa3c8f732` | CLI: recover devices commands via local pairing fallback | 1 prod + 1 test | CLI-side fallback; gateway enforces auth boundary |
| `ab256b8ec` | fix: split telegram reasoning and answer draft streams (#20774) | 3 prod + 3 test + 1 doc | Telegram stream handler refactor |
| `ae4907ce6` | fix(heartbeat): return false for zero-width active-hours window (#21408) | 2 prod + 1 test + 1 doc | Scheduling edge case fix |
| `beb2b74b5` | fix(telegram): prevent silent message loss across all streamMode settings (#19041) | 3 prod + 1 test + 1 doc | Message delivery reliability fix |
| `cf4ffff3e` | fix(heartbeat): run when HEARTBEAT.md is missing | 2 prod + 1 test | Heartbeat scheduling behavior fix |
| `d6fbed790` | fix: prevent whatsapp fallback for webchat sessions | 1 prod | Channel isolation fix — positive enforcement |
| `d871ee91d` | fix(config-cli): correct misleading --json flag description (#21332) | 2 prod + 1 test + 1 doc | Description correction, no behavior change |
| `d9e46028f` | fix(cron/whatsapp): route implicit delivery to allowlisted recipients (openclaw#21533) | 3 prod + 2 test + 1 doc | Allowlist enforcement for cron WhatsApp delivery |
| `e321f21da` | fix: serialize tool result delivery to preserve message ordering (#21231) | 2 prod + 1 test | Concurrency/ordering fix |
| `ec4198954` | Memory: harden readFile ENOENT handling | 1 prod + 2 test | Defensive error handling |
| `f1e1cc4ee` | feat: surface cached token counts in /status output (openclaw#21248) | 5 prod + 12 test + 1 doc | Token count observability — non-sensitive |
| `f3f47886b` | fix(memory): handle ENOENT gracefully in readFile instead of throwing | 1 prod + 1 test | Defensive error handling |
| `f91034aa6` | fix(auth): clear all usage stats fields in clearAuthProfileCooldown (openclaw#19211) | 1 prod + 1 test + 1 doc | Cooldown state correctness fix |
| `083298ab9` | fix: memory ENOENT handling (#20680) (thanks @pahdo) | 1 doc | Changelog entry only (safe) |
| `99db4c790` | Changelog: document pairing bootstrap recovery (#21616) | 1 doc | Changelog only (safe) |
| `14618af23` | chore: bump Pi SDK packages to 0.54.0 (openclaw#21578) | 2 prod + 1 doc | SDK dependency bump (safe) |
| `cbcc75f6c` | Add Claude Sonnet 4.6 and 4.5 to GitHub Copilot model catalog (openclaw#20270) | 1 prod + 1 test + 1 doc | Model catalog update (safe) |
| `db8ffb13f` | fix: prevent whatsapp fallback for webchat sessions (#21534) (thanks @lbo728) | 1 doc | Changelog entry for d6fbed790 (safe) |
| `a87b5fb00` | (feat): MMR and temporal decay / bring back schema changes (openclaw#18786) | 2 prod + 1 doc | Memory relevance/schema changes (safe) |
| `9264a8e21` | chore: move skills to maintainers repository | 6 prod + 10 doc | Skills maintenance migration (safe) |
| `399781aac` | fix: remove duplicate comment in orderProfilesByMode (#21409) | 1 prod | Comment deduplication (safe) |
| `ffa7de046` | chore: add CHANGELOG entry | 1 doc | Changelog only (safe) |
| `6bc982473` | docs: update clawtributors for PR #21447 | 1 doc | Credits update (safe) |

### New CVEs/GHSAs (Feb 20 Batch)

Four new security advisories published 2026-02-20, all patched in v2026.2.18.

| GHSA | Severity | Summary | Patched |
|------|----------|---------|---------|
| [GHSA-r6h2-5gqq-v5v6](https://github.com/advisories/GHSA-r6h2-5gqq-v5v6) | LOW | OC-22: Skill packaging may follow symlinks | v2026.2.18 |
| [GHSA-wh94-p5m6-mr7j](https://github.com/advisories/GHSA-wh94-p5m6-mr7j) | MEDIUM | Discord moderation from untrusted sender | v2026.2.18 |
| [GHSA-cxpw-2g23-2vgw](https://github.com/advisories/GHSA-cxpw-2g23-2vgw) | LOW | OC-53: ACP prompt-size validation missing | v2026.2.18 |
| [GHSA-w45g-5746-x9fp](https://github.com/advisories/GHSA-w45g-5746-x9fp) | MEDIUM | Cron webhook SSRF | v2026.2.18 |

Added to [Official Security Advisories](../official-security-advisories.md) with full detail sections.

### Feature Changes (Phase 5c)

| SHA | Message | Documentation Impact |
|-----|---------|---------------------|
| `f1e1cc4ee` | feat: surface cached token counts in /status output (openclaw#21248) | Token count fields added to `/status` API response |
| `ee519086f` | Feature/default messenger delivery target (openclaw#16985) | `defaultTo` config field added to all messenger channel schemas |

> These feature changes are flagged for `align-docs-upstream` — no immediate hardening action required here.

### Audit Cross-Reference

| Claim/Gap | Status |
|-----------|--------|
| **Audit 1 Claim 1** (OAuth token storage) | **STRENGTHENED** — 38b4fb5d5 repairs profile-id drift; valid credentials always found when available |
| **Audit 1 Claim 4** (Token refresh race) | **PARTIALLY ADDRESSED** — 38b4fb5d5 ensures correct profile selection before refresh |
| **Audit 2 Claim 5** (Self-approving agent / RBAC) | **STRENGTHENED** — 525d6e067 establishes operator scope hierarchy via `roleScopesAllow()` |
| **Gap 1** (Gateway-side env var blocklist) | Not affected |
| **Gap 2** (Pipe-delimited token format) | Not affected |
| **Gap 3** (outPath validation) | Not affected |

---

*[Legitimate Gaps status](../post-merge-hardening.md#legitimate-gaps-status) — no gaps closed this sync.*
