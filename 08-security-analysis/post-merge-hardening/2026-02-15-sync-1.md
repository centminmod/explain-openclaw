> **Navigation:** [Post-merge Hardening Index](../post-merge-hardening.md) | [Main Guide](../../README.md)

# Post-Merge Hardening — Feb 15 sync 1 (38 commits)

**Merge commit:** `066650047` — Merge upstream openclaw/main (Feb 15 sync 1)
**Parent range:** `0c3389dbf..1ba266a8e`

## Security-Relevant Commits

### 1. Gateway Node Invoke Approval Hardening Chain (4 commits)

- `0af76f5f0` — refactor(gateway): centralize node.invoke param sanitization
- `c15946274` — fix(gateway): allowlist system.run params
- `a7af646fd` — fix(gateway): bind approval ids to device identity
- `318379cdb` — fix(gateway): bind system.run approvals to exec approvals

**Files (15 unique across chain):** `src/gateway/node-invoke-sanitize.ts` (NEW), `src/gateway/node-invoke-system-run-approval.ts` (NEW — 237 lines), `src/gateway/server-methods/nodes.ts`, `src/gateway/server-methods/exec-approval.ts`, `src/gateway/server-methods/types.ts`, `src/gateway/exec-approval-manager.ts`, `src/gateway/server-broadcast.ts`, `src/gateway/server.node-invoke-approval-bypass.e2e.test.ts` (NEW), `src/gateway/protocol/schema/snapshot.ts`, `CHANGELOG.md`

**Security relevance: CRITICAL.** Addresses **GHSA-gv46-4xfq-jv58** (Remote Code Execution via Node Invoke Approval Bypass). Before this chain, a gateway client with `operator.write` scope could inject `approved: true` and `approvalDecision: "allow-once"` into `node.invoke` params for `system.run`, bypassing the node-host approval flow entirely.

**Fix mechanism:**
1. **Param sanitization** (`node-invoke-sanitize.ts`): Entry point that routes commands to command-specific sanitizers. Only `system.run` currently receives special handling; all other commands pass through.
2. **Allowlist-based field stripping** (`pickSystemRunParams()` at `node-invoke-system-run-approval.ts:88-108`): Only forwards known fields (`command`, `rawCommand`, `cwd`, `env`, `timeoutMs`, `needsScreenRecording`, `agentId`, `sessionKey`, `runId`). Control fields (`approved`, `approvalDecision`) are always stripped from user input.
3. **Device identity binding** (`node-invoke-system-run-approval.ts:177-198`): Approval IDs are now bound to `client.connect.device.id` (stable across reconnects) with fallback to `connId`. Cross-device approval replay is rejected with `APPROVAL_DEVICE_MISMATCH`.
4. **Full request matching** (`approvalMatchesRequest()` at `:57-86`): Validates that the approval record matches the current request on command text, cwd, agentId, and sessionKey.
5. **Scope enforcement** (`clientHasApprovals()` at `:38-41`): Only clients with `operator.admin` or `operator.approvals` scopes can use timed-out approval fallback.

### 2. Sandbox Bridge Auth Enforcement (3 commits)

- `af50b914a` — refactor(browser): centralize http auth
- `4711a943e` — fix(browser): authenticate sandbox browser bridge server
- `6dd6bce99` — fix(security): enforce sandbox bridge auth

**Files (14 unique):** `src/browser/bridge-auth-registry.ts` (NEW), `src/browser/http-auth.ts` (NEW), `src/browser/control-auth.ts` (NEW — test), `src/browser/bridge-server.ts`, `src/browser/server.ts`, `src/browser/client-fetch.ts`, `src/agents/sandbox/browser.ts`, `src/agents/sandbox/browser-bridges.ts`, `src/agents/sandbox/context.ts`, plus tests

**Security relevance: HIGH.** Addresses tracked issue **#6609** (browser bridge server optional authentication). Previously, `startBrowserBridgeServer()` was called without `authToken` from the sandbox browser setup, meaning the bridge server had no authentication on its ephemeral loopback port.

**Fix mechanism:**
1. **Centralized HTTP auth** (`http-auth.ts`): `isAuthorizedBrowserRequest()` validates Bearer tokens via `safeEqualSecret()` (timing-safe) and supports Basic auth + `x-openclaw-password` header. Extracted from previously inline auth checks in `server.ts`.
2. **Bridge auth registry** (`bridge-auth-registry.ts`): In-process Map keyed by port for loopback bridge servers with ephemeral ports. `setBridgeAuthForPort()`/`getBridgeAuthForPort()`/`deleteBridgeAuthForPort()` with input validation.
3. **Client-fetch integration** (`client-fetch.ts`): `getBridgeAuthForPort()` lookup injects auth headers into outbound requests to bridge servers.
4. **Sandbox browser** (`sandbox/browser.ts:215-225`): `startBrowserBridgeServer()` now receives `authToken` and `authPassword` parameters.
5. **Browser server restructure** (`server.ts`): 65 lines deleted — auth logic extracted to `control-auth.ts` and `http-auth.ts`, reducing the file from ~166 to ~154 lines.

### 3. Dangerous Tool Centralization + Audit Warning (2 commits)

- `233483d2b` — refactor(security): centralize dangerous tool lists
- `539689a2f` — feat(security): warn when gateway.tools.allow re-enables dangerous HTTP tools

**Files (6):** `src/security/dangerous-tools.ts` (NEW), `src/security/audit.ts`, `src/security/audit-extra.sync.ts`, `src/gateway/tools-invoke-http.ts`, `src/acp/client.ts`

**Security relevance: HIGH.** Addresses **GHSA-943q-mwmv-hhvh** (Gateway /tools/invoke tool escalation + ACP permission auto-approval).

**Fix mechanism:**
1. **Centralized constants** (`dangerous-tools.ts`): `DEFAULT_GATEWAY_HTTP_TOOL_DENY` = `["sessions_spawn", "sessions_send", "gateway", "whatsapp_login"]` — tools denied over HTTP by default because they enable RCE/session orchestration. `DANGEROUS_ACP_TOOLS` = 10 mutating tools that always require explicit approval over ACP.
2. **Audit warning** (`audit.ts:271-293`): New `gateway.tools_invoke_http.dangerous_allow` check. If `gateway.tools.allow` includes any of the default-denied tools, severity escalates to "critical" when the gateway is non-loopback or Tailscale-funnel-exposed.
3. **ACP client** (`acp/client.ts`): Uses `DANGEROUS_ACP_TOOLS` set for permission prompting instead of inline lists, preventing drift.

### 4. Trusted-Proxy Auth Mode (1 commit — largest in batch)

- `1fb52b4d7` — feat(gateway): add trusted-proxy auth mode (#15940)

**Files (28):** `src/gateway/auth.ts` (+116 lines), `src/gateway/net.ts` (+55 lines), `src/gateway/server-runtime-config.ts`, `src/gateway/session-utils.ts`, `src/gateway/session-utils.fs.ts` (NEW), `src/config/types.gateway.ts` (+32 lines), `src/config/zod-schema.ts` (+21 lines), `docs/gateway/trusted-proxy-auth.md` (NEW), plus 20 test/config files

**Security relevance: HIGH.** New `"trusted-proxy"` auth mode that delegates authentication to a reverse proxy (Pomerium, Caddy, nginx). The gateway trusts user identity from a configurable header (`gateway.auth.trustedProxy.userHeader`).

**Key security controls:**
1. **Runtime validation** (`server-runtime-config.ts:99-103`): Trusted-proxy mode is the only exception to the "no auth = refuse non-loopback bind" rule. Must have `trustedProxies` configured.
2. **Proxy IP enforcement** (`auth.ts`): Requests only accepted from IPs in `gateway.trustedProxies`. Non-proxy requests are rejected.
3. **Audit checks** (`audit.ts:376-436`): Four new audit findings: trusted-proxy mode enabled (always critical — informational), no proxies configured (critical), missing userHeader (critical), no allowUsers (warn).
4. **Rate limiting exemption** (`audit.ts:438`): Trusted-proxy mode doesn't require gateway-side rate limiting (proxy handles it).

### 5. ACP Permission Hardening (2 commits)

- `153a7644e` — fix(acp): tighten safe kind inference
- `bb1c3dfe1` — fix(acp): prompt for non-read/search permissions

**Files (4):** `src/acp/client.ts`, `src/acp/client.test.ts`

**Security relevance: MEDIUM.** ACP (Automation Control Protocol) now requires explicit user approval for non-read/search permissions. The "safe kind" inference is tightened so fewer tool invocations are auto-approved.

### 6. Gateway HTTP Tool Deny Typing (1 commit)

- `a2b45e1c1` — fix(gateway): relax http tool deny typing

**Files (1):** `src/gateway/tools-invoke-http.ts`

**Security relevance: LOW-MEDIUM.** Relaxes TypeScript typing for the tool deny configuration to support the new centralized `DEFAULT_GATEWAY_HTTP_TOOL_DENY` constant. No behavioral change to security logic.

### 7. Test Coverage for Security Features (2 commits)

- `cd84885a4` — test(browser): cover bridge auth registry fallback
- `a7a08b665` — test(gateway): cover tools allow/deny precedence

**Security relevance: MEDIUM.** New test coverage for the security features introduced in this batch. The tools allow/deny test verifies precedence behavior when both `allow` and `deny` are configured.

## Non-Security Commits

| SHA | Message | Files |
|-----|---------|-------|
| `1ba266a8e` | refactor: split minimax-cn provider | 7 |
| `274da72c3` | Revert "fix: don't auto-create HEARTBEAT.md on workspace init" | 3 |
| `0cfea4629` | fix: wire minimax-api-key-cn onboarding | 8 |
| `9bb099736` | feat: add minimax-api-key-cn option for China API endpoint | 5 |
| `586176730` | perf(gateway): optimize sessions/ws/routing | 5 |
| `c90b3e4d5` | perf(cli): speed up startup | 8 |
| `eb4215d57` | perf(test): speed up Vitest bootstrap | 12 |
| `626a225c0` | docs: fix merge-pr comment variable expansion | 1 |
| `f8ba8f769` | fix(docs): update outdated hooks documentation URLs | 13 |
| `01d2ad205` | docs: harden maintainer and advisory workflow | 4 |
| `79e78cff3` | docs(changelog): thank reporter for ACP hardening | 1 |
| `9e24eee52` | docs(changelog): note audit warning for gateway tools override | 1 |
| `fba19fe94` | docs: link trusted-proxy auth from gateway docs | 4 |
| `3b56a6252` | chore!: remove moltbot legacy state/config support | 8 |
| `e21a7aad5` | docs: recommend loopback-only gateway bind | 1 |
| `3a330e681` | fix(feishu): remove typing indicator on NO_REPLY cleanup | 2 |
| `6182d3ef8` | test: increase live-model retry token budget | 1 |
| `7b39543e8` | fix(reply): honour explicit [[reply_to_*]] tags when replyToMode is off | 6 |
| `9475791d9` | fix: update remaining replyToMode "first" defaults to "off" | 3 |
| `c17a109da` | fix: align extension plugin and docs with new replyToMode default | 2 |
| `ad96c126e` | fix(telegram): change default replyToMode from "first" to "off" | 1 |
| `4c79a63eb` | fix: default QMD search mode | 1 |
| `e38ed4f64` | fix(memory): default qmd searchMode to search + scope search/vsearch to collections | 5 |

## Commit Chains

**Gateway approval hardening** (same author, overlapping files):
`0af76f5f0` → `c15946274` → `a7af646fd` → `318379cdb` — shared files: `node-invoke-system-run-approval.ts`, `server-methods/nodes.ts`, `server.node-invoke-approval-bypass.e2e.test.ts`

## Line Number Shifts

**`src/gateway/net.ts`** — +55 lines (trusted-proxy support added):
- `isTrustedProxyAddress()`: old `:142-148` → `:187-201`
- `resolveGatewayClientIp()`: old `:150-164` → `:203-217`
- `resolveGatewayBindHost()`: old `:197-247` → `:238-300`
- Silent 0.0.0.0 fallback: old `:203-208` → `:256-261`

**`src/gateway/auth.ts`** — +116 lines (trusted-proxy auth functions):
- `resolveTailscaleClientIp()`: old `:73-94` → `:78-99`
- `isLocalDirectRequest()`: old `:96-117` → `:101-122`

**`src/security/audit.ts`** — +104 lines (dangerous tools audit + trusted-proxy checks):
- Critical flag detection (dangerously*): old `:334-353` → `:343-363`
- `runSecurityAudit()`: old `:570+` → `:624-706`

**`src/config/zod-schema.ts`** — +21 lines (trusted-proxy schema):
- Top-level `.strict()`: old `:599-600` → `:635`

**`src/config/types.gateway.ts`** — +32 lines (trusted-proxy types):
- `trustedProxies` field: old `:243-247` → `:312`
- `dangerouslyDisableDeviceAuth`: `:73-77` — UNCHANGED

**`src/agents/workspace.ts`** — +10 lines:
- `loadWorkspaceBootstrapFiles()`: old `:276-330` → `:278-332`
- `filterBootstrapFilesForSession()`: old `:334-342` → `:336-344`

**`src/memory/backend-config.ts`** — +4 lines:
- `resolveDefaultCollections()`: old `:233-252` → `:235-254`

**`src/memory/qmd-manager.ts`** — +7 lines:
- Symlink/extension validation: old `:346-352` → `:346-353`

**`src/browser/server.ts`** — -65 lines (auth extracted to separate modules):
- Bind `127.0.0.1`: old `:133` → `:77`
- Auth middleware: old `:117-124` → extracted to `src/browser/control-auth.ts`

**`src/agents/sandbox/browser.ts`** — +31 lines:
- `startBrowserBridgeServer()` call: old `:192-200` → `:215-225`

**`src/agents/sandbox/context.ts`** — +20 lines:
- `workspaceAccess=rw`: old `:39-46` → `:42-49`

**`src/security/audit-extra.sync.ts`** — +41 lines:
- `collectSmallModelRiskFindings()`: old ~`:713-760` → `:805-894`

**`src/gateway/server-runtime-config.ts`** — +17 lines:
- Non-loopback auth requirement: old `:97-101` → `:99-103` (now exempts `authMode === "trusted-proxy"`)

## CVE/GHSA Coverage

This batch includes fixes for two GHSAs published Feb 14:

| GHSA | Severity | Summary | Fixed by |
|------|----------|---------|----------|
| [GHSA-gv46-4xfq-jv58](https://github.com/openclaw/openclaw/security/advisories/GHSA-gv46-4xfq-jv58) | CRITICAL | RCE via Node Invoke Approval Bypass | `0af76f5f0`, `c15946274`, `a7af646fd`, `318379cdb` |
| [GHSA-943q-mwmv-hhvh](https://github.com/openclaw/openclaw/security/advisories/GHSA-943q-mwmv-hhvh) | HIGH | Gateway /tools/invoke tool escalation + ACP auto-approval | `233483d2b`, `539689a2f`, `153a7644e`, `bb1c3dfe1` |

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation, bootstrap/memory .md scanning — unchanged). See [post-merge-hardening.md](../post-merge-hardening.md#legitimate-gaps-status).

## Phase Completion Self-Check

- [x] Phase 0: sync-upstream.sh merged 40 commits (38 non-merge + 2 merge)
- [x] Phase 0.5: Triage — 28 flagged, 10 safe, 0 promoted. 28+10=38 ✓
- [x] Phase 1: Parents verified via `git cat-file -p 066650047` — `0c3389dbf` and `1ba266a8e`. rev-list=38, log=38, analysis=38 ✓
- [x] Phase 2: Source references cataloged from explain-clawdbot/**/*.md and explain-clawdbot-opus-4.5/**/*.md
- [x] Phase 3: 16 doc-referenced source files confirmed changed in this range
- [x] Phase 4: Line numbers verified for all 15 shifted files via grep + read confirmation
- [x] Phase 5: All 38 commits analyzed — 7 security-relevant groups (deep), 23 non-security (summary table)
- [x] Phase 5b: Per-commit audit completed. 28 flagged + 10 safe = 38 = Phase 1 count ✓
- [x] Phase 5c: Commit chains identified (gateway approval: 4 commits, sandbox bridge: 3 commits)
- [x] Phase 6: Audit claims cross-referenced — no changes to Issue #1796 or Medium article verdicts
- [x] Phase 6c: CVE/GHSA check — 2 GHSAs fixed in this batch (GHSA-gv46-4xfq-jv58, GHSA-943q-mwmv-hhvh)
- [x] Phase 7: Line number references updated in documentation files
- [x] Phase 8: This self-check completed
