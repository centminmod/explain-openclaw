> **Navigation:** [Post-merge Hardening](../post-merge-hardening.md) | [Main Guide](../../README.md)

## Post-merge hardening notes (Feb 14, 2026 — sync 9, 71 commits)

**Merge commit:** `fb7f86c10` — "Merge upstream openclaw/main (Feb 14 sync 9)"
**Parent range:** `29988e166..bdc63b5b7` (71 commits)

### Commits in this merge

| SHA | Type | Summary |
|-----|------|---------|
| `207e2c5af` | fix | Add outbound delivery crash recovery (#15636) |
| `caebe70e9` | perf(test) | Cut setup/import overhead in hot suites |
| `93dd51bce` | perf(matrix) | Lazy-load music-metadata parsing |
| `ea95e88dd` | fix(cron) | Prevent duplicate delivery for isolated jobs with announce mode |
| `45a2cd55c` | fix | Harden isolated cron announce delivery fallback (#15739) |
| `b0728e605` | fix(cron) | Skip relay only for explicit delivery config, not legacy payload |
| `b8703546e` | docs(changelog) | Note cron delivered-relay regression coverage (#15737) |
| `ab4a08a82` | fix | Defer gateway restart until all replies are sent (#12970) |
| `874ff7089` | fix | Ensure CLI exits after command completion (#12906) |
| `ad57e561c` | refactor | Unify gateway restart deferral and dispatcher cleanup |
| `d5e25e0ad` | refactor | Centralize dispatcher lifecycle ownership |
| `51296e770` | feat(slack) | Land thread-ownership from @DarlingtonDeveloper (#15775) |
| `ab71fdf82` | feat | Plugin API: compaction/reset hooks, bootstrap file globs, memory plugin status (#13287) |
| `3bda3df72` | fix(browser) | Hot-reload profiles added after gateway start (#4841) (#8816) |
| `1055e71c4` | fix(telegram) | Auto-wrap .md file references in backticks to prevent URL previews (#8649) |
| `9bd2ccb01` | feat | Add pre-prompt context size diagnostic logging (openclaw#8930) |
| `3a73e2508` | perf(gateway) | Skip idle channel shutdown work |
| `a0cbf9002` | fix(models) | Antigravity opus 4.6 availability follow-up (#12845) |
| `cf2524b8b` | refactor(models) | Share auth helpers and forward-compat list fallbacks |
| `363a56ab8` | refactor(telegram) | Streamline file-ref wrapping and hoist regexes |
| `11702290f` | feat(ollama) | Add native /api/chat provider for streaming + tool calling (#11853) |
| `5378583da` | fix(discord) | Apply historyLimit to channel/group sessions to prevent compaction bypass (openclaw#11356) |
| `bc3eb9844` | fix(cli) | Avoid runtime import cycle in routed commands |
| `2f49d8858` | perf(cli) | Slim route-first bootstrap with lazy route handlers |
| `1c928e493` | fix(hooks) | Replace console logging with proper subsystem logging in loader (openclaw#11029) |
| `386bb0c61` | fix | Don't auto-create HEARTBEAT.md on workspace init (openclaw#12027) |
| `f9379ecee` | fix | Ignore up to 4 non-word characters when stripping HEARTBEAT_OK token (#15847) |
| `67b5c093b` | fix(auto-reply) | Allow image-only messages to reach the agent (openclaw#12352) |
| `fdacfc571` | fix(media) | Classify text/* MIME types as documents (openclaw#12341) |
| `28431b84c` | fix(gateway) | Prune expired entries instead of clearing all hook auth failure state (#15848) |
| `11ab1c693` | fix | Enforce Telegram 100-command limit with warning (#5787) (#15844) |
| `a4f4b0636` | fix | Preserve ${VAR} env var references when writing config back to disk (#11560) |
| `31d8546af` | fix(gateway) | Hide phantom main agent when agents.list is configured (openclaw#12364) |
| `7f0d6b1fc` | fix(heartbeat) | Exempt wake and hook reasons from empty-heartbeat skip (openclaw#14532) |
| `0942ecb54` | fix(cron) | Use job config for cleanup instead of hardcoded "keep" (openclaw#15427) |
| `d134c854a` | feat(config) | Expose full pi-ai model compat fields in config schema (openclaw#11063) |
| `87b31acbb` | feat | Add GLM-5 model support (#14352) (#15867) |
| `643288fda` | fix(cli) | Route logs to stderr during shell completion output (openclaw#15496) |
| `bdc63b5b7` | fix(macos) | Resolve dashboard basePath for local and remote (#15862) |
| `cc2249a43` | refactor(telegram) | Extract native command menu helpers |
| `e18f94a34` | refactor(config) | Simplify env snapshot write context |
| `4fdfa4261` | perf(test) | Silence config overwrite warnings in vitest |
| `54a242eaa` | perf(test) | Gate monitor runtime logs during vitest |
| `f86840f4d` | perf(cli) | Reduce read-only startup overhead |
| `9cb630ca7` | docs | Fix compaction config note |
| + 26 perf(test) commits | | Test suite optimizations (no production code changes) |

### Security-relevant changes

#### 1. Outbound delivery crash recovery (PR #15636) — `207e2c5af`

**Files:** `src/infra/outbound/deliver.ts` (new), `src/infra/outbound/delivery-queue.ts` (new), `src/gateway/server.impl.ts`

**What changed:**
- New durable delivery queue (`delivery-queue.ts`) persists outbound messages to disk before attempting delivery. If the process crashes mid-delivery, queued messages are recovered on restart.
- `deliver.ts` provides the delivery executor with retry logic.
- `server.impl.ts` integrates the delivery queue into gateway startup.

**Security assessment:** Availability improvement. Prevents message loss on process crash, which could have caused silent data loss (messages acknowledged to the user but never delivered). The disk persistence adds a small disk I/O surface but is confined to the existing config directory with 0o600 permissions. No new network surface.

#### 2. Gateway restart deferral (PR #12970) — `ab4a08a82`

**Files:** `src/gateway/server-reload-handlers.ts`, `src/gateway/server-restart-sentinel.ts`, `src/infra/restart-sentinel.ts`, `src/infra/restart.ts`, `src/auto-reply/reply/dispatcher-registry.ts` (new), `src/auto-reply/reply/reply-dispatcher.ts`, `src/config/sessions/delivery-info.ts` (new), + 12 more files

**What changed:**
- Gateway restart (from `config.apply`/`config.patch`) is now deferred until all in-flight replies complete, preventing mid-reply crashes.
- New `dispatcher-registry.ts` tracks active reply dispatchers so the restart handler knows when it's safe to proceed.
- New `delivery-info.ts` captures delivery context (channel, recipient, account) at restart time for post-restart reply routing.
- `restart-sentinel.ts` expanded with `deliveryContext` and `threadId` fields to preserve reply threading across restarts.

**Security assessment:** Reliability fix that also prevents a denial-of-service vector where rapid `config.apply` calls could interrupt active conversations. The dispatcher registry is process-internal only. Delivery context persisted to the restart sentinel file inherits existing 0o600 file permissions. No new external attack surface.

#### 3. Cron delivery hardening chain — `ea95e88dd`, `45a2cd55c`, `b0728e605`

**Files:** `src/cron/isolated-agent/run.ts`, `src/cron/service/state.ts`, `src/cron/service/timer.ts`

**What changed:**
- `ea95e88dd`: Prevents duplicate delivery when isolated cron jobs use announce mode — the announce handler now checks whether delivery was already performed by the job runner.
- `45a2cd55c`: Hardens the fallback delivery path for isolated cron agents — `bestEffortDeliver` now validates recipient presence before attempting delivery.
- `b0728e605`: Skips relay only for jobs with explicit delivery config, preventing legacy payload jobs from losing delivery.

**Security assessment:** Prevents unintended message duplication and ensures delivery integrity for scheduled jobs. Duplicate delivery could cause confusion or repeated action execution in downstream systems. No new surface — changes are to internal cron execution paths.

#### 4. Env var preservation in config writes (PR #11560) — `a4f4b0636`

**Files:** `src/config/env-preserve.ts` (new), `src/config/env-preserve-io.test.ts` (new), `src/config/env-preserve.test.ts` (new), `src/config/io.ts`, `src/config/config.ts`, `src/gateway/server-methods/config.ts`

**What changed:**
- New `env-preserve.ts` module tracks `${VAR}` references in the config file and restores them after JSON serialization, preventing config writes from resolving environment variables to their literal values.
- `io.ts` now captures an env-ref map on read and restores refs on write.
- Adds ~141 lines of new code for the env-preserve module.

**Security assessment:** Prevents a subtle config integrity issue where secrets referenced via `${API_KEY}` would be written out as literal values after any `config.apply`/`config.patch` operation. This could expose secrets in config file backups, git history, or config exports. The fix ensures env var references remain symbolic. Significant security improvement for credential hygiene.

#### 5. Hook auth failure state pruning (PR #15848) — `28431b84c`

**Files:** `src/gateway/server-http.ts`

**What changed:**
- Hook authentication failure tracking now prunes expired entries instead of clearing all failure state on any successful request. This prevents a timing attack where an attacker could clear failure state by making a single valid request between brute-force attempts.

**Security assessment:** Direct security hardening. The previous behavior reset the failure counter on success, meaning an attacker could alternate valid/invalid requests to bypass rate limiting. Now each entry has independent expiry.

#### 6. Discord compaction bypass fix (openclaw#11356) — `5378583da`

**Files:** `src/agents/pi-embedded-runner.ts`, `src/agents/pi-embedded-runner/history.ts`

**What changed:**
- `historyLimit` from provider config is now applied to channel/group sessions in Discord (not just DMs). Previously, channel sessions had no history limit, allowing unbounded context growth that bypassed the compaction system.

**Security assessment:** Prevents resource exhaustion through unbounded history accumulation in Discord group sessions. Without the limit, a busy group channel could accumulate unlimited history, eventually causing memory pressure or hitting API context limits. This aligns with the existing DM history limiting behavior.

#### 7. Plugin API expansion (PR #13287) — `ab71fdf82`

**Files:** `src/plugins/hooks.ts`, `src/plugins/types.ts`, `src/agents/pi-embedded-runner/compact.ts`, `src/agents/workspace.ts`, `src/hooks/bundled/bootstrap-extra-files/handler.ts` (new), + 7 more

**What changed:**
- New plugin hooks: `onCompaction` (fires when context is compacted), `onReset` (fires on session reset), `memoryStatus` (lets plugins report memory system status).
- `bootstrap-extra-files` bundled hook: plugins can now declare glob patterns for additional bootstrap files to inject into the system prompt.
- `workspace.ts` gains `loadExtraBootstrapFiles()` for plugin-declared bootstrap file loading.

**Security assessment:** Expands the plugin API surface area. The `bootstrap-extra-files` hook deserves attention — it allows plugins to inject arbitrary `.md` content into the system prompt via glob patterns. This follows the same trust model as existing bootstrap files (no content scanning, 20K char limit per file). Plugins are already fully trusted (in-process execution via jiti), so this doesn't create a new trust boundary violation, but it increases the volume of unscanned content that can enter the prompt. The `onCompaction`/`onReset` hooks are notification-only (no return value consumed by the system), limiting abuse potential.

#### 8. Ollama native provider (PR #11853) — `11702290f`

**Files:** `src/agents/ollama-stream.ts` (new, 419 lines), `src/agents/models-config.providers.ts`, `src/config/types.models.ts`, `src/config/zod-schema.core.ts`

**What changed:**
- New native Ollama `/api/chat` streaming provider with tool calling support, replacing the OpenAI-compatible adapter.
- Supports streaming responses, tool calls, and model-specific configuration.

**Security assessment:** New external service integration point. The Ollama provider connects to a local Ollama instance (default `http://localhost:11434`). Key considerations: (1) HTTP connection to local service is unencrypted — acceptable for localhost but not for remote Ollama instances; (2) tool calling results are sent to the local Ollama model, which processes them in-context; (3) the provider validates model names against Zod schema before use. No SSRF risk — the Ollama base URL is user-configured, not derived from model responses.

#### 9. Thread-ownership extension (PR #15775) — `51296e770`

**Files:** `extensions/thread-ownership/index.ts` (new, 133 lines), `src/channels/plugins/outbound/slack.ts`

**What changed:**
- New `thread-ownership` extension for Slack: only one agent instance responds per Slack thread (the first to claim it). Subsequent messages in the same thread are routed to the owning instance.
- `slack.ts` outbound channel plugin now checks thread ownership before sending.

**Security assessment:** Prevents thread hijacking in multi-instance Slack deployments where multiple OpenClaw instances monitor the same channel. The ownership claim is stored in-memory (no persistence across restarts). A restarted instance could re-claim threads, but this is a correctness issue, not a security vulnerability.

#### 10. Browser profile hot-reload (PR #8816) — `3bda3df72`

**Files:** `src/browser/server-context.ts`, `src/browser/control-service.ts`, `src/browser/server.ts`

**What changed:**
- Browser profiles added to the config after gateway start are now discovered and usable without a full gateway restart. Previously, only profiles present at startup were accessible.

**Security assessment:** Minor. The hot-reload scans the same config file that's already trusted. No new trust boundaries — profiles are still validated via the existing Zod schema.

#### 11. Telegram URL preview prevention (PR #8649) — `1055e71c4`

**Files:** `src/telegram/format.ts`, `src/telegram/bot/delivery.ts`

**What changed:**
- `.md` file references in Telegram messages are now auto-wrapped in backticks to prevent Telegram from generating URL previews. Previously, references like `MEMORY.md` could trigger Telegram's URL preview bot to fetch `memory.md` as a URL, leaking file references as network requests.

**Security assessment:** Privacy improvement. Prevents unintended information leakage through Telegram's URL preview system. File references in bot responses could have triggered outbound HTTP requests from Telegram servers to arbitrary domains matching the `.md` filename pattern.

#### 12. Subsystem logging in hooks loader (openclaw#11029) — `1c928e493`

**Files:** `src/hooks/loader.ts`

**What changed:**
- Replaced `console.log`/`console.error` calls with proper `createSubsystemLogger()` logging. Hook loading errors now go through the structured logging pipeline instead of raw console output.

**Security assessment:** Log hygiene improvement. Console output could bypass log rotation and structured log filtering, potentially exposing debug information in production environments. Now subject to the same redaction and rotation policies as all other logs.

#### 13. Phantom agent hiding (openclaw#12364) — `31d8546af`

**Files:** `src/gateway/session-utils.ts`

**What changed:**
- When `agents.list` is configured, the phantom "main" agent entry is now hidden from session utility functions. Previously, the main agent appeared in listings even when the operator had explicitly configured an agent allowlist.

**Security assessment:** Information disclosure fix. An operator restricting visible agents via `agents.list` would still see the main agent in session utilities, leaking information about the gateway's internal agent structure. Minor severity since agent names are not credentials.

#### 14. Image-only message routing (openclaw#12352) — `67b5c093b`

**Files:** `src/auto-reply/reply/get-reply-run.ts`

**What changed:**
- Image-only messages (no text body) are now correctly routed to the agent instead of being silently dropped. The media-only check now recognizes image attachments without accompanying text.

**Security assessment:** Correctness fix. Silent message dropping is a usability issue, not a security vulnerability. No new attack surface.

#### 15. MIME type classification fix (openclaw#12341) — `fdacfc571`

**Files:** `src/media/constants.ts`

**What changed:**
- `text/*` MIME types (e.g., `text/csv`, `text/plain`) are now classified as "document" instead of "unknown". This ensures proper size limits (100MB document cap vs no cap for unknown).

**Security assessment:** Ensures `text/*` uploads are subject to the document size limit. Previously, `text/*` files fell through to "unknown" which could bypass size validation depending on the handling path.

### Line number shifts

This merge includes ~6,900 new lines and ~4,100 deleted lines across 206 files. Major shifts affecting documentation references:

| File | Old line(s) | New line(s) | Shift | Cause |
|------|------------|------------|-------|-------|
| `src/config/io.ts` | `:273-290` (rotateConfigBackups) | `:291-310` | +18 | env-preserve module integration |
| `src/config/io.ts` | `:749` (0o600 writeFile) | `:852` | +103 | env-preserve + write context refactor |
| `src/config/io.ts` | `:766` (0o700 mkdir) | `:818` | +52 | env-preserve module integration |
| `src/agents/workspace.ts` | `:265-319` (loadWorkspaceBootstrapFiles) | `:276-330` | +11 | bootstrap-extra-files hook, new exports |
| `src/agents/workspace.ts` | `:323-331` (filterBootstrapFilesForSession) | `:334-342` | +11 | same |
| `src/agents/workspace.ts` | `:23-31` (file list) | `:30-31` | +7 | new type exports |
| `src/gateway/server.impl.ts` | `:107` (loopback default) | `:112` | +5 | new imports |
| `src/infra/restart-sentinel.ts` | `:30-46` (payload type) | `:30-48` | +2 | deliveryContext + threadId fields |
| `src/plugins/loader.ts` | `:211-296` (jiti load) | `:214-299` | +3 | minor restructure |
| `src/agents/tools/gateway-tool.ts` | `:175-225` (config.patch) | `:175-228` | +3 | minor expansion |
| `src/agents/pi-embedded-runner/history.ts` | `:15-36` (limitHistoryTurns) | `:15-36` | 0 | unchanged |
| `src/media/constants.ts` | `:1-4` (size limits) | `:1-4` | 0 | mediaKindFromMime added below |
| `src/cron/service/timer.ts` | `:422` (loop) | ~`:396-599` | file grew | runDueJobs/runMissedJobs restructured |

### New files

| File | Purpose |
|------|---------|
| `src/config/env-preserve.ts` | Env var reference preservation during config writes |
| `src/config/sessions/delivery-info.ts` | Delivery context capture for restart continuity |
| `src/infra/outbound/deliver.ts` | Outbound message delivery executor |
| `src/infra/outbound/delivery-queue.ts` | Durable delivery queue with crash recovery |
| `src/agents/ollama-stream.ts` | Native Ollama /api/chat streaming provider |
| `src/agents/model-forward-compat.ts` | Forward-compatible model listing fallbacks |
| `src/auto-reply/reply/dispatcher-registry.ts` | Active reply dispatcher tracking |
| `src/auto-reply/reply/get-reply-run.media-only.test.ts` | Media-only message routing tests |
| `src/cli/program/routes.ts` | Route-first CLI command dispatch |
| `src/cli/respawn-policy.ts` | CLI process respawn policy |
| `src/commands/provider-auth-helpers.ts` | Shared provider auth helpers |
| `src/commands/models/list.errors.ts` | Model list error types |
| `src/hooks/bundled/bootstrap-extra-files/handler.ts` | Plugin-declared bootstrap file loader |
| `src/telegram/bot-native-command-menu.ts` | Telegram command menu builder |
| `extensions/thread-ownership/index.ts` | Slack thread-ownership extension |

### Commit chain detection

Related commit chains touching the same subsystems:

1. **Cron delivery chain:** `207e2c5af` → `ea95e88dd` → `45a2cd55c` → `b0728e605` → `b8703546e` — progressive hardening of cron/outbound delivery
2. **Gateway restart chain:** `ab4a08a82` → `ad57e561c` → `d5e25e0ad` — unified restart deferral + dispatcher lifecycle
3. **Config write chain:** `a4f4b0636` → `e18f94a34` → `3bda3df72` — env-preserve + config I/O restructuring
4. **Models/forward-compat chain:** `a0cbf9002` → `cf2524b8b` → `d134c854a` → `87b31acbb` — model registry forward compat + GLM-5
5. **Telegram chain:** `11ab1c693` → `cc2249a43` → `1055e71c4` → `363a56ab8` — command menu + format hardening
6. **CLI startup chain:** `f86840f4d` → `4d1461011` → `2f49d8858` → `bc3eb9844` → `874ff7089` — route-first startup + exit fix

### CVE/GHSA check

No new CVEs or GHSAs published since last check. Existing advisories (GHSA-g55j-c2v4-pjcg, GHSA-r8g4-86fx-92mq) remain tracked in [official-security-advisories.md](../official-security-advisories.md).
