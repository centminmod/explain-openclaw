> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 16 sync 1 — 172 commits)

Merge SHA `c949780be` — 172 upstream commits (91064edba..1843bcf1d). 378 files changed, 13703 insertions, 8984 deletions. Triage: 84 initially flagged → 35 after Haiku triage (49 demotions). 15 security-relevant commits identified out of 35 deep-analyzed.

### Security-Relevant Commits (15)

1. **`191194236`** — Config redaction robustness: Case-insensitive sensitive field matching (`src/config/redact-snapshot.ts:304`) prevents `maxTokens`/`passwordFile` confusion in field detection. Addresses Audit 2 Claim 1 defense-in-depth.

2. **`fac040cb1`** — Status endpoint redaction: New `redactSensitiveStatusSummary()` (`src/commands/status.summary.ts:70-89`) strips session storage paths, model defaults, and session details from non-admin gateway clients. Addresses Audit 2 Claim 4 (info disclosure).

3. **`a45778238`** — Parameter validation hardening: Explicit type checking for `agentId`/`name` in gateway RPC (`src/gateway/server-methods/agents.ts:67-82`) prevents `Object.prototype.toString()` coercion bypass.

4. **`df95ddc77`** — Session key normalization: Normalizes agent session keys in spawn operations to prevent cross-session interference. Addresses Audit 1 Claim 5 (session isolation).

5. **`ade11ec89`** — Idempotency strengthening: Deterministic HMAC-SHA256 keys (`src/agents/subagent-announce.ts:177-207`) prevent duplicate subagent invocations via race conditions.

6. **`c211fd112`** — Model fallback enforcement: When `storedModelOverride` is set, passes explicit `fallbacksOverride ?? []` to prevent silent fallback to smaller-window models that could crash or enable context escape.

7. **`0931a3570`** — Null pointer guard: Guards `withSessionStoreLock()` against undefined `storePath` (`src/config/sessions/store.ts:208-213`) preventing crashes during session store initialization failure.

8. **`b8f66c260`** — Nested subagent orchestration (major): Implements spawn depth limits (`spawnDepth` tracking in session store), model fallback override enforcement, and cascade kill on parent failure. Addresses Audit 2 Claims 1, 5 (config injection, self-approval).

9. **`ef1f98ed6`** — OAuth credential parsing consolidation: Unified `readPortalCliOauthCredentials()` for Qwen/MiniMax portal OAuth tokens (`src/agents/cli-credentials.ts:220-270`). Strengthens Audit 1 Claims 1-4 (OAuth handling).

10. **`3d0e56800`** — JSONL socket communication centralization: Shared `requestJsonlSocket` module consolidates exec approval socket parsing with unified timeout/error handling. Addresses Audit 2 Claim 6 (token field shifting via pipe injection).

11. **`47462eed6`** — Shell environment setup consolidation: Unified env var handling for login shells enables future LD_* blocklist. Addresses Audit 2 Claims 7-8 (shell injection, LD_PRELOAD).

12. **`d7079b557`** — Tool policy decision centralization: New `src/security/audit-tool-policy.ts` module for sandbox policy verification. Supports Audit 1 Claim 7, Audit 2 Claim 5 (webhook bypass, RBAC).

13. **`7793f2efd`** — Pairing ACL update consolidation: Reduces duplication in `allowFrom` modifications (`src/pairing/pairing-store.ts:12-25, 42-45`), making authorization changes more auditable.

14. **`91c041e5d`** — AllowFrom normalization: Shared `safeChannelKey()` function (`src/pairing/pairing-store.ts:53-62`) ensures consistent address validation across ACL operations. Prevents ACL bypass via alternate address formats.

15. **`2fe16af3c`** — Agent file path resolution consolidation: Centralizes path validation for agent workspace files (`src/gateway/server-methods/agents.ts:60-89`). Addresses Audit 1 Claim 6 (path traversal).

### Audit Claims Impact

| Audit | Addressed | Not in Scope | Coverage |
|-------|-----------|--------------|----------|
| Issue #1796 (8 claims) | 7 | 1 (CSRF in OAuth state) | 87.5% |
| Medium article (8 claims) | 7 | 1 (outPath validation) | 87.5% |
| Legitimate gaps (3) | 2 | 1 (outPath in screen_record) | 66.7% |

### Line Number Shifts

| File | Old Range | New Range | Shift | Cause |
|------|-----------|-----------|-------|-------|
| `src/gateway/net.ts` | 238-300 | 258-318 | +20 | New helper functions added above resolveGatewayBindHost |
| `src/gateway/net.ts` (canBindToHost) | 309-322 | 328-340 | +19 | Same cause |
| `src/gateway/auth.ts` | 78-99 | 64-85 | -14 | Function reordering (headerValue helper moved up) |
| `src/gateway/auth.ts` (isLocalDirectRequest) | 101-122 | 87-108 | -14 | Same cause |
| `src/gateway/origin-check.ts` | 43-71 | 24-52 | -19 | parseOrigin helper moved into file, checkBrowserOrigin shifted up |
| `src/security/audit.ts` (dangerously* flags) | 343-363 | 347-367 | +4 | Tailscale serve finding added above |
| `src/security/audit.ts` (runSecurityAudit) | 624-706 | 605-687 | -19 | Probe auth extraction refactor |
| `src/commands/status.summary.ts` | 134-195 | 135-200 | +1/+5 | New redactSensitiveStatusSummary() added at line 70 |
| `src/config/sessions/store.ts` | 667,729,575 | 760,816,590 | +93/+87/+15 | Session store refactoring and pruning overhaul |
| `src/agents/subagent-announce.ts` (statsLine) | 479-506 | 545-559 | +66 | Announce idempotency and orchestration additions |

### 20 New Security Advisories

This sync coincides with a large batch of 20 new GitHub Security Advisories published Feb 15, 2026 (10 HIGH, 10 MEDIUM). All added to [official-security-advisories.md](../official-security-advisories.md). Key categories:
- **Path traversal** (3): Feishu LFI, sandbox skill mirroring, browser upload
- **DoS** (4): Media fetch, webhook body, base64 buffers, archive extraction
- **Auth bypass** (4): Telnyx webhook, Twilio voice, Google Chat cross-account, Telegram mutable usernames
- **CSRF/info disclosure** (3): Loopback browser CSRF, skills.status secrets, config secret persistence
- **Other** (6): macOS deep link truncation, discovery TXT routing, gatewayUrl override SSRF, iMessage cross-context, Tlon SSRF, hooks timing attack
