> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 16 sync 7) — 21 upstream commits

**Merge commit:** `35ab521e0` | **Range:** `69e2e49f3..35ab521e0`

**Security relevance: LOW** — 2 defensive improvements (plugin cache invalidation, schema tightening) across 4 production files. No audit claims affected. Remaining 19 commits are test suite consolidation and documentation. **LARGE REFACTOR:** 12,419 lines changed (6,170 insertions, 6,249 deletions) — predominantly test file merges.

### Security-Relevant Commits

| SHA | Message | Files | Notes |
|-----|---------|-------|-------|
| `bed0e0762` | fix(cli): clear plugin manifest cache after install | 2 production | Cache invalidation for plugin manifests |
| `bbcbabab7` | fix(ci): repair e2e mocks and tool schemas | 2 production + 7 test | Schema tightening for process tool timeout |

1. **Plugin manifest cache invalidation** (`bed0e0762`): Adds `clearPluginManifestRegistryCache()` export (`src/plugins/manifest-registry.ts:64`) and calls it after both plugin install paths (`src/cli/plugins-cli.ts:597`, `src/cli/plugins-cli.ts:648`). The manifest registry cache was warmed at CLI startup; without invalidation, `enablePluginInConfig()` config validation could see stale data and fail to validate a freshly installed plugin. Defensive fix — prevents stale cache from serving outdated plugin manifests after install.

2. **Process tool timeout schema tightening** (`bbcbabab7`): Changes `bash-tools.process.ts` timeout schema from `Type.Union([Type.Number(), Type.String()])` to strict `Type.Number({ minimum: 0 })` (`src/agents/bash-tools.process.ts:67-72`), rejecting string values and negative numbers. Also normalizes `sessions-spawn-tool.ts` timeout handling: adds back-compat comment for legacy `timeoutSeconds` parameter (line 31) and simplifies the timeout resolution logic (`src/agents/tools/sessions-spawn-tool.ts:48-58`) to use a single `timeoutSecondsCandidate` variable with `Number.isFinite()` validation. Test mocks updated to match new schemas.

### Non-Security Commits (19)

| SHA | Message | Files | Category |
|-----|---------|-------|----------|
| `d8d9d3724` | docs(agents): add GHSA patch/publish notes | 1 (AGENTS.md) | docs |
| `e3445f59c` | docs(changelog): note inter-session provenance security fix | 1 (CHANGELOG.md) | docs |
| `35ab521e0` | refactor(test): simplify voicewake env cleanup | 1 test | test refactor |
| `a68ed3f64` | refactor(test): reuse env snapshots in gateway call tests | 1 test | test refactor |
| `31980bcaf` | refactor(test): dedupe gateway env restores | 3 test + 1 test-helper | test refactor |
| `70f86e326` | refactor(test): reuse shared env snapshots | 3 test + 1 test-util | test refactor |
| `632b71c7f` | fix(test): avoid inheriting process.env in nix config e2e | 1 test | test fix |
| `eef13235a` | fix(test): make sessions_spawn e2e harness ordering stable | 3 test | test fix |
| `89155aa6c` | fix(test): load sessions_spawn harness before tools | 1 test | test fix |
| `0e2d8b8a1` | perf(test): consolidate channel action suites | 6 test | test consolidation |
| `c5288300a` | perf(test): consolidate reply flow suites | 5 test | test consolidation |
| `a7f6c9567` | perf(test): consolidate slack monitor suites | 7 test + 1 rename | test consolidation |
| `74294a465` | perf(test): consolidate web auto-reply suites | 5 test + 2 rename | test consolidation |
| `c59a472ca` | perf(test): consolidate memory tool e2e suites | 2 test + 1 rename | test consolidation |
| `722bfaa9c` | perf(test): consolidate reply plumbing/state suites | 8 test | test consolidation |
| `37086d0c3` | perf(test): consolidate sessions tool e2e suites | 5 test | test consolidation |
| `a1c50b4ee` | perf(test): consolidate channel plugin suites | 13 test | test consolidation |
| `d75cd4078` | perf(test): consolidate reply utility suites | 6 test | test consolidation |
| `34b088ede` | perf(test): consolidate infra outbound suites | 9 test | test consolidation |

Most changes are to test files. Two demoted commits touch test infrastructure files (`src/test-utils/env.ts` and `src/gateway/test-helpers.server.ts`) which are not `*.test.ts` but are test utilities — no production behavior changes.

### File Renames

| Old Path | New Path |
|----------|----------|
| `src/agents/tools/memory-tool.citations.e2e.test.ts` | `src/agents/tools/memory-tool.e2e.test.ts` |
| `src/slack/monitor/message-handler/prepare.inbound-contract.test.ts` | `src/slack/monitor/message-handler/prepare.test.ts` |
| `src/web/auto-reply/monitor/group-gating.test.ts` | `src/web/auto-reply/web-auto-reply-monitor.test.ts` |
| `src/web/auto-reply/mentions.test.ts` | `src/web/auto-reply/web-auto-reply-utils.test.ts` |

### Line Number Shifts

| File | Old | New | Context |
|------|-----|-----|---------|
| `src/cli/plugins-cli.ts` | 46-70 | 47-71 | `resolveFileNpmSpecToLocalPath()` function (+1 from new import at line 12) |

### Audit Cross-Reference

**Unaffected Claims:** None of the 16 audit claims (8 from Issue #1796 + 8 from Medium article) are affected by this batch. The plugin cache fix (`bed0e0762`) is supply-chain adjacent but does not address any specific audit finding. The timeout schema tightening (`bbcbabab7`) is input validation hardening but does not relate to any claimed vulnerability.

**Legitimate Gaps:** All 3 remaining gaps (pipe-delimited token format, outPath validation, bootstrap/memory .md scanning) are unaffected by this batch.

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
