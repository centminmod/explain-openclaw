> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 14 sync 7 (63 commits)

**Merge commit:** `6af19494a` | **Parents:** `29518deb8` (local) + `31537c669` (upstream) | **Range:** `29518deb8..31537c669`

Large merge: 304 files changed, 22,098 insertions, 57,029 deletions. Contains 4 security-relevant commits, 23 refactor commits (massive module extractions affecting security-referenced line numbers), 10 Matrix multi-account commits, 9 Discord gateway proxy/presence commits, and 17 other commits (CI, docs, tests, perf).

### HIGH (2)

- **`4225206f0`** (PR [#12846](https://github.com/openclaw/openclaw/pull/12846)) — **Normalize session key casing to prevent ghost sessions:** On case-sensitive filesystems (Linux), mixed-case session keys (`agent:ops:MySession` vs `agent:ops:mysession`) resolved to different store entries, creating ghost session duplicates that never converge. New `resolveSessionStoreKey()` lowercases all components. `loadSessionEntry()` returns `legacyKey` for migration. `resolveGatewaySessionStoreTarget()` scans for case-insensitive matches. `findStoreKeysIgnoreCase()` cleans all legacy variants on write paths. 8 files, +544/-76 lines. Tests: 5 new (session key normalization + gateway session store target). Thanks @mcaxtr.

- **`7f0489e47`** (PR [#15652](https://github.com/openclaw/openclaw/pull/15652)) — **Constrain browser trace and download output paths to OpenClaw temp roots:** Browser download and trace endpoints previously accepted arbitrary file paths without validation (tracked issue [#8516](https://github.com/openclaw/openclaw/issues/8516), [#8696](https://github.com/openclaw/openclaw/issues/8696)). New `src/browser/routes/path-output.ts` (28 lines) validates that output paths resolve within OpenClaw temp directories. Applied to POST `/download` (`src/browser/routes/agent.act.ts:447+`) and POST `/trace/stop` (`src/browser/routes/agent.debug.ts:119+`). 10 files, +166/-16 lines. Tests: 84+ new lines in agent contract tests. Thanks @mbelinky. **Addresses** tracked issues #8516 and #8696 (browser path traversal).

### MODERATE (2)

- **`d3b2135f8`** (PR [#13746](https://github.com/openclaw/openclaw/pull/13746)) — **Wait for agent idle before flushing pending tool results:** Race condition in pi-agent-core's auto-retry mechanism caused `flushPendingToolResults()` to fire while tools were still executing, inserting synthetic "missing tool result" errors and causing silent agent failures. New `waitForIdleBeforeFlush()` in `src/agents/pi-embedded-runner/wait-for-idle-before-flush.ts` (45 lines) with 30s timeout. Applied to 3 call sites: main run finally block, catch block in `attempt.ts`, and finally block in `compact.ts`. 4 files, +178/-3 lines. Tests: 112 new lines. Fixes #8643, #13351. Thanks @rodbland2021.

- **`2b685b08c`** (PR [#7286](https://github.com/openclaw/openclaw/pull/7286)) — **Harden Matrix multi-account routing:** Hardens the multi-account routing introduced by the 10-commit Matrix chain (see below). Normalizes account IDs across client lookup, send, directory, and group mentions. Ensures account-aware config resolution uses correct `cfg+accountId` params instead of raw lookups. 10 files, +188/-35 lines. Tests: 82+ new lines (channel directory) + 54 new lines (directory-live). Thanks @emonty.

### Feature: Matrix Multi-Account (10-commit chain)

New multi-account support for the Matrix channel, with security hardening in the final commit:

| Commit | Description |
|--------|-------------|
| `caf5d2dd7` | feat(matrix): Add multi-account support to Matrix channel |
| `c89b8d99f` | fix: normalize accountId in active-client and send/client |
| `a6dd50fed` | fix: normalize account config keys for case-insensitive matching |
| `bf4e34844` | fix: de-duplicate normalized account IDs, add case-insensitive config lookup |
| `1a7290299` | refactor: read accounts from cfg.channels.matrix.accounts directly |
| `da00f6cf8` | fix: deep-merge nested config, prefer default account in send fallback |
| `3985ef7b3` | fix: merge top-level config into per-account config |
| `1a17466a6` | fix: use account-aware config paths in resolveDmPolicy and resolveAllowFrom |
| `a76ac1344` | fix: resolveAllowFrom uses cfg+accountId params, not account |
| `2b685b08c` | fix: harden matrix multi-account routing (#7286) — **security hardening** |

### Feature: Discord Gateway Proxy + Presence (9-commit chain)

New Discord gateway proxy support and configurable presence:

| Commit | Description |
|--------|-------------|
| `0cb69b0f2` | Discord: add gateway proxy support |
| `5f0debdfb` | Fix: check cleanups |
| `e55431bf8` | fix(discord): restore gateway reconnect maxAttempts to 50 |
| `5645f227f` | Discord: add gateway proxy docs and tests (#10400) — thanks @winter-loo |
| `5d8c6ef91` | feat(discord): add configurable presence (activity/status/type) |
| `770e904c2` | fix(discord): restrict activity types and statuses to valid enum values |
| `6acea69b2` | Discord: refine presence config defaults (#10855) — thanks @h0tp-ftw |
| `c82cd9e5d` | Docs: add discord presence config notes (#10855) |
| `4b3c87b82` | fix: finalize discord presence config (#10855) — thanks @h0tp-ftw |

### Session Transcript Archival

- **`31537c669`** (PR [#14949](https://github.com/openclaw/openclaw/pull/14949)) — **Archive old transcript files on /new and /reset:** Moves stale transcript files to `.archive/` subdirectory. `archiveSessionTranscripts()` in `src/gateway/session-utils.fs.ts`. No security impact — operational hygiene.

### Massive Module Extractions (23 refactor commits)

23 `refactor(...)` commits restructured the codebase, extracting ~22,000 lines into new modules. Four of these refactors touch security-referenced files and shift line numbers across the documentation:

**Security-critical refactors:**

| Commit | Extraction | Lines moved |
|--------|-----------|-------------|
| `b47fa9e71` | `bash-tools.exec.ts` → `bash-tools.exec-runtime.ts` | 790 lines extracted (env blocklist, validateHostEnv, runtime helpers) |
| `83bc73f4e` | `exec-approvals.ts` → `exec-approvals-allowlist.ts` | Allowlist evaluation functions (`evaluateExecAllowlist`, `isSafeBinUsage`) |
| `81fbfa06e` | `exec-approvals.ts` → `exec-approvals-analysis.ts` | 1,105 lines extracted (command analysis, `analyzeShellCommand`, `splitCommandChain`) |
| `1d46d3ae4` | `node-host/runner.ts` → `node-host/invoke.ts` | Invoke handlers including `blockedEnvKeys`/`blockedEnvPrefixes` |

**Other refactors (19 — not security-referenced):**

| Commit | Module extraction |
|--------|------------------|
| `9fab0d2ce` | ui: split nodes exec approvals module |
| `d443a7379` | ui: extract usage tab render module |
| `6c445889b` | ui: split agents view into focused panel modules |
| `a1df0939d` | bluebubbles: split monitor parsing and processing modules |
| `a750a195e` | extensions: extract feishu dedup and mattermost onchar helpers |
| `6310b8b7f` | ui: split usage styles into modular parts |
| `68dbbc7c5` | ui: split usage view into focused modules |
| `4c401d336` | memory: extract manager sync and embedding ops |
| `3f5e72835` | tts: extract directives and provider core |
| `2a1f8b261` | media: extract runner entry execution helpers |
| `02684b913` | cli: split update command modules |
| `39af215c3` | outbound: extract message action param helpers |
| `23555de5d` | security: extract channel audit checks |
| `ca3a42009` | memory: extract qmd scope helpers |
| `c256503ea` | infra: extract session cost usage types |
| `5a431f57f` | infra: split heartbeat event filters |
| `a79c2de95` | gateway: extract ws auth message helpers |
| `5429f2e63` | line: split flex template builders |

### Other Changes (Not Security-Relevant)

- **`c8b198ab5`** — Speed up gateway missing-tick e2e watchdog (test-only)
- **`e746a67cc`** — Speed up telegram media e2e flush timing (test-only)
- **`bbca3b191`** — Changelog: add missing attribution
- **`8c1e8bb2f`** (PR [#15501](https://github.com/openclaw/openclaw/pull/15501)) — Note clawdock zsh compatibility (documentation)
- **`66f6d71ff`** — Update clawdock-helpers.sh compatibility with Zsh (script helper)
- **`f24d70ec8`** (PR [#15297](https://github.com/openclaw/openclaw/pull/15297)) — Switch MiniMax API-key provider to anthropic-messages format
- **`607b625aa`** — Docs: update PR commit guidance
- **`e0c04c62c`** — Docs: improve Signal setup/verification guidance
- **`f02247b6c`** — Fix CI: Discord proxy WebSocket binding + BlueBubbles timeout status
- **`c801ffdf9`** — Perf: add zero-delay gateway client connect for tests
- **`08725270e`** — Perf: honor low timeout budgets in health Telegram probes
- **`a3574bbde`** — Fix(android): add bcprov dependency for device identity store
- **`7d1be585d`** — Test: fix exec approval and pty fallback e2e flows
- **`34eb14d24`** — Perf: trim web auto-reply test cleanup backoff
- **`1c7a099b6`** — Test: move reasoning replay regression to unit suite
- **`ed5a8dff8`** — Chore: fix CHANGELOG.md formatting
- **`f6232bc2b`** — CI: close invalid items without response
- **`b05c41f34`** — Perf: reduce gateway multi e2e WebSocket churn

### Line Number Shifts (Verified via grep)

Major refactoring extracted ~3,800 lines from security-referenced files into new modules. All references below verified via `grep -n` against current source code:

| Symbol | Old Location | New Location | Verification |
|--------|-------------|--------------|-------------|
| `DANGEROUS_HOST_ENV_VARS` | `bash-tools.exec.ts:61-78` | `bash-tools.exec-runtime.ts:32` | `grep -n 'DANGEROUS_HOST_ENV_VARS' src/agents/bash-tools.exec-runtime.ts` → line 32 |
| `validateHostEnv` | `bash-tools.exec.ts:83-107` | `bash-tools.exec-runtime.ts:54` (def) + `bash-tools.exec.ts:295` (call) | `grep -n 'validateHostEnv' src/agents/bash-tools.exec-runtime.ts` → line 54 |
| `elevatedMode` | `bash-tools.exec.ts:955-962` | `bash-tools.exec.ts:199-207` (stayed in file, renumbered) | `grep -n 'elevatedMode' src/agents/bash-tools.exec.ts` → line 199 |
| `bypassApprovals` | `bash-tools.exec.ts:1278` | `bash-tools.exec.ts:269-271` (stayed in file, renumbered) | `grep -n 'bypassApprovals' src/agents/bash-tools.exec.ts` → line 269 |
| `coerceEnv(process.env)` | `bash-tools.exec.ts:982` | `bash-tools.exec.ts:290` (stayed in file, renumbered) | `grep -n 'coerceEnv' src/agents/bash-tools.exec.ts` → line 290 |
| `mergedEnv` | `bash-tools.exec.ts:988` | `bash-tools.exec.ts:298` (stayed in file, renumbered) | `grep -n 'mergedEnv' src/agents/bash-tools.exec.ts` → line 298 |
| `blockedEnvKeys` | `runner.ts:166-175` | `invoke.ts:45-175` | `grep -n 'blockedEnvKeys' src/node-host/invoke.ts` → line 45 |
| `resolveExecApprovals` | `exec-approvals.ts:73-97` | `exec-approvals.ts:319` (stayed in file, renumbered) | `grep -n 'resolveExecApprovals' src/infra/exec-approvals.ts` → line 319 |
| `evaluateExecAllowlist` | `exec-approvals.ts:110-161` | `exec-approvals-allowlist.ts:157-197` (extracted) | `grep -n 'evaluateExecAllowlist' src/infra/exec-approvals-allowlist.ts` → line 157 |
| `analyzeShellCommand` | `exec-approvals.ts:454+` | `exec-approvals-analysis.ts` (1,105 lines extracted) | `grep -n 'analyzeShellCommand' src/infra/exec-approvals-analysis.ts` |

**Key distinction:** `elevatedMode`, `bypassApprovals`, `coerceEnv`, and `mergedEnv` were **NOT** extracted to new modules. They stayed in `bash-tools.exec.ts` but shifted to much lower line numbers because 790 lines were extracted out of the file above them.

### Commit Chains

Two major commit chains detected:

1. **Matrix multi-account** (10 commits: `caf5d2dd7`..`2b685b08c`) — new feature with security hardening in final commit
2. **Discord gateway proxy + presence** (9 commits: `0cb69b0f2`..`4b3c87b82`) — new feature, no direct security impact but adds gateway proxy surface area

**Gap status:** No change — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status). Browser path traversal issues #8516/#8696 partially addressed by commit `7f0489e47` (output paths constrained to temp roots).
