> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening — Feb 16 sync 3 (60 commits)

**Merge commit:** b4f14d6f7 | **Range:** daaaf0c56..b4f14d6f7

**Overview:** 60 commits (28 auto-flagged, 16 demoted by triage, 12 deep-analyzed). Large refactor batch (10,529 lines changed) dominated by code deduplication into shared modules (`plugin-sdk/`, `shared/`). Two direct security fixes: workspace-* path traversal prevention and Discord role-based allowlist bypass.

### Security-Relevant Commits

1. **`75f33e92b`** — **fix(web): disallow workspace-* roots without explicit localRoots.** New hardening in `assertLocalMediaAllowed()` (`src/web/media.ts:56-72`) prevents path traversal into per-agent `workspace-*` state directories through the default tmpdir allowlist. When `localRoots` is undefined and the resolved path falls under a `workspace-*` sibling of the default workspace root, the request is rejected. **Directly addresses Audit 1 Claim 6 (path traversal in agent dirs).**

2. **`c68263418`** — **fix(discord): role-based allowlist never matches (#16369).** Carbon's `GuildMember.roles` getter returns `Role[]` objects that stringify to mentions (`<@&ID>`) instead of raw role ID strings. Changed from `data.member.roles` to `data.rawMember.roles` (raw Discord API string array) at `src/discord/monitor/message-handler.preflight.ts:241` and `src/discord/monitor/listeners.ts:275`. This was a complete authorization bypass — role-based allowlists never matched any member. **Directly addresses Audit 2 Claim 5 (self-approving agent / RBAC).**

3. **`b4f14d6f7`** — **Gateway: hide BOOTSTRAP in agent files after onboarding (#17491).** New `isWorkspaceOnboardingCompleted()` (`src/agents/workspace.ts:221`) checks workspace state. `listAgentFiles()` in `src/gateway/server-methods/agents.ts:115` now accepts `hideBootstrap` option, using `BOOTSTRAP_FILE_NAMES_POST_ONBOARDING` (line 56) to exclude `BOOTSTRAP.md` from file listings after onboarding completes. Reduces information exposure post-setup.

4. **`80eb91d9e`** — **refactor(plugin-sdk): add shared helper utilities.** Five new modules centralize OAuth credential construction (`buildOauthProviderAuthResult()` at `src/plugin-sdk/provider-auth-result.ts:5`), webhook path normalization (`normalizeWebhookPath()` in `src/plugin-sdk/webhook-path.ts`), status helpers, and media payload builders. Prevents inconsistent validation across extensions.

5. **`88548784c`** — **fix(bluebubbles): use Buffer for multipart body.** Wraps `concatUint8Arrays()` result in `Buffer.from()` at `extensions/bluebubbles/src/multipart.ts:20`, ensuring proper binary data handling for HTTP multipart form data.

6. **`9a5e617a5` + `c118f6c68`** — **fix(discord): align message action send parameters + fix component parsing.** Fixes ambiguous parameter handling for Discord message actions in `src/channels/plugins/actions/discord/handle-action.ts`. Removes incorrect logic accepting plain objects as components (should only be arrays or functions) and fixes modal field typing.

7. **`137079fc2`** — **refactor(shared): share entry requirements evaluation.** New `evaluateEntryMetadataRequirements()` at `src/shared/entry-status.ts:5` ensures consistent security boundary checks between skills (`src/agents/skills-status.ts`) and hooks (`src/hooks/hooks-status.ts`), preventing security inconsistencies from manual requirement duplication.

8. **`a6158873f`** — **refactor(imessage): split monitor inbound processing.** Extracts gating and decision logic from `src/imessage/monitor/monitor-provider.ts` into `src/imessage/monitor/inbound-processing.ts` (483 lines) and `src/imessage/monitor/abort-handler.ts` (34 lines). Adds proper abort handler (`attachIMessageMonitorAbortHandler`) to prevent unhandled promise rejections during shutdown.

9. **`8fdde0429`** — **perf(auto-reply): avoid skill scans for inline directives.** `shouldLoadSkillCommands` check at `src/auto-reply/reply/get-reply-inline-actions.ts:179-187` skips full skill plugin scanning for messages using only builtin inline directives (like `/think:`, `/verbose:`), reducing unnecessary code execution paths.

10. **`41f546faa` + `f92900fc2`** — **Discord role allowlist regression test.** Adds and then re-adds test coverage for the role-based allowlist fix (c68263418), ensuring the Carbon Role serialization vulnerability doesn't regress.

### Line Number Shifts

| File | Old range | New range | Shift | Cause |
|------|-----------|-----------|-------|-------|
| `src/agents/workspace.ts` | `:363-398` (resolveMemoryBootstrapEntries) | `:375-410` | +12 | `isWorkspaceOnboardingCompleted()` insertion |
| `src/agents/workspace.ts` | `:400-454` (loadWorkspaceBootstrapFiles) | `:412-466` | +12 | Same cause |
| `src/agents/workspace.ts` | `:458-466` (filterBootstrapFilesForSession) | `:470-478` | +12 | Same cause |
| `src/gateway/server-methods/agents.ts` | `:454-506` (agents.files handlers) | `:467-519` | +13 | BOOTSTRAP_FILE_NAMES_POST_ONBOARDING + hideBootstrap logic |
| `src/gateway/server-methods/agents.ts` | `:60-89` (resolveAgentWorkspaceFileOrRespondError) | `:64-93` | +4 | import + const additions |
| `src/gateway/server-methods/agents.ts` | `:67-82` (parameter validation) | `:71-86` | +4 | Same cause |
| `src/web/media.ts` | `:47-77` (assertLocalMediaAllowed) | `:47-89` | +18 (end only) | workspace-* hardening insertion at line 56 |
| `src/imessage/monitor/monitor-provider.ts` | `:184` (dmPolicy default) | `:142` | -42 | Inbound processing extraction |
| `src/imessage/monitor/monitor-provider.ts` | `:342-381` (pairing response) | `:247-278` | Refactored | Decision logic moved to `inbound-processing.ts:81,201` |

### Non-Security Commits (48 commits)

| SHA | Message | Files |
|-----|---------|-------|
| 3cd786cc2 | refactor(swift): share discovery status text | 3 |
| ef2c66a16 | refactor(camera): centralize JPEG transcode cap | 3 |
| 71009ab1b | refactor(macos): share tailnet IPv4 detection | 3 |
| c8779ef61 | refactor(macos): share pairing alert plumbing | 3 |
| 218189318 | refactor(swift): share primary IPv4 lookup | 3 |
| f37b1c11e | refactor(macos): centralize presence system info | 3 |
| 375e16170 | refactor(macos): dedupe file watcher | 3 |
| a3419e48a | refactor(swift): dedupe AnyCodable | 3 |
| 6c33bd9c6 | ci: reduce node test OOM on linux | 1 |
| 342e9cac0 | refactor(status): reuse plugin-sdk status helpers | 4 |
| bdfa2b490 | refactor(media): reuse buildAgentMediaPayload | 2 |
| 108f0ef8c | fix(test): remove stale cleanup calls in cron regressions | 1 |
| e3f4cabf4 | perf(test): speed up update-cli unit tests | 1 |
| b2088d2e1 | perf(test): speed up process poll timeout tests | 1 |
| 719280d73 | refactor(bluebubbles): share multipart helpers | 3 |
| de103773c | refactor(tlon): share urbit poke/scry ops | 3 |
| 0653e8d2e | refactor(matrix): dedupe group config resolution | 1 |
| 699136f89 | refactor(msteams): share credential prompt | 1 |
| 824901083 | refactor(pi): dedupe compaction failure | 1 |
| a2ceadcc2 | refactor(gateway): dedupe assistant delta parsing | 3 |
| 5248b759f | refactor(shared): reuse isPidAlive | 4 |
| c7b6d6a14 | refactor(plugins): reuse createEmptyPluginRegistry | 2 |
| 99fda7b92 | refactor(models): share fallback command logic | 3 |
| 6a4144f53 | refactor(auto-reply): dedupe chunk early returns | 1 |
| 6f2f88d3a | refactor(status): reuse Requirements types | 2 |
| 99caaef6c | Revert "Docs: add discord role allowlist changelog entry" | 1 |
| a5b87338e | refactor(onboard): reuse applyAgentDefaultModelPrimary | 2 |
| 8678b10ae | Docs: add discord role allowlist changelog entry | 1 |
| d9c891eb9 | refactor(channels): share threading tool context | 1 |
| b2d8b9590 | refactor(models): dedupe MiniMax provider models | 1 |
| 394e69a2f | refactor(cli): share browser resize output helper | 3 |
| 7ef956d22 | refactor(browser): share client-actions url helpers | 4 |
| 778959b3d | refactor(ios): dedupe gateway helpers | 8 |
| b30ed6ca4 | refactor(ios): share EventKit auth gating | 3 |
| 3a075f029 | fix(macos): drop duplicate AnyCodable helpers | 1 |
| c75fe7e3c | fix(swift): make SwiftPM tests deterministic | 2 |
| 8ccbd00e1 | chore: ignore OpenClawKit SwiftPM artifacts | 1 |
| 92f8c0fac | perf(test): speed up suites and reduce fs churn | 32 |
| 38f430e13 | perf(models): lazy-load heavy deps in models list | 2 |
| 5c5af2b14 | perf(wizard): lazy-load onboarding deps | 2 |
| c25026f2b | perf(plugins): lazy-create jiti loader | 3 |
| a8f3a579d | perf(telegram): lazy import proxy + timeout deps in audit | 1 |
| a4b958efc | perf(test): cover embedding chunk limits without indexing | 2 |
| a742d4413 | perf(test): stub config + persistence in subagent registry tests | 2 |
| 59c0b2bb3 | refactor(auth): reuse oauth auth result helper | 2 |
| 00e63da33 | refactor(webhooks): reuse plugin-sdk webhook path helpers | 2 |
| 95c986dee | refactor(models): share model picker auth checker | 1 |
| a2c695126 | refactor(browser): reuse CDP fetch helpers | 1 |

### Audit Claims Impact

| Audit | Claim | Status | Commit |
|-------|-------|--------|--------|
| Audit 1 #6 | Path traversal in agent dirs | **Directly hardened** | `75f33e92b` |
| Audit 2 #5 | Self-approving agent (no RBAC) | **Directly fixed** (Discord) | `c68263418` |

### Legitimate Gaps

All 3 gaps remain open — no changes in this sync.

**Gap status: 1 closed (PR #12), 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
