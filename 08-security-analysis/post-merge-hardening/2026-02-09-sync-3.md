> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 9 sync 3)

45 upstream commits. Key changes: device pairing + phone control plugins (new attack surface), iOS alpha node app, centralized home-dir resolution, transcript integrity fix, routing/thread guards tightened, exec approval UI clarity.

**HIGH — New attack surface (1):**

- **`730f86dd5`** (PR [#11755](https://github.com/openclaw/openclaw/pull/11755)) — **Gateway/Plugins: device pairing + phone control:**
  - New `/pair` command generates base64-encoded setup codes containing gateway URL + auth credentials. Credentials transmitted in a base64 blob (not encrypted) over the chat channel.
  - New `/phone` command temporarily arms/disarms dangerous node commands with auto-expiry timer (default 10m), modifying the live config file.
  - **Positive:** New default-deny policy for dangerous commands — `camera.snap`, `camera.clip`, `screen.record`, `contacts.add`, `calendar.add`, `reminders.add`, `sms.send` are now in `DEFAULT_DANGEROUS_NODE_COMMANDS` (`src/gateway/node-command-policy.ts`) and must be explicitly enabled via `gateway.nodes.allowCommands`. **Partially mitigates Gap #3** (outPath in screen_record) since `screen.record` is now default-denied.
  - Session key canonicalization in `chat.ts` distinguishes `rawSessionKey` from `canonicalKey`, preventing session confusion attacks.

**MODERATE — Path hardening (2):**

- **`db137dd65`** (PR [#12091](https://github.com/openclaw/openclaw/pull/12091)) — **fix(paths): respect OPENCLAW_HOME for all internal paths:** New centralized `src/infra/home-dir.ts` with `resolveEffectiveHomeDir()` using precedence: `OPENCLAW_HOME` > `HOME` > `USERPROFILE` > `os.homedir()`. Eliminates scattered `os.homedir()` calls. All path-sensitive callsites migrated (config IO, agent dirs, session transcripts, pairing store, cron store, CLI profiles, OAuth dir). Strengthens Audit 1 Claim 6 (path traversal) defense-in-depth.

- **`456bd5874`** (PR [#12125](https://github.com/openclaw/openclaw/pull/12125)) — **fix(paths): structurally resolve home dir:** Single `path.resolve()` exit point in `resolveEffectiveHomeDir()` prevents unresolved paths from escaping. Removes dangerous colon-split in `tool-meta.ts` `shortenMeta()` that broke on Windows drive letters.

**MODERATE — Transcript integrity (1):**

- **`0cf93b8fa`** (PR [#12283](https://github.com/openclaw/openclaw/pull/12283)) — **Gateway: fix post-compaction amnesia for injected messages:** Eliminates raw JSONL appends for injected assistant messages. Now uses `SessionManager.appendMessage()` with proper `parentId` chain. Fixes `stopReason` from invalid `"injected"` to `"stop"` with explicit metadata. Prevents context amnesia where compaction summaries and security-relevant prior instructions could be lost.

**LOW-MODERATE (3):**

- **`d85f0566a`** — **fix: tighten thread-clear and telegram retry guards:** Thread-clear in `updateLastRoute` now only clears when explicit route is provided. `hasMessageThreadIdParam` validates value is finite number or non-empty string, preventing invalid thread IDs causing cross-thread message delivery.

- **`8d96955e1`** (PR [#11372](https://github.com/openclaw/openclaw/pull/11372)) — **fix(routing): make bindings dynamic per-message:** Calls `loadConfig()` fresh per incoming message instead of using stale startup config. Security-relevant: routing restriction changes (e.g., restricting agent access) take effect immediately without restart.

- **`ad8b839aa`** (PR [#11937](https://github.com/openclaw/openclaw/pull/11937)) — **Exec approvals: render forwarded commands in monospace:** Exec-approval requests render commands in backtick-fenced code blocks with escalating fence lengths. Helps operators accurately review commands before approving, reducing risk of approving visually misleading commands.

**Line number shifts in this sync:** `src/config/io.ts` +2-3 lines (writeConfigFile 480→482, 0o700 at 495→497, 0o600 at 489→509). `src/routing/session-key.ts` +30 lines (per-account-channel-peer 119,135→148,166-170). `src/agents/bash-tools.exec.ts` +5 lines (env merge 967→972, validateHostEnv 975→976-977, bypassApprovals 1273→1278). `src/config/paths.ts` reorganized (resolveUserPath at 87-105, resolveCanonicalConfigPath at 114-123). `src/plugins/config-state.ts` +4 (loadPaths 69→73, enable 190→194). All references updated and LSP-verified.

**CVE status:** 5 published advisories (CVE-2026-25593, CVE-2026-25475, GHSA-g8p2-7wf7-98mq, CVE-2026-25157, CVE-2026-24763) — all pre-existing, none patched in this merge.

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation — Gap #3 partially mitigated by default-deny on `screen.record`, bootstrap/memory .md scanning) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
