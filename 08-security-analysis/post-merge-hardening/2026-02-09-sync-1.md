> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 9 sync 1)

43 upstream commits. Key changes: new agent CRUD API (RBAC-gated), gateway LAN bind fix, sandbox USER directive fix, STATE_DIR credential path fix, cron isolation hardening, context overflow recovery, new MITRE ATLAS threat model documentation.

**HIGH (3):**

- **`980f78873`** (PR [#11045](https://github.com/openclaw/openclaw/pull/11045)) — **Agent CRUD RBAC gating:** New `agents.create`, `agents.update`, `agents.delete` gateway methods gated behind `operator.admin` scope in `authorizeGatewayMethod()` (`src/gateway/server-methods.ts:146-148`). Prevents non-admin clients from creating/modifying/deleting agents. Strengthens Audit 2 Claim 5 (agent self-approval) controls — agents cannot call these methods.

- **`b8c8130ef`** (PR [#11448](https://github.com/openclaw/openclaw/pull/11448)) — **Gateway LAN IP bind fix:** New `pickPrimaryLanIPv4()` in `src/gateway/net.ts:9-25` resolves the primary non-internal IPv4 address for `bind=lan` mode. WebSocket and probe URLs now use the actual LAN IP instead of `0.0.0.0`, preventing unintended exposure of internal URLs to external networks.

- **`28e1a65eb`** (PR [#11289](https://github.com/openclaw/openclaw/pull/11289)) — **Sandbox USER directive fix:** Adds `USER root` directive to `Dockerfile.sandbox` and `Dockerfile.sandbox-browser`, fixing sandbox container user context. Also fixes `workspace:*` protocol references in extension package.json files and removes dead config entries.

**MEDIUM (4):**

- **`ebe573040`** (PR [#4824](https://github.com/openclaw/openclaw/pull/4824)) — **STATE_DIR credential path fix:** Device identity and canvas host now use `STATE_DIR` environment variable instead of hardcoded `~/.openclaw`, preventing credential path misalignment in non-standard installations (e.g., Docker, Nix). Affects `src/infra/device-identity.ts`, `src/canvas-host/server.ts`. New test: `src/infra/device-identity.state-dir.test.ts`.

- **`8fae55e8e`** (PR [#11641](https://github.com/openclaw/openclaw/pull/11641)) — **Cron isolated announce flow hardening:** Shared isolated announce flow between cron jobs and main agent. Hardened cron scheduling and delivery with improved timer management and job state tracking. Continues cron race condition work from Feb 6 sync 3.

- **`ea423bbbf`** — **Context overflow sanitization:** Enhanced error handling in `sanitizeUserFacingText()` for context overflow scenarios. Improves user-facing error messages when agent encounters context limits, reducing information leakage in error paths.

- **`0deb8b0da`** (PR [#11579](https://github.com/openclaw/openclaw/pull/11579)) — **Tool result overflow recovery:** New `src/agents/pi-embedded-runner/tool-result-truncation.ts` (328 lines) detects and truncates oversized tool results that cause context overflow. Prevents DoS via tools returning unbounded output. Tests: `src/agents/pi-embedded-runner/tool-result-truncation.test.ts` (215 lines).

**Notable non-security changes:**
- **MITRE ATLAS threat model** (`74fbbda28`): New `docs/security/THREAT-MODEL-ATLAS.md` (603 lines) documents 20+ threats across 8 MITRE ATLAS tactics. Identifies P0 risks: direct prompt injection, malicious skill installation, credential harvesting via skills. References key security files including `src/infra/exec-approvals.ts`, `src/gateway/auth.ts`, `src/infra/net/ssrf.ts`.
- **Memory hardening** (5 commits): QMD startup resilience, SQLITE_BUSY fallback, cache eviction idempotency, forced sync queuing.
- **CI pipeline overhaul** (`multiple`): Docs-only detection, pnpm store caching, consolidated test sharding.

**Line number shifts in this sync:** `src/gateway/server-methods.ts` +3 lines (93-160 → 93-163), `src/gateway/net.ts` +24 lines (all functions shifted: `isTrustedProxyAddress` 74→98, `resolveGatewayClientIp` 82→106, `resolveGatewayBindHost` 129→153). All references updated and LSP-verified.

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation, bootstrap/memory .md scanning) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
