> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 19 sync 7 (45 commits)

**Merge commit:** 0ff506140 | **Range:** f990d8960..0ff506140

> Batch capped at 45 commits (89 total upstream). Remaining 44 commits will be processed in subsequent sync.

### Security-Relevant Commits (2)

| SHA | Message | Files | Audit Cross-Ref |
|-----|---------|-------|-----------------|
| `c5698caca` | Security: default gateway auth bootstrap and explicit mode none (#20686) | 8 prod + 7 test + 3 doc | **NEW SECURITY FEATURE** - Auth bootstrap + explicit none mode |
| `7e54b6c96` | fix(browser): unify extension relay auth on gateway token | 4 prod + 1 test + 3 doc | **HARDENING** - Extension relay token enforcement |

### Commit Details

1. **`c5698caca`** — **NEW** Gateway authentication bootstrap and explicit `mode: none` support.
   - `src/config/types.gateway.ts:79` — `GatewayAuthMode` type now includes `"none"`
   - `src/config/zod-schema.ts:414-420` — Zod schema updated with `"none"` literal
   - `src/gateway/auth.ts:186` — `resolveGatewayAuth()` gains `authOverride` param and `modeSource` tracking
   - `src/gateway/startup-auth.ts:1-147` — **NEW FILE** — `ensureGatewayStartupAuth()` auto-generates token if missing
   - `src/gateway/server.impl.ts:228-250` — Server startup now calls `ensureGatewayStartupAuth()`
   - `src/browser/control-auth.ts:61-66` — Browser control respects explicit `mode: none`
   - `src/gateway/server-runtime-config.ts:71-72` — Rejects LAN binding with explicit `mode: none`

   **Security implications:**
   - Default auth mode changed from implicit "none" to "token" when unconfigured
   - Missing token now auto-generates and persists (secure-by-default)
   - Explicit `mode: none` requires loopback binding (prevents accidental exposure)
   - New `modeSource` field tracks whether mode came from config, override, password, token, or default

2. **`7e54b6c96`** — **HARDENING** Extension relay now requires gateway token.
   - `src/browser/extension-relay.ts:177` — `resolveRelayAuthToken()` now throws if no gateway token
   - `src/browser/extension-relay.ts:226` — `getChromeExtensionRelayAuthHeaders()` uses gateway token directly
   - `src/browser/extension-relay.ts:96-108` — `getRelayAuthTokenFromRequest()` accepts header or query param
   - `assets/chrome-extension/background.js:50-55` — Extension reads gateway token from storage
   - `assets/chrome-extension/options.js:104-108` — Options page validates token before relay check

   **Security implications:**
   - Removes separate deterministic relay token derivation
   - Extension WebSocket now requires authentication (401 if missing)
   - Unifies auth model: relay uses same token as gateway
   - Chrome extension must be configured with gateway token

### Non-Security Commits (43)

> All 43 commits demoted during triage. Primarily test deduplication, iOS fixes, and non-security production changes.

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `0ff506140` | fix: clear matched tool errors and dedupe reasoning end | 5 prod + 1 test | Stream handling fix |
| `221d50bc1` | fix: preserve assistant partial stream during reasoning | 3 prod + 1 test | Stream handling fix |
| `a82a41236` | test(web): dedupe creds-update trigger helper in session tests | 1 test | Test deduplication |
| `ca71b5cc5` | test(shell-env): dedupe repeated login-shell path lookups | 1 test | Test deduplication |
| `9bd2261c0` | fix(ios): auto-generate local signing overrides (#20716) | 1 doc | iOS-only, no server impact |
| `57ea6feb0` | test(gateway): dedupe startup auth override token checks | 1 test | Test deduplication |
| `1c04f5fcb` | style: format extension relay imports | 1 prod | Formatting only |
| `781b1c1e0` | test(memory): dedupe voyage embedding provider test setup | 1 test | Test deduplication |
| `a2e846f64` | test: drop duplicate skills-cli integration coverage | 1 test | Test deduplication |
| `a4da6cfd5` | test(update-cli): dedupe restart script test setup helpers | 1 test | Test deduplication |
| `4c68a09f0` | test(discord): dedupe gateway proxy runtime fixture | 1 test | Test deduplication |
| `192366e0e` | test: dedupe shell env coverage from infra runtime suite | 1 test | Test deduplication |
| `c37cf02f2` | test: make shell env path cache tests platform deterministic | 2 test + 1 prod | Test platform fix |
| `f855d0be4` | fix: skip heartbeat when HEARTBEAT.md does not exist (#20461) | 8 prod + 2 test + 1 doc | Heartbeat behavior fix |
| `48e6b4fca` | fix: run BOOT.md for each configured agent at startup (#20569) | 6 prod + 2 test + 1 doc | Hook execution fix |
| `d17a1f387` | fix(telegram): unify inbound handling for message-like updates (#20591) | 4 prod + 1 test + 1 doc | Telegram handler fix |

**Safe commits (27):** Test deduplication (17), CI fixes (2), docs updates (2), production refactors (6) — see commit-analysis.md for full list.

### Audit Cross-Reference

| Claim/Gap | Status |
|-----------|--------|
| **Claim 5** (Self-approving agent / RBAC) | **INDIRECTLY STRENGTHENED** - Auth bootstrap ensures token exists by default |
| **Claim 9** (Gateway auth bypass) | **STRENGTHENED** - Extension relay now requires gateway token |
| **Gap 1** (Gateway-side env var blocklist) | Not affected |
| **Gap 2** (Pipe-delimited token format) | Not affected |
| **Gap 3** (outPath validation) | Not affected |

### Potentially Stale References

The following source files were modified in this sync. Doc references should be verified:

- `src/gateway/auth.ts` - Major changes to `resolveGatewayAuth()` signature and behavior
- `src/browser/extension-relay.ts` - Token handling simplified to use gateway token
- `src/config/types.gateway.ts` - `GatewayAuthMode` type updated
- `src/config/zod-schema.ts` - Auth mode schema updated
- `src/gateway/server-runtime-config.ts` - Auth resolution path changed
- `src/infra/heartbeat-runner.ts` - Heartbeat logic changes

**Gap status: 0 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
