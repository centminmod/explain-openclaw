> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 19 sync 3 (61 commits, 2 security)

**Merge commit:** d7a6a0a0b | **Range:** d6b82c92f..d7a6a0a0b

### Security-Relevant Commits

| SHA | Message | Files | Description |
|-----|---------|-------|-------------|
| `63403d47d` | refactor(auth): share oauth profile config checks | 2 prod | Introduces `isProfileConfigCompatible()` at `oauth.ts:26` to enforce that stored credentials match configured provider and mode (e.g., rejects OAuth credentials when config expects `api_key`). Adds 106-line test suite for config compatibility scenarios. Strengthens Audit 1 Claim 4 (token refresh) by preventing mismatched credential types. |
| `79cc4aec8` | refactor(auth): share oauth result builders and token expiry checks | 1 prod + 1 test | Extracts `isExpiredCredential()` at `oauth.ts:81` to centralize token expiry validation logic, ensuring consistent handling across all auth resolution paths. Adds tests for edge cases (expired tokens, `expires: 0` as non-expiring). Strengthens Audit 1 Claim 8 (token expiry validation). |

### Non-Security Commits (59)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `d7a6a0a0b` | refactor(reply): share embedded run fallback/context builders | 4 prod | Helper extraction, no security impact |
| `32a704f63` | refactor(auth): share resolve profile params type | 1 prod | Type-only change |
| `f830261c4` | test(daemon): dedupe schtasks fixtures and cover state-dir override | 1 test | Test-only |
| `9a7726824` | refactor(media): share provider auth resolution for entry runs | 1 prod | Helper extraction |
| `a848e9a1c` | fix(types): narrow snapshot refs mode type | 1 prod | Type-only |
| `86f504e25` | refactor(browser): share checked fetch helper for cdp | 1 prod | Helper extraction |
| `4f36c813a` | refactor(commands): share custom api verification request flow | 1 prod | Helper extraction |
| `307719abe` | fix(types): align restart sentinel and typing test mocks | 1 prod + 1 test | Type alignment |
| `7bf9b6e52` | refactor(line): share account config base type | 1 prod | Type-only |
| `2d55cc446` | refactor(config): share install record schema shape | 3 prod | Schema deduplication |
| `95aa5480a` | fix(telegram): correct onboarding import for chat lookup helper | 1 prod | Import fix |
| `d67942af1` | refactor(telegram): share getChat id lookup helper | 4 prod | Helper extraction |
| `6187e2afb` | refactor(gateway): share gmail watcher startup flow | 4 prod | Helper extraction |
| `b73a2de9f` | refactor(infra): reuse shared home prefix expansion | 2 prod + 1 test | Deduplication |
| `b51166e87` | refactor(browser): share control lifecycle helpers | 4 prod | Helper extraction |
| `fedebc245` | fix(protocol): align bool-first AnyCodable equality/hash dispatch (#20233) | 1 prod | Swift protocol fix |
| `e9b4d86e3` | fix(protocol): preserve AnyCodable booleans from JSON bridge (#20220) | 2 prod + 1 doc | Swift protocol fix |
| `d16621f60` | fix(test): annotate mock web listener return type | 1 test | Test-only |
| `9c125c6c1` | perf(test): remove unnecessary qmd export delay | 1 test | Test-only |
| `8d4ffe350` - `5d81c3ead` (39 commits) | refactor/perf(test): various helpers and test optimizations | 39 prod/test | Refactors, test perf improvements |

**Detailed SHAs for grouped ranges:**
- `8d4ffe350` - `5d81c3ead`: 39 commits covering discord role parsing, download helpers, openai response extraction, embedded block helpers, storage mutation parsing, directory CLI flow, configure wizard, transcript helpers, slack formatting, rich menu batching, session persistence, playwright downloads, systemd actions, subagent utilities, image resize helpers, text block extraction, session parsing, queue helpers, and test performance improvements (polling loop replacements, timer removals).

### Audit Cross-Reference

**Affected Claims:**
- **Audit 1 Claim 4 (Token refresh race condition):** Strengthened by `63403d47d` which adds `isProfileConfigCompatible()` to enforce credential/config mode compatibility before refresh attempts.
- **Audit 1 Claim 8 (Token expiry validation):** Strengthened by `79cc4aec8` which centralizes expiry checks in `isExpiredCredential()` for consistent handling.

**Unaffected Claims:** All other audit claims (Audit 1 Claims 1-3, 5-7; Audit 2 Claims 1-8; all 3 legitimate gaps) remain unchanged.

### Line Number Updates

| File | Old | New | Context |
|------|-----|-----|---------|
| `src/agents/auth-profiles/oauth.ts` | 43-105 | 94 | `refreshOAuthTokenWithLock()` function |
| `src/agents/auth-profiles/oauth.ts` | 176 | 153 | `tryResolveOAuthProfile()` function |
| `src/agents/auth-profiles/oauth.ts` | 176-197 | 153-194 | Token use + refresh flow |
| `src/agents/auth-profiles/constants.ts` | 12-21 | 12 | `AUTH_STORE_LOCK_OPTIONS` |

### Notes

- This batch is predominantly refactoring with 2 security-relevant commits that strengthen existing auth controls
- The `isProfileConfigCompatible()` function adds defense-in-depth by validating credential/config compatibility
- The `isExpiredCredential()` function ensures consistent token expiry handling across code paths
- 39 test performance commits replaced polling loops with `waitFor`/`expect.poll` patterns
- Batch cap applied: 61 of 68 commits merged (7 remaining)

**Gap status: 1 closed, 3 remain open.** â€” see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
