> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 21 sync 2, 37 commits)

**Merge commit:** `2649e9e04` | **Range:** `c0e526239..2649e9e04` | **37 non-merge commits** (30 flagged, 7 safe)

**Security relevance: MEDIUM** — 6 security-relevant commits across gateway network hardening, prompt injection defense, input validation, schema hardening, and canvas path traversal protection.

### Security-Relevant Commits (6)

#### Gateway & Network Hardening (1 commit)

1. **`47f397975`** — **Gateway: force loopback self-connections for local binds:** `src/gateway/call.ts:121` now hardcodes `127.0.0.1` for self-connections: `const localUrl = \`${scheme}://127.0.0.1:${localPort}\`` with comment "Self-connections should always target loopback; bind mode only controls listener exposure." Previously used a Tailscale-aware IP resolver that could expose self-connections via network interfaces. Added CWE-319 security check at `src/gateway/call.ts:142-155` that blocks plaintext `ws://` connections to any non-loopback address. Files: 1 prod + 2 test.

#### Prompt Injection Defense (1 commit)

2. **`9a6b26d42`** — **fix(ui): strip inbound metadata blocks and guard reply-tag streaming (clean rewrite) (#22346):** Adds gateway-level stripping of injected inbound metadata from message history. `INBOUND_METADATA_HEADERS` at `src/shared/chat-envelope.ts:19-26` defines 6 trusted metadata section headers. `INBOUND_METADATA_PREFIX_RE` at `src/shared/chat-envelope.ts:28-32` strips JSON code blocks under these headers. `stripInboundMetadataBlocks()` at `src/shared/chat-envelope.ts:65` is called in `src/gateway/chat-sanitize.ts` at lines 19, 46, and 58 to sanitize message history before it is processed. Predecessor: `a4e7e952e` (initial implementation, included in non-security table). Files: 3 prod + 1 test + 1 doc.

#### Input Validation & Schema Hardening (2 commits)

3. **`122bdfa4e`** — **feat(discord): add configurable ephemeral option for slash commands:** NEW `src/discord/monitor/commands.ts` (9 lines): `resolveDiscordSlashCommandConfig()` at line 3 enforces `ephemeral: true` as the safe default when configuration is absent (`raw?.ephemeral !== false`). Slash command responses remain ephemeral unless explicitly disabled by the operator. Schema hardening in `src/config/zod-schema.providers-core.ts` uses `.strict()` to reject unknown configuration fields. Files: 4 prod + 1 test + 1 doc.

4. **`844d84a7f`** — **Usage API UTC offset bounds enforcement:** `parseUtcOffsetToMinutes()` at `src/gateway/server-methods/usage.ts:115` validates incoming UTC offset strings via regex `/^UTC([+-])(\d{1,2})(?::([0-5]\d))?$/` and enforces range bounds: hours > 14 or (hours === 14 && minutes !== 0) returns `undefined` at line 129; total minutes outside -12:00 to +14:00 returns `undefined` at line 133. Prevents arithmetic overflow or unexpected behavior from malformed timezone inputs in the usage API. Files: 6 prod + 2 test + 1 doc.

#### Feature Security Controls (2 commits)

5. **`4ab946eeb`** — **Discord VC: voice channels, transcription, and TTS (#18774) — canvas path validation hardened:** Large feature commit adding Discord voice channel support. Security-relevant change: `readJsonlFromPath()` at `src/agents/tools/canvas-tool.ts:30` replaces the prior ad-hoc URL resolver with `isInboundPathAllowed()` from `src/media/inbound-path-policy.ts:100`, blocking canvas jsonlPath values outside allowed media roots. The old code had resolveLocalRoot() with manual path comparison; the new code uses the centralized inbound path policy which also validates at the realpath level. Files: 19 prod + 0 test + 4 doc. NEW files: `src/discord/voice/command.ts`, `src/discord/voice/manager.ts`. **Partially mitigates Legitimate Gap #3.**

6. **`30a0d3fce`** — **Status reactions: fix stall timers and gating (#22190) — schema hardening:** Introduces status reaction emoji feedback during agent processing. NEW `src/channels/status-reactions.ts` (390 lines): `DEFAULT_EMOJIS` at line 51, `DEFAULT_TIMING` at line 63, `createStatusReactionController()` at line 122. Schema added to `src/config/zod-schema.session.ts` — the `emojis` and `timing` sub-objects both use `.strict()` to reject unknown configuration fields, preventing silent misconfiguration. Files: 8 prod + 1 test + 1 doc.

### Cross-Commit Regression Note

**`fe57bea08`** (Tier A: "Subagents: restore announce chain + fix nested retry/drop regressions") introduced `DEFAULT_SUBAGENT_MAX_SPAWN_DEPTH = 2` in `src/config/agent-limits.ts` and simplified cron session handling to always generate a fresh session ID. However, **`f555835b0`** (Tier A: "Channels: add thread-aware model overrides", newer) reverted both changes — removing the constant and restoring the prior session-freshness-based reuse logic. Net effect on security posture: neutral. Both commits appear in the Non-Security table below.

### Non-Security Commits (from flagged, 24)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `fe57bea08` | Subagents: restore announce chain + fix nested retry/drop regressions (#22223) | 10 prod + 8 test + 3 doc | Regression fix — security aspects reverted by f555835b0 |
| `f555835b0` | Channels: add thread-aware model overrides | 30 prod + 18 test + 5 doc | Feature — NEW `src/channels/model-overrides.ts`; reverts fe57bea08 security aspects |
| `a4e7e952e` | fix(ui): strip injected inbound metadata from user messages in history (#22142) | 8 prod + 2 test + 1 doc | UI layer strip — gateway layer handled by 9a6b26d42 (clean rewrite) |
| `2649e9e04` | fix: preselect Telegram-supported status reaction variants (#22380) | 2 prod + 1 test + 1 doc | Status reaction variant fix |
| `5dae5e6ef` | fix(tools): forward senderIsOwner to embedded runner so owner-only tools work (#22296) | 4 prod + 0 test + 1 doc | Access control bug fix (enables authorized access, not a hardening) |
| `b294342d7` | feat(discord): support forum tag edits via channel-edit (#12070) (thanks @xiaoyaner0201) | 5 prod + 1 test + 1 doc | Feature |
| `b7644d61a` | fix: restore Discord model picker UX (#21458) (thanks @pejmanjoon) | 4 prod + 2 test + 4 doc | UI fix |
| `ee8dd4050` | Discord/Telegram: emit edit system events (#22310) | 3 prod + 2 test + 0 doc | Feature |
| `eedea6cf3` | Discord: add trusted channel topics on new sessions | 3 prod + 1 test + 2 doc | Feature |
| `086af5686` | Discord: keep DM component sessions | 1 prod + 1 test + 1 doc | Session management fix |
| `1eec2aee4` | Discord: ingest inbound stickers | 2 prod + 1 test + 1 doc | Feature |
| `64c29c375` | Discord: avoid reply spam on chunked sends | 3 prod + 1 test + 1 doc | Message delivery fix |
| `ab27d7b05` | Discord: fix voice command typing | 3 prod + 0 test + 0 doc | Bug fix |
| `866b33e0d` | fix: lazy-load Discord allowlist guilds (#20208) (thanks @zhangjunmengyang) | 1 prod + 1 test + 1 doc | Perf fix |
| `feccac672` | fix: sanitize thinking blocks for GitHub Copilot Claude models (openclaw#19459) thanks @jackheuberger | 4 prod + 1 test + 1 doc | Provider compatibility fix |
| `a305dfe62` | Memory/QMD: harden multi-collection search and embed scheduling | 3 prod + 2 test + 1 doc | QMD reliability improvement |
| `d94d21f9b` | test: isolate local media regression fixtures to allowed roots (#22369) | 1 prod + 3 test + 1 doc | Test isolation fix |
| `0e068194a` | fix(tool-display): `cd ~/dir && npm install` shows as `run cd` — compound commands truncated to first stage (#21925) | 1 prod + 1 test + 1 doc | UI bug fix |
| `2dba150c1` | Fix path-root flaky tests and restore status emoji defaults (#22274) | 1 prod + 4 test + 0 doc | Test fix |
| `3100b77f1` | Agents: clarify authorized sender prompt (Closes #19794) | 1 prod + 1 test + 1 doc | Prompt clarification |
| `6a2778720` | Docker: restore pre-change ownership steps | 1 prod + 0 test + 0 doc | Docker fix |
| `0f1b2ad96` | chore: Reduce app-specific docker image size by ~50% / ~900 MB (AI assisted) (#22019) | 1 prod + 0 test + 1 doc | Docker optimization |
| `282a54513` | chore: fix formatting on CI-drift files (#22391) | 3 prod + 0 test + 0 doc | Formatting |
| `1410d15c5` | fix: compaction safeguard extension not loading in production builds (openclaw#22349) thanks @Glucksberg | 3 prod + 0 test + 1 doc | Build fix |

### Safe Commits (7)

Demoted by triage: 3 (docs or test only) — `02ac5b59d` (Skills: add SonosCLI troubleshooting guidance — 2 doc), `22ffde90b` (tests: align macmini suite expectations — 4 test), `105a6307c` (Tests: fix discord components loadConfig mock — 1 test). Originally safe: 4 (docs/changelog only) — `e2dbd4541` (fix: add configurable ephemeral defaults for Discord slash commands — 1 doc, changelog for 122bdfa4e), `3e1ed0032` (Docs: add Discord forum thread docs — 2 doc), `68fd8ed86` (clankers are dumb — 1 doc), `df002ef84` (Workflow: clarify dirty PR response — 1 prod).

---

### Audit Cross-Reference

| Audit Claim | Commits | Impact |
|-------------|---------|--------|
| **Audit 1 Claim 6** (Path traversal) | `4ab946eeb` | **PARTIALLY MITIGATED** — canvas jsonlPath now validated via `isInboundPathAllowed()` |
| **Audit 2 Claim 3** (Log/path traversal) | `4ab946eeb` | **PARTIALLY MITIGATED** — inbound path policy applied to canvas tool |
| **All other claims** | — | Unaffected — no commits touch OAuth storage, CSRF, RBAC, sandbox, or exec-safety paths |

### Legitimate Gap Cross-Reference

| Gap | Status | Commits |
|-----|--------|---------|
| Gap #1 (Gateway env blocklist) | Remains closed | — |
| Gap #2 (Pipe-delimited token format) | Open | — |
| Gap #3 (outPath validation) | **Further mitigated** | `4ab946eeb` — canvas jsonlPath now validated via centralized `isInboundPathAllowed()` from `src/media/inbound-path-policy.ts:100` |
| Gap #4 (Bootstrap/memory .md scanning) | Open | — |

### Line Number Shifts

24 stale refs updated across 17 doc files in Phase 4b (applied prior to this entry):

`attempt.ts` 192→277, 229→296, 288→298, 662→731, 893→993. `google.ts` 67→72, 458→459. `compact.ts` 433-438→605-607. `transcript-policy.ts` 98→106. `bot-message-context.ts` 267-272→277-282. `message-handler.process.ts` 141-147→176-182. `usage.ts` 51→41. `qmd-manager.ts` 418-424→521-525, 656-661→826-831, 1080-1086→1378-1384, 1083-1109→1322-1361, 1112-1123→1364-1376, 1146→1398, 34→35. `tui-formatters.ts` 93-117→94-118. `zod-schema.providers-core.ts` 116→117, 325→344, 808→841. `zod-schema.session.ts` 132→161.

**CVE status:** 30 published advisories — all pre-existing, none newly patched in this merge.

**Gap status: 1 closed, 3 remain open** (Gap #3 further mitigated by canvas path validation in `4ab946eeb`) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
