> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 16 Sync 13 Hardening (31 commits, 5 security-relevant)

**Merge commit:** 2b4ebcb57 | **Range:** 5f982d45c..2b4ebcb57

### Commits

| SHA | Message | Files | Category |
|-----|---------|-------|----------|
| `cf6990701` | fix(security): redact Telegram bot tokens in errors | 2 prod + 1 test + 1 doc | Security |
| `ba84b1253` | fix: harden pre-commit hook against option injection | 2 prod + 1 test + 1 doc | Security |
| `a7cbce1b3` | refactor(security): tighten sandbox bind validation | 3 prod + 1 test | Security |
| `3b4096e02` | fix(ui): load Control UI bootstrap config via JSON endpoint | 4 prod + 1 test | Security |
| `adc818db4` | fix(gateway): serve Control UI bootstrap config and lock down CSP | 1 prod + 1 test | Security |
| `c1655982d` | refactor: centralize pre-commit file filtering | 3 prod + 2 test | Refactor |
| `09566b169` | fix(discord): preserve channel session keys via channel_id fallbacks (#17622) | 10 prod + 5 test + 1 doc | Refactor |
| `ddcc7a1a5` | fix(discord): dedupe native skill commands by skillName (#17365) | 1 prod + 1 test + 1 doc | Refactor |
| (23 others) | Refactors, deduplication, helper extraction | ~45 prod + ~15 test | Refactor |

### Security-Relevant Commits

1. **`cf6990701`** — **fix(security): redact Telegram bot tokens in errors**

   Adds Telegram bot token redaction to error formatting and log redaction:

   - `formatErrorMessage()` (`src/infra/errors.ts:31`) and `formatUncaughtError()` (`src/infra/errors.ts:50`) now call `redactSensitiveText()` before returning — any error message or stack trace containing a Telegram bot token is automatically redacted
   - Two new patterns added to `DEFAULT_REDACT_PATTERNS` (`src/logging/redact.ts:36-37`):
     - `\bbot(\d{6,}:[A-Za-z0-9_-]{20,})\b` — matches `bot<token>` format in Telegram Bot API URLs
     - `\b(\d{6,}:[A-Za-z0-9_-]{20,})\b` — matches bare `<numeric_id>:<secret>` token format
   - Patterns array now spans lines 13-38 (was 13-36)

   **Mitigates token leakage** in error messages, log files, and UI-displayed errors. Telegram bot tokens embedded in API URLs (e.g., `https://api.telegram.org/bot<token>/getMe`) are now caught by both pattern-based redaction and the error formatting pipeline. Relevant to the same defense-in-depth posture as **Gap 2** (sensitive data in logs).

2. **`ba84b1253`** — **fix: harden pre-commit hook against option injection**

   Rewrites `git-hooks/pre-commit` to prevent malicious filenames from being interpreted as git/tool options:

   - NUL-delimited file listing (`git diff --cached --name-only --diff-filter=ACMR -z`) at line 21 prevents filename splitting on spaces/newlines
   - `mapfile -d ''` reads NUL-delimited entries safely (lines 21, 27, 28)
   - Double-dash separators (`--`) in all tool invocations: `oxlint --fix -- "${lint_files[@]}"` (line 31), `oxfmt --write -- "${format_files[@]}"` (line 35), `git add -- "${files[@]}"` (line 38)
   - A file named `--all` or `--force` can no longer be misinterpreted as a git option

   **Mitigates option injection attacks** via crafted filenames in the repository. Without `--`, a file named `--all` would cause `git add --all` (staging everything) instead of `git add -- --all` (staging only that file).

3. **`a7cbce1b3`** — **refactor(security): tighten sandbox bind validation**

   Tightens sandbox bind mount validation in `src/agents/sandbox/validate-sandbox-security.ts`:

   - `getBlockedBindReasonStringOnly()` renamed to `getBlockedBindReason()` (line 68) — returns structured `BlockedBindReason` object instead of string
   - New `getBlockedReasonForSourcePath()` extracted (line 78) — isolates path-matching logic for reuse
   - Three new entries in `BLOCKED_HOST_PATHS` denylist (lines 22-24): `/run`, `/var/run`, `/private/var/run` — blocks ALL bind mounts from these directories, not just the Docker socket paths. This closes a gap where `BLOCKED_HOST_PATHS` blocked `/var/run/docker.sock` but allowed `/var/run:/container-run` which exposes the socket indirectly
   - Zod schema `SandboxDockerSchema.superRefine` (`src/config/zod-schema.agent-runtime.ts:128-180`) expanded with bind mount path validation — rejects non-absolute source paths at config parse time
   - `collectSandboxDangerousConfigFindings()` (`src/security/audit-extra.sync.ts:588`) updated to call renamed `getBlockedBindReason()`

   **Strengthens Audit 1 Claim 6** (path traversal in agent dirs) and **Gap 3** (outPath validation) — the ancestor mount detection that previously only caught exact Docker socket paths now blocks any mount sourced from `/run`, `/var/run`, or `/private/var/run`.

4. **`3b4096e02`** — **fix(ui): load Control UI bootstrap config via JSON endpoint**

   Eliminates inline `<script>` injection in the Control UI by loading bootstrap configuration via a JSON endpoint:

   - New `loadControlUiBootstrapConfig()` (`ui/src/ui/controllers/control-ui-bootstrap.ts:18`) fetches `/__openclaw/control-ui-config.json` via `fetch()` with `same-origin` credentials
   - Replaces inline `<script>window.__OPENCLAW_CONFIG = {...}</script>` pattern that was vulnerable to XSS if config values contained unescaped HTML
   - `normalizeAssistantIdentity()` processes the JSON response to extract only expected fields (name, avatar, agentId)
   - Called from `app-lifecycle.ts:43` during UI initialization

   **Mitigates stored XSS** — config values (assistant name, avatar URL) that previously rendered directly into HTML `<script>` blocks are now served as JSON with proper `Content-Type: application/json` headers, preventing script execution.

5. **`adc818db4`** — **fix(gateway): serve Control UI bootstrap config and lock down CSP**

   Server-side counterpart to `3b4096e02` — adds the JSON config endpoint and strict Content Security Policy:

   - `applyControlUiSecurityHeaders()` (`src/gateway/control-ui.ts:70-90`) sets strict CSP on ALL Control UI responses:
     - `script-src 'self'` — blocks ALL inline scripts (the key XSS mitigation)
     - `base-uri 'none'` — prevents `<base>` tag hijacking
     - `object-src 'none'` — blocks Flash/Java embeds
     - `frame-ancestors 'none'` — prevents clickjacking (supplements `X-Frame-Options: DENY`)
   - `CONTROL_UI_BOOTSTRAP_CONFIG_PATH` constant (line 15): `/__openclaw/control-ui-config.json`
   - JSON endpoint at lines 246-270 serves bootstrap config as `application/json` with `no-cache`

   **Completes the XSS fix** from `3b4096e02`. The `script-src 'self'` CSP directive ensures that even if an attacker found another injection vector, inline scripts would be blocked by the browser.

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `c1655982d` | refactor: centralize pre-commit file filtering | 3 prod + 2 test | Extracts shared file-filtering logic into `scripts/pre-commit/filter-staged-files.mjs`. No security boundary changes. |
| `09566b169` | fix(discord): preserve channel session keys via channel_id fallbacks (#17622) | 10 prod + 5 test + 1 doc | Adds channel_id fallbacks for session key resolution across Discord message handling, routing, and diagnostics. No auth boundary changes. |
| `ddcc7a1a5` | fix(discord): dedupe native skill commands by skillName (#17365) | 1 prod + 1 test + 1 doc | Deduplicates native skill command registrations in Discord provider. No security changes. |
| (23 others) | Refactors for code sharing and deduplication | ~45 prod + ~15 test | Helper extraction, deduplication, device-pairing refactor, route normalization. No security boundary changes. |

### Audit Cross-Reference

| Audit Claim | Commits | Status |
|-------------|---------|--------|
| Audit 1 Claim 6 (Path traversal in agent dirs) | `a7cbce1b3` | **STRENGTHENED** — `/run`, `/var/run`, `/private/var/run` added to BLOCKED_HOST_PATHS, closing ancestor mount gap |
| Gap 2 (Sensitive data in logs) | `cf6990701` | **STRENGTHENED** — Telegram bot tokens now redacted in error messages and stack traces |
| Gap 3 (outPath validation) | `a7cbce1b3` | **STRENGTHENED** — Zod-level bind mount path validation rejects non-absolute source paths at config parse time |

**Unaffected Claims:** Audit 1 Claims 1-5, 7-8; Audit 2 Claims 1-8; Gap 1 (closed).

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
