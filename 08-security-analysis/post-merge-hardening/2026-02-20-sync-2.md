> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 20 Sync 2 — 41 Commits (15 Security)

**Merge commit:** c9dee5926 | **Range:** 4e1ff966c..c9dee5926

### Security-Relevant Commits

| SHA | Message | Files | Impact |
|-----|---------|-------|--------|
| c9dee5926 | refactor(security): centralize trusted sender checks for discord moderation | 11 | Trusted sender ID validation centralization |
| 81b19aaa1 | fix(security): enforce plugin and hook path containment | 14 | Symlink-resolved path containment for hooks/plugins |
| b40821b06 | fix: harden ACP secret handling and exec preflight boundaries | 14 | --token-file/--password-file CLI options, exec sandbox path assertion |
| 26c9b37f5 | fix(security): enforce strict IPv4 SSRF literal handling | 6 | Canonical decimal-only IPv4 parsing blocks legacy bypass forms |
| baa335f25 | fix(security): harden SSRF IPv4 literal parsing | 5 | Parse hex/octal/decimal IPv4 variants to detect private IPs |
| 5dc50b8a3 | fix(security): harden npm plugin and hook install integrity flow | 23 | npm integrity verification with --json pack output and drift callbacks |
| 2777d8ad9 | refactor(security): unify gateway scope authorization flows | 14 | Single `authorizeOperatorScopesForMethod` for RBAC enforcement |
| 3d7ad1cfc | fix(security): centralize owner-only tool gating and scope maps | 16 | Owner-only tool enforcement via `assertOwnerSender` helper |
| 775816035 | fix(security): enforce trusted sender auth for discord moderation | 15 | Trusted sender auth for Discord moderation actions |
| 3561442a9 | fix(plugins): harden discovery trust checks | 6 | Plugin discovery trust validation hardening |
| 77c748304 | refactor(plugins): extract safety and provenance helpers | 6 | Plugin safety/provenance extraction for security |
| e01011e3e | fix(acp): harden session lifecycle against flooding | 6 | Session rate limiting and flood protection |
| 742684891 | test(feishu): add mention regex injection regressions | 2 | Regex injection test coverage |
| 0bda0202f | fix(security): require explicit approval for device access upgrades | 2 | Device access upgrade approval gate |
| 7e67ab75c | fix(feishu): escape regex metacharacters in stripBotMention | 1 | Regex escape hardening in Feishu bot mention |

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| 10379e7dc | fix: harden voice-call tts deep merge | 3 | Extension hardening |
| 9130fd2b0 | ci: harden workflow action input handling | 6 | CI hardening |
| efca61e3a | test: share cron tool mock harness | 3 | Test helper |
| eb9861b20 | test: share memory manager bootstrap helper | 3 | Test helper |
| 2581b67cd | refactor: share exec approval request helper | 4 | Refactor |
| 3179097a1 | refactor: dedupe redact snapshot restore prelude | 2 | Refactor |
| ba538c98c | refactor: share plain object guard across config and utils | 4 | Refactor |
| a99fd8f2d | refactor: reuse daemon action response type in lifecycle core | 1 | Refactor |
| 672b1c508 | refactor: dedupe slack monitor mrkdwn and modal event base | 4 | Refactor |
| 29118995a | refactor(lobster): remove lobsterPath overrides | 8 | Refactor |
| 7a89049d1 | refactor: dedupe pending pairing request flow and add reuse tests | 5 | Refactor |
| d9046f0d2 | chore(deps): update dependencies to latest | 2 | Deps |
| 177654f52 | refactor: dedupe APNs push send flow and add wake default test | 2 | Refactor |
| 722a898f2 | refactor: dedupe openclaw root traversal and add coverage | 2 | Refactor |
| ffd4e8587 | refactor: share allow-from merge and sender-id checks | 5 | Refactor |
| 397f243de | refactor: dedupe gateway session guards and agent test fixtures | 3 | Refactor |

### Safe Commits (Not in Tables)

| SHA | Message | Reason |
|-----|---------|--------|
| f4b288b8f | refactor(feishu): dedupe mention regex escaping | Safe paths |
| b54ba3391 | fix: credit contributor in changelog | Docs only |
| f8b61bb4e | refactor(acp): split session tests and share rate limiter | Safe paths |
| 4ddc4dfd7 | test: dedupe fetch cleanup-throw signal harness | Test only |
| cf6edc6d5 | docs(changelog): credit allsmog for Lobster security report | Docs only |
| cb6b835a4 | test: dedupe heartbeat and action-runner fixtures | Test only |
| 79ab4927c | test: dedupe extracted-size budget assertions in archive tests | Test only |
| 182ffdf55 | test: dedupe zai env test setup and cover blank legacy key | Test only |
| 19348050b | style: normalize acp translator import ordering | Style only |
| d900d5efb | style: normalize ws message handler import ordering | Style only |

### Key Security Changes

#### 1. SSRF IPv4 Literal Hardening (`26c9b37f5`, `baa335f25`)

Enforces canonical decimal-only IPv4 parsing and detects alternate forms (hex, octal) that could bypass private IP detection.

- `src/infra/net/ssrf.ts:71` — `parseStrictIpv4Octet` function

#### 2. Plugin/Hook Path Containment (`81b19aaa1`)

Adds symlink-resolved path containment for hooks and plugins, preventing path traversal via symlinks.

- `src/security/scan-paths.ts:19` — `isPathInsideWithRealpath` function

#### 3. NPM Install Integrity Flow (`5dc50b8a3`)

Harden npm plugin and hook install with integrity verification using --json pack output and drift callbacks.

- `src/infra/install-source-utils.ts` — Integrity verification

#### 4. ACP Secret Handling (`b40821b06`)

Adds --token-file/--password-file CLI options to avoid process exposure, and exec sandbox path assertion before preflight reads.

- `src/acp/secret-file.ts:4` — `readSecretFromFile` function
- `src/agents/bash-tools.exec.ts:95` — Sandbox path assertion

#### 5. Gateway Scope Authorization Unification (`2777d8ad9`)

Unifies gateway scope authorization into single `authorizeOperatorScopesForMethod` for consistent RBAC enforcement.

- `src/gateway/method-scopes.ts:174` — `authorizeOperatorScopesForMethod` function

### NEW Files Created

- `src/agents/tools/discord-actions-moderation-shared.ts`
- `src/channels/allow-from.ts`
- `src/acp/secret-file.ts`
- `src/plugins/path-safety.ts`
- `src/infra/fixed-window-rate-limit.ts`

### Audit Cross-Reference

| Claim | Status |
|-------|--------|
| Claim 1 (SSRF protection) | **Affected** — IPv4 literal parsing hardening |
| Claim 2 (Gateway method auth) | **Affected** — Scope authorization unification |
| Claim 4 (File path sandboxing) | **Affected** — Plugin/hook path containment |
| Claim 12 (Secret file handling) | **Affected** — ACP secret file handling |
| Claim 13 (Plugin install integrity) | **Affected** — npm install integrity flow |
| Claim 14 (Hook path safety) | **Affected** — Path containment |
| Claim 15 (Discord moderation auth) | **Affected** — Trusted sender checks |
| Claim 16 (Session lifecycle security) | **Affected** — Session flood protection |

**Gap status:** No gaps closed in this sync. — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
