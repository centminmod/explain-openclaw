> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 19 sync 2 (51 commits, 3 security)

**Merge commit:** f9e67f3f4 | **Range:** c5056ed67..f9e67f3f4

### Security-Relevant Commits

| SHA | Message | Files | Security Impact |
|-----|---------|-------|-----------------|
| `2b8f1bade` | refactor(archive): share archive path safety helpers | 1 test + 3 prod | **Consolidates path traversal defenses** - extracts validation into dedicated module |
| `28d49b8d4` | refactor(auth-profiles): reuse cooldown timestamp resolver | 1 test + 2 prod | DRY refactoring of cooldown logic, no security boundary change |
| `288015a9f` | refactor(auth): share api key masking utility | 1 test + 3 prod | DRY consolidation of masking implementations, no security change |

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `0a7833153` | refactor(infra): share shell env timeout normalization | 1 test + 1 prod | Pure refactor: extracts `resolveTimeoutMs()` helper |
| `0d25b6a31` | perf(test): remove fixed sleeps in async test flows | 3 test | Test performance improvement |
| `29d3bb278` | refactor(device-pair): reduce duplicated gateway parsing | 1 prod | Refactor: extracts URL parsing helpers |
| `33f30367e` | fix(cli): include model and thinking fields in cron edit patch type | 1 test | Test type fix |
| `e71e9a55a` | fix(cli): align runtime capture helper with RuntimeEnv signature | 1 prod | Test helper signature fix |
| `57083e422` | iOS: add Apple Watch companion message MVP (#20054) | 1 test + 14 prod + 1 doc | New iOS feature |

**Detailed SHAs for test refactor commits (32 safe):**
- Test deduplication refactors: `f9e67f3f4`, `e8e47ff00`, `8ab90858b`, `5ae4595bb`, `64a10e64e`, `00e32cf04`, `818419b4c`, `50e5413c1`, `f05395ae0`, `72a4d8333`, `82cb18588`, `4605dfd2a`, `f3b75730d`, `a661eec0b`, `68be4611d`, `d77dcebcb`, `983a68c23`, `eb4f1e765`, `e5f13db13`, `98fac87a9`, `f5c370219`, `7648f6bb0`, `95d52b06d`, `c7bc94436`, `797a47c3c`, `a0d904dc2`, `1934eebbf`, `42025915d`, `33b0b38f6`, `41e68c31d`, `c7bfa818e`, `277d524fa`

### Key Hardening: Archive Path Safety Module

**Commit `2b8f1bade`** consolidates archive extraction path safety into a dedicated `src/infra/archive-path.ts` module (63 lines) with four exported functions:

1. **`isWindowsDrivePath()`** (lines 4-6) — Detects Windows absolute paths (`C:\`, `D:/`) to prevent cross-platform escapes
2. **`validateArchiveEntryPath()`** (lines 12-30) — Validates entry paths reject:
   - Path traversal via `../` sequences
   - Absolute paths (leading `/` or `//`)
   - Windows drive paths
3. **`stripArchivePath()`** (lines 32-48) — Mimics `tar --strip-components` semantics while preserving traversal attempts for downstream validation
4. **`resolveArchiveOutputPath()`** (lines 50-62) — Ensures resolved output paths stay within safe base directory via `resolveSafeBaseDir()`

**Consumers updated:**
- `src/infra/archive.ts:232-244` — ZIP extraction calls `validateArchiveEntryPath()` before extraction
- `src/infra/archive.ts:330-340` — TAR extraction calls `validateArchiveEntryPath()` before extraction
- `src/agents/skills-install-download.ts:7-10,173-180` — Skills download uses shared helpers with custom `escapeLabel: "targetDir"`

### CVE/GHSA Cross-Reference

This sync includes the fix for:
- **GHSA-v892-hwpg-jwqp** (HIGH): Path traversal (Zip Slip) in archive extraction — fixed by `2b8f1bade`
- **GHSA-h7f7-89mm-pqh6** (MEDIUM): Harden skill download target directory validation — fixed by `2b8f1bade`

### Audit Cross-Reference

| Claim | Status | Notes |
|-------|--------|-------|
| 6. Path traversal in agent dirs | Reinforced | Centralizes archive path safety in dedicated module |
| Other 15 claims | Unaffected | Pure refactoring with no security boundary changes |

**Legitimate gaps affected:** None. The `resolveArchiveOutputPath()` helper uses `resolveSafeBaseDir()` which indirectly reinforces path safety, but does not close any of the 3 remaining gaps.

### Line Reference Updates

Updated stale references in documentation:
- `open-upstream-issues.md:12` — Updated archive.ts references to new archive-path.ts module
- `open-upstream-issues.md:134-136` — Updated validation function locations
- `resource-usage.md:593,595,597,608` — Updated memory/internal.ts line shifts

### Production File Audit

Of the 9 post-triage flagged commits:
- **3 Tier A security commits** touch production code
- **3 Tier B commits** touch production code (0a7833153, 29d3bb278, 57083e422)
- **3 Tier B commits** are test-only (0d25b6a31, 33f30367e, e71e9a55a)

Of the 32 safe commits: most are test deduplication refactors with no security implications.

---

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
