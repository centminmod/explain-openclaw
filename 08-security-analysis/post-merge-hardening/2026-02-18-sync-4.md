# Feb 18 Sync 4 (32 commits, 4 security)

> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

**Merge commit:** f8adfcf60 | **Range:** 39c5e8cc7..f8adfcf60

## Security-Relevant Commits

| SHA | Message | Files | Description |
|-----|---------|-------|-------------|
| `4b40bdb98` | fix(telegram): clear offsets on token change | 1 prod + 1 test + 1 doc | Clears Telegram update offsets when bot tokens change. `channelsAddCommand` at `src/commands/channels/add.ts:53-71` compares previous and new tokens, calls `deleteTelegramUpdateOffset()` at line 230. Prevents stale offset state after token rotation. |
| `1486eb66f` | revert(gateway): restore loopback auth setup | 2 prod + 1 test | Reverts changes that would skip gateway auth for loopback-only gateways. Restores auth prompt in `configure.gateway.ts`, ensuring all gateways require auth configuration. Defense-in-depth for gateway security. |
| `52b624cca` | fix(doctor): audit env-only gateway tokens | 1 prod + 1 test + 1 doc | Adds `resolveGatewayAuthToken()` at `src/commands/doctor-gateway-services.ts:53` to prioritize config tokens over env vars (`OPENCLAW_GATEWAY_TOKEN` or `CLAWDBOT_GATEWAY_TOKEN`). Used at lines 128 and 185 for service audit and repair. Ensures env-only tokens are properly validated. |
| `826e62a3b` | fix(sessions): purge deleted transcript archives | 2 prod + 1 test + 1 doc | Adds `cleanupArchivedSessionTranscripts()` at `src/gateway/session-utils.fs.ts:222` to remove old archived transcript files (`.deleted.` and `.bak.` suffixes). Called from `store.ts` at line 557 during session pruning. Prevents accumulation of stale session data. |

## Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `65fa529e0` | Revert "fix(whatsapp): allow per-message link preview override..." | 4 prod + 2 test | WhatsApp link preview feature revert (UX, not security) |
| `67014228c` | fix(subagents): harden announce retry guards | 3 prod + 2 test | Subagent retry logic reliability (not security controls) |
| `759c7fc18` | revert(voice-call): remove cached inbound greeting | 3 prod | Removes voice call greeting cache (performance feature) |
| `950f36fef` | revert(voice-call): undo oxfmt formatting pass | 2 prod | Import order formatting (code style) |
| `ffe1ba68b` | revert(voice-call): undo cached greeting note | 1 prod | Comment cleanup (documentation) |
| `df8f7ff1a` | docs(voice-call): document stale call reaper config | 1 prod + 2 test | Documentation update for voice call config |
| `7a00f056a` | revert(sandbox): revert SHA-1 slug restoration | 2 prod | Restores SHA-1 for backward compatibility (no security impact) |
| `f8adfcf60` | test(agents): cover exec non-zero exits | 1 prod + 1 test | Test coverage for existing behavior |
| `f7d2e15a2` | test: stabilize infra tests | 4 prod + 1 test | Test stability improvements |
| `b7cf28f40` | test(docker): cover browser install build arg | 1 prod + 1 test | Test coverage |
| `bfaa03981` | test(voice-call): cover stream disconnect auto-end | 1 prod + 1 test | Test coverage |
| `def025416` | test(session): cover stale threadId fallback | 1 prod + 1 test | Test coverage |
| `6b8c0bc69` | chore: Format files. | 5 prod | Import reordering (code style) |
| `cf6cdc74d` - `db3529e92` | chore: Fix types in tests 14/N - 23/N | various test files | Type fixes in test files |

**Originally safe (5):** 833c646ec, ecfc5a5ee, 68634468f, 78c3e5166, d137f3328 — all test-only or formatting changes.

## Audit Cross-Reference

| Commit | Audit Claim | Impact |
|--------|-------------|--------|
| 4b40bdb98 | None | Token rotation hygiene (defense-in-depth) |
| 1486eb66f | Claim 5 (no RBAC) | Ensures auth required for all gateways |
| 52b624cca | Claim 1 (token storage) | Token validation improvement |
| 826e62a3b | None | Session data cleanup (defense-in-depth) |

**Unaffected Claims:** All other audit claims and legitimate gaps remain unchanged.

## Notes

- High initial flag rate (84.4%, 27/32) due to test files triggering security pattern matches
- Triage correctly demoted 16 test/chore commits as non-security
- The formatting commit `6b8c0bc69` only reordered imports — no function definitions shifted
- 30 security advisories in GitHub; none addressed by this batch

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
