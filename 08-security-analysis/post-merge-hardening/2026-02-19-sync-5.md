> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 19 Sync 5 (29 commits)

**Merge commit:** 89a0b95af | **Range:** d968e64f2..89a0b95af

### Summary

Non-security batch — 29 commits of test deduplication and code refactoring. No security-relevant changes to production code.

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| 89a0b95af | refactor(security): reuse shared allowlist normalization | 2 prod | Deduplicates `normalizeStringEntries` helper across security/doctor files — pure refactor |
| 54e9924fc | refactor(agents): dedupe subagent inline text extraction | 1 prod | Extracts `extractInlineTextContent` helper — pure refactor |
| 3267f0926 | refactor(node-host): extract invoke result helpers | 1 prod | Extracts `sendJsonPayloadResult`, `sendErrorResult`, etc. — pure refactor |
| a37660581 | refactor(infra): dedupe APNs send context setup | 1 prod | APNs push notification refactor — no security logic |
| aa8f87a3b | refactor(plugins): reuse plugin loader logger adapter | 5 prod + 1 test | Plugin logging refactor — no security logic |
| a8ebe942a | refactor(cli): share camera clip file writer | 3 prod + 1 test | Extracts `writeCameraClipPayloadToFile` — pure refactor |
| e368e74a9 | test: dedupe validate-turns identity cases | 1 test | Test-only |
| 002f158da | test: merge empty-id sanitize mode checks | 1 test | Test-only (sanitize tests already exist) |
| 595246b58 | test: merge context-window overflow variants | 1 test | Test-only |
| cea586ba5 | test: merge skills-cli json output cases | 1 test | Test-only |
| 5d9517767 | refactor(config): share media provider request fields | 1 prod | Extracts `MediaProviderRequestConfig` type — pure refactor |
| 3f621d13f | refactor(cli): dedupe browser debug and download opts | 2 prod | Browser CLI refactor — no security logic |
| 0048af4e2 | refactor(commands): dedupe auth-choice model notes | 4 prod | Extracts `createAuthChoiceAgentModelNoter` — UI helper only |
| 4e62bdf78 | refactor(signal): reuse shared reaction types | 1 prod | Signal adapter refactor — no security logic |
| 136bd59ba | refactor(shared): centralize @/# slug normalization | 3 prod + 1 test | Extracts `normalizeSlug` helper — pure refactor |
| b36627903 | refactor(shared): reuse node list parsers across cli and tools | 3 prod + 1 test | Extracts `parseNodeListString` — pure refactor |
| 3b7c8fe79 | refactor(cli): extract shared node media helpers | 4 prod + 1 test | Extracts media helpers — pure refactor |
| 65ef7fb4a | test: dedupe empty-input mmr assertions | 1 test | Test-only |
| 317441d09 | test: reuse chat-not-found assertion helper | 1 test | Test-only |
| 281e9110c | test: table-drive format-time timestamp assertions | 1 test | Test-only |
| 20849df70 | test: merge media invalid-path scenarios | 1 test | Test-only (path traversal tests already exist) |
| 6f3a6013e | test: table-drive poll duration clamp cases | 1 test | Test-only |
| 5e7e63250 | test: merge base64 oversize guard variants | 1 test | Test-only (oversize guard tests already exist) |
| d743332d8 | test: table-drive mime mapping assertions | 1 test | Test-only |
| de826a62f | test: merge telegram reaction scenarios | 1 test | Test-only |
| 03241498f | test: table-drive telegram thread param cases | 1 test | Test-only |
| c25a18493 | test: merge direct announce origin variants | 1 test | Test-only |
| 1a030a544 | test: table-drive sandbox formatter assertions | 1 test | Test-only |
| c8e02329c | test: dedupe subagent announce fallback and thread assertions | 1 test | Test-only |

### Audit Cross-Reference

**Unaffected Claims:** All 16 audit claims and 3 legitimate gaps remain unchanged. The refactors touch:
- `src/security/audit-channel.ts` — only deduplicates `normalizeAllowFromList` to use shared helper
- `src/commands/doctor-security.ts` — uses same shared helper for allowlist normalization
- No changes to env var handling, sandbox config, OAuth, webhook validation, or path safety

### Line Number Shifts

| File | Old | New | Context |
|------|-----|-----|---------|
| `src/agents/subagent-announce.ts` | :822-833 | :908-923 | `statsLine` shifted +86 lines from `extractInlineTextContent` extraction |
| `src/agents/subagent-announce.ts` | :621-623 | :705-707 | `SILENT_REPLY_TOKEN` usage shifted +84 lines |
| `src/node-host/invoke.ts` | :44-174 | :45-175 | `blockedEnvKeys` blocklist +1 line from helper extraction |
| `src/agents/tools/nodes-tool.ts` | :344-347 | :353-357 | `outPath` handling shifted from camera clip refactor |

### New Files

- `src/cli/nodes-media-utils.ts` — shared media helpers (extracted from nodes-camera.ts)
- `src/cli/nodes-media-utils.test.ts`
- `src/plugins/logger.ts` — plugin loader logger adapter
- `src/plugins/logger.test.ts`
- `src/shared/node-list-parse.ts` — node list parser (extracted from nodes-tool.ts, nodes-cli/format.ts)
- `src/shared/node-list-parse.test.ts`
- `src/shared/string-normalization.ts` — `normalizeStringEntries`, `normalizeSlug` helpers

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
