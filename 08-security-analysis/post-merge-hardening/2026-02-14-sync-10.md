> **Navigation:** [Post-merge Hardening Index](../post-merge-hardening.md) | [Main Guide](../../README.md)

# Post-Merge Hardening — Feb 14 sync 10 (48 commits)

**Merge commit:** `dcee9cea1` | **Range:** `f4124f654..84ed9ab55` | **Date:** 2026-02-14

## Security-Relevant Commits

1. **`748d6821d`** — **fix(config): add forensic config write audit and watch attribution:** Adds a `config-audit.jsonl` audit log that records every config write with forensic details: PID, PPID, CWD, argv, watch mode state, previous/next content hashes, byte sizes, `meta` presence, and gateway mode changes. A `resolveConfigWriteSuspiciousReasons()` function flags anomalies: size drops >50%, missing meta before write, and gateway-mode removal. The audit log is written to `$STATE_DIR/logs/config-audit.jsonl` with `0o600` permissions in a `0o700` directory. Best-effort — write failures are silently caught. Files: `src/config/io.ts`, `src/config/io.write-config.test.ts`, `apps/macos/Sources/OpenClaw/OpenClawConfigFile.swift`, `scripts/watch-node.mjs`, `src/cli/gateway-cli/run.ts`.

2. **`3b5a9c14d`** (PR [#15833](https://github.com/openclaw/openclaw/pull/15833)) — **Fix: Preserve Per-Agent Exec Override After Session Compaction:** Previously, `compactEmbeddedPiSessionDirect()` in `src/agents/pi-embedded-runner/compact.ts` called `resolveExecToolDefaults(params.config)` which only read global exec config, ignoring per-agent overrides. After session compaction, agents configured with restricted exec permissions (e.g., `security: "strict"`) would revert to global defaults, potentially escalating privileges. Fix: removed `resolveExecToolDefaults()` from compact.ts and updated `resolveExecConfig()` in `src/agents/pi-tools.ts` to merge per-agent config from `resolveAgentConfig()` with agent-level values taking precedence via `??` fallback chain. The unused `resolveExecToolDefaults` function was removed from `src/agents/pi-embedded-runner/utils.ts`.

3. **`8c3cc793b`** (PR [#15635](https://github.com/openclaw/openclaw/pull/15635), thanks @lailoo) + **`534e4213a`** (PR [#15502](https://github.com/openclaw/openclaw/pull/15502)) — **fix: dedupe before_tool_call in embedded runtime + fix(hooks): deduplicate before_tool_call hook in toToolDefinitions:** The `before_tool_call` hook was firing twice per tool execution — once in `handleToolExecutionStart()` (`src/agents/pi-embedded-subscribe.handlers.tools.ts`) and once in `toToolDefinitions()` (`src/agents/pi-tool-definition-adapter.ts`). For security hooks that enforce tool policies, double-firing could cause spurious blocks or inconsistent state. Fix: removed the duplicate hook call from `handleToolExecutionStart()`, added `isToolWrappedWithBeforeToolCallHook()` symbol-based detection to `toToolDefinitions()` so it skips the hook for already-wrapped tools, and introduced `consumeAdjustedParamsForToolCall()` with a bounded map (`MAX_TRACKED_ADJUSTED_PARAMS = 1024`) to pass adjusted params between the wrapped execute and the after_tool_call hook.

4. **`c4d2061a7`** (PR [#15480](https://github.com/openclaw/openclaw/pull/15480)) — **Web UI: allow img tags in DOMPurify so markdown images render in webchat:** Adds `"img"` to DOMPurify `ALLOWED_TAGS` and `"src"`, `"alt"` to `ALLOWED_ATTR` in `ui/src/ui/markdown.ts`. Also adds `ADD_DATA_URI_TAGS: ["img"]` allowing data URIs in image sources. This intentionally expands the sanitization allowlist — data URIs cannot execute JavaScript in img src (browsers block it), but they can encode tracking pixels. The existing `htmlEscapeRenderer` (added in sync-3, `ui/src/ui/markdown.ts:119`) prevents raw HTML injection before DOMPurify runs, providing defense-in-depth.

5. **`dbe026214`** (PR [#15274](https://github.com/openclaw/openclaw/pull/15274)) — **fix(routing): exclude peer-specific bindings from guild-wide matching:** Major refactor of `src/routing/resolve-route.ts`. Previously, separate `matchesPeer()`, `matchesGuild()`, `matchesTeam()`, `matchesRoles()` functions were called in a cascading if-else chain. A peer-specific binding (e.g., for `user:123`) could be matched at the guild tier if the guild ID also matched, ignoring the peer constraint — routing messages to the wrong agent. Fix: introduced `NormalizedBindingMatch` type with explicit `NormalizedPeerConstraint` states (`none`/`invalid`/`valid`), a unified `matchesBindingScope()` function, and a tier-based matching loop that evaluates all constraint dimensions together. Each tier specifies which `scopePeer` to use, ensuring peer-specific bindings only match when the peer matches.

6. **`1d01bb1c8`** (PR [#15599](https://github.com/openclaw/openclaw/pull/15599)) — **fix(telegram): scope default account skill commands to resolved agent:** In `src/telegram/bot-native-commands.ts`, `boundAgentIds` previously only included the resolved agent if the route was a `binding.*` match. When the route was `default`, skill commands from all agents were exposed. Fix: removed the `matchedBy.startsWith("binding.")` check so `boundAgentIds` always includes the resolved agent, preventing skill command leakage to unrelated agents.

7. **`9443c638f`** (PR [#15892](https://github.com/openclaw/openclaw/pull/15892)) — **voice-call: hang up rejected inbounds, idempotency and logging:** Rejected inbound calls are now explicitly hung up via `hangUpCall()` instead of being left in a dangling state. Added idempotency checks to prevent duplicate event processing. Files: `extensions/voice-call/src/manager.ts`, `extensions/voice-call/src/manager/events.ts`, `extensions/voice-call/src/manager/context.ts`, `extensions/voice-call/src/manager/store.ts`.

8. **`89fa93ed7`** (PR [#15343](https://github.com/openclaw/openclaw/pull/15343)) — **feat: support freshness parameter for Perplexity web_search provider:** Adds a `freshness` parameter to the web_search tool schema (`src/agents/tools/web-search.ts:64-69`). Maps normalized values (`pd`/`pw`/`pm`/`py`) to Perplexity's `search_recency_filter` and passes Brave's `freshness` as a query parameter. The parameter is user-controlled but validated to known values via the mapping function (`freshnessToPerplexityRecency`). Brave passes the raw value directly as a URL query parameter — arbitrary strings could be sent but Brave's API rejects unknown values.

9. **`8316571ef`** (PR [#15878](https://github.com/openclaw/openclaw/pull/15878)) — **fix(venice): disable streaming to prevent SDK crash:** Adds `venice` to the set of providers that force `stream: false` in `src/agents/venice-models.ts`, preventing SDK crashes from malformed streaming responses.

10. **`2b154e045`** (PR [#14962](https://github.com/openclaw/openclaw/pull/14962)) — **fix(mattermost): add WebSocket reconnection with exponential backoff:** Extracted WebSocket monitoring and reconnection into `extensions/mattermost/src/mattermost/monitor-websocket.ts` and `reconnect.ts`. Implements exponential backoff (1s→60s) with jitter for reconnection, preventing message loss and thundering herd during Mattermost server restarts.

11. **`13aface86`** (PR [#15280](https://github.com/openclaw/openclaw/pull/15280)) — **fix(config): accept $schema key in root config:** Adds `$schema` to the config schema allowlist in `src/config/schema.ts` and `src/config/zod-schema.ts`, preventing validation errors when editors add JSON Schema references.

## Non-Security Changes (summary)

- 30+ commits are `perf(test):` changes — test deduplication, fixture optimization, vmForks mode, and parallel test execution improvements. No production code changes.
- `refactor(voice-call): split manager into facade and context slices` — code organization only.
- `refactor(media): centralize voice compatibility policy` — consolidates audio format checks.
- `refactor(memory): unify embedding provider constants` + `fix(memory): use QAT variant of embedding model` — changes default local embedding model from `embeddinggemma-300M-GGUF` to `embeddinggemma-300m-qat-q8_0-GGUF` for better quality.
- `chore(release): publish 2026.2.13 appcast` — release metadata.
- `docs:` changelog reordering.

## Commit Chain Detection (Phase 5c)

- **Config audit chain:** `748d6821d` (forensic audit) follows `3691631fd` (silence non-audit logs in tests) — the test commit adds log suppression specifically for the audit logging.
- **Hook dedupe chain:** `8c3cc793b` (embedded runtime fix) builds on `534e4213a` (toToolDefinitions fix) — both address the same double-firing bug from different execution paths.
- **Routing + Telegram chain:** `dbe026214` (routing refactor) fixes the binding scope that `1d01bb1c8` (telegram scoping) relies on. The telegram fix narrows skill command exposure while the routing fix ensures bindings match correctly.
- **Memory chain:** `5219f7461` (QAT model) → `61b513326` (align docs/tests) → `03fee3c60` (unify constants) — sequential refinement of embedding model defaults.

## Line Number Shifts

The forensic config audit logging in `748d6821d` adds ~200 lines to `src/config/io.ts` (new types, helper functions, audit record builder, append function), causing significant shifts. The freshness parameter in `89fa93ed7` adds ~30 lines to `src/agents/tools/web-search.ts`. The readability memoization in `0b52a520d` adds ~20 lines to `src/agents/tools/web-fetch-utils.ts`.

### `src/config/io.ts` (was 960 lines → now 1,156 lines, +196)

| Reference | Previous | Current | Shift |
|-----------|----------|---------|-------|
| `rotateConfigBackups()` | `:291-310` | `:343-362` | +52 |
| fail-open `return {}` (#5052) | `:550-553` | `:651,654` | +101 |
| `writeConfigFile` range (#9627) | `:748-893` | `:849-1067` | +101/+174 |
| 0o700 mkdir | `:818` | `:919` | +101 |
| 0o600 writeFile | `:852` | `:1027` | +175 |

### `src/agents/tools/web-search.ts`

| Reference | Previous | Current | Shift |
|-----------|----------|---------|-------|
| X-Title header | `:448-449` | `:481-482` | +33 |
| X-Title (table ref) | `:449` | `:482` | +33 |
| Grok API headers | `:502-508` | `:527-535` | +25/+27 |
| Brave Search headers | `:632-637` | `:660-663` | +28/+26 |
| `wrapWebContent` calls | `:577,604,654,656` | `:603,630,680,682` | +26 |

### `src/agents/tools/web-fetch-utils.ts`

| Reference | Previous | Current | Shift |
|-----------|----------|---------|-------|
| script/style/noscript strip | `:31-34` | `:59-61` | +28 |

### `src/memory/embeddings.ts`

| Reference | Previous | Current | Shift |
|-----------|----------|---------|-------|
| DEFAULT_LOCAL_MODEL | `:58` | `:65-66` | +7 |
| EmbeddingProviderId type | `:32-34` | `:32` | 0 |

### `ui/src/ui/markdown.ts`

| Reference | Previous | Current | Shift |
|-----------|----------|---------|-------|
| htmlEscapeRenderer | `:132-133` | `:119` | -14 |

## CVE/GHSA Coverage

No new CVE or GHSA references in this batch.

## Phase 8: Self-Check

- [x] All 48 commits audited via `git diff-tree` (Phase 5b)
- [x] Commit chains identified (Phase 5c)
- [x] Security-relevant commits analyzed with file:line references
- [x] Line number shifts computed for all referenced files
- [x] No CVE/GHSA references found (Phase 6c)
- [x] TOC entry added to post-merge-hardening.md
