> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 16 sync 2 — 60 commits)

**Merge commit:** 7773c5410 | **Range:** 65c527bef..7773c5410
156 files changed, 3058 insertions, 1967 deletions. **LARGE REFACTOR** (5025 net lines). Triage: 26 initially flagged → 20 after Haiku triage (8 demotions, 2 promotions). 7 security-relevant commits identified out of 20 deep-analyzed.

### Security-Relevant Commits (7)

1. **`a0e763168`** — **refactor(exec-approvals): share socket default merge.** New `mergeExecApprovalsSocketDefaults()` at `src/infra/exec-approvals.ts:244` centralizes socket path and authentication token default merging across gateway exec-approval handler (`src/gateway/server-methods/exec-approvals.ts:137`) and node-host invocation (`src/node-host/invoke.ts`). Tests in `src/infra/exec-approvals.socket-defaults.test.ts` verify preference cascading (normalized → current → default). Mitigates token handling consistency risks. **Audit 2 Claim 6** (token field shifting) — maintains RSA-signed token integrity through unified socket defaults.

2. **`b6069fc68`** — **feat: support per-channel ackReaction config (#17092).** New `resolveAckReaction()` at `src/agents/identity.ts:13` implements 4-level fallback hierarchy (account → channel → global config → agent emoji). Comprehensive test coverage in `src/agents/identity.test.ts` prevents unintended precedence skips. New config types in `src/config/types.discord.ts`, `src/config/types.slack.ts`, `src/config/types.telegram.ts`. Security note: proper precedence cascading prevents unintended fallback behavior where a channel could inherit an unintended reaction configuration.

3. **`c6b3736fe`** — **fix: dedupe probe/token base types (#16986) (thanks @iyoda).** Introduces `BaseProbeResult` and `BaseTokenResult` type hierarchies across 23 files — all channel plugins (Discord, Telegram, Signal, Slack, LINE, iMessage) and extensions (BlueBubbles, Feishu, IRC, Matrix, Mattermost, MS Teams, Twitch, Zalo). Type consistency ensures common validation interface for authentication credentials across plugins. **Audit 1 Claim 8** (token expiry validation) — enforces common base validation interface.

4. **`3ce0e80f5`** — **refactor(commands): dedupe cleanup path resolution.** New `buildCleanupPlan()` at `src/commands/cleanup-utils.ts:32` and `isPathWithin()` at line 49 centralize path containment checks for config/oauth/workspace directories. Unit tests in `src/commands/cleanup-utils.test.ts` verify containment logic. Unifies security boundary checking across `reset.ts` and `uninstall.ts` commands. **Audit 1 Claims 5-6** (file permission checks, path traversal) — unified path validation.

5. **`9adcccadb`** — **Outbound: scope core send media roots by agent (#17268).** Adds `agentId` parameter to message send pipeline: `MessageSendParams.agentId` at `src/infra/outbound/message.ts:35`, `OutboundSendContext.agentId` at `src/infra/outbound/outbound-send-service.ts:26`. New `OutboundSendPolicy.enforceAgentScope()` at `src/infra/outbound/outbound-policy.ts`. Tests in `src/infra/outbound/message.test.ts` and `outbound-send-service.test.ts` verify agentId threading to delivery layer. **Audit 2 Claim 2, Legitimate Gap #3** (outPath validation) — enables per-agent media sandboxing for outbound messages.

6. **`a76777759`** — **refactor(skills): dedupe env overrides.** Extracts `applySkillConfigEnvOverrides()` helper in `src/agents/skills/env-overrides.ts`. Type aliases `EnvUpdate` and `SkillConfig` improve auditability. Centralized reverter function (`createEnvReverter()`) ensures cleanup of environment variable modifications. **Audit 2 Claim 8, Legitimate Gap #1** (env variable injection) — centralizes env override logic for easier auditing.

7. **`9203a2fdb`** — **Discord: CV2! (#16364).** Major Discord component v2 rewrite across 22 files (745+ insertions). Key security changes: component validation types (`DiscordSendComponents` type casting in `src/discord/send.shared.ts`), enhanced exec-approval handling in `src/discord/monitor/exec-approvals.ts` (now 807+ lines with `DiscordExecApprovalHandler` class at line 314, `ExecApprovalButton` at line 733), new UI helpers in `src/discord/ui.ts`. Tests in `src/discord/monitor/exec-approvals.test.ts` validate approval flow changes. **Audit 2 Claim 5** (self-approving agent) — improves approval validation framework with structured component interactions.

### Additional Security-Adjacent Commits (5)

8. **`7773c5410`** — **refactor(telegram): share allowFrom normalization.** New `normalizeTelegramAllowFromEntry()` at `src/channels/telegram/allow-from.ts:1` removes `@` prefix and whitespace from allowlist entries. Used by `doctor-config-flow.ts` and `security/audit-channel.ts` for consistent allow-list entry parsing. Related to **GHSA-mj5r-hh7j-4gxf** (Telegram allowlist mutable usernames).

9. **`813b96a80`** — **refactor(commands): share cleanup plan resolver.** New `resolveCleanupPlanFromDisk()` in `src/commands/cleanup-plan.ts` unifies config/oauth/state directory resolution across `reset.ts` and `uninstall.ts`.

10. **`2e758d369`** [PROMOTED] — **refactor(gateway): share node event sessionKey parsing.** Extracted `parseSessionKeyFromNodeEvent()` helper in `src/gateway/server-node-events.ts`. Session key parsing is security-relevant for gateway authentication routing.

11. **`1f1e97674`** [PROMOTED] — **refactor(allowlists): share user entry collection.** New helpers in `src/channels/allowlists/resolve-utils.ts` with tests in `resolve-utils.test.ts`. Allowlist resolution affects authorization decisions for Discord and Slack providers.

12. **`bf61d9408`** — **refactor(cli): dedupe daemon install finalize.** New `installDaemonServiceAndEmit()` at `src/cli/daemon-cli/response.ts:85` deduplicates install success/failure handling across daemon-cli and node-cli paths.

### Non-Security Commits (48)

| Category | Count | SHAs |
|----------|-------|------|
| Sandbox helpers | 4 | `afa544424`, `5457f6e7e`, `d4476c689`, `b567ba5df` |
| Line/config schema | 4 | `9f393a045`, `c906121ad`, `fabe4807a`, `6e36d956d` |
| Model commands | 4 | `04f00f8ef`, `cbf6ee3a6`, `d23848333`, `910e1e52d`, `d4c7b0505` |
| Auto-reply/reply | 5 | `ca4c2b33d`, `aa4d212a0`, `3a3bfa7f1`, `ac75cc349`, `b74c3d80c` |
| Discord UI | 3 | `63ab5bfdd`, `ac3db098a`, `b4f16001a` |
| Allowlists/channels | 3 | `25be51967`, `1ab5fcc32`, `da2fde7b6` |
| CLI/config | 4 | `dce3e4bd9`, `08f16da8d`, `fe303fc01`, `c1bf99406` |
| Gateway/plugins | 4 | `01ca3da8e`, `2e758d369`, `3783cd385`, `9143f33a8` |
| Infra/agents | 5 | `5c88d3c9f`, `b3ef3fca7`, `9084c4e34`, `f4782e1e7`, `e89c7b773` |
| Other | 5 | `2da512e24`, `94eb50658`, `dda3026d1`, `8da99247f`, `95355ba25` |
| Test-only (demoted) | 5 | `65f8b46c1`, `be9b5cefb`, `6277698f8`, `b2c42697d`, `10feda100` |
| Bug fix (demoted) | 2 | `cc0bfa0f3`, `d23848333` |

### Commit Chains

- `65f8b46c1` + `be9b5cefb` (test stabilization, shared: `exec-approvals.test.ts`)
- `c6b3736fe` + `b6069fc68` (shared: `CHANGELOG.md`)
- `63ab5bfdd` + `ac3db098a` (Discord component refactoring)
- `9f393a045` + `1ab5fcc32` (LINE bot-handlers refactoring)
- `c906121ad` + `fabe4807a` (LINE config-schema chain)
- `910e1e52d` + `d4c7b0505` (model fallback key chain)

### Line Number Shifts

| File | Old ref | New ref | Symbol | Verified |
|------|---------|---------|--------|----------|
| `src/infra/exec-approval-forwarder.ts` | `70-77` | `53-60` | `matchSessionFilter()` | VERIFIED via rg |
| `src/discord/monitor/exec-approvals.ts` | `270-273` | `395` | `buildGatewayConnectionDetails()` usage | VERIFIED via rg |

Other doc-referenced files that changed in this merge (`tool-policy.ts`, `sandbox/context.ts`, `node-host/invoke.ts`, `tools-invoke-http.ts`) were verified — **no line shifts** for current-state references.

### Audit Cross-Reference

**Audit 1 (Issue #1796) affected:**
- Claim 5 (Insufficient file permission checks) → addressed by `buildCleanupPlan()` + `isPathWithin()` (3ce0e80f5)
- Claim 6 (Path traversal in agent dirs) → addressed by centralized path containment (3ce0e80f5)
- Claim 8 (Insufficient token expiry validation) → addressed by base type hierarchy (c6b3736fe)

**Audit 2 (Medium article) affected:**
- Claim 2 (Arbitrary write via outPath) → addressed by agent-scoped media roots (9adcccadb)
- Claim 5 (Self-approving agent/no RBAC) → improved by Discord CV2 approval framework (9203a2fdb)
- Claim 6 (Token field shifting) → maintained by unified socket defaults (a0e763168)
- Claim 8 (Env variable injection) → centralized for auditing (a76777759)

**Legitimate Gaps affected:**
- Gap 1 (Gateway-side env var blocklist) → env-overrides refactoring enables easier auditing (a76777759)
- Gap 2 (Pipe-delimited token format) → mitigated by centralized socket defaults (a0e763168)
- Gap 3 (outPath validation) → partially addressed by agent-scoped media roots (9adcccadb)

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
