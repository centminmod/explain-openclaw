> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 17 sync 7 (60 commits)

**Merge commit:** 726ad45c7 | **Range:** 60380d1e3..726ad45c7

### Summary

This batch contains 4 security-relevant commits (1 HIGH, 3 MODERATE) centered on defense-in-depth consolidation: URL allowlist centralization for SSRF protection, improved Windows bind mount path parsing, unified input file limit enforcement, and device auth scope normalization. The remaining 56 commits are infrastructure refactors, reverts of recent experimental features, test type fixes, cron session namespace routing enhancements, and a large reformatting pass.

### Security-Relevant Commits (4)

| SHA | Message | Files | Notes |
|-----|---------|-------|-------|
| `a6466f257` | refactor(web-tools): share URL allowlist resolver | 3 prod + 0 test | HIGH — URL allowlist consolidation for SSRF protection |
| `6244ef9ea` | fix: handle Windows and UNC bind mount parsing | 1 prod + 1 test | MODERATE — bind mount path separator robustness |
| `37c97964a` | refactor(media): centralize input file limit resolution | 3 prod + 0 test | MODERATE — input constraint unification |
| `b9aed3a07` | refactor(infra): reuse device auth scope normalization | 1 prod + 0 test | MODERATE — device auth scope consistency |

---

**`a6466f257` — refactor(web-tools): share URL allowlist resolver (HIGH)**

Centralizes URL allowlist resolution for SSRF protection by extracting `resolveWebUrlAllowlist()` at `src/agents/tools/web-shared.ts:11` — a shared helper used by both web-fetch and web-search tools. Previously each tool contained independent URL allowlist parsing logic; now both delegate to the single verified implementation. Ensures consistent allowlist validation across all web tool integrations.

- `src/agents/tools/web-shared.ts:11` — `resolveWebUrlAllowlist()` extracts `urlAllowlist` from web config objects
- `src/agents/tools/web-fetch.ts:78` — `resolveFetchUrlAllowlist()` delegates to `resolveWebUrlAllowlist()`

**Audit 2 Claim 4** (DNS rebinding SSRF via web-fetch): Directly relevant — consolidating URL allowlist logic in a single auditable function reduces risk of inconsistent validation between web tool integrations.

---

**`6244ef9ea` — fix: handle Windows and UNC bind mount parsing (MODERATE)**

Improves bind mount path parsing in `splitBindSpec()` at `src/agents/sandbox/fs-paths.ts:63` by extracting Windows drive-letter and UNC path separator detection into a new internal helper `getHostContainerSeparatorIndex()` at `src/agents/sandbox/fs-paths.ts:82`. Replaces naive string splitting with explicit separator iteration that handles Windows drive letters and UNC paths correctly, reducing path traversal risk in bind mount specifications.

- `src/agents/sandbox/fs-paths.ts:63` — `splitBindSpec()` refactored for Windows/UNC support
- `src/agents/sandbox/fs-paths.ts:82` — new `getHostContainerSeparatorIndex()` internal helper

**Audit 1 Claim 6** (path traversal in agent dirs via bind mounts): Defense-in-depth improvement via more robust separator detection.

---

**`37c97964a` — refactor(media): centralize input file limit resolution (MODERATE)**

Extracts `resolveInputFileLimits()` at `src/media/input-files.ts:171` consolidating all file upload constraint logic — size limits, MIME type allowlists via `normalizeMimeList()`, PDF page/pixel constraints, redirects, and timeouts — into a single reusable implementation. Previously duplicated across gateway HTTP and media-understanding code paths. Ensures consistent enforcement of upload boundaries.

- `src/media/input-files.ts:171` — `resolveInputFileLimits()` unifies file upload constraints

**Audit 2 Claim 2** (arbitrary write via outPath): Defense-in-depth — consistent limit enforcement reduces upload boundary exposure.

---

**`b9aed3a07` — refactor(infra): reuse device auth scope normalization (MODERATE)**

Extracts device auth scope normalization into a shared `normalizeDeviceAuthScopes()` at `src/shared/device-auth.ts:18`, replacing inline normalization in four code paths within `src/infra/device-pairing.ts` (approveDevicePairing, verifyDeviceToken, ensureDeviceToken, rotateDeviceToken). Eliminates inconsistency risk in scope handling across device pairing workflows.

- `src/shared/device-auth.ts:18` — `normalizeDeviceAuthScopes()` consolidates scope array normalization

**Audit 1 Claims 2 & 5** (OAuth scope handling, file permissions): Defense-in-depth via consistent scope normalization across all device auth paths.

---

### Non-Security Commits (56)

#### Reverts (9)

| SHA | Message | Files |
|-----|---------|-------|
| `726ad45c7` | Revert "fix: add windowsHide: true to spawn in runCommandWithTimeout" | 1 prod |
| `22b2a77b3` | Revert "fix(docker): ensure memory-lancedb deps installed in Docker image" | 1 prod |
| `63aa5c5a4` | Revert "fix: remove stderr suppression so install failures are visible in build logs" | 1 prod |
| `25126d75c` | Revert "Agents: improve Windows scaffold helpers for venture studio" | 9 mixed |
| `37064e5cc` | Revert "feat(docker): add init script support via /openclaw-init.d/" | 2 prod |
| `09c82a1fb` | Revert "fix: capture init script exit codes instead of swallowing via pipe" | 1 prod |
| `83392d392` | Revert "fix(gateway): set explicit chat timeouts for mesh gateway calls" | 1 prod |
| `563df5638` | Revert "config: align memory hybrid UI metadata with schema labels/help" | 3 prod |
| `4fa35d3fd` | Revert "fix: use resolveUserPath utility for tilde expansion" | 1 prod |

#### Cron Session Namespace Routing (4)

| SHA | Message | Files |
|-----|---------|-------|
| `c20ef582c` | fix: align cron session key routing (#18637) (thanks @vignesh07) | 5 mixed |
| `a7c25f203` | Protocol: regenerate cron Swift models | 2 prod |
| `a25850359` | Cron: dedupe gateway wake target resolution | 1 prod |
| `f988abf20` | Cron: route reminders by session namespace | 19 mixed |

These four commits implement session namespace awareness for cron jobs, adding ~110 lines to `src/gateway/server-cron.ts` and causing the line number shifts documented below.

#### Test and Type Fixes (12)

| SHA | Message | Files |
|-----|---------|-------|
| `950d5a46b` | chore: Fix types in tests 2/N. | 3 test |
| `0cf443afe` | chore: Fix types in tests 1/N. | 5 test |
| `d3a36cc3b` | chore: Fix remaining extension test types, enable type checking for extension tests. | 10 test |
| `a74198557` | chore: Fix more extension test types, 2/N. | 7 test |
| `72f00df95` | chore: Fix more extension test type 1/N. | 9 test |
| `0f8d1f175` | chore: Fix type errors in `extensions/twitch` tests. | 5 test |
| `889f221ed` | chore: Fix type errors in `extensions/bluebubbles` tests. | 4 test |
| `dcdbbd8b3` | test: replace ui prototype method patches with instance stubs | 3 test |
| `6d451c820` | test(ollama): add reasoning fallback regression coverage | 1 test |
| `7649f9cba` | refactor(test): share heartbeat sandbox fixtures | 3 test |
| `b9e7299a7` | refactor(test): share embedded runner overflow mocks | 2 test |
| `5cbdd3a9c` | test(auto-reply): dedupe command spawn test harness | 1 test |

#### Infrastructure Refactors (15)

| SHA | Message | Files |
|-----|---------|-------|
| `ddef3cadb` | refactor: replace memory manager prototype mixing | 5 prod |
| `9032a5098` | refactor: reuse sandbox path expansion in apply-patch | 1 prod |
| `7687f6cfc` | refactor: reuse runtime requires evaluation | 3 prod |
| `519517915` | refactor: centralize plugin allowlist mutation | 3 prod |
| `7147cd9cc` | refactor: dedupe process-scoped lock maps | 3 prod |
| `f452a7a60` | refactor(shared): reuse chat content extractor for assistant text | 3 prod |
| `817b5812e` | refactor(agents): share queued JSONL file writer | 3 prod |
| `80c7d04ad` | refactor(cron): reuse shared run outcome telemetry types | 2 prod |
| `64fc82844` | refactor(channels): share prefixed target parsing | 3 prod |
| `10b060dbd` | refactor(agent-tools): reuse gateway option parsing | 3 prod |
| `ed74f48bd` | refactor(status): share update channel display + one-liner | 3 prod |
| `fbd3786e7` | refactor(channels): share target parsing helpers | 3 prod |
| `9bfd3ca19` | refactor(memory): consolidate embeddings and batch helpers | 11 prod |
| `423b7a0f2` | refactor(auto-reply): reuse embedded run context helpers | 3 prod |
| `246bb7f30` | refactor(agents): share model auth label resolution | 3 prod |

#### Chore / Maintenance (16)

| SHA | Message | Files |
|-----|---------|-------|
| `d4385e67a` | chore(docs): drop accidental .DS_Store artifacts | 2 doc |
| `c65b3c2ed` | fix(docs): revert accidental es/pt-BR translation scaffold from #18473 | 4 doc |
| `83b1ae895` | fix(transcript): always drop orphaned OpenAI reasoning blocks | 1 test + 1 doc |
| `6229814af` | chore: Remove invalid tsconfig paths reference. | 1 prod |
| `ff8316e04` | chore: Fix formatting. | 2 prod |
| `13ae1ae05` | fix(memory): tighten embedding manager inheritance types | 2 prod |
| `5115f6fdf` | style: normalize imports for oxfmt 0.33 | 7 prod |
| `064a3079c` | Heartbeat: queue pending wakes per target | 2 prod |
| `c70597dae` | chore: Fix formatting. | 13 prod |
| `194608d0d` | chore: Remove leftover file. | 2 prod |
| `dee013426` | style: reformat dedupe-touched files | 11 prod |
| `1dc9bb8d6` | chore: Fix more type issues. | 2 prod |
| `8ae93cce5` | docs: add ts-suppression guardrails | 1 doc |
| `843acd52b` | chore: Fix up Oxlint/Oxfmt ignore patterns. | 2 prod |
| `90ef2d6bd` | chore: Update formatting. | 1107 prod |
| `1e13a3933` | chore: Update deps. | 3 prod |

### Audit Cross-Reference

**Audit 1 (Issue #1796 — 8 claims):**
- Claim 6 (path traversal in agent dirs): Strengthened by `6244ef9ea` (bind mount path separator improvement)
- Claims 2, 5 (OAuth scope, file permissions): Defense-in-depth via `b9aed3a07` (scope normalization consistency)
- Claims 1, 3, 4, 7, 8: Unaffected by this batch

**Audit 2 (Medium article — 8 claims):**
- Claim 4 (DNS rebinding SSRF via web-fetch): Strengthened by `a6466f257` (URL allowlist consolidation)
- Claim 2 (arbitrary write via outPath): Defense-in-depth via `37c97964a` (input limit centralization)
- Claims 1, 3, 5, 6, 7, 8: Unaffected by this batch

**Legitimate Gaps (3 open):** Pipe-delimited token format, outPath validation in screen_record, Bootstrap/memory .md content scanning — none affected or closed by this batch.

### Line Number Changes

The four cron routing commits (`c20ef582c`, `a7c25f203`, `a25850359`, `f988abf20`) added ~110 lines to `src/gateway/server-cron.ts`. The `7687f6cfc` refactor extracted hasBinary, evaluateRuntimeRequires, and PATHEXT logic to `src/shared/config-eval.ts`. References in previous hardening entries updated:

- `src/gateway/server-cron.ts:115` → `:240` (bearer token auth)
- `src/gateway/server-cron.ts:110` → `:235` (opt-in gating)
- `src/gateway/server-cron.ts:23,117-120` → `:28,242-245` (timeout protection)
- `src/gateway/server-cron.ts:25-32,132` → `:30-37,257` (URL redaction)
- `src/agents/skills/config.ts` / `src/hooks/config.ts` → `src/shared/config-eval.ts:121` (`hasBinary()` — implementation extracted, call sites remain at `src/agents/skills/config.ts:99` and `src/hooks/config.ts:70`)
- `src/agents/skills/config.ts:102-107` / `src/hooks/config.ts:71-78` → `src/shared/config-eval.ts:110-115` (PATHEXT logic)

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
