> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 15 sync 4) — 30 upstream commits

**Merge commit:** 8d1a1d9e8 | **Range:** 8f4db73ce..8d1a1d9e8

**Overview:** All 30 commits in this batch are `refactor(*)` code extraction refactors — consolidating duplicated logic into shared modules. No behavioral changes to security controls. 15 commits classified as security-relevant (touch security-adjacent code paths); 15 classified as safe (pure type/constant extraction).

### Security-Relevant Refactors (15 commits)

1. **`4caeb203a`** — refactor(install): share package dir install. Consolidates file copying, backup management, and npm installation from `src/hooks/install.ts` and `src/plugins/install.ts` into shared `installPackageDir()` in `src/infra/install-package-dir.ts`. File mode enforcement (`0o600`) and atomic write semantics preserved. Relates to Audit 1 #5 (file permissions) — permissions still enforced.

2. **`4f61a3f52`** — refactor(shared): centralize requirements evaluation. Creates `evaluateRequirements()` helper in `src/shared/requirements.ts` consolidating bin/env/OS/config checks from `src/agents/skills-status.ts` and `src/hooks/hooks-status.ts`. All existing validation checks preserved. Commit chain with `270779b2c`.

3. **`747b11c83`** — refactor(config): share allow/deny channel policy schema. Extracts Zod schema into `createAllowDenyChannelRulesSchema()` in new `src/config/zod-schema.allowdeny.ts`. `MediaUnderstandingScopeSchema` and `SessionSendPolicySchema` now use shared definition. Validation behavior unchanged.

4. **`1a4fb3503`** — refactor(canvas-host): share static file resolver. Consolidates path normalization and file resolution into `src/canvas-host/file-resolver.ts`. Symlink checks and `..` path traversal rejection preserved identically from `src/canvas-host/a2ui.ts` and `server.ts`.

5. **`2004ce919`** — refactor(daemon): share schtasks exec helper. Extracts Windows `execSchtasks()` wrapper into `src/daemon/schtasks-exec.ts`. Error handling and `windowsHide: true` flag preserved. No shell injection vectors (uses `execFile` with array args).

6. **`3150ece95`** — refactor(channels): pass setup input to mutator. Consolidates 28 individual optional channel parameters into single `input: ChannelSetupInput` object in `applyChannelAccountConfig()` (`src/commands/channels/add-mutators.ts`). Existing `plugin.setup.validateInput()` callback still applies. Commit chain with `4c74a2f06`.

7. **`4c74a2f06`** — refactor(channels): reuse setup input types. Imports `ChannelSetupInput` from `src/channels/plugins/types.js` and uses it in `ChannelsAddOptions` via `Omit<>`. No validation logic changes. Commit chain with `3150ece95`.

8. **`a1fc6a6ea`** — refactor(daemon): share runtime status formatter. Extracts `formatRuntimeStatus()` into `src/daemon/runtime-format.ts`. Pure display string formatting from PID/state/exit-code fields. Zero security impact.

9. **`1b9c1c648`** — refactor(daemon): share service lifecycle runner. Consolidates daemon start/stop/install/uninstall logic into `src/cli/daemon-cli/lifecycle-core.ts` (265 new lines). Affects systemd/Windows/launchd integration. Privilege escalation checks and service boundary enforcement preserved.

10. **`1b03eb71a`** — refactor(health): share channel line styling. Creates `styleHealthChannelLine()` in `src/terminal/health-style.ts`. Terminal color formatting only — zero security-relevant data handling.

11. **`64df78744`** — refactor(channels): share account summary helpers. Consolidates `buildChannelAccountSnapshot()` and `formatChannelAllowFrom()` into `src/channels/account-summary.ts`. Account metadata display logic only.

12. **`cc233da37`** — refactor(pairing): share JSON state helpers. Consolidates file I/O and atomic write logic into `src/infra/pairing-files.ts`. File mode `0o600` enforced on both temp and final files. Atomic write with temp+rename prevents race conditions. Relates to Audit 1 #4 (token refresh race) — atomic semantics preserved; Audit 1 #5 (file permissions) — `0o600` enforced.

13. **`8d1a1d9e8`** — refactor(commands): share vLLM setup. Extracts vLLM configuration wizard into `promptAndConfigureVllm()` in `src/commands/vllm-setup.ts`. API key stored via `upsertAuthProfileWithLock()` (encrypted). No plaintext token storage vectors. Relates to Audit 1 #1 — not affected (vLLM uses API key via auth-profiles).

14. **`cdc31903c`** — refactor(media-understanding): share Gemini inline-data helper. Consolidates base64 media encoding for audio/video into `src/media-understanding/providers/google/inline-data.ts`. Pure encoding consolidation. No SSRF or media validation changes.

15. **`d1f36bfd8`** — refactor(cli): share Windows argv normalization. Extracts `normalizeWindowsArgv()` into `src/cli/windows-argv.ts`. Filters control characters (code >= 32 && code !== 127). No regex-based shell injection vectors. Relates to Audit 2 #7 — not affected (char code filtering, not regex).

### Non-Security Refactors (15 commits)

| SHA | Title | Files | Notes |
|-----|-------|-------|-------|
| bc4881ed0 | Memory: stale index cleanup | 3 | File cleanup utility; zero auth/exec impact |
| e1e05e57c | Utils: shell argv tokenizer | 3 | Display parsing only; no execution path |
| 8218a94a3 | Signal: RPC context | 3 | Setup logic only; no credential/auth changes |
| e401e2584 | Auto-reply: elevated unavailable message | 3 | Message formatting; no permission changes |
| 0dbe087ef | PI: attempt params dedup | 1 | Type consolidation; zero behavior change |
| 4734c985c | Discord: REST helpers | 3 | Client utility extraction; no auth bypass |
| 270779b2c | Shared: requirements from metadata | 4 | Evaluation logic identical; chain with `4f61a3f52` |
| 7bd073340 | Memory: batch output parsing | 3 | Response parsing consolidation; safe |
| 3e2f0ca07 | Media: Gemini output extract | 3 | Response parsing; no new injection vectors |
| 9f84afc99 | Line: flex footer helper | 3 | UI template generation; cosmetic only |
| ece55b468 | Shared: frontmatter parsing | 4 | YAML frontmatter parsing extracted to `src/shared/frontmatter.ts`; no injection paths |
| e9de24215 | Exec-approvals: request events | 3 | Type extraction to `src/infra/exec-approval-events.ts`; no validation changes |
| 268c14f02 | Tools: default policy steps | 3 | `DEFAULT_GATEWAY_HTTP_TOOL_DENY` moved to `src/security/dangerous-tools.ts`; zero behavior change |
| f97ad8f28 | Tools: policy pipeline | 4 | Policy application logic consolidated; unchanged |
| bc0160d0f | Shared: dedupe requirements evaluation | 2 | Follow-up to `4f61a3f52`; identical logic |

### Audit Cross-Reference

**Audit 1 (8 claims):** No claims affected. #4 (refresh race) — atomic writes in `cc233da37` preserve existing mitigation. #5 (file permissions) — `0o600` preserved in `4caeb203a` and `cc233da37`.

**Audit 2 (8 claims):** No claims affected. #7 (shell injection) — `d1f36bfd8` uses safe char code filtering, not regex.

**3 Legitimate Gaps:** None addressed. Gateway env blocklist (closed), pipe-delimited token format, outPath validation, bootstrap/memory .md scanning — all unchanged.

### Line Number Shifts

| File | Old Line | New Line | Symbol | Status |
|------|----------|----------|--------|--------|
| `src/infra/exec-approvals.ts` | 137-162 | 161-188 | `coerceAllowlistEntries()` | VERIFIED |
| `src/agents/skills/frontmatter.ts` | 163-164 | 119 | `disableModelInvocation` parsing | VERIFIED |
| `src/gateway/tools-invoke-http.ts` | 173, 175 | 200, 202 | `x-openclaw-message-channel`, `x-openclaw-account-id` headers | VERIFIED |
| `src/gateway/tools-invoke-http.ts` | 62-65 | 44-48 | `resolveSessionKeyFromBody()` | VERIFIED |
| `src/gateway/tools-invoke-http.ts` | 42-51 | moved to `src/security/dangerous-tools.ts:9-18` | `DEFAULT_GATEWAY_HTTP_TOOL_DENY` | VERIFIED |
| `src/gateway/tools-invoke-http.ts` | 325 | 283 | Deny list filtering (import from `dangerous-tools.ts`) | VERIFIED |
| `src/gateway/tools-invoke-http.ts` | 382-384 | 319, 322 | Error handling ("tool execution failed") | VERIFIED |

**Note:** Historical references to `tools-invoke-http.ts:43-52` in `open-upstream-prs.md` PR tracking entries (#15390, #13185) are intentionally left unchanged — they document what the code looked like at the time those PRs were synced. Current-state references in `open-upstream-issues.md`, `detecting-openclaw-requests.md`, and `11-security-audit-analysis.md` have been updated.

### New CVE/GHSA Advisories

Two new advisories published Feb 14 (documented separately in [Official Security Advisories](../official-security-advisories.md)):

- **GHSA-wfp2-v9c7-fh79** (MEDIUM) — SSRF via attachment/media URL hydration (CWE-918)
- **CVE-2026-24764 / GHSA-782p-5fr5-7fj8** (LOW) — Slack integration hardening: prevent channel metadata from influencing system prompts (CWE-74, CWE-94)

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation, bootstrap/memory .md scanning — unchanged) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
