# Feb 18 Sync 7 (87 commits, 3 security)

> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

**Merge commit:** 6b5199ba2 | **Range:** 820e4274c..6b5199ba2

**Large refactor detected:** 25,026 lines changed. Many documentation line references may need verification.

## Security-Relevant Commits

| SHA | Message | Files | Security Relevance |
|-----|---------|-------|-------------------|
| `b05e89e5e` | fix(agents): make image sanitization dimension configurable | 21 prod | Configurable image dimension limit (2000→1200px default), input validation prevents NaN/infinite values |
| `087dca8fa` | fix(subagent): harden read-tool overflow guards and sticky reply threading (#19508) | 40 prod | Context overflow protection, 15s grace window for transient errors, adaptive read budget scaling |
| `6945fbf10` | feat(slack): add native text streaming support | 5 prod | Feature addition with proper fallback handling, media payloads use normal delivery |

### Security Details

1. **`b05e89e5e`** — Image sanitization dimension is now configurable via `agents.defaults.imageMaxDimensionPx` (default: 1200px, reduced from 2000px). The `resolveImageSanitizationLimits()` function at `src/agents/image-sanitization.ts:11` validates input (type check, finite check, floor rounding) before applying limits. All image sanitization paths now respect this configurable limit, providing defense-in-depth against oversized base64 image transcripts that could cause memory pressure or API rejection.

2. **`087dca8fa`** — Tool-result context overflow protection added via `installToolResultContextGuard()` at `src/agents/pi-embedded-runner/tool-result-context-guard.ts:297`. The guard intercepts `transformContext` to estimate token consumption (75% headroom ratio, 2 chars/token estimate, 8000 chars/image) and proactively compacts oversized tool results before context overflow. Also adds 15-second grace window for transient errors (AGENT_RUN_ERROR_RETRY_GRACE_MS constant) in `src/gateway/server-methods/agent-job.ts` to prevent premature agent job termination during auth/model failover.

3. **`6945fbf10`** — Slack native text streaming support added with proper security considerations. The `shouldUseStreaming()` function at `src/slack/monitor/message-handler/dispatch.ts:46` validates prerequisites (streaming enabled + thread context), while `hasMedia()` at line 25 ensures media payloads fall back to normal delivery. Stream lifecycle functions (`startSlackStream`, `appendSlackStream`, `stopSlackStream` in `src/slack/streaming.ts`) properly handle errors with graceful degradation.

## Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `6b5199ba2` | Whatsapp/add resolve outbound target tests (#19345) | 2 test | Test-only |
| `ae2c8f2cf` | feat(models): support anthropic sonnet 4.6 | 12 prod | Provider config update |
| `c26cf6aa8` | feat(cron): add default stagger controls for scheduled jobs | 20 prod | Feature, not security |
| `20a561224` | iOS: use operator session for ChatSheet RPCs (#19320) | 2 iOS | iOS app, not security path |
| `bfc973636` | feat: share to openclaw ios app (#19424) | 19 iOS | iOS app, not security path |
| `98962ed81` | feat(ios): auto-select local signing team (#18421) | 10 iOS | iOS config, not security path |
| `2362aac3d` | chore: document sessions_spawn response note | 4 doc | Docs-only |
| `9a2c39419` | chore(release): bump version to 2026.2.17 | 48 misc | Version bump |
| `75001a049` | fix cron announce routing and timeout handling | 12 prod | Not security |
| `5acec7f79` | fix: wire agents.defaults.imageModel | 1 prod | Config wiring, not security |
| `6bb9b0656` | Tests: fix fetch mock typings | 2 test | Test-only |
| `2547b782d` | Agents: add before_message_write persistence tests | 3 test | Test-only |
| `5d1bcc76c` | docs(zai): document tool_stream defaults | 4 doc | Docs-only |
| `7caf87454` | test(update): cover restart gating | 2 test | Test-only |
| `cc359d338` | test: add fetch mock helper and reaction coverage | 28 test | Test-only |
| `9772a28f0` | test(gateway): cover trusted proxy trimming | 2 test | Test-only |
| `7fca92ea9` | test(web): fix baileys mock typing | 1 test | Test-only |
| `210bc3797` | chore(subagents): add regression coverage | 6 test | Test-only |
| `85b5ac852` | Revert: fully roll back #17974 zh-cn UI README | 1 doc | Docs revert |
| `bc4038149` | Revert: undo #17974 README change | 1 doc | Docs revert |
| `878a13d21` | fix: don't consume replyPlan reference eagerly | 1 prod | Slack, not security |
| `06efbd231` | fix: resolve ChatStreamer import path | 3 prod | Slack, not security |
| `b114c8270` | CLI: approve latest pending device request | 3 prod | CLI feature, not security |
| `9f907320c` | Revert "fix: handle forum/topics in Telegram DM thread routing (#17980)" | 2 prod | Revert, not security path |

**Plus 7 additional Tier B commits:** test infrastructure, iOS changes, UI reverts, channel bug fixes.

## Audit Cross-Reference

**Unaffected Claims:** None of the 3 security commits directly address the 16 audit claims or 3 legitimate gaps:

| Category | Affected |
|----------|----------|
| OAuth security (Claims 1-4) | No |
| File permissions (Claim 5) | No |
| Path traversal (Claim 6) | No |
| Webhook security (Claim 7) | No |
| Token validation (Claims 8, 14) | No |
| RCE vectors (Claims 9, 15, 16) | No |
| Arbitrary write (Claim 10) | No |
| Log traversal (Claim 11) | No |
| SSRF (Claim 12) | No |
| RBAC (Claim 13) | No |
| Gateway env blocklist (Gap 1) | No |
| Pipe-delimited token (Gap 2) | No |
| outPath validation (Gap 3) | No |

**Gap status:** All 3 legitimate gaps remain open. See [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).

## Stale References Note

This sync includes a large refactor (~25k lines changed). Approximately 90 potentially stale documentation line references were detected. These should be verified in a dedicated cleanup pass to update line numbers for files like:
- `src/agents/system-prompt.ts` (18 refs)
- `src/agents/pi-tools.ts` (5 refs)
- `src/agents/pi-tools.read.ts` (5 refs)
- `src/agents/tools/web-fetch.ts` (6 refs)
- `src/browser/extension-relay.ts` (9 refs)
- `src/cron/isolated-agent/run.ts` (8 refs)
