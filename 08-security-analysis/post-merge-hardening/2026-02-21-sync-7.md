> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

# Feb 21 Sync 7 — 27 Commits (11 Security)

**Merge commit:** `d25a10662` | **Range:** `4640bcf38..d25a10662`
**Date:** 2026-02-21

## Security-Relevant Commits

| SHA | Message | Files | Description |
|-----|---------|-------|-------------|
| `2cdbadee1` | fix(security): block startup-file env injection across host execution paths | 8 prod + 4 test + 1 doc | Creates `src/infra/host-env-security.ts` (NEW): `isDangerousHostEnvVarName()` at `:34` validates keys against 14 exact blocked entries plus `DYLD_*` and `LD_*` prefixes. `sanitizeHostExecEnv()` at `:46` validates all env var overrides before injection into host exec paths. Foundation for the JSON-backed policy centralized in `f202e7307`. |
| `f202e7307` | refactor(security): centralize host env policy and harden env ingestion | 6 prod + 4 test | `src/agents/bash-tools.exec-runtime.ts:34`: `validateHostEnv()` now delegates to sanitizeHostExecEnv() at `src/infra/host-env-security.ts:46`. Moves policy to `src/infra/host-env-security-policy.json` (NEW — `DYLD_*`, `LD_*`, `BASH_FUNC_*` prefix blocks). Addresses Audit 2 Claim 8. Related to GHSA-82g8-464f-2mv7 (CRITICAL, 2026-02-21). |
| `08e020881` | refactor(security): unify command gating and blocked-key guards | 10 prod | Creates NEW `src/auto-reply/reply/command-gates.ts`: `rejectUnauthorizedCommand()` at `:7`, `buildDisabledCommandReply()` at `:20`, `requireCommandFlagEnabled()` at `:33`. Creates NEW src/config/prototype-keys.ts with isBlockedObjectKey() at :3 (prototype chain key checking; also verified in Key Code Locations below). |
| `fbb79d401` | fix(security): harden runtime command override gating | 7 prod + 4 test + 1 doc | `isBlockedObjectKey()` at `prototype-keys.ts:3` added to override key validation. `sanitizeOverrideValue()` at `runtime-overrides.ts:10` adds WeakSet circular reference guard. |
| `356d61aac` | fix(gateway): scope tailscale tokenless auth to websocket | 5 prod + 2 test + 9 doc | `authorizeGatewayConnect()` at `auth.ts:322` gains `allowTailscaleHeaderAuth?: boolean` at `:332`. NEW `resolveTailscaleClientIp()` at `auth.ts:71`. `isLocalDirectRequest()` shifted to `auth.ts:94`. Tailscale tokenless header auth scoped to WebSocket connections only. Partially addresses Audit 1 Claim 7. |
| `084f62102` | fix(security): OC-65 prevent compaction counter reset to enforce context exhaustion limit — Aether AI Agent | 1 prod | `MAX_OVERFLOW_COMPACTION_ATTEMPTS` at `run.ts:477` enforces the compaction limit; removes the counter reset that allowed unbounded attempts. Fixes GHSA-x2g4-7mj7-2hhj (CWE-400, compaction DoS). |
| `99048dbec` | fix(gateway): align insecure-auth toggle messaging | 5 prod + 3 doc | `collectGatewayConfigFindings()` at `security/audit.ts:248`; `gateway.control_ui.insecure_auth` finding message corrected at `audit.ts:350`. |
| `283029bde` | refactor(security): unify webhook auth matching paths | 6 prod + 3 test | Creates NEW `src/plugin-sdk/webhook-targets.ts`: `resolveSingleWebhookTarget<T>()` at `:46`, `resolveSingleWebhookTargetAsync<T>()` at `:66`. `extensions/bluebubbles/src/config-schema.ts:49`: `.superRefine()` requires a password when a serverUrl is configured. Partially addresses Audit 1 Claim 7. |
| `6007941f0` | fix(security): harden and refactor system.run command resolution | 4 prod + 2 test | `resolveSystemRunCommand()` at `src/infra/system-run-command.ts:126`. NEW `src/node-host/invoke-system-run.ts` extracted from inline logic. |
| `6b2f2811d` | fix(security): require BlueBubbles webhook auth | 1 prod + 1 test + 2 doc | Removes the passwordless loopback bypass in BlueBubbles webhook authentication. Chain with `283029bde`. |
| `b577228d6` | test(security): add overflow compaction truncation-budget regression | 1 test + 1 doc | Regression test for the GHSA-x2g4-7mj7-2hhj fix (`084f62102`). Verifies the compaction loop terminates within `MAX_OVERFLOW_COMPACTION_ATTEMPTS`. |

### Key Code Locations

- `src/infra/host-env-security.ts` (NEW): `isDangerousHostEnvVarName()` at `:34`, `sanitizeHostExecEnv()` at `:46`
- `src/infra/host-env-security-policy.json` (NEW): JSON-backed blocklist (14 exact keys + `DYLD_`, `LD_`, `BASH_FUNC_` prefixes)
- `src/agents/bash-tools.exec-runtime.ts:34`: `validateHostEnv()` (was at `:54` pre-sync-7)
- `src/agents/bash-tools.exec.ts:330`: enforcement of `validateHostEnv()` (was at `:300` pre-sync-7)
- `src/node-host/invoke.ts:115`: `sanitizeEnv()` delegates to `sanitizeHostExecEnv()`
- `src/auto-reply/reply/command-gates.ts` (NEW): `rejectUnauthorizedCommand()` at `:7`, `requireCommandFlagEnabled()` at `:33`
- `src/config/prototype-keys.ts` (NEW): `isBlockedObjectKey()` at `:3`
- `src/gateway/auth.ts:71`: `resolveTailscaleClientIp()` (NEW function, was `:64-85`)
- `src/gateway/auth.ts:94`: `isLocalDirectRequest()` (was at `:87`)
- `src/gateway/auth.ts:322`: `authorizeGatewayConnect()`
- `src/infra/system-run-command.ts:126`: `resolveSystemRunCommand()`
- `src/plugin-sdk/webhook-targets.ts` (NEW): `resolveSingleWebhookTarget<T>()` at `:46`
- `src/config/runtime-overrides.ts:10`: `sanitizeOverrideValue()` (WeakSet guard)
- `src/agents/pi-embedded-runner/run.ts:477`: `MAX_OVERFLOW_COMPACTION_ATTEMPTS`

## Audit Cross-Reference

| Commit | Audit Claims Affected |
|--------|----------------------|
| `2cdbadee1`, `f202e7307` | Audit 2 Claim 8 (env var injection) — further closes Gap #1; centralizes policy to JSON; related to GHSA-82g8-464f-2mv7 |
| `356d61aac` | Audit 1 Claim 7 (webhook auth) — Tailscale tokenless auth scoped to WS only (partial) |
| `283029bde`, `6b2f2811d` | Audit 1 Claim 7 — BlueBubbles webhook auth hardened; passwordless bypass removed |
| `084f62102`, `b577228d6` | GHSA-x2g4-7mj7-2hhj (CWE-400) — compaction counter reset fix + regression tests |

**Unaffected claims:** Audit 2 Claim 1 (setupCommand RCE — not touched), Claim 2 (outPath — not touched), Claim 3 (logs.tail — not touched), Claim 4 (DNS rebinding — not touched), Claim 5 (self-approving agent — not touched), Claim 6 (token format — not touched), Claim 7 (shell injection regex — not touched). Gap #2 (pipe-delimited token) and Gap #3 (outPath) remain open.

## Non-Security Commits

| SHA | Message | Files |
|-----|---------|-------|
| `d25a10662` | docs(changelog): add tailscale auth hardening release note | 1 doc |
| `6aa11f309` | fix(acp): harden resource link metadata formatting | 1 prod + 1 test |
| `073651fb5` | docs: add sponsors section to README | 3 doc |
| `2b76901f3` | docs(changelog): credit reporter for control-ui auth hardening | 1 doc |
| `810218756` | docs(security): clarify trusted-host deployment assumptions | 3 doc |
| `ede496fa1` | docs: clarify trusted-host assumption for tokenless tailscale | 9 doc |
| `cb84c537f` | fix: normalize status auth cost handling and models header tests | 1 prod + 2 test |
| `e393d7aa5` | docs(changelog): clarify Security/Exec release note | 1 doc |
| `dff61a10e` | docs(changelog): add windows system.run approval mismatch fix note | 1 doc |
| `11f6bea59` | add secret safety | 1 doc |
| `8db5e77ff` | skills: fmt | 1 doc |
| `da844d641` | skills: update xurl description | 1 doc |
| `ac2ef6945` | Update skills/xurl/SKILL.md | 1 doc |
| `635b6298e` | skills: add xurl skill | 1 doc |
| `5cc631cc9` | fix(agents): harden model-skip and tool-policy imports | 1 prod + 1 test |
| `55aaeb508` | refactor(browser): centralize navigation guard enforcement | 4 prod + 4 test |

## Summary

Eleven security commits in this sync. Key themes:

1. **Env var policy centralization (Gap #1 further hardened):** Commits `2cdbadee1` + `f202e7307` extract the env var blocklist from a TypeScript const array into a JSON policy file (`host-env-security-policy.json`), shared with the macOS Swift layer. `sanitizeHostExecEnv()` at `host-env-security.ts:46` is now the single enforcement point for both bash-tools and node-host exec paths. Related to GHSA-82g8-464f-2mv7 (CRITICAL, environment variable injection, 2026-02-21).

2. **Command gating unification:** `08e020881` centralizes command authorization boilerplate into `command-gates.ts` (`rejectUnauthorizedCommand()`, `requireCommandFlagEnabled()`). `fbb79d401` adds prototype-key checking and circular-reference guard to runtime override validation.

3. **Tailscale WebSocket-only auth scope:** `356d61aac` restricts Tailscale tokenless header auth to WebSocket connections only (not HTTP). Introduces `resolveTailscaleClientIp()` at `auth.ts:71`; shifts `isLocalDirectRequest()` to `auth.ts:94`.

4. **BlueBubbles webhook hardening:** `283029bde` unifies webhook auth into `webhook-targets.ts` and requires password when `serverUrl` is set. `6b2f2811d` removes the passwordless loopback bypass entirely.

5. **Compaction DoS fix:** `084f62102` fixes GHSA-x2g4-7mj7-2hhj by preventing the compaction attempt counter from being reset. `b577228d6` adds regression tests.

---

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation, memory.md scanning) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
