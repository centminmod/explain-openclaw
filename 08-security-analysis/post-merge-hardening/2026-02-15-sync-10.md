> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 15 sync 10) — 60 upstream commits

**Merge commit:** b97191b81 | **Range:** 82f038895..b97191b81

8 security-relevant commits, 4 non-security flagged, 48 safe (test refactors, perf optimizations, docs, style).

### Security-Relevant Commits

1. **633fe8b9c** — **Telegram webhook secret now mandatory** (`src/telegram/webhook.ts:42-48`): `startTelegramWebhook()` validates that `opts.secret` is a non-empty trimmed string and throws if missing. The `webhookCallback()` and `setWebhook()` calls use the validated secret (lines 58, 126). Directly resolves **Audit 1 Claim 7 (webhook signature bypass)** and reinforces **CVE-2026-25474** defense-in-depth chain (`ca92597e1` config validation + `5643a934` loopback bind + `3cbcba10` body limits + this runtime guard).

2. **d73f3336d** — **Exec stdin closure for non-PTY runs** (`src/agents/bash-tools.exec-runtime.ts:369-378`): New `maybeCloseNonPtyStdin()` function closes `child.stdin` immediately after spawn for non-PTY runs (called at lines 415, 509). Prevents stdin-only commands from hanging indefinitely and potential process backgrounding issues. Improves exec runtime safety.

3. **d8a2c80cd** — **Explicit token precedence in gateway client** (`src/gateway/client.ts:191`): Token selection reordered from `storedToken ?? opts.token` to `opts.token ?? storedToken`, ensuring explicitly provided credentials always take priority over persisted device-auth tokens. Removes `canFallbackToShared` fallback logic, preventing silent device token leakage. Related: `00b7ab7db` (preceding cleanup — removed unused device auth import from same file).

4. **2a3da2133** — **Session key normalization for send policy** (`src/sessions/send-policy.ts:23-131`): New `stripAgentSessionKeyPrefix()` function (lines 23-33) handles canonical `agent:<agentId>:<sessionKey>` format. `deriveChannelFromKey()` (line 35) and `deriveChatTypeFromKey()` (line 47) updated to normalize keys. `resolveSendPolicy()` (lines 61-131) checks both raw and stripped keys against prefix rules, preventing format-dependent policy bypasses.

5. **ee8d8be2e** — **OAuth manual code flow with validation** (`src/agents/chutes-oauth.ts:36-80`): `parseOAuthCallbackInput()` now accepts bare authorization codes via manual input. Validates: non-empty after trim (line 41), attempts URL parse first (line 46), falls back to bare code only if no whitespace and no `://` scheme (line 62). Maintains state parameter pass-through for CSRF protection. Improves OAuth usability for environments where browser redirect fails.

6. **c5406e1d2** — **Backend SSRF hardening: drop gateway URL overrides** (`src/infra/outbound/message.ts:104-121`): `resolveGatewayOptions()` now drops `opts.url` when operating in `BACKEND` mode or as `GATEWAY_CLIENT` (lines 108-109). Forces backend message delivery through config-derived gateway URLs only. New test suite (message.e2e.test.ts) verifies AWS metadata endpoint probes are blocked. Directly mitigates **Audit 2 Claim 4 (DNS rebinding SSRF)** at the backend layer. Cross-ref: **GHSA-g8p2-7wf7-98mq** (gatewayUrl token exfiltration).

7. **2d5647a80** — **Tool gateway URL validation with loopback allowlist** (`src/agents/tools/gateway.ts:13-83`): New `canonicalizeToolGatewayWsUrl()` (lines 13-41) validates WebSocket URLs (ws/wss only, no credentials/query/hash/path). `validateGatewayUrlOverrideForAgentTools()` (lines 43-77) enforces allowlist of loopback addresses (127.0.0.1, localhost, [::1]) on port 18789, plus optional configured remote gateway URL. Called from `resolveGatewayOptions()` (line 83). Rejects non-allowlisted overrides. Directly mitigates **Audit 2 Claim 4 (DNS rebinding SSRF)** at the tool layer. Cross-ref: **GHSA-g8p2-7wf7-98mq**.

8. **b2a4283c3** — **Podman root write prevention** (`setup-podman.sh`): Restructures podman setup script to avoid root writing to user home directory. File permission hardening for containerized deployments. Addresses **Audit 1 Claim 5 (insufficient file permission checks)** in container setup context.

### Non-Security Flagged Commits

| SHA | Type | Summary |
|-----|------|---------|
| 42ab5dd2d | Test consolidation | Merges 12 agent runner test files into 2 (perf optimization, no logic change) |
| e95ce05c1 | Messaging | Softens "gatewayUrl override blocked" to "rejected"; clarifies help text |
| 07850e8a9 | TypeScript fix | Replaces vitest `MockInstance` with `AnyMock` type alias to avoid TS2742 under pnpm |
| d9d321f94 | Dependency update | Bumps `qs` (JS) and `golang.org/x/net` (Go) security patches |

### Safe Commits (48 — summary)

Bulk of this sync is test infrastructure modernization: `refactor(test)` harness extraction (discord, web, telegram, models-config, doctor, pw-tools, signal, onboarding, imessage, openai batch, slack, telegram media — 14 commits), `perf(test)` suite consolidation and speedups (update-runner, pairing-store, control-ui-assets, web auto-reply, agent runner heartbeat/misc/memory-flush, raw-body, cron skills snapshot, heartbeat typing — 14 commits), test import ordering fixes (3 commits), docs/changelog entries (5 commits), test stabilization (3 commits), style formatting (1 commit), and a non-security iMessage refactor extracting `parse-notification.ts` (1 commit). Also includes 5 additional test infrastructure commits (mock annotations, duplicate suite removal, streaming dedup, docker-setup speedup).

### Commit Chains

- **Gateway SSRF chain:** `c5406e1d2` → `e95ce05c1` → `2d5647a80` — progressive SSRF hardening (backend drop, messaging polish, tool-level allowlist)
- **Gateway client chain:** `00b7ab7db` → `d8a2c80cd` — cleanup unused import, then fix token precedence
- **Agent runner test chain:** `64f718218` → `42ab5dd2d` — initial consolidation then final merge of 12 files

### Audit Impact

| Audit | Claim | Status | Commit(s) |
|-------|-------|--------|-----------|
| Audit 1 Claim 7 | Webhook signature bypass | **Further hardened** | 633fe8b9c (CVE-2026-25474 runtime guard) |
| Audit 2 Claim 4 | DNS rebinding SSRF | **Further hardened** | c5406e1d2 + 2d5647a80 (GHSA-g8p2-7wf7-98mq defense-in-depth) |
| Audit 1 Claim 5 | File permission checks | **Further hardened** | b2a4283c3 (podman root write prevention) |

### New CVE/GHSA Advisories

2 new advisories added to [Official Security Advisories](../official-security-advisories.md):

| ID | Severity | Summary |
|----|----------|---------|
| [GHSA-3hcm-ggvf-rch5](https://github.com/openclaw/openclaw/security/advisories/GHSA-3hcm-ggvf-rch5) | HIGH | Exec allowlist bypass via command substitution/backticks in double quotes |
| [GHSA-mr32-vwc2-5j6h](https://github.com/openclaw/openclaw/security/advisories/GHSA-mr32-vwc2-5j6h) | HIGH | Browser Relay /cdp WebSocket missing auth (cross-tab cookie access) |

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
