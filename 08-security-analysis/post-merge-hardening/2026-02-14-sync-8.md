> **Navigation:** [Post-merge Hardening](../post-merge-hardening.md) | [Main Guide](../../README.md)

## Post-merge hardening notes (Feb 14, 2026 — sync 8, 5 commits)

**Merge commit:** `d3e3f1da9` — "Merge upstream openclaw/main (Feb 14 sync 8)"
**Parent range:** `8793005..4e9f933` (5 commits)

### Commits in this merge

| SHA | Type | Summary |
|-----|------|---------|
| `4e9f933e8` | fix | Reset stale execution state after SIGUSR1 in-process restart (#15195) |
| `2086cdfb9` | perf(test) | Reduce hot-suite import and setup overhead |
| `1655df7ac` | fix(config) | Log config overwrite audits |
| `42eaee8b7` | chore | Fix root_dir resolution/stale scripts during PR review |
| `644251295` | perf | Reduce hotspot test startup and timeout costs |

### Security-relevant changes

#### 1. SIGUSR1 restart state reset (PR #15195) — `4e9f933e8`

**Files:** `src/cli/gateway-cli/run-loop.ts`, `src/process/command-queue.ts`, `src/process/restart-recovery.ts` (new), `src/infra/heartbeat-wake.ts` (new), `src/macos/gateway-daemon.ts`, `scripts/recover-orphaned-processes.sh` (new)

**What changed:**

- **`run-loop.ts`**: Now imports `resetAllLanes` from command-queue and `createRestartIterationHook` from new restart-recovery module. After SIGUSR1 in-process restart, `resetAllLanes()` is called to clear stale active task IDs that would permanently block new work from draining. The `onIteration()` hook runs at the top of each loop iteration, detecting restart boundaries.
- **`command-queue.ts`**: Replaced `active` counter with `generation`-based tracking. Each lane now has a `generation` number that increments on `resetAllLanes()`. Task completions from stale generations are silently ignored (their `completeTask()` returns false, preventing pump/logging for dead tasks). New `resetAllLanes()` export clears all activeTaskIds, bumps generation, and re-drains lanes with queued work.
- **`restart-recovery.ts`** (new): `createRestartIterationHook()` factory returns a callback that fires the provided cleanup function once on the first iteration after a restart, then becomes a no-op until the next restart.
- **`heartbeat-wake.ts`** (new): Provides heartbeat awakening mechanism for restart coordination.
- **`recover-orphaned-processes.sh`** (new): Shell script to recover orphaned gateway processes after unclean restarts.
- **`gateway-daemon.ts`**: Extended with restart coordination logic.

**Security assessment:** This is a reliability/availability fix. Stale execution state after SIGUSR1 restarts could prevent new commands from executing (denial-of-service condition for the gateway loop). The generation-based approach ensures stale completions from interrupted tasks don't corrupt lane state. No new attack surface introduced — `resetAllLanes()` is only called from the restart hook inside the gateway loop, not externally accessible.

#### 2. Config overwrite audit logging — `1655df7ac`

**Files:** `src/config/io.ts`, `src/config/io.write-config.test.ts`

**What changed:**

- **`config/io.ts`**: Added `logConfigOverwrite()` function at lines 731-740 that logs a warning with SHA-256 hash before and after, backup path, and changed path count on every config file overwrite. Called on both success (line 780) and Windows EPERM fallback (line 772).
- Adds defense-in-depth visibility: unauthorized or unexpected config modifications now leave an audit trail in logs with cryptographic proof of what changed.

**Security assessment:** Pure defense-in-depth improvement. Provides forensic evidence for config tampering detection. No functional behavior change — existing write paths are unchanged, only logging added. Aligns with tracked issue #9627 mitigation strategy.

### Line number shifts

The config audit logging adds 15 lines to `src/config/io.ts` after line 727 (13-line `logConfigOverwrite` block + 2 call sites). The browser server import adds 1 line to `src/browser/server.ts`. The run-loop.ts restructuring shifts `consumeGatewaySigusr1RestartAuthorization()` from line 76 to 104.

| File | Old line(s) | New line(s) | Shift |
|------|------------|------------|-------|
| `src/config/io.ts` | `:736` (0o600 writeFile) | `:749` | +13 |
| `src/config/io.ts` | `:753` (0o600 chmod) | `:766` | +13 |
| `src/config/io.ts` | `:681-753` (writeConfigFile) | `:681-781` | end +28 |
| `src/browser/server.ts` | `:132` (bind) | `:133` | +1 |
| `src/browser/server.ts` | `:116-123` (auth middleware) | `:117-124` | +1 |
| `src/browser/server.ts` | `:78-165` (server setup) | `:79-166` | +1 |
| `src/cli/gateway-cli/run-loop.ts` | `:76-77` (SIGUSR1 auth) | `:104-105` | +28 |

All references updated in documentation.

### Non-security commits

- **`2086cdfb9`** (perf test): Reduces hot-suite import/setup overhead. Adds `pw-ai-state.ts` lazy-load guard for Playwright. Test-only changes to discord, cron, update-cli, session, skills, tools tests. No security impact.
- **`42eaee8b7`** (chore): Fixes `root_dir` resolution and stale scripts in PR review workflow (`.agents/skills/`, `scripts/pr*`). Internal tooling only.
- **`644251295`** (perf): Reduces test startup/timeout costs. Extracts `gateway-plugin.ts` from `provider.ts` (Discord monitor refactor). Test infrastructure changes only.

### New files

| File | Purpose | Security relevance |
|------|---------|-------------------|
| `src/process/restart-recovery.ts` | Restart iteration hook factory | Internal coordination — no external API |
| `src/infra/heartbeat-wake.ts` | Heartbeat awakening for restart | Internal coordination — no external API |
| `scripts/recover-orphaned-processes.sh` | Orphaned process recovery | Operator utility — runs with user privileges |
| `src/browser/pw-ai-state.ts` | Playwright lazy-load state tracker | Performance optimization — no security impact |
| `src/discord/monitor/gateway-plugin.ts` | Extracted from provider.ts | Refactor — same functionality, no new surface |
| `src/cli/gateway-cli/run-loop.test.ts` | Tests for run-loop restart | Test coverage |
| `src/process/restart-recovery.test.ts` | Tests for restart-recovery | Test coverage |
