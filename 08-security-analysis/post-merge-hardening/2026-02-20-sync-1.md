> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 20 Sync 1 — 41 Commits

**Merge commit:** 265475da7 | **Range:** 10d5bd76d..758ea3c5a

### Security-Relevant Commits

| SHA | Message | Files | Impact |
|-----|---------|-------|--------|
| 08a796793 | fix(security): fail closed on gateway bind fallback and tighten canvas IP fallback | 4 | Gateway HTTP server fails closed on bind errors; Canvas IP auth tightened |
| a40c10d3e | fix: harden agent gateway authorization scopes | 19 | RBAC scope enforcement via `method-scopes.ts` |
| ff74d89e8 | fix: harden gateway control-plane restart protections | 11 | Rate limiting on restart/update endpoints |
| bafdbb6f1 | fix(security): eliminate safeBins file-existence oracle | 5 | Command injection info disclosure fix |
| 1316e5740 | fix: enforce inbound attachment root policy across pipelines | 16 | Path traversal prevention in inbound media |
| e0aaf2d39 | fix(security): block prototype-polluting keys in deepMerge | 2 | `__proto__` injection prevention |
| ee6d0bd32 | fix(security): escape backticks in exec-approval command previews | 1 | Markdown escaping in approval UI |
| f1e1ad73a | fix(security): SHA-256 hash before timingSafeEqual to prevent length leak | 1 | Side-channel mitigation |
| baf4a799a | fix(security): use YAML core schema to prevent type coercion | 1 | YAML parsing hardening |
| 9edec67a1 | fix(security): block plaintext WebSocket connections to non-loopback addresses | 9 | Transport security enforcement |
| a23e0d514 | fix(security): harden feishu and zalo webhook ingress | 4 | Webhook signature validation |
| f7a7a28c5 | fix: enforce hooks token separation from gateway auth | 4 | Token isolation between hooks and gateway |
| db7340223 | Security: add explicit opt-in for deprecated plugin runtime exec | 8 | Plugin command execution opt-in |
| e955582c8 | security: add baseline security headers to gateway HTTP responses | 2 | HTTP headers (X-Content-Type-Options, etc.) |
| 57102cbec | Security: use crypto.randomBytes for temp file names | 3 | Predictable filename prevention |
| fb35635c1 | Security: use execFileSync instead of execSync with shell strings | 2 | Shell injection prevention |
| cfe8457a0 | fix(security): harden safeBins stdin-only enforcement | 6 | Safe-bin policy hardening |
| fec48a500 | refactor(exec): split host flows and harden safe-bin trust | 10 | Host execution flow separation |
| ec232a9e2 | refactor(security): harden temp-path handling for inbound media | 10 | Path traversal prevention in temp paths |

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| 758ea3c5a | style: apply oxfmt import ordering for check | 1 | Style-only |
| 74c51aeb1 | style: format gateway server methods | 1 | Style-only |
| 0e85380e5 | style: format files and fix safe-bins e2e typing | 1 | Style-only |
| 7c9130f3c | docs: require SECURITY.md before GHSA reviews | 1 | Docs |
| 268b0dc92 | style: fix formatting drift in security allowlist checks | 3 | Style-only |
| 14b4c7fd5 | refactor: dedupe provider usage auth/fetch logic | 6 | Refactor |
| 2d485cd47 | refactor(security): extract safe-bin policy and dedupe tests | 3 | Code dedup |
| 165c18819 | refactor(security): simplify safe-bin validation structure | 3 | Refactor |
| e3e0ffd80 | feat(security): audit gateway HTTP no-auth exposure | 7 | Audit feat |
| 808a60d3b | docs: clarify intentional network-visible canvas model | 1 | Docs |
| 3c419b7bd | docs(security): document webhook hardening and changelog | 2 | Docs |
| aa267812d | test(security): add webhook hardening regressions | 2 | Test |
| 9f9cd5cbb | refactor(browser): unify navigation guard path and error typing | 10 | Refactor |
| 6195660b1 | fix(browser): unify SSRF guard path for navigation | 15 | Guard refactor |
| b45bb6801 | fix(doctor): skip embedding provider check when QMD active | 2 | Fix |
| 3feb7fc3a | fix(matrix): detect mentions in formatted_body matrix.to links | 2 | Fix |
| 466a1e1cd | fix(clawdock): include docker-compose.extra.yml in helper commands | 2 | Fix |
| 3c127b6ea | test: dedupe provider usage tests | 2 | Test |
| 825cc7079 | test: dedupe gateway auth and sessions patch coverage | 2 | Test |
| badafdc7b | refactor: dedupe provider usage fetch logic and tests | 2 | Refactor |
| 043b2f5e7 | changelog: add unreleased fixes from recent PRs | 2 | Changelog |
| 267bb3c81 | changelog: backfill PR release-note entries | 1 | Changelog |

### Key Security Changes

#### 1. Gateway Bind Fallback Fail-Closed (`08a796793`)

Gateway HTTP server now fails closed on bind errors instead of continuing with degraded security. Canvas IP authentication fallback also tightened.

- `src/gateway/server-http.ts` — Fail-closed bind handling
- `src/gateway/server-runtime-config.ts` — Canvas IP fallback restrictions

#### 2. Agent Gateway Authorization Scopes (`a40c10d3e`)

New `src/gateway/method-scopes.ts` centralizes RBAC scope enforcement for gateway method calls. Agents now have explicit scope requirements.

- `src/gateway/method-scopes.ts` — Scope definitions
- `src/gateway/call.ts` — Scope enforcement at call site

#### 3. Control-Plane Restart Rate Limiting (`ff74d89e8`)

Gateway restart and update endpoints now have rate limiting to prevent abuse.

- `src/gateway/control-plane-rate-limit.ts` — Rate limit implementation
- `src/gateway/control-plane-audit.ts` — Audit logging

#### 4. SafeBins File-Existence Oracle Elimination (`bafdbb6f1`)

Eliminates information disclosure where safeBins checks could reveal file existence on the host system.

- `src/infra/exec-approvals-allowlist.ts` — Oracle elimination

#### 5. Inbound Attachment Root Policy (`1316e5740`)

New `src/media/inbound-path-policy.ts` enforces path validation on all inbound media attachments, preventing path traversal.

- `src/media/inbound-path-policy.ts` — Policy implementation
- `src/auto-reply/reply/stage-sandbox-media.ts` — Policy enforcement

#### 6. Prototype Pollution Prevention (`e0aaf2d39`)

`deepMerge` function now blocks `__proto__`, `constructor`, and `prototype` keys.

- `src/config/includes.ts` — Key filtering

#### 7. Timing-Safe Comparison Hardening (`f1e1ad73a`)

Uses SHA-256 hash before `timingSafeEqual` to prevent length-based timing attacks on secrets.

- `src/config/includes.ts` — Hash-first comparison

#### 8. Plaintext WebSocket Blocking (`9edec67a1`)

Blocks plaintext WebSocket connections to non-loopback addresses, enforcing TLS for remote connections.

- `src/gateway/server-websocket.ts` — Plaintext blocking

### Audit Cross-Reference

| Claim | Status |
|-------|--------|
| Threat model Section 2 (Untrusted content) | **Affected** — Inbound path policy, temp path hardening |
| Threat model Section 3 (Network exposure) | **Affected** — WebSocket TLS enforcement, gateway auth scopes |
| Threat model Section 4 (Local disk + secrets) | **Affected** — SafeBins oracle elimination |
| Hardening checklist Section 4 (Require auth) | **Affected** — Gateway scope enforcement |
| Hardening checklist Section 7 (Minimize tool blast radius) | **Affected** — Plugin runtime exec opt-in |

**Gap status:** No gaps closed in this sync. — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
