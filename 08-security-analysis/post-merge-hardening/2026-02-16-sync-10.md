> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 16 Sync 10 (21 commits)

**Merge commit:** f8fbeb52b | **Range:** a5f4a8b44..f8fbeb52b

### Overview

This batch contains 21 upstream commits, predominantly refactoring work to deduplicate code across protocol schemas, model commands, update CLI, daemon services, memory batching, and media providers. One security-relevant fix addresses response size limiting for web fetch operations.

### Commits

| SHA | Message | Security Relevance | Files |
|-----|---------|-------------------|-------|
| 166cf6a3e | fix(web_fetch): cap response body before parsing | **Yes** — DoS prevention | 7 files (6 production + 1 test) |
| f8fbeb52b | refactor(protocol): dedupe cron/config schemas | No | 2 production |
| cb46ea037 | refactor(models): dedupe set default model updates | No | 3 production |
| dece9e8b0 | refactor(update): share package.json readers | No | 3 production |
| 32221e194 | refactor(probe): share withTimeout | No | 3 production |
| 5ecc364d5 | fix(daemon): drop unused import | No | 1 production |
| 0dbc51aa5 | refactor(daemon): share service description resolve | No | 5 files (4 production + 1 test) |
| 58cf37cee | refactor(memory): reuse batch utils in gemini | No | 1 production |
| 652318e56 | refactor(media): share http error handling | No | 4 production |
| d8691ff4e | refactor(memory): share sync progress helpers | No | 3 production |
| 8251f7c23 | refactor(memory): dedupe batch helpers | No | 3 production |
| ae1880acf | refactor(frontmatter): share manifest parsing | No | 3 production |
| fddf8a6f4 | perf(test): fold pi extensions tests | No | 2 test |
| 412c1d0af | perf(test): fold logger test into diagnostic | No | 2 test |
| fd3d452f1 | fix(ci): fix ui cron test mock | No | 1 test |
| fdd0e78d1 | perf(test): fold exec approvals socket defaults | No | 2 test |
| 60ce38d21 | perf(test): drop redundant signature test | No | 1 test |
| acb2a1ce3 | perf(test): fold discord voice hardening | No | 2 test |
| ba3a0e7ad | perf(test): fold gateway server utils | No | 2 test |
| 3a7b1b36b | perf(test): consolidate shared utilities | No | 4 test |
| 3830a4b58 | perf(test): fold acp session tests | No | 2 test |

### Security-Relevant Changes

#### 1. Web Fetch Response Size Limiting (`166cf6a3e`)

**Commit:** `166cf6a3e` — fix(web_fetch): cap response body before parsing

**Files:**
- `src/agents/tools/web-fetch-utils.ts` — 103 lines added (249 total)
- `src/agents/tools/web-fetch.response-limit.test.ts` (NEW) — 66 lines
- `src/agents/tools/web-fetch.ts` — 30 lines added
- `src/agents/tools/web-search.ts` — 9 lines modified
- `src/agents/tools/web-shared.ts` — 81 lines added
- `CHANGELOG.md`, `docs/tools/web.md` — documentation updates

**What changed:**
New response size limiting prevents DoS from attacker-controlled HTTP responses. The commit adds:

1. **HTML parsing safeguards** in `web-fetch-utils.ts`:
   - `READABILITY_MAX_HTML_CHARS = 1_000_000` — character limit before falling back to simple markdown conversion
   - `READABILITY_MAX_ESTIMATED_NESTING_DEPTH = 3_000` — depth limit to detect pathological HTML (e.g., `<div><div>...` nesting attacks)
   - `exceedsEstimatedHtmlNestingDepth()` — cheap heuristic to skip expensive DOM parsing on malicious HTML

2. **Response body capping** in `web-fetch.ts` and `web-shared.ts`:
   - New `DEFAULT_FETCH_MAX_RESPONSE_BYTES` (2 MB), `FETCH_MAX_RESPONSE_BYTES_MIN` (32 KB), `FETCH_MAX_RESPONSE_BYTES_MAX` (10 MB) constants in `web-fetch.ts:36-38` with `resolveFetchMaxResponseBytes()` resolver
   - Streaming `readResponseText()` in `web-shared.ts` accepts `maxBytes` parameter — reads response body in chunks, aborts early when limit exceeded
   - Fallback to truncated/partial responses (`{ text, truncated: true, bytesRead }`) rather than crashing

**Security impact:**
Defense-in-depth against resource exhaustion attacks via malicious web content. Prevents:
- Memory blowups from deeply nested HTML (stack overflow in DOM parsers)
- Unbounded memory allocation from large HTTP response bodies
- CPU exhaustion from expensive Readability parsing on pathological inputs

**Audit cross-reference:**
- Not directly tied to the 16 audit claims
- Strengthens web-fetch DoS resilience (web content processing is a high-attack-surface area)
- Complements existing `maxChars`/`maxResponseBytes` limits with parsing-time safeguards

### Non-Security Commits (20)

All remaining commits are internal refactoring and test consolidation:

- **Protocol refactors:** Deduplicated cron/config schemas (`f8fbeb52b`)
- **Model commands:** Shared default model update logic (`cb46ea037`)
- **Update CLI:** Consolidated package.json readers (`dece9e8b0`)
- **Daemon:** Shared service description resolution (`0dbc51aa5`), removed unused import (`5ecc364d5`)
- **Memory:** Extracted batch utils to shared module (`8251f7c23`, `58cf37cee`), added sync progress helpers (`d8691ff4e`)
- **Media:** Centralized HTTP error handling (`652318e56`)
- **Frontmatter:** Shared OpenClaw manifest parsing (`ae1880acf`)
- **Test consolidation:** 9 commits folding test suites into consolidated files (`fddf8a6f4`, `412c1d0af`, `fdd0e78d1`, `60ce38d21`, `acb2a1ce3`, `ba3a0e7ad`, `3a7b1b36b`, `3830a4b58`)
- **CI fix:** Cron test mock signature (`fd3d452f1`)

None of these refactors modify security controls, authentication flows, or audit-referenced code.

### Audit Cross-Reference

**Unaffected Claims:** All 16 audit claims and 3 legitimate gaps remain unaffected by this batch.

- **Claim 4 (DNS rebinding SSRF via web-fetch):** The new response limiting hardens web-fetch against DoS but does not address the DNS rebinding concern (which is already mitigated by `resolvePinnedHostname()`).
- **Gap 1 (Gateway env var blocklist):** Closed in earlier sync.
- **Gap 2 (Pipe-delimited token format):** Unchanged.
- **Gap 3 (outPath validation):** Unchanged.
- **Gap 4 (Bootstrap/memory .md scanning):** Unchanged.

**Line number shifts:** No changes to documented security controls. The refactored files (`web-fetch.ts`, `web-search.ts`) had minor line shifts, but all security-referenced symbols remain at their documented locations.

**Gap status:** [1 closed, 3 remain open](../post-merge-hardening.md#legitimate-gaps-status).
