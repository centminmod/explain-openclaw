> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-merge hardening (Feb 13 sync 5, 35 upstream commits)

**SECURITY-RELEVANT (5):**

1. **`9230a2ae1`** — **fix(browser): require auth on control HTTP and auto-bootstrap token:** New `src/browser/control-auth.ts` (88 lines) provides `resolveBrowserControlAuth()` and `ensureBrowserControlAuth()` which auto-generates `gateway.auth.token` when browser control is enabled. `src/browser/server.ts:50-76` adds `isAuthorizedBrowserRequest()` supporting Bearer token, `x-openclaw-password` header, and HTTP Basic auth (all using `safeEqualSecret()` for timing-safe comparison). Auth middleware at `:116-123` returns HTTP 401 for unauthenticated requests. `src/security/audit.ts:410-424` adds new `browser.control_no_auth` critical finding when browser control has no auth configured. **Partially mitigates** tracked issue [#4949](https://github.com/openclaw/openclaw/issues/4949) (DNS rebinding) — requests now require authentication, significantly raising the bar for DNS rebinding exploitation.

2. **`3421b2ec1`** — **fix: harden hook session key routing defaults:** New `HookSessionPolicyResolved` type in `src/gateway/hooks.ts:31-36` with `defaultSessionKey`, `allowRequestSessionKey`, and `allowedSessionKeyPrefixes`. New `resolveHookSessionKey()` at `:327-360` validates session keys against policy — external webhook payloads cannot override session keys unless `hooks.allowRequestSessionKey=true`, and all session keys must match configured prefixes. Validation at config load time ensures `defaultSessionKey` matches `allowedSessionKeyPrefixes` (`:57-72`). Defense-in-depth for webhook-to-session routing — prevents attackers from injecting messages into arbitrary sessions via crafted webhook payloads.

3. **`85409e401`** — **fix: preserve inter-session input provenance:** New `src/sessions/input-provenance.ts` (79 lines) with `InputProvenance` type tracking `kind` (`external_user` / `inter_session` / `internal_system`), `sourceSessionKey`, `sourceChannel`, and `sourceTool`. `applyInputProvenanceToUserMessage()` stamps provenance metadata onto user messages; `hasInterSessionUserProvenance()` enables downstream checks. Defense-in-depth for session isolation — enables distinguishing external user input from inter-session forwarded messages.

4. **`34c304727` + `22fe30c1d` + `4c0ce46ac` + `75fc8cf25` + `f7adc21d3` + `e084f0742` + `334a291fb` + `4bf06e782`** (8 commits) — **Discord: role-based allowlists + role-based agent routing:** Major Discord RBAC expansion. New `allowedRoles` configuration in `src/discord/monitor/allow-list.ts:49+` with OR logic — users matching ANY listed role pass preflight. `src/routing/resolve-route.ts:30+` now accepts `memberRoleIds` and matches against route `allowedRoles` for role-based agent routing. `src/discord/monitor/message-handler.preflight.ts:48+` integrates role checks alongside existing user/channel allowlists. `src/discord/send.permissions.ts:17+` honors `Administrator` permission for all permission checks. Full test coverage in `allow-list.test.ts` and `resolve-route.test.ts`. **Strengthens Audit 2 Claim 5** (self-approving agent / RBAC) — Discord users can now be restricted by role, not just by user ID or channel.

5. **`d34138dfe`** (PR [#15012](https://github.com/openclaw/openclaw/pull/15012)) — **fix: dispatch before_tool_call and after_tool_call hooks from both tool execution paths:** `src/agents/pi-tool-definition-adapter.ts:58+` — both the direct and adapter tool execution paths now dispatch `before_tool_call` and `after_tool_call` hooks. Previously, tools executed through the adapter path skipped these hooks. Ensures hook-based security policies (e.g., tool auditing, blocking) apply uniformly regardless of which code path invokes the tool. Thanks @Patrick-Barletta.

**NON-SECURITY (notable):**

6. **`1d8bda4a2`** (PR [#15104](https://github.com/openclaw/openclaw/pull/15104)) — **fix: emit message_sent hook for all successful outbound paths:** `src/infra/outbound/deliver.ts:56+` — ensures `message_sent` hook fires for all successful message deliveries including previously unwired paths.

7. **`89bfe0c94`** (PR [#15105](https://github.com/openclaw/openclaw/pull/15105)) — **fix: add adapter-path after_tool_call coverage:** Follow-up to PR #15012. Adds test coverage for after_tool_call hook dispatch from the adapter execution path in `src/agents/pi-tool-definition-adapter.after-tool-call.test.ts`.

8. **`da2d09f57`** (PR [#6878](https://github.com/openclaw/openclaw/pull/6878)) — **fix(memory-flush): instruct agents to append rather than overwrite memory files:** `src/hooks/bundled/session-memory/handler.ts:4+` and `src/auto-reply/reply/memory-flush.ts:1+` — session memory flush instructions now explicitly tell the agent to append to existing memory files. Prevents data loss from overwrite. Thanks @EmberCF.

9. **`57d0f65e7`** (PR [#6141](https://github.com/openclaw/openclaw/pull/6141)) — **CLI: add plugins uninstall command:** New `src/plugins/uninstall.ts` (237 lines) and `src/cli/plugins-cli.ts` (146 lines). `openclaw plugins uninstall <name>` removes installed plugins. Security-neutral — follows existing install patterns. Thanks @JustasMonkev.

**Line number shifts in this sync:** `audit.ts` +39 lines (browser control auth check + HTTP API session key check + import): old 323-343->334-353, old 914-992->953-1031, old 159-176->160-177. `hooks.ts` +65 lines (session key policy, prefix validation, resolveHookSessionKey): old 92-109->157-174, old 102-103->167-168, old 111-157->176-222. `browser/server.ts` +96 lines (auth middleware + auto-bootstrap + isAuthorizedBrowserRequest): old 36->132. All references updated in documentation.

**CVE status:** 5 published advisories — all pre-existing, none patched in this merge.

**Gap status (Feb 13 sync 5): 1 closed, 3 remain open** (pipe-delimited token format, outPath validation — Gap #3 partially mitigated, bootstrap/memory .md scanning — Gap #4 unchanged) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
