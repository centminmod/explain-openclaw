> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 18 Sync 12 (49 commits, 8 security)

**Merge commit:** 7ea7b7e7a | **Range:** 7b01202f3..7ea7b7e7a

### Security-Relevant Commits

| SHA | Message | Files | Audit Impact |
|-----|---------|-------|--------------|
| `442fdbf3d` | fix(security): block SSRF IPv6 transition bypasses | 1 prod + 1 test + 1 doc | Audit 2 Claim 4 (SSRF) |
| `28bac46c9` | fix(security): harden safeBins path trust | 1 prod + 1 test + 3 doc | Audit 2 Claim 7 (shell injection) |
| `ac0db6823` | refactor(security): extract safeBins trust resolver | 2 prod + 2 test + 1 doc | Audit 2 Claim 7 (shell injection) |
| `99db4d13e` | fix(gateway): guard cron webhook delivery against SSRF | 1 prod + 1 test + 1 doc | Audit 2 Claim 4 (SSRF) |
| `35016a380` | fix(sandbox): serialize registry mutations and lock usage | 2 prod + 1 test | Sandbox integrity |
| `cc29be8c9` | fix: serialize sandbox registry writes | 1 prod + 1 test + 1 doc | Sandbox integrity |
| `e8154c12e` | refactor(net): table-drive embedded IPv6 decoding and SSRF tests | 1 prod + 1 test | Audit 2 Claim 4 (SSRF) |
| `6a5f887b3` | test: harden Telegram command menu sanitization coverage (#19703) | 2 test + 1 doc | Defense-in-depth |

### Security Details

#### SSRF IPv6 Transition Bypass Blocked (`442fdbf3d`, `e8154c12e`)

The SSRF guard in `src/infra/net/ssrf.ts` now detects embedded IPv4 addresses within IPv6 transition mechanisms:
- **NAT64 well-known prefix** (`64:ff9b::/96`) - extracts embedded IPv4 from last 32 bits
- **Teredo prefix** (`2001:0000::/32`) - XOR-decodes client IPv4 from last 32 bits
- **IPv4-mapped IPv6** (`::ffff:a.b.c.d`) - already handled, now with explicit tests
- **Parse failure fallback:** Now returns `true` (fail closed) instead of `false` for security-critical parse errors

New helper function `extractIpv4FromEmbeddedIpv6()` at `src/infra/net/ssrf.ts:200-207` decodes transition addresses using table-driven rules (`EMBEDDED_IPV4_RULES` at line 154). The `isPrivateIpAddress()` function at line 237 now checks embedded addresses before returning.

**Files:**
- `src/infra/net/ssrf.ts` — 76 lines added (table-driven IPv6 decoding, embedded address extraction)
- `src/infra/net/ssrf.test.ts` — new test coverage for IPv6 transition bypasses

#### Cron Webhook SSRF Guard (`99db4d13e`)

Cron webhook delivery now uses `fetchWithSsrFGuard()` instead of raw `fetch()` to block private/internal IP addresses from webhook targets. This prevents attackers from configuring cron jobs that deliver webhooks to internal services.

**Files:**
- `src/gateway/server-cron.ts:270` — blocks webhook delivery to private IPs, logs warning with SSRF reason
- `src/gateway/server-cron.test.ts` — new test for SSRF-blocked webhook URLs

#### safeBins Path Trust Hardening (`28bac46c9`, `ac0db6823`)

Two related commits strengthen the safeBins execution path trust:

1. **`ac0db6823`** — Extracts trust resolution into new module `src/infra/exec-safe-bin-trust.ts`:
   - `isTrustedSafeBinPath()` at line 92 checks if resolved path is in trusted directories
   - `collectTrustedSafeBinDirs()` builds set from system paths + `$PATH`
   - Trusted directories: `/bin`, `/usr/bin`, `/usr/local/bin`, `/opt/homebrew/bin`, `/opt/local/bin`, `/snap/bin`, `/run/current-system/sw/bin`

2. **`28bac46c9`** — Enforces path trust in `isSafeBinUsage()`:
   - `src/infra/exec-approvals-allowlist.ts:65` — `isSafeBinUsage()` now rejects binaries from untrusted directories
   - Prevents execution of malicious binaries placed in `/tmp` or other world-writable directories
   - Test coverage for untrusted directory rejection

**Files:**
- `src/infra/exec-safe-bin-trust.ts` — NEW 101-line module for safeBins trust resolution
- `src/infra/exec-approvals-allowlist.ts` — integrates path trust check
- `src/infra/exec-approvals.test.ts` — new test for untrusted directory blocking

#### Sandbox Registry Serialization (`35016a380`, `cc29be8c9`)

Two commits fix race conditions in sandbox container/browser registry access:

1. **`cc29be8c9`** — Adds file-based locking via `acquireSessionWriteLock()`:
   - `withRegistryLock()` wrapper at `src/agents/sandbox/registry.ts:72-78`
   - Atomic write pattern: write to temp file with UUID suffix, then `rename()`
   - Prevents corrupted JSON from concurrent writes

2. **`35016a380`** — Extends serialization to registry mutations and lock usage

**Files:**
- `src/agents/sandbox/registry.ts` — 169 lines added (file locking, atomic writes)
- `src/agents/sandbox/registry.test.ts` — NEW 219-line test file for registry race conditions

#### Telegram Command Sanitization (`6a5f887b3`)

Test coverage for `TELEGRAM_COMMAND_NAME_PATTERN` validation that ensures only Telegram-safe command names are registered. Prevents command injection via hyphens in command names.

**Files:**
- `src/telegram/bot-native-commands.test.ts` — new test validates command names match pattern

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `7ea7b7e7a` - `8278903f0` | Various refactors, version bump, test deduplication | ~195 files | Large refactor (10,863 lines) - test deduplication, CI fixes, version bump to 2026.2.18 |

**Detailed SHAs for grouped ranges:**

**Test deduplication/refactoring (9 commits):**
- `a9cce800d`: test: dedupe slack missing-thread tests and cover history failures
- `e3292b9af`: test: dedupe sessions command tests and cover active filtering
- `112f8250f`: test: dedupe registry/session tests and add install source coverage
- `a69e7682c`: refactor(test): dedupe channel and monitor action suites
- `05b7bd2c2`: refactor: dedupe command dispatch and process poll tests
- `adac9cb67`: refactor: dedupe gateway and scheduler test scaffolding
- `262472ba2`: test: remove duplicated scenario scaffolding across runtime tests
- `d1ab85297`: test: extract shared e2e helpers for trigger handling and skills
- `b099171db`: perf(test): dedupe slow discord monitor cases

**Agent/subagent messaging fixes (3 commits):**
- `e8816c554`: Agents: fix subagent completion delivery to origin channel
- `8984f3187`: fix(agents): correct completion announce retry backoff schedule
- `289f215b3`: fix(agents): make manual subagent completion announce deterministic

**Production files changed (non-security):**
- `7ea7b7e7a`: `src/infra/git-root.ts` (NEW), `src/infra/git-commit.ts`, `src/agents/system-prompt-params.ts`
- `5c69e625f`: `src/agents/model-selection.ts`, `src/agents/subagent-spawn.ts`, `src/agents/subagent-announce.ts`
- `4d3403b7a`: `src/infra/exec-approvals-allowlist.ts` (CI fix)
- `50e555353`: `src/agents/subagent-registry.ts` (retry backoff)
- `516046dba`: `src/commands/doctor-config-flow.ts`, `src/commands/doctor.ts`
- `4bf333883`: Version bump (47 files)
- `f25bbbc37`: `src/commands/auth-choice.apply.anthropic.ts`, `src/commands/configure.gateway-auth.ts`
- `8407eeb33`: `src/shared/string-normalization.ts` (NEW), `src/channels/plugins/group-mentions.ts`

### Audit Cross-Reference

**Affected Claims:**
- **Audit 2 Claim 4 (DNS rebinding SSRF via web-fetch):** Strengthened by IPv6 transition bypass blocking (`442fdbf3d`, `e8154c12e`) and cron webhook SSRF guard (`99db4d13e`)
- **Audit 2 Claim 7 (Shell injection via incomplete regex):** Strengthened by safeBins path trust hardening (`28bac46c9`, `ac0db6823`)

**Unaffected Claims:**
- Audit 1 Claims 1-8 (OAuth, CSRF, file permissions, path traversal, webhook signatures, token expiry)
- Audit 2 Claims 1-3, 5-6, 8 (setupCommand, outPath, log traversal, RBAC, token format, env injection)

**Legitimate Gaps:**
- Gap 1 (Gateway env var blocklist): CLOSED in PR #12
- Gap 2 (Pipe-delimited token format): Still open
- Gap 3 (outPath validation in screen_record): Still open

### CVE/GHSA Cross-Reference

This sync includes fixes for:
- New advisories published 2026-02-18 (31 total in upstream, including 10 new)
- SSRF-related fixes align with ongoing SSRF hardening tracked in existing advisories

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
