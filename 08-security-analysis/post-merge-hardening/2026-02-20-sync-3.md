> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 20 sync 3 (51 commits, 11 security)

**Merge commit:** f7a8c2df2 | **Range:** 69c2ecad6..f7a8c2df2

### Security-Relevant Commits

| SHA | Message | Files | Security Impact |
|-----|---------|-------|-----------------|
| `c0cd5a726` | Net: strip sensitive headers on cross-origin redirects | 1 prod + 1 test | Header leakage prevention during cross-origin HTTP redirects |
| `a688ccf24` | refactor(security): unify safe-bin argv parsing and harden regressions | 4 prod + 3 test | Command injection defense in safe-bin exec allowlist |
| `2e421f32d` | fix(security): restore trusted plugin runtime exec default | 6 prod + 1 test + 2 doc | Plugin execution security policy restoration |
| `c45f3c5b0` | fix(gateway): harden canvas auth with session capabilities | 6 prod + 2 test + 3 doc | Canvas authentication hardening with capability checks |
| `63e39d7f5` | fix(security): harden ACP prompt size guardrails | 2 prod + 2 test + 1 doc | DoS prevention via prompt size limits (CWE-400) |
| `ebcf19746` | fix(security): OC-53 validate prompt size before string concatenation | 2 prod | Memory exhaustion prevention in ACP (OC-53) |
| `732e53151` | fix(security): OC-53 enforce 2MB prompt size limit to prevent ACP DoS | 1 prod | ACP DoS mitigation with 2MB limit (CWE-400) |
| `280c6b117` | fix(daemon): harden windows schtasks script quoting | 1 prod + 1 test + 1 doc | Command injection prevention in Windows task scheduler |
| `dafe52e8c` | fix(daemon): escape schtasks environment assignments | 1 prod + 1 test | Environment injection prevention in Windows scheduled tasks |
| `dcd592a60` | refactor: eliminate jscpd clones and boost tests | 5 prod + 11 test | Refactor touching plugin install paths (hooks/install.ts) |
| `edf92f1cb` | refactor: share npm integrity drift handling | 4 prod + 1 test | Refactor touching plugin install/update paths |

### Key Security Changes

1. **Cross-Origin Header Stripping** (`c0cd5a726`): New `stripSensitiveHeadersForCrossOriginRedirect()` function at `src/infra/net/fetch-guard.ts:46` strips sensitive headers (Authorization, Cookie, X-API-Key, etc.) when HTTP redirects cross origins. Prevents credential leakage to attacker-controlled redirect targets.

2. **ACP Prompt Size Limits (OC-53)** (`63e39d7f5`, `ebcf19746`, `732e53151`): New `MAX_PROMPT_BYTES = 2MB` constant at `src/acp/translator.ts:44` prevents memory exhaustion DoS via oversized prompts. Size validation before string concatenation prevents OOM attacks.

3. **Safe-Bin Argv Parsing Hardening** (`a688ccf24`): Unified argv parsing in `src/infra/exec-safe-bin-policy.ts` with improved handling of edge cases and command injection vectors.

4. **Windows Schtasks Injection Fixes** (`280c6b117`, `dafe52e8c`): Script quoting and environment assignment escaping in `src/daemon/schtasks.ts` prevent command injection via crafted environment variables or task arguments.

5. **Canvas Auth Hardening** (`c45f3c5b0`): Session capabilities added to canvas authentication in `src/gateway/canvas-capability.ts` for fine-grained access control.

### Non-Security Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `f7a8c2df2` | Discord: handle gateway 4014 close | 1 prod + 1 doc | Discord connection handling |
| `802f043e5` | Net: expand cross-origin sensitive header regression test | 1 test | Test for security fix |
| `7579e9511` | Auto-reply: delay onAgentRunStart until real activity | 1 prod + 1 test | Auto-reply timing fix |
| `4b7d89100` | fix(auto-reply): restore prompt cache stability by moving per-turn ids to user context (#20597) | 1 prod + 1 test + 1 doc | Auto-reply caching |
| `a1d5dce7a` | iOS: use dedicated session key for chat sheet (#21139) | 3 prod + 1 doc | iOS feature |
| `42d11a3ec` | iOS: auto-resync chat after reconnect gaps (#21135) | 4 prod + 1 doc | iOS feature |
| `bf8117ad3` | fix(update): silence npm deprecation/funding noise | 1 prod + 1 test | CLI UX improvement |
| `45d9b2069` | fix(cli): refresh gateway service env during update (#21071) | 1 prod + 1 test | CLI bug fix |
| `3077c3583` | fix(ui): unblock docker onboarding build | 7 prod | UI/logging refactor |
| `30e36c30d` | fix(ci): tighten test typing for browser and cron cli | 2 test | CI test typing |
| `018370e82` | fix(ci): normalize path assertions across platforms | 2 test | CI cross-platform |
| `3a258e7ca` | fix(ci): add explicit mock export types for harnesses | 2 prod | CI test harness |
| `e96c6a7a3` | fix(ci): format cron tool imports | 1 prod | CI formatting |
| `bc6f983f8` | fix(ci): resolve format drift and acp mock typing | 2 prod + 1 test | CI formatting |
| `d3bf6e1b9` | test: harden mock order and shell path coverage | 2 test | Test hardening |
| `71983716f` | test: share channels command mock harness | 1 prod + 2 test | Test harness sharing |
| `0213a0921` | test: share temp home env harness | 1 prod + 3 test | Test harness sharing |
| `f76f98b26` | chore: fix formatting drift and stabilize cron tool mocks | 7 prod + 14 test | Formatting/import reordering |

### Audit Cross-Reference

**Affected Claims:**
- **Claim 7 (Webhook signature bypass):** Unrelated - no webhook changes
- **Audit 2 Claim 1 (Config injection RCE):** Indirectly related - schtasks fixes harden command execution on Windows

**Unaffected Claims:** All 16 audit claims remain unchanged in verdict. The 3 legitimate gaps (env blocklist, token format, outPath validation) remain open.

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).

### New Files Created

- `src/agents/tool-policy-shared.ts` — Shared tool policy types
- `src/gateway/canvas-capability.ts` — Canvas session capabilities (NEW)
- `src/infra/exec-approvals-analysis.ts` — Exec approval analysis utilities
- `src/infra/npm-integrity.ts` — npm integrity validation
- `src/daemon/cmd-argv.ts`, `src/daemon/cmd-set.ts` — Windows command argv helpers

### Phase 6c: CVE/GHSA Check

Phase 6c: 31 advisories found. 11 new advisories from Feb 18-19 require documentation update:
- GHSA-6c9j-x93c-rw6j, GHSA-4685-c5cp-vp95 (Feb 19) - safeBins vulnerabilities
- CVE-2026-27001/27002/27003/27004/27007/27008/27009 (Feb 18) - Various sandbox, path injection, XSS issues
