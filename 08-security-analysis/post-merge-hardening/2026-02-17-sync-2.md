> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 17 sync 2 (120 commits)

**Merge commit:** 06b961b03 | **Range:** eab3cddd4..06b961b03

> Large refactor batch: 16,462 lines changed. Includes ~21 test deduplication refactors, i18n/UI additions, Slack streaming features, and Discord component work. 94 flagged pre-triage → 70 after haiku triage (24 demoted, 7 demotion rejections via keyword guard).

### Security-Relevant Commits (15)

| SHA | Message | Files | Audit Cross-Ref |
|-----|---------|-------|-----------------|
| `b0a01fe48` | Agents/Tools: preflight exec script files for shell var injection (#18457) | 1 prod + 2 test + 1 doc | **Claim 7** — DIRECTLY ADDRESSES |
| `f27561186` | fix(sandbox): restore SHA-1 in slugifySessionKey to preserve workspace dirs (#18503) | 1 prod + 1 test | Sandbox integrity |
| `feed57098` | fix: syncs all credential types to agent auth.json | 1 prod + 1 test | **Claim 1** — REINFORCES |
| `0587e4cc7` | fix(agents): restrict MEDIA: token parsing to line start in tool results (#18510) | 1 prod + 1 test | Input validation hardening |
| `e95134ba3` | fix (commands): keep webchat auth on internal provider | 1 prod + 1 test | **Claim 5** — REINFORCES |
| `20957efa4` | fix(process): graceful process tree termination with SIGTERM before SIGKILL | 1 prod | Process isolation |
| `3646625dc` | Infra: skip Discord text exec approvals | 1 prod + 1 test + 1 doc | Exec approval workflow |
| `02c268eec` | fix (gateway/memory): start qmd onBoot for all agents | 1 prod + 1 test | **Claim 8** — REINFORCES |
| `03cadc4b7` | fix(auth): auto-expire stale auth profile cooldowns and reset error count | 3 prod + 2 test + 1 doc | **Claim 4** — ADDRESSES |
| `72e228e14` | Heartbeat: allow suppressing tool warnings (#18497) | 10 prod + 1 test + 3 doc | Execution transparency |
| `93fbe6482` | fix(sessions): archive transcript files when pruning stale entries | 1 prod + 1 test | **Claim 5** — REINFORCES |
| `441401221` | fix(media): clean expired files in subdirectories | 1 prod + 1 test | **Claim 3** — REINFORCES |
| `d799a3994` | fix(doctor): reconcile gateway service token drift after re-pair | 2 prod + 2 test | **Claim 1** — REINFORCES |
| `5f821ed06` | fix(session): prevent stale threadId leaking into non-thread sessions | 1 prod + 1 test | Session isolation |
| `01b37f1d3` | fix(telegram): handle large file getFile errors gracefully | 1 prod + 1 test | Error handling hardening |

### Commit Details

1. **`b0a01fe48`** — **NEW** Shell variable injection preflight validation.
   - `src/agents/bash-tools.exec.ts:123` — `extractScriptTargetFromCommand()` parses script target from exec commands
   - `src/agents/bash-tools.exec.ts:148` — `validateScriptFileForShellBleed()` reads script content and checks for unescaped shell variables
   - `src/agents/bash-tools.exec.ts:179` — regex `/\$[A-Z_][A-Z0-9_]{1,}/g` detects all-caps env var patterns (e.g., `$DATABASE_URL`) in Python/Node scripts
   - `src/agents/bash-tools.exec.ts:973` — enforcement point: called before exec in the main execution path
   - **Directly mitigates Audit 2 Claim 7** (shell injection via incomplete regex) by detecting leaked shell variables before execution

2. **`f27561186`** — Restores SHA-1 hash in sandbox session key slugification.
   - `src/agents/sandbox/shared.ts:7-17` — `slugifySessionKey()` uses `createHash("sha1")` with first 8 chars to preserve workspace directory stability across upgrades

3. **`feed57098`** — Syncs all credential types to agent `auth.json`.
   - `src/agents/pi-auth-json.ts:106` — `ensurePiAuthJsonFromAuthProfiles()` bridges api_key, token, and oauth credentials into the agent's auth.json for pi-coding-agent compatibility

4. **`0587e4cc7`** — Restricts MEDIA token parsing to line start.
   - `src/agents/pi-embedded-subscribe.tools.ts:160` — `if (!line.trimStart().startsWith("MEDIA:"))` check prevents false-positive media path extraction from mid-line content or artifact mentions

5. **`e95134ba3`** — Keeps webchat auth on internal provider.
   - `src/auto-reply/command-auth.ts` — preserves authentication routing for webchat sessions through the internal provider path, preventing auth bypass via provider switching

6. **`20957efa4`** — Graceful process tree termination.
   - `src/process/kill-tree.ts:28-34` — sends SIGTERM to process group first (`process.kill(-pid, "SIGTERM")`)
   - `src/process/kill-tree.ts:41-61` — waits grace period, then escalates to SIGKILL if process is still alive
   - Prevents orphaned subprocesses from persisting after agent shutdown

7. **`3646625dc`** — Skips Discord text exec approvals.
   - `src/infra/exec-approval-forwarder.ts:102` — `shouldSkipDiscordForwarding()` returns true when channel is Discord (uses component-based approvals instead of text forwarding)
   - `src/infra/exec-approval-forwarder.ts:274` — filtered targets exclude Discord text-based forwarding

8. **`02c268eec`** — Starts qmd onBoot for all agents.
   - Ensures gateway memory (qmd) initialization on boot for all agents, not just the first, improving session state consistency

9. **`03cadc4b7`** — Auto-expire stale auth profile cooldowns.
   - `src/agents/auth-profiles/usage.ts:57-112` — when `cooldownUntil` or `disabledUntil` has passed, resets `errorCount` and clears the cooldown fields (circuit-breaker half-open → closed transition)
   - Prevents indefinite rate-limit lockout from stale cooldown persistence

10. **`72e228e14`** — Heartbeat: allow suppressing tool warnings.
    - Adds `suppressToolErrorWarnings` flag across 14 files including `src/infra/heartbeat-runner.ts`
    - Allows gateway to control warning verbosity for execution approval transparency

11. **`93fbe6482`** — Archive transcript files when pruning stale entries.
    - `src/config/sessions/store.ts:322` — `pruneStaleEntries()` now archives transcript files instead of deleting them, preserving audit trail

12. **`441401221`** — Clean expired media files in subdirectories.
    - Extends media cleanup to recursively handle subdirectories, preventing orphaned expired files from accumulating

13. **`d799a3994`** — Reconcile gateway service token drift after re-pair.
    - `src/daemon/service-audit.ts` — NEW audit check detects when daemon's `OPENCLAW_GATEWAY_TOKEN` drifts from `gateway.auth.token` in `openclaw.json`
    - `src/commands/doctor-gateway-services.ts` — passes `cfg.gateway.auth.token` into service audits so `openclaw doctor` can detect and fix token mismatch after re-pairing

14. **`5f821ed06`** — Prevent stale threadId leaking into non-thread sessions.
    - `src/auto-reply/reply/session.ts` — only falls back to `baseEntry.lastThreadId` for thread sessions; non-thread sessions leave threadId unset, preventing bot from replying into old topics

15. **`01b37f1d3`** — Handle large file getFile errors gracefully.
    - `src/telegram/bot/delivery.ts` — adds error handling for Telegram file retrieval failures, preventing crashes on large file download errors

### Non-Security Commits (24)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `06b961b03` | fix: flatten remaining anyOf/oneOf in Gemini schema cleaning | 4 | Provider schema normalization |
| `1bbf6206d` | fix: exclude google-antigravity from Gemini schema sanitization | 1 | Provider-specific handling |
| `fe94e83f6` | fix: make tool schema normalization provider-aware | 2 | Provider schema normalization |
| `304bfefaf` | chore: remove unused channelName parameter from ensureWildcard | 1 | Code cleanup |
| `b05273de6` | fix: doctor --fix auto-repairs dmPolicy="open" missing allowFrom wildcard | 2 | Config doctor repair logic |
| `89ce1460e` | feat(slack): add configurable stream modes | 8 | Slack streaming feature |
| `087edec93` | feat(slack): add draft preview cleanup lifecycle | 3 | Slack message lifecycle |
| `dfd5a7963` | fix(slack): pass account token for draft final chat.update | 1 | Slack message delivery fix |
| `bec974aba` | feat(slack): stream partial replies via draft message updates | 3 | Slack streaming feature |
| `e8b03a862` | fix(agents): replace anyOf with string in image tool schema | 1 | Schema simplification |
| `6d31d1ecc` | fix(plugins): enforce high-priority override precedence | 2 | Plugin override priority |
| `b90eb5152` | feat(plugins): add modelOverride/providerOverride to before_agent_start hook | 6 | Plugin hook expansion |
| `15dd2cda2` | feat: show transcript file size in session status | 5 | Session status UX |
| `fc6d53c89` | fix: correct import path in test and restore deleted schema help entries | 2 | Import path fix |
| `6d2e3685d` | feat(tools): add URL allowlist for web_search and web_fetch | 8 | Web tool access control |
| `e179d453c` | fix: resolve #12770 - update Antigravity default model and trim leading whitespace in BlueBubbles replies | 5 | Provider config fix |
| `24f213e7e` | feat(tool-display): add intent-first details and exec summaries | 5 | Tool display UX |
| `12ce358da` | fix(failover): recognize 'abort' stop reason as timeout for model fallback | 2 | Failover logic fix |
| `32c66aff4` | fix: add windowsHide: true to spawn in runCommandWithTimeout | 1 | Windows process spawn |
| `e5eb5b3e4` | feat: add stuck loop detection and exponential backoff infrastructure for agent polling (#17118) | 12 | Agent polling DoS mitigation |
| `1b7301051` | Config: require Discord ID strings (#18220) | 13 | Discord ID validation |
| `c593709d2` | Discord: add per-button component allowlist | 5 | Discord component access |
| `1567d6cbb` | feat(discord): download attachments from forwarded messages (#17049) | 4 | Discord attachment feature |
| `f476c8b48` | Fix #12767: Heartbeat  strip responsePrefix before HEARTBEAT_OK suppression | 2 | Heartbeat message handling |

### Safe / Demoted Commits (81)

> These commits were classified as safe by analyze-commits.sh (26) or demoted from flagged by haiku triage (24), or non-security flagged (31). Primarily test harness deduplication, i18n/UI, documentation, and formatting.

**Test refactors** (21 commits): `refactor(test*)` harness deduplication — dispatch test flow (`769f7631d`), doctor legacy fixtures (`af5d4ac7d`), discord component fixtures (`389eb8ba1`), discord attachment resolution (`abbe04b18`), reaction notification flow (`1aabe9712`), pi-tools loop detection (`61859377a`), discord message handler harness (`05bfb7f9f`), slack monitor event fixtures (`054745a7e`), cron service harness (`11f3da766`), trusted-proxy auth setup (`9b7084956`), antigravity usage fixtures (`96eabcbe8`), web tool defaults (`b0035a1e4`), legacy config policy (`8a1893a21`), auth choice options (`9372df45f`), trigger model fixtures (`23480bb4e`), sandbox config helpers (`9ff473fa0`), isolated cron turn setup (`30c8361d0`), dispatch-from-config setup (`5d40d4750`), web fetch e2e setup (`74c49c943`), heartbeat runner scaffolding (`9c6e879a0`), agent/memory CLI setup (`c7e386982`).

**i18n/UI** (12 commits): i18n support with English/Chinese/Portuguese (`4b17ce7f4`), zh-TW locale additions (`98ed2e713`, `a9c952b13`), locale validation (`cf44a0c4c`), auto-refresh sessions list (`382158fb3`), ESM import fixes (`f20bef3d7`), lint fixes (`d30f5a243`, `075317ab1`, `1bb2d65ff`, `fe613297a`), oxfmt formatting (`66fc12a40`, `e0c45eab4`).

**Docs/chore** (18 commits): cron troubleshooting docs (`a03098ca4`), fly.io frontmatter fix (`348ea6be9`), exec pty docs (`d2dd28203`), video-quote-finder skill + reverts (`61726a2fb`, `d0793cbb9`, `71dad8919`, `e2f28ff4c`, `28216956e`, `84a37129f`), changelog entries (`d35172cce`, `21e5c0ce5`, `0f6b39ea5`, `c953cfdee`, `1cf3aba3f`), heartbeat test updates (`1953b938e`), carbon update (`d3707147c`), test file reference fix (`290f33759`), doctor deprecated auth ref (`0af795287`).

**Discord** (5 commits): reusable component option (`05a83b9e9`), native exec options (`fc60336c1`), non-forum thread creation (`81d2a91a9`), reaction status state machine (`7c240a2b5`), bare numeric ID normalization (`3238bd78d`).

**Other** (25 commits): Windows scaffold helpers (`b6d934c2c`), doctor runtime quit (`78c34bcf3`, `254041717`), Telegram voice transcription (`c15385fc9`), Telegram DM thread ID (`0cff8bc4e`), sanitizer leak corpus (`5801c4f98`, `eec1f3e9d`), tool display formatting (`facfa410a`), Windows ui.js spawn fix (`b60b44b42`), oxfmt formatting (`b9c45d003`, `c89eb351e`, `8947d2dea`), session-memory fallback (`19ae7a4e1`), process poll backoff (`23f5cc80a`), cron scheduling guard (`5a26d1c62`), heartbeat test assertions (`1f99d8271`), Greptile review fix (`250896cf6`), reminder note guard (`4e930db43`), plugin test (`2456b1758`), hooks install fixtures (`616d4692a`), CLI dedup (`9a29d7833`), CLI help normalization (`fc8290af4`, `b25f334fa`), heartbeat formatting (`c08e8c035`, `a0191426d`).

### Audit Cross-Reference

| Claim/Gap | Status |
|-----------|--------|
| **Claim 1** (Plaintext token storage) | **REINFORCED** — `feed57098` syncs all credential types; `d799a3994` detects token drift after re-pairing |
| **Claim 3** (Log traversal) | **REINFORCED** — `441401221` recursive subdirectory cleanup prevents orphaned files |
| **Claim 4** (Token refresh race condition) | **ADDRESSED** — `03cadc4b7` auto-expires stale cooldowns, prevents indefinite lockout |
| **Claim 5** (RBAC self-approval) | **REINFORCED** — `e95134ba3` maintains webchat auth on internal provider; `93fbe6482` preserves audit trail |
| **Claim 7** (Shell injection via incomplete regex) | **DIRECTLY ADDRESSED** — `b0a01fe48` adds preflight validation detecting unescaped shell variables in scripts |
| **Claim 8** (Token expiry validation) | **REINFORCED** — `02c268eec` ensures qmd initialization consistency across all agents |
| **Gap 1** (Gateway-side env var blocklist) | Not affected (already closed) |
| **Gap 2** (Pipe-delimited token format) | Not affected |
| **Gap 3** (outPath validation) | Not affected |

### Stale Line References Updated

The following source files changed in this sync, requiring doc reference updates:

| File | Old Ref | New Ref | Reason |
|------|---------|---------|--------|
| `src/infra/net/ssrf.ts` | `isPrivateIpAddress` at `:193-257` | `:186-250` | 7-line shift from parseIpv6Hextets changes |
| `src/infra/net/ssrf.ts` | `parseIpv6Hextets` at `:91-150` | `:84-143` | Same 7-line shift |
| `src/infra/net/ssrf.ts` | `extractIpv4FromEmbeddedIpv6` at `:152-165` | `:145-158` | Same 7-line shift |
| `src/infra/net/ssrf.ts` | `resolvePinnedHostnameWithPolicy` at `:337-389` | `:330-382` | Same 7-line shift |
| `src/auto-reply/command-auth.ts` | `resolveCommandAuthorization` at `:203-328` | `:218-343` | 15-line shift |
| `src/config/sessions/store.ts` | `updateSessionStoreEntry` at `:760` | `:777` | 17-line shift |
| `src/process/exec.ts` | `runCommandWithTimeout` at `:119` | `:98` | 21-line shift (backward) |
| `src/agents/tools/web-fetch.ts` | headers block at `:420-425` | `:561-565` | 141-line shift from URL allowlist additions |

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
