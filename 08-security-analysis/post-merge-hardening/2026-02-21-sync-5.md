# Post-Merge Hardening: Feb 21 Sync 5

**Date:** 2026-02-21
**Commit Range:** `9464afaab`..`d2a729374` (26 commits)
**Merge SHA:** `081883fc4`
**Security-Relevant:** 3 commits
**Non-Security:** 23 commits (including 7 demoted via triage)

---

## Security-Relevant Commits

| SHA | Message | Description |
|-----|---------|-------------|
| `c20d519e0` | feat(security): migrate sha1 hashes to sha256 for synthetic ids (#7343) (#22528) | Cryptographic upgrade: migrates all synthetic ID generation from SHA1 to SHA256. Affected functions: `formatOwnerDisplayId()` (src/agents/system-prompt.ts:78), `shortHash()` (src/agents/tool-call-id.ts:98), `resolveGatewayLockPath()` (src/infra/gateway-lock.ts:159). SHA256 provides stronger collision resistance than deprecated SHA1. |
| `9abab6a2c` | Add explicit ownerDisplaySecret for owner ID hash obfuscation (#22520) | Privacy enhancement: adds `ownerDisplay` and `ownerDisplaySecret` config options (src/config/types.messages.ts:158-159) for obfuscating owner IDs in system prompts. When `ownerDisplay: "hash"`, owner numbers are replaced with 12-char HMAC-SHA256 hashes. Optional secret enables keyed hashing for consistent per-deployment obfuscation. Files: src/agents/system-prompt.ts, src/config/zod-schema.session.ts:165-166. |
| `fe609c0c7` | security(hooks): block prototype-chain traversal in webhook template getByPath (#22213) | Prototype pollution fix: blocks `__proto__`, `prototype`, and `constructor` keys in webhook template path resolution. New `BLOCKED_PATH_KEYS` set at line 444 prevents prototype-chain traversal attacks in `getByPath()` function. File: src/gateway/hooks-mapping.ts:444-446. |

---

## Non-Security Commits (23)

| SHA | Message | Notes |
|-----|---------|-------|
| `d2a729374` | Docs: issue template copy cleanup (#22546) | |
| `dcf2c6d7f` | docs: normalize Amazon Bedrock setup section labels (#22549) | |
| `e36245bd3` | docs: finalize onboarding option heading normalization (#22547) | |
| `ef42fe009` | docs: rename Tlon setup heading (#22544) | |
| `b5a77b9cb` | docs: finalize remaining setup heading phrasing (#22543) | |
| `d7891badd` | docs: more channel heading consistency updates (#22541) | |
| `78caf9ec3` | feat(ios): surface gateway talk defaults and refresh icon assets (#22530) | Demoted: iOS app icons only |
| `e93e67bc8` | docs: fix thinking section heading link target (#22539) | |
| `7c593cd33` | docs: finish onboarding/config heading consistency (#22537) | |
| `79183852f` | docs: more channel onboarding naming cleanup (#22536) | |
| `4c4147fb0` | docs: continue onboarding terminology cleanup (#22535) | |
| `5eca08dab` | Chore: trim stale TODOs and issue-template language (#22534) | Demoted: comment cleanup |
| `12d75ff7f` | docs: continue channel onboarding/config naming cleanup (#22533) | |
| `436f79839` | docs: more channel onboarding heading consistency (#22532) | |
| `325992b77` | docs: small docs sweep consistency updates (#22531) | |
| `0bee3f337` | MSTeams: dedupe sent-message cache storage (#22514) | Demoted: performance |
| `f4a59eb5d` | Chore: harden A2UI bundle dependency resolution (#22507) | Demoted: build tooling |
| `187f4ea41` | deadcode: remove unused extension dev dependencies (#22495) | Demoted: cleanup |
| `55eab106a` | chore: remove root long and rolldown deps (#22481) | Demoted: cleanup |
| `40f1a6c0d` | chore: Dedupe sent-message cache storage (#22127) | Demoted: performance |
| `92ac6c95c` | CI: format github workflow (#22497) | |
| `35fd32211` | chore: format CI workflow (#22482) | |
| `7428f5a74` | chore: format files for oxfmt (#22479) | |

---

## Audit Cross-Reference

All 16 audit claims unchanged by this sync. The 3 legitimate gaps remain open.

### Key Security Changes

1. **SHA1→SHA256 Migration (c20d519e0):** All synthetic ID generation now uses SHA256 instead of SHA1. This is a defense-in-depth upgrade as SHA1 is cryptographically deprecated (collision attacks demonstrated since 2017).

2. **Owner ID Hash Obfuscation (9abab6a2c):** New privacy feature allows hiding raw owner phone numbers/IDs in system prompts. When `ownerDisplay: "hash"` is set, owner IDs are replaced with 12-character HMAC-SHA256 hashes. Optional `ownerDisplaySecret` enables per-deployment keyed hashing.

3. **Prototype Pollution Prevention (fe609c0c7):** Webhook template path resolution now blocks access to `__proto__`, `prototype`, and `constructor` keys, preventing prototype-chain traversal attacks that could escalate to RCE in some scenarios.

---

## Line Number Shifts

### `src/agents/system-prompt.ts`

| Symbol | Old Line | New Line | Notes |
|--------|----------|----------|-------|
| `formatOwnerDisplayId()` | N/A | 78 | NEW function (HMAC-SHA256 hash) |
| `buildOwnerIdentityLine()` | N/A | 86 | NEW function |
| `createHmac` import | N/A | 1 | NEW import |

### `src/agents/tool-call-id.ts`

| Symbol | Old Line | New Line | Notes |
|--------|----------|----------|-------|
| `shortHash()` | 98 | 98 | Changed SHA1→SHA256 |

### `src/gateway/hooks-mapping.ts`

| Symbol | Old Line | New Line | Notes |
|--------|----------|----------|-------|
| `BLOCKED_PATH_KEYS` | N/A | 444 | NEW set for prototype blocking |
| `getByPath()` | ~440 | 446 | Added blocked key check |

### `src/infra/gateway-lock.ts`

| Symbol | Old Line | New Line | Notes |
|--------|----------|----------|-------|
| `resolveGatewayLockPath()` | 159 | 159 | Changed SHA1→SHA256 |

---

## Triage Summary

- **Initial flagged:** 10 commits
- **After triage:** 3 commits (7 demoted as false positives)
- **Demotions:**
  - `78caf9ec3` - iOS app icons (cosmetic)
  - `5eca08dab` - TODO/comment cleanup
  - `0bee3f337` - MSTeams cache dedupe (performance)
  - `f4a59eb5d` - Build tooling hardening
  - `187f4ea41` - Unused dependency removal
  - `55eab106a` - Build dependency removal
  - `40f1a6c0d` - Telegram cache dedupe (performance)

---

> **Gap status:** [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status) (1 closed, 3 remain open)
