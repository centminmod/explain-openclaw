> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 21 sync 1 (35 commits, 5 security)

**Merge commit:** c37843924 | **Range:** 0c07326ca..c37843924

### Security-Relevant Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `914a7c535` | fix: Device Token Scope Escalation via Rotate Endpoint (#20703) | 4 prod | Scope escalation prevention via `approvedScopes` tracking |
| `40a292619` | fix: Control UI Insecure Auth Bypass Allows Token-Only Auth Over HTTP (#20684) | 4 prod | Removes `allowInsecureAuth` bypass for Control UI |
| `8c9f35cdb` | Agents: sanitize skill env overrides | 5 prod + 2 test | Blocks dangerous env vars (`NODE_OPTIONS`, `LD_PRELOAD`) in skill overrides |
| `868fe48d5` | fix(gateway): allow health method for all authenticated roles (#19699) | 2 prod + 2 test | Health endpoint scope bypass for monitoring |
| `0692927cc` | Changelog: note canvas auth hardening | 1 doc | Documents canvas auth hardening fix |

### Key Security Changes

#### 1. Device Token Scope Escalation Fix (`914a7c535`)

Fixes a privilege escalation vulnerability where the device token rotate endpoint could escalate scopes beyond originally-approved limits.

- **`src/infra/device-pairing.ts:59`** — New `approvedScopes` field tracks maximum approved scope set
- **`src/infra/device-pairing.ts:180`** — `scopesAllow()` function for scope comparison
- **`src/infra/device-pairing.ts:191-196`** — `DEVICE_SCOPE_IMPLICATIONS` constant + `expandScopeImplications()` for scope hierarchy
- **`src/infra/device-pairing.ts:214`** — `scopesAllowWithImplications()` validates rotate requests
- **`src/infra/device-pairing.ts:577`** — `rotateDeviceToken()` calls scope validation
- **`src/gateway/server-methods/devices.ts:27`** — `redactPairedDevice()` strips `approvedScopes` from responses

#### 2. Control UI Auth Bypass Fix (`40a292619`)

Removes the `allowInsecureAuth` config option's ability to bypass secure-context requirements for Control UI.

- **`src/gateway/server/ws-connection/message-handler.ts:346`** — `allowControlUiBypass` now only uses `disableControlUiDeviceAuth`, not `allowInsecureAuth`
- **`src/gateway/server/ws-connection/message-handler.ts:433`** — `markHandshakeFailure()` includes `insecureAuthConfigured` metadata
- **`src/security/audit.ts:354`** — Audit check updated: `allowInsecureAuth=true` is now legacy, no longer bypasses secure context

Control UI now requires HTTPS/localhost AND device pairing even with `allowInsecureAuth=true`.

#### 3. Skill Env Override Sanitization (`8c9f35cdb`)

Adds comprehensive sanitization of skill environment variable overrides to prevent code injection.

- **`src/agents/skills/env-overrides.ts:17-22`** — `HARD_BLOCKED_SKILL_ENV_PATTERNS` blocks `NODE_OPTIONS`, `OPENSSL_CONF`, `LD_PRELOAD`, `DYLD_INSERT_LIBRARIES`
- **`src/agents/skills/env-overrides.ts:28`** — `sanitizeSkillEnvOverrides()` enforces blocklist
- **`src/agents/sandbox/sanitize-env-vars.ts:45`** — `validateEnvVarValue()` validates for null bytes and shell-unsafe chars

Skills can now only override env vars declared in `requires.env` metadata or via `primaryEnv`.

#### 4. Health Method Authorization (`868fe48d5`)

Allows the `health` method for all authenticated roles without scope requirements.

- **`src/gateway/server-methods.ts:42`** — Early-return check bypasses role/scope validation for health checks

Enables monitoring tools to probe gateway health without elevated permissions. Low risk — health returns status only, no sensitive data.

### Additional Security-Adjacent Commits

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `c37843924` | Security: harden tool media paths | 6 prod + 4 test | Media path validation in embedded tools |
| `39816e61b` | Security: restrict canvas jsonlPath file reads | 2 prod + 1 test | Canvas file path validation |
| `8e4f6c038` | fix(browser): block upload symlink escapes (#21972) | 4 prod + 2 test | Symlink escape prevention |
| `61f646c41` | Daemon: harden systemd unit env rendering | 2 prod + 1 test | Systemd env hardening |
| `582870834` | iOS/Gateway: harden pairing resolution | 4 prod + 2 test | iOS pairing hardening |
| `5dd304d1c` | fix(gateway): clear pairing state on device token mismatch | 3 prod + 2 test | Token mismatch handling |
| `094dbdaf2` | fix(gateway): require loopback proxy IP for trusted-proxy | 3 prod + 1 test | Trusted-proxy loopback enforcement |
| `9c5249714` | fix(gateway): trusted-proxy auth rejected when bind=loopback | 3 prod + 2 test | Trusted-proxy auth fix |
| `8775d34fb` | fix(pairing): simplify pending merge and harden mixed-role onboarding | 3 prod | Mixed-role onboarding hardening |
| `1da23be30` | fix(pairing): preserve operator scopes for ios onboarding | 3 prod | iOS scope preservation |
| `7ecfc1d93` | fix(auth): bidirectional mode/type compat + sync OAuth | 9 prod + 5 test | OAuth synchronization |

### Non-Security Commits (demoted after triage)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `1b886e737` | docs(ui): add animated underline for nav tabs (#21912) | 2 doc | UI documentation only |
| `72e937a59` | fix(gitignore): add mise configuration files | 1 other | Gitignore only |
| `7bee4ea33` | fix(gitignore): include top-level .agents directory | 1 other | Gitignore only |
| `e2c5f8fda` | chore: ignore .agents directory | 1 other | Gitignore only |
| `fd8c6d1f7` | iOS: refresh phone/watch app icons | 31 other | Icon assets only |
| `09e697038` | Discord: implement stream preview mode | 6 prod + 4 test | Feature addition, not security-critical |
| `9476dda9f` | iOS Chat: clean UI noise and format tool outputs | 5 prod + 3 test | UI cleanup only |
| `f52476f18` | iOS Watch: bridge mirrored notification actions | 2 prod + 1 test | Notification handling |

### Other Commits (iOS/Gateway features, tests, docs)

| SHA | Message | Files |
|-----|---------|-------|
| `67edc7790` | iOS: gate capabilities by permissions | 5 prod + 3 test |
| `84281abd4` | Docker: drop root in test images | 4 other |
| `c8ee33c16` | fix(gateway): include export name in hook transform cache key | 2 prod + 1 test |
| `618b36f07` | fix(gateway): return 404 for missing static assets | 2 prod + 1 test |
| `fe3215092` | test(ios): cover IPv4-mapped IPv6 loopback | 1 prod + 1 test |
| `738b01162` | iOS/watch: add actionable watch approvals | 6 prod + 4 test |
| `774d73b45` | fix(macos): reject insecure non-loopback ws remote gateway urls | 2 prod + 1 test |
| `ebae6f918` | fix(shared): reject insecure non-loopback gateway deep links | 2 prod + 2 test |
| `8fa46d709` | fix(ios): force tls for non-loopback manual gateway hosts | 3 prod + 1 test |
| `741435aac` | fix(web): remove unrelated login changes | 2 prod |
| `ac0c1c26b` | fix: preserve ios bg refresh plist key | 2 prod + 1 test |

### Audit Cross-Reference

- **gateway.control_ui.insecure_auth (CRITICAL):** Affected by `40a292619`. The check now correctly reflects that `allowInsecureAuth=true` no longer bypasses secure-context requirements.
- **Device Token Scope Enforcement:** New security control introduced by `914a7c535`. The `approvedScopes` field and scope implication hierarchy prevent escalation via rotate endpoint.
- **Skill Env Override Security:** New hardening by `8c9f35cdb`. Blocks dangerous env vars from skill config overrides. Complements existing exec runtime hardening (Legitimate Gap #1, closed in PR #12).

### Unaffected Claims

All 16 audit claims and 3 legitimate gaps from the security audits remain valid. The commits in this sync strengthen existing controls without changing verdicts.

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
