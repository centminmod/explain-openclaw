> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 17 sync 5 — 60 commits)

**Merge commit:** `690ec492d` | **Range:** `0bbb2a075..690ec492d`

60 upstream commits. 6 security-relevant: OC-09 environment variable injection fix (credential theft prevention in Docker sandbox), IPv6 host header parsing hardening, trusted proxy whitespace stripping, chat history oversized payload hard-cap, mesh orchestration gateway methods with scope-enforced RBAC, and mesh auto-planning with auth/session hardening.

### Security-Relevant Commits

| SHA | Message | Files | Audit Ref |
|-----|---------|-------|-----------|
| `235794d9f` | fix(security): OC-09 credential theft via environment variable injection | 3 prod + 2 test | Claim 8, Gap 1 |
| `4e5a9d83b` | fix(gateway): preserve unbracketed IPv6 host headers | 1 prod + 1 test | — |
| `d3698f4eb` | fix(gateway): trim trusted proxy entries before matching | 1 prod + 1 test | — |
| `5d9a026a9` | gateway: hard-cap chat.history oversized payloads | 1 prod + 1 test | — |
| `16e59b26a` | Add mesh auto-planning with chat command UX and hardened auth/session behavior | 9 prod + 3 test + 2 doc | — |
| `83990ed54` | Add mesh orchestration gateway methods with DAG execution and retry | 7 prod + 1 test | — |

1. **`235794d9f`** — **fix(security): OC-09 credential theft via environment variable injection:** Blocks 39+ credential patterns (ANTHROPIC_API_KEY, OPENAI_API_KEY, AWS_*, AZURE_*, database credentials, SSH/GPG keys, LD_PRELOAD) in Docker sandbox containers. **Addresses Audit 2 Claim 8** (LD_PRELOAD env injection). **Partially addresses Gap 1** — Docker sandbox containers are now protected; gateway-side blocking for host exec path (`bash-tools.exec-runtime.ts:33`) was already closed in PR #12.
   - `src/agents/sandbox/sanitize-env-vars.ts:111` — `sanitizeEnvVars()` implements blocklist/allowlist pattern matching
   - `src/agents/sandbox/docker.ts:274` — `buildSandboxCreateArgs()` integrates sanitization with audit logging
   - `src/agents/sandbox/validate-sandbox-security.ts:189` — `validateEnvVars()` enforces policy at runtime

2. **`4e5a9d83b`** — **fix(gateway): preserve unbracketed IPv6 host headers:** `resolveHostName()` at `src/gateway/net.ts:32` now detects unbracketed IPv6 hosts via `net.isIP(host) === 6` at line 44, returning as-is without port stripping. Prevents incorrect host header resolution for IPv6 loopback (`::1`) and internal addresses.

3. **`d3698f4eb`** — **fix(gateway): trim trusted proxy entries before matching:** `isTrustedProxyAddress()` at `src/gateway/net.ts:210` applies `.trim()` at line 217 to each proxy candidate before CIDR/IP matching. Prevents whitespace-padding bypass of trusted proxy list (e.g., `" 10.0.0.5 "`).

4. **`5d9a026a9`** — **gateway: hard-cap chat.history oversized payloads:** Constants at `src/gateway/server-methods/chat.ts:63-64`: `CHAT_HISTORY_TEXT_MAX_CHARS = 12_000` (per text field) and `CHAT_HISTORY_MAX_SINGLE_MESSAGE_BYTES = 128 * 1024` (per message). `truncateChatHistoryText()` at line 88 with placeholder `[chat.history omitted: message too large]`. Image data stripped with byte count tracking. `thinkingSignature` fields deleted from history payloads.

5. **`16e59b26a`** — **Add mesh auto-planning with chat command UX and hardened auth/session behavior:** New `mesh.plan.auto` gateway method. `WRITE_METHODS` at `src/gateway/server-methods.ts:85` now includes `mesh.plan.auto` (line 100), `mesh.run` (line 101), and `mesh.retry` (line 102) — all require `operator.write` scope via `authorizeGatewayMethod()` at `src/gateway/server-methods.ts:105`. Schema validation at `src/gateway/protocol/schema/mesh.ts:64`.

6. **`83990ed54`** — **Add mesh orchestration gateway methods with DAG execution and retry:** Core mesh infrastructure in `src/gateway/server-methods/mesh.ts` (706 lines). Gateway methods `mesh.plan`, `mesh.run`, `mesh.status`, `mesh.retry` with DAG execution (cycle detection, topological ordering). Schema validation at `src/gateway/protocol/schema/mesh.ts:64-221` with constraints: maxItems 128 steps, maxParallel 16, timeout 1s–1h. `mesh.plan` and `mesh.status` gated as READ_METHODS; `mesh.run` and `mesh.retry` as WRITE_METHODS.

### Non-Security Commits (54)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `690ec492d` | refactor: remove redundant field assignments in resolveCronSession | 1 prod | Cron housekeeping |
| `57c8f6239` | fix(cron): reuse existing sessionId for webhook/cron sessions | 1 prod + 1 test | Session persistence |
| `952db1a3e` | fix(discord): route audioAsVoice payloads through voice message API | 1 prod | Discord voice |
| `2fa9ddebd` | fix(mattermost): add actions config typing | 1 prod | Config enhancement |
| `9f0fc74d1` | refactor(model): share normalized provider map lookups | 5 prod | Model refactoring |
| `1fca7c392` | fix(discord): strip user:/discord:/pk: prefixes in command allowFrom | 1 prod | Allowlist normalization |
| `6931ca703` | fix(subagent): route nested announce to parent even when parent run ended | 1 prod + 1 test | Subagent routing |
| `65a1787f9` | fix: normalize paths to forward slashes for Windows RegExp compatibility | 1 prod | Windows paths |
| `811c4f5e9` | feat: add post-compaction read audit (Layer 3) | 2 prod + 1 test | Compaction auditing |
| `3296a25cc` | fix: format compaction-safeguard.ts with oxfmt | 1 prod | Formatting |
| `c4f829411` | feat: append workspace critical rules to compaction summary | 2 prod | Compaction context |
| `d0b33f23e` | fix: improve section extraction robustness (case-insensitive, H3, code blocks) | 1 prod + 1 test | Markdown parsing |
| `90476d465` | fix: format post-compaction-context test file | 1 test | Test formatting |
| `35a3e1b78` | feat: inject post-compaction workspace context as system event (#18023) | 2 prod + 1 test | Compaction system event |
| `b1d5c7160` | fix(cli): use standalone script for service restart after update (#17225) | 2 prod + 1 test | Service restart |
| `a62ff19a6` | fix(agent): isolate last-turn total in token usage reporting (#17016) | 1 prod + 1 test | Token usage |
| `d6acd7157` | fix: session-memory hook finds previous session file after /new/reset | 1 prod | Session memory |
| `767109e7d` | fix(skills): improve git credential handling for gh-issues sub-agents | 1 prod | GitHub issues skill |
| `068260bbe` | fix: add api-version query param for Azure verification | 1 prod | Azure compatibility |
| `960cc1151` | fix: add Azure AI Foundry URL support for custom providers | 1 prod | Azure provider |
| `8e55503d7` | fix(browser): track original port mapping for EADDRINUSE fallback | 1 prod | Browser port |
| `0e6daa2e6` | fix(browser): handle EADDRINUSE with automatic port fallback | 1 prod | Browser port recovery |
| `a1a1f5684` | fix(process): disable detached spawn on Windows to fix empty exec output (#18035) | 1 prod + 1 test | Windows process |
| `d0a5ee017` | fix: include token drift warning in JSON response | 1 prod | Token drift |
| `d6e85aa6b` | fix(daemon): warn on token drift during restart (#18018) | 2 prod + 1 test | Service token audit |
| `8af4712c4` | fix(cron): prevent spin loop when job completes within scheduled second (#17821) | 2 prod + 1 test | Cron scheduling |
| `eed806ce5` | f | 1 prod | Feishu refactor |
| `a42ccb9c1` | f | 1 prod | Feishu parsing |
| `c31524697` | fix(feishu): fix mention detection for post messages with embedded docs | 1 prod + 1 test | Feishu mentions |
| `cd4f7524e` | feat(telegram): receive and surface user message reactions (#10075) | 2 prod | Telegram reactions |
| `e24e465c0` | fix(webchat): strip reply/audio directive tags before rendering #18079 | 1 prod + 1 test | Webchat UI |
| `9c3eed597` | Update Akash Kobal's avatar link in README | 1 doc | README update |
| `18f3bbfe0` | Add avatar link for AkashKobal to README | 1 doc | README contributor |
| `e91a5b021` | fix: release stale session locks and add watchdog for hung API calls (#18060) | 6 prod + 2 test | Session lock management |
| `7d8d8c338` | config: align memory hybrid UI metadata with schema labels/help | 3 prod | Config metadata |
| `65ad9a426` | Memory: fix MMR tie-break and temporal timestamp dedupe | 2 prod | Memory search |
| `33cf27a52` | fix: MMR default disabled, tie-break null guard, correct docs URL | 1 prod + 1 test | Memory MMR config |
| `6b3e0710f` | feat(memory): Add opt-in temporal decay for hybrid search scoring | 4 prod + 1 test | Memory feature |
| `fa9420069` | feat(memory): Add MMR re-ranking for search result diversity | 4 prod + 1 test | Memory MMR algorithm |
| `a0ab301dc` | Fix Discord auto-thread attempting to thread in Forum/Media channels | 2 prod + 1 test | Discord threading |
| `b90d7625e` | Fix Discord session routing continuity (enable lastRoute for groups) | 1 prod + 1 test | Discord routing |
| `dbe2ab6f6` | cron: keep usage telemetry in run log types + error paths | 2 prod | Cron telemetry |
| `ddea5458d` | cron: log model+token usage per run + add usage report script | 5 prod | Cron usage |
| `edbc68e9f` | feat: support Z.AI tool_stream for real-time tool call streaming | 1 prod + 1 test | Tool streaming |
| `c529e6005` | fix(gateway): set explicit chat timeouts for mesh gateway calls | 1 prod | Mesh timeouts |
| `15fe87e6b` | feat: add before_message_write plugin hook | 4 prod | Plugin hooks |
| `94eecaa44` | fix: atomic session store writes to prevent context loss on Windows | 1 prod | Windows sessions |
| `1bef2fc68` | fix(whatsapp): allow per-message link preview override | 5 prod + 1 test | WhatsApp links |
| `312a7f788` | fix: make tool exit code handling less aggressive | 1 prod | Tool exit codes |
| `91903bac1` | fix: include OPENCLAW_SERVICE_VERSION in system presence version detection | 1 prod | Version detection |
| `97e0f8d55` | fix(onboarding): keep wildcard allowFrom helper string-typed | 1 prod | Onboarding types |
| `64f5e4a42` | refactor(onboarding): reuse allowlist merge across channels | 4 prod | Onboarding refactor |
| `486b7379d` | refactor(test): dedupe doctor harness mock payload factories | 1 test | Test refactoring |
| `230e1d996` | refactor(auth): share profile id dedupe helper | 5 prod | Auth refactoring |

### Audit Cross-Reference

**Audit 2 (Medium article) — 8 claims:**
- **Claim 8 (Env variable injection via LD_PRELOAD):** **ADDRESSED** by `235794d9f`. `sanitizeEnvVars()` blocks `LD_PRELOAD` and 39+ credential patterns in Docker sandbox containers.

**Legitimate Gaps:**
- **Gap 1 (Gateway-side env var blocklist):** `235794d9f` addresses Docker sandbox; host exec path was already closed in PR #12 via `DANGEROUS_HOST_ENV_VARS` blocklist.
- **Gap 2 (Pipe-delimited token format):** Not addressed. RSA signing prevents exploitation.
- **Gap 3 (outPath validation in screen_record):** Not addressed.
- **Gap 4 (Bootstrap/memory .md content scanning):** Not addressed.

Remaining audit claims (1-7) unaffected by this batch — no changes to `setupCommand` handling (Claim 1), `outPath` validation (Claim 2), `logs.tail` schema (Claim 3), SSRF guards (Claim 4), approval RBAC (Claim 5), token format (Claim 6), or regex validation (Claim 7).

### Line Number Shifts

| File | Old | New | Symbol |
|------|-----|-----|--------|
| `src/gateway/server-methods.ts` | 99 | 105 | `authorizeGatewayMethod()` |
| `src/gateway/server-methods.ts` | 99-169 | 105-175 | `authorizeGatewayMethod()` range |
| `src/gateway/server-methods.ts` | 146-148 | 158-160 | `agents.create/update/delete` |
| `src/gateway/server-methods/chat.ts` | 63 | 78 | `sanitizeChatSendMessageInput()` |
| `src/gateway/server-methods/chat.ts` | 52 | 67 | `stripDisallowedChatControlChars()` |
| `src/agents/sandbox/docker.ts` | 260 | 261 | `readOnlyRoot` |
| `src/agents/sandbox/docker.ts` | 278-280 | 295-296 | `capDrop` |
| `src/agents/sandbox/docker.ts` | 281 | 298 | `no-new-privileges` |
| `src/agents/sandbox/docker.ts` | 282-287 | 299-303 | seccomp/AppArmor |
| `src/agents/sandbox/docker.ts` | 288-297 | 305-313 | DNS/extra hosts |
| `src/agents/sandbox/docker.ts` | 298-317 | 315-333 | Resource limits |
| `src/agents/sandbox/docker.ts` | 318-322 | 335-337 | `binds` |
| `src/agents/sandbox/docker.ts` | 344-354 | 361-370 | Workspace mount |
| `src/agents/sandbox/docker.ts` | 360-361 | 377-378 | `setupCommand` exec |

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
