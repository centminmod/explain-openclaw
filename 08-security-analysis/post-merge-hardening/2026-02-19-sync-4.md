> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 19 sync 4 (62 commits, 5 security)

**Merge commit:** d54a4a08b | **Range:** 008f14a99..d54a4a08b

### Security-Relevant Commits

| SHA | Message | Files | Description |
|-----|---------|-------|-------------|
| `9a100d520` | refactor(gateway): dedupe exec approvals node validation | 1 prod | Extracts nodeId validation into reusable `resolveNodeIdOrRespond()` helper at `exec-approvals.ts:89`. Consolidates duplicate trim/validation logic that previously existed inline at two handler sites (now lines 143 and 176). Maintains existing validation behavior — no change to attack surface. |
| `5e76cefc7` | refactor(gateway): share session store lookup map builder | 1 prod | Extracts `buildStoreBySessionId()` helper at `usage.ts:157` to create a Map from session store entries. Pure refactor with no behavior change. The function builds a read-only lookup structure from trusted internal state. |
| `b62bd290c` | fix: remove hardcoded disableBlockStreaming to honor agent config for TUI (#19693) | 1 prod + 2 test + 1 doc | Removes hardcoded `disableBlockStreaming: true` override from TUI chat handler (line deleted). Fix allows agent-level `blockStreamingDefault` config to take effect. Primarily UX/consistency fix with minimal security impact — removes a hardcoded override that was bypassing configuration. |
| `e67da1538` | iOS/Gateway: wake disconnected iOS nodes via APNs before invoke (#20332) | 4 prod + 2 test + 2 doc | Adds APNs-based wake-on-invoke for disconnected iOS nodes. New `maybeWakeNodeWithApns()` at `nodes.ts:67` checks 15s throttle (NODE_WAKE_THROTTLE_MS at :44), deduplicates in-flight requests via `nodeWakeById` Map at :51, and calls `sendApnsBackgroundWake()` from `push-apns.ts:461`. Uses silent push semantics (pushType="background", priority="5"). Introduces Apple Push Notification service integration with HTTP/2 + JWT bearer auth. Wake is best-effort and does not block invoke on failure. |
| `99d099aa8` | Gateway: add APNs push test pipeline (#20307) | 11 prod + 2 test + 1 doc | Adds `push.test` RPC endpoint and CLI command for APNs connectivity testing. New handler at `push.ts:19` validates params via JSON schema, loads device registration, and sends visible alert via `sendApnsAlert()` at `push-apns.ts:406`. Device tokens validated with regex `/^[0-9a-f]{32,}$/i` via `isLikelyApnsToken()` at :96 before storage. Registered as WRITE_METHOD at `server-methods.ts:99` requiring authentication. Environment override restricted to "sandbox" or "production" only. |

### Non-Security Commits (57)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `c7458782b` | refactor(cli): dedupe service-load and command-removal loops | 2 prod | Pure code deduplication — extracts `resolveServiceLoadedOrFail` and `removeEntryCommands` helpers |
| `bc38d9b84` | refactor(tui): share select list theme styles | 1 prod + 1 test | UI theme refactoring — extracts `baseSelectListTheme` to share styles |
| `671560616` | perf(test): use expect.poll in browserless live test | 1 test | Test-only change — replaces custom `waitFor` loop with vitest's built-in |
| `5d98c2ae7` | refactor(browser): share playwright route context for debug/storage routes | 3 prod | Route handler refactoring — extracts context helpers to reduce boilerplate |
| `dd28a77df` | fix(ios): refactor screen webview lifecycle handling (#20366) | 3 prod + 1 test + 1 doc | iOS webview lifecycle improvement — no security implications |
| `750276fa3` | fix(protocol): regenerate Swift models for push.test (#20325) | 2 prod + 1 doc | Auto-generated Swift model update |
| `264131eb9` | Canvas: improve A2UI asset resolution and empty state (#20312) | 2 prod + 1 doc | A2UI asset path resolution improvement |
| `fe3f0759b` | Chat UI: accept canonical main session key alias (#20311) | 1 prod + 1 test + 1 doc | Chat UI enhancement — accepts additional session key alias format |
| `6e7f1a6a1` | iOS onboarding: prevent pairing flicker during auto-resume (#20310) | 1 prod + 1 doc | UI bug fix |
| `c2d12b7e3` | iOS: add APNs registration and notification signing config (#20308) | 10 prod + 1 doc | iOS feature addition — push notification config only |
| `c0e0d4c63` | test: dedupe empty-array counter checks in sandbox formatters | 1 test | Test-only (demoted from flagged) |
| `8b4d449db` | perf(test): use setImmediate for node invoke bypass yields | 1 test | Test-only (demoted from flagged) |
| `f3b7b5113` | perf(test): remove fixed waits in node invoke bypass e2e | 1 test | Test-only (demoted from flagged) |
| `d54a4a08b` - `8b257703d` (39 commits) | refactor/perf(test): various deduplication helpers and test optimizations | 39 prod/test | Refactors extracting shared helpers and test performance improvements |

**Detailed SHAs for grouped ranges:**
- `d54a4a08b` - `8b257703d`: 39 commits covering auto-reply allowlist helpers, config command resolvers, daemon runtime warning sharing, cron CLI wiring, models shared utilities, update CLI timeout validation, outbound message resolution, browser storage/snapshot routes, channel dock lookup, TUI theme styles, and numerous test performance improvements (expect.poll adoption, timer tightening, fake timer batching).

### Audit Cross-Reference

**Affected Claims:**
- **Audit 2 Claim 3 (Config-driven behavior):** Strengthened by `b62bd290c` which removes hardcoded override, allowing agent-level config to take effect.

**New Security Considerations:**
- **APNs Authentication:** The `resolveApnsAuthConfigFromEnv()` function at `push-apns.ts:247` requires three env vars (OPENCLAW_APNS_TEAM_ID, OPENCLAW_APNS_KEY_ID, OPENCLAW_APNS_PRIVATE_KEY_P8). Private key handling is via environment variables or file path.
- **Device Token Storage:** APNs device tokens stored at `push/apns-registrations.json` in state directory. Tokens are sensitive identifiers validated with regex before storage.
- **External Service Communication:** APNs integration introduces Apple server communication via HTTP/2 with JWT bearer token authentication.

**Unaffected Claims:** All other audit claims (Audit 1 Claims 1-8; Audit 2 Claims 1, 2, 4-8; all 3 legitimate gaps) remain unchanged.

### Line Number Updates

| File | Old | New | Context |
|------|-----|-----|---------|
| `src/gateway/server-methods/exec-approvals.ts` | 110, 137 | 89, 148 | `resolveNodeIdOrRespond()` helper, invoke handlers |
| `src/gateway/server-methods/usage.ts` | 51 | 157 | `buildStoreBySessionId()` helper location |
| `src/gateway/server-methods.ts` | 105 | 102 | `authorizeGatewayMethod()` function |
| `src/gateway/server-methods.ts` | 85 | 84 | `WRITE_METHODS` set definition |
| `src/gateway/server-methods.ts` | 158-160 | 155-157 | Agents CRUD RBAC check |

### Notes

- This batch introduces significant new functionality: APNs push notification infrastructure for iOS node wake-on-invoke
- 3 commits were demoted from flagged to safe during triage (test-only changes)
- Large refactor (6784 lines changed) with 47 potentially stale doc references identified
- Main security impact is external service integration (Apple Push Notification service) with proper authentication and token validation
- The `push.test` command allows operators to verify APNs connectivity: `openclaw nodes push test --node-id <node-id>`

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
