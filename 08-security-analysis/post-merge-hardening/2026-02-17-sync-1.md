> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 17 sync 1 (69 commits)

**Merge commit:** 5a39e13c9 | **Range:** ab7538a9d..5a39e13c9

> Large refactor: 47,278 lines changed (23,017 insertions, 24,261 deletions). Primarily test harness deduplication and iOS app updates. Phase 4 must verify all documented file paths still exist.

### Security-Relevant Commits (8)

| SHA | Message | Files | Audit Cross-Ref |
|-----|---------|-------|-----------------|
| `095d52209` | fix(security): create session transcript files with 0o600 permissions (#18066) | 6 | **Claim 1** - DIRECTLY IMPLEMENTS |
| `553d17f8a` | refactor(agents): use silent token constant in prompts | 7 | **Claim 15** - REINFORCES |
| `68e39cf2c` | CLI: restore and harden qr --remote pairing behavior (#18166) | 3 | Hardening - QR pairing validation |
| `df6d0ee92` | refactor(core): dedupe tool policy and IPv4 matcher logic | 4 | **Claim 13** - REFACTORS |
| `f4b2fd00b` | fix(config): harden object-array merge-by-id fallback | 3 | Data integrity hardening |
| `b4fa10ae6` | refactor(infra): make fetch wrapping idempotent | 2 | SSRF protection integrity |
| `e3e8046a9` | fix(infra): avoid detached finally unhandled rejection in fetch wrapper (#18014) | 3 | Infrastructure reliability |
| `cb391f4bd` | fix(config): prevent config.patch from destroying arrays when patch entries lack id (#18030) | 4 | Data integrity fix |

### Commit Details

1. **`095d52209`** — **NEW** Session transcript files created with 0o600 permissions.
   - `src/config/sessions/transcript.ts:77` — `ensureSessionHeader()` adds `mode: 0o600`
   - `src/gateway/server-methods/chat.ts:124` — transcript file creation adds `mode: 0o600`
   - `src/security/fix.ts` — permission fix logic for existing `.jsonl` files

2. **`553d17f8a`** — **REINFORCES** Silent token constant usage.
   - `src/agents/subagent-announce.ts:368-370` — uses `SILENT_REPLY_TOKEN` constant
   - `src/agents/system-prompt.ts:115,124,604` — uses `SILENT_REPLY_TOKEN` constant

3. **`68e39cf2c`** — Hardens QR pairing flow validation.
   - `src/cli/qr-cli.ts:101-103` — validates `hasRemoteUrl || hasTailscaleServe` before `--remote`

4. **`df6d0ee92`** — Refactors tool policy logic.
   - `src/agents/sandbox-tool-policy.ts:21` — NEW: `pickSandboxToolPolicy()` function
   - `src/agents/pi-tools.policy.ts:213-216,289` — calls `pickSandboxToolPolicy()`

5. **`f4b2fd00b`** — Hardens config merge-by-id fallback.
   - `src/config/merge-patch.ts:24-78` — `mergeObjectArraysById()` enhanced

6. **`b4fa10ae6`** — Infrastructure hardening for fetch wrapper.
   - `src/infra/fetch.ts:9,37,93` — `wrapFetchWithAbortSignalMarker` idempotency check

7. **`e3e8046a9`** — Stability fix for fetch wrapper error handling.
   - `src/infra/fetch.ts:45-68` — restructured try/catch/finally

8. **`cb391f4bd`** — Data integrity fix for config.patch.
   - `src/config/merge-patch.ts:17-33` — relaxed ID requirement for patch entries

### Non-Security Commits (13)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `5a39e13c9` | fix(ios): restore missing location monitor merge files (#18260) | 6 | iOS platform fix |
| `9e26fe445` | fix(ios): gate talk barge-in on isolated audio routes (#18265) | 2 | iOS audio routing |
| `44ef04561` | fix(canvas): port remaining iOS branch stability fixes (#18228) | 4 | iOS stability |
| `c8a536e30` | fix(agents): scope message tool schema by channel (#18215) | 4 | Feature enhancement |
| `2e7fac223` | iOS: port talk redaction, accessibility, and ATS hardening (#18163) | 8 | iOS UI/ATS |
| `599c89022` | CLI/Gateway: restore qr flow with --remote support (clean) (#18091) | 8 | Feature restoration |
| `fec4be8de` | fix(cron): prevent daily jobs from skipping days (48h jump) #17852 (#17903) | 5 | Cron scheduling bug |
| `dddb1bc94` | fix(telegram): fix streaming with extended thinking models overwriting previous messages/ also happens to Execution error (#17973) | 14 | Telegram streaming UX |
| `c2a0cf0c2` | fix(tts): update tool description to prevent duplicate audio delivery (#18046) | 4 | TTS UX improvement |
| `39bb1b332` | fix: auto-recover primary model after rate-limit cooldown expires (#17478) (#18045) | 5 | Model fallback |
| `244ed9db3` | fix(telegram): draft stream preview not threaded when replyToMode is on (#17880) (#17928) | 5 | Telegram threading |
| `b2aa6e094` | fix(telegram): prevent non-abort slash commands from racing chat replies (#17899) | 5 | Telegram race condition |
| `bc67af6ad` | cron: separate webhook POST delivery from announce (#17901) | 33 | Cron webhook feature |

### Safe / Demoted Commits (48)

> These commits were classified as safe by analyze-commits.sh (12) or demoted from flagged by haiku triage (37, with 1 overlap in Phase 5b). Primarily test harness deduplication and iOS app features.

**Test refactors** (23 commits): `refactor(test*)` harness extraction and deduplication — outbound runner/delivery helpers (`d68818886`, `71111c997`), slack/telegram/web monitor setup (`a177f7b9f`), CLI/monitor fixtures (`c37f65a44`), doctor health/sandbox/migration fixtures (`0d51869c3`, `3a2fffefd`, `ffeeb835a`), onboarding/model auth helpers (`2d8edf85a`), agent/status fixtures (`ac5f6e7c9`), command config/model fixtures (`261f5ee49`), auth test env/lifecycle/helpers (`110b1cf46`, `def3a3ced`, `9adcaccd0`, `db3480f9b`, `f1351fc54`, `36a5ff813`, `a948a3bd0`, `a0e8f00b2`, `716872c17`, `1633c6fe9`, `94f455c69`), remaining command dedup (`5b185da36`), web send-api helpers (`291275982`).

**Large dedup refactors** (4 commits, 416 files, ~47k lines): `refactor(channels)` transport/gateway scaffolds (`93ca0ed54`, 95 files), `refactor(agent)` harness/command workflows (`f717a1303`, 204 files), `refactor(core)` config/runtime helpers (`04892ee23`, 68 files), `refactor(extensions)` connector helper usage (`544ffbcf7`, 49 files).

**Test additions** (7 commits): harness mock TS2742 annotations (`1d3738949`), reasoning replay assertion fix (`a1ca9291f`), qr/setup-code env isolation (`bc55ffb16`), abort assertion trim (`c9f2c3aef`), merge-patch fixture formatting (`7b8cce091`), config.patch rollback coverage (`5b8bfd261`), cooldown expiry regressions (`3a277e394`).

**iOS / OpenClawKit** (5 commits): background listening toggle (`b3859b488`), Talk voice directive hint (`ad27716d3`), onboarding + QR pairing stability (`130e59a9c`), gateway connect/discovery stability (`9a1e16868`), ChatUI update stabilization (`6effcdb55`).

**Production refactors** (5 commits): gateway wizard/exec dedup (`94a4dd018`), core runtime/wizard schemas (`8df83d183`), cron next-run dedup (`b99191975`), telegram proxy fetch double-wrap fix (`6931f0fb5`), cooldown probe decision helper (`d224776ff`).

**Features** (2 commits): telegram inline button styles (`16327f21d`, 13 files), bootstrap total cap raise + /context truncation warning (`8a6701664`, 16 files).

**Docs / chore** (2 commits): changelog credit @Marvae (`f2e12646b`), changelog entry restoration (`fc9fae2c2`).

### Audit Cross-Reference

| Claim/Gap | Status |
|-----------|--------|
| **Claim 1** (Session transcript 0o600) | **STRENGTHENED** - `095d52209` implements explicit file permissions |
| **Claim 13** (Tool policy sandbox) | **REFACTORED** - `df6d0ee92` consolidates logic into `pickSandboxToolPolicy()` |
| **Claim 15** (Silent token constant) | **REINFORCED** - `553d17f8a` replaces hardcoded strings with constant |
| **Claim 9** (File permissions on JSON writes) | Partially addressed by `095d52209` |
| **Gap 1** (Tool result size limits) | Not affected |
| **Gap 2** (Rate limiting) | Not affected |
| **Gap 3** (Audit logging) | Not affected |

### Potentially Stale References

The following source files were modified in this sync. Doc references should be verified:

- `src/agents/pi-embedded-helpers/bootstrap.ts` - Multiple doc references
- `src/agents/skills-install.ts` - Line shifts likely
- `src/agents/system-prompt.ts` - Line shifts from silent token changes
- `src/config/redact-snapshot.ts` - Line verification needed
- `src/config/merge-patch.ts` - Line shifts from merge logic changes
- `src/infra/fetch.ts` - Line shifts from idempotency changes

**Gap status: 1 closed, 3 remain open.** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
