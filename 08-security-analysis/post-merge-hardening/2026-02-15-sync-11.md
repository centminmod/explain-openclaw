> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 15 sync 11) — 80 upstream commits

**Merge commit:** 110cc5d79 | **Range:** e17a0f485..110cc5d79

6 security-relevant commits, 10 security-adjacent/hardening, 64 safe (test refactors, changelog docs, perf optimizations, schema deduplication).

### Security-Relevant Commits

1. **c0c0e0f9a** — **SSRF guard: block full-form IPv4-mapped IPv6** (`src/infra/net/ssrf.ts`): Complete rewrite of IPv6 handling. New `parseIpv6Hextets()` (lines 91-150) parses all IPv6 representations including full-form IPv4-mapped addresses (e.g., `0000:0000:0000:0000:0000:ffff:7f00:0001`). New `extractIpv4FromEmbeddedIpv6()` (lines 152-165) extracts the embedded IPv4 for private-IP checking. `isPrivateIpAddress()` (lines 193-257) now handles `::ffff:127.0.0.1`, full-form mapped loopback, and `169.254.169.254` metadata service via IPv6 embedding. New test file `ssrf.test.ts` verifies all bypass forms rejected. Directly addresses **Audit 2 Claim 4 (DNS rebinding SSRF)**. Closes tracked issue [#13274](https://github.com/openclaw/openclaw/issues/13274).

2. **5e7c3250c** — **Workspace-only path guards for filesystem tools** (14 files): Adds `workspaceOnly` parameter to `createApplyPatchTool()` at `src/agents/apply-patch.ts:81-86`. `resolvePatchPath()` (lines 254-285) gains a `purpose` parameter; calls `assertSandboxPath()` at line 273 for workspace-only enforcement. New `wrapToolWorkspaceRootGuard()` at `src/agents/pi-tools.read.ts:255` wraps read/write/list tools with workspace root validation. Applied to all tools via `pi-tools.ts:283,301,312`. Addresses **Audit 1 Claims #5 (file permission checks), #6 (path traversal)**, and partially mitigates **Gap #3 (outPath validation)**.

3. **a99ad11a4** — **OAuth CSRF state validation for Chutes** (`src/agents/chutes-oauth.ts:36-80`): `parseOAuthCallbackInput()` rewritten to enforce state parameter validation. Rejects bare authorization code input — requires full callback URL with state parameter matching the expected verifier. Validates: non-empty after trim (line 41), attempts URL parse first (line 46), extracts state from query params (line 54), falls back to bare code only if no whitespace and no `://` scheme (line 72). Tests verify state mismatch rejection. Addresses **Audit 1 Claim #2 (missing CSRF in OAuth state)**.

4. **48b3d7096** — **Device pairing token hardening** (`src/infra/pairing-token.ts:6-12`): New `generatePairingToken()` generates 256-bit (32-byte) `base64url`-encoded tokens via `crypto.randomBytes()`. New `verifyPairingToken()` uses `safeEqualSecret()` (timing-safe comparison). Imported at `device-pairing.ts:9` and `node-pairing.ts:9`, called at `:179` and `:91` respectively. Token format: `/^[A-Za-z0-9_-]{43}$/`. Strengthens **Audit 1 Claim #4 (token security)** — replaces weaker token generation with cryptographic 256-bit entropy.

5. **a429380e3** — **Clawtributors updater shell injection hardening** (`scripts/update-clawtributors.ts`): New `isValidLogin()` at line 293 with strict regex `/^[A-Za-z0-9-]{1,39}$/` validates GitHub login names. New `normalizeLogin()` at line 306 trims and validates. Changed from `execSync()` to `execFileSync()` at line 336 — prevents shell metacharacter injection via attacker-controlled GitHub login parameters. Addresses **Audit 2 Claim #7 (shell injection via incomplete regex)**.

6. **c0cd3c3c0** — **Session compaction safety timeout** (`src/agents/pi-embedded-runner/compaction-safety-timeout.ts:5`): New `compactWithSafetyTimeout()` wraps `session.compact()` with a configurable timeout to prevent infinite blocking during compaction. Imported at `compact.ts:60`, called at `compact.ts:636` during overflow compaction. Prevents denial-of-service via compaction deadlock.

### Security-Adjacent Commits

| SHA | Summary | Security Relevance |
|-----|---------|-------------------|
| 3efb75212 | `ensureSessionRuntimeCleanup()` at `sessions.ts:91` aborts active runs + waits for completion before `sessions.reset` | Prevents orphaned agent processes; gateway resilience |
| 542271e30 | `appendWithCap()` at `tui-local-shell.ts:103` caps stdout/stderr buffering | Prevents memory exhaustion via unbounded shell output |
| 8217d77ec | `runGlobalGatewayStopSafely()` runs plugin `gateway_stop` hooks before message exit | Prevents resource leaks in plugin-extended deployments |
| dbdcbe03e | Bootstrap path tracking fixed (uses `file.path` not `file.name` in `bootstrap.ts:162-191`); new mutation failure tracking | Improves tool mutation visibility; partial step toward Gap #3 |
| 8927c69b3 | Message send exit handling ensures `exit()` called after delivery | Prevents CLI hanging forever after message send |
| 6da69255f | `WritableStdin` interface + `AgentToolResult<unknown>` return types in `bash-tools.process.ts` | Type safety for tool execution signatures |

### Non-Security Flagged Commits

| SHA | Type | Summary |
|-----|------|---------|
| 182afe9f5 | Refactor | Extract `ensureSandboxWorkspaceLayout()` at `sandbox/context.ts:20-67` (centralizes path validation, no behavioral change) |
| 123ae82fc | Refactor | Extract `applyLegacyStore()` in `auth-profiles/store.ts` (dedupes auth token migration) |
| 5db579f2e | Test refactor | Extract sanitize session history fixtures (test-only) |
| 775a6c662 | Test refactor | Extract isolated agent turn helpers (test-only) |

### Safe Commits (64 — summary)

Bulk of this sync is test infrastructure modernization and code deduplication: `refactor(test)` harness extraction (nodes media, telegram dm/heartbeat/message ctx/health probes, slack inbound/slash, pi embedded models, chrome JSON, command handler params — 12 commits), `refactor(*)` code deduplication (discord component allowlist, whatsapp onboarding, cron job state, slack pin handlers, CLI hooks install, outbound attachment hydration, gemini schema union, process stdin/session guards — 8 commits), `perf(test)` speedups (archive suite, session store lock suite — 2 commits), changelog documentation (consolidate 2026.2.14, exec allowlist notes, clawtributors fix credit, traversal report credit, gateway auth credit — 9 commits), test fixes (unused cron imports, vitest harness typing, cli smoke exit, Signal tool-result mocks — 7 commits).

### Commit Chains

- **SSRF chain:** `c0c0e0f9a` (IPv4-mapped IPv6 blocking) builds on sync 10's `c5406e1d2` + `2d5647a80` (backend drop + tool-level allowlist)
- **Path traversal chain:** `5e7c3250c` (workspace-only guards) builds on sync 8's `5544646a0` (apply_patch assertSandboxPath)
- **OAuth chain:** `a99ad11a4` (Chutes state validation) complements sync 10's `ee8d8be2e` (manual code flow)

### Audit Impact

| Audit | Claim | Status | Commit(s) |
|-------|-------|--------|-----------|
| Audit 1 Claim 2 | Missing CSRF in OAuth state | **Further hardened** | a99ad11a4 (Chutes state validation) |
| Audit 1 Claims 5, 6 | File permissions / path traversal | **Further hardened** | 5e7c3250c (workspace-only guards) |
| Audit 1 Claim 4 | Token security | **Further hardened** | 48b3d7096 (256-bit base64url tokens) |
| Audit 2 Claim 4 | DNS rebinding SSRF | **Further hardened** | c0c0e0f9a (IPv4-mapped IPv6 blocking) |
| Audit 2 Claim 7 | Shell injection via incomplete regex | **Further hardened** | a429380e3 (normalizeLogin + execFileSync) |

### Line Number Shifts

`ssrf.ts` — major rewrite (+124 lines): `parseIpv6Hextets` 91-150 (was inline in `isPrivateIpAddress`), `extractIpv4FromEmbeddedIpv6` 152-165 (NEW), `isPrivateIpv4` 167-191 (was part of `isPrivateIpAddress`), `isPrivateIpAddress` 193-257 (was ~200 lines, expanded), `isBlockedHostname` 259-272 (was ~210), `createPinnedLookup` 274-329 (was ~215), `resolvePinnedHostnameWithPolicy` 337-389 (was 267-268 in sync 4), `resolvePinnedHostname` 391-396 (was 270-274), `createPinnedDispatcher` 398-404 (was ~280), `assertPublicHostname` 424-429 (was ~305).

`apply-patch.ts` +11 lines: `resolvePatchPath` 254-285 (was 249-273), `assertSandboxPath` call at 274 (was 264).

`chutes-oauth.ts` +12 lines: `parseOAuthCallbackInput` 36-80 (was 36-68).

**Gap status: 1 closed, 3 remain open** (pipe-delimited token format, outPath validation — Gap #3 partially mitigated by `5e7c3250c`, bootstrap/memory .md scanning — Gap #4 unchanged) — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
