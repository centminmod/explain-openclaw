> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Feb 14 sync 6 (33 upstream commits)

**Merge commit:** `71939523a` | **Range:** `2ab7715d1..71939523a`

Seven security-relevant commits plus four low-severity hardening fixes.

### Critical: Exec Approval Race Condition Fix

- **`1af0edf7f`** (PR [#3357](https://github.com/openclaw/openclaw/pull/3357)) — **Two-phase exec approval protocol:** Fixes a race where exec approval IDs could be returned to callers before being registered in the gateway's pending map. Introduces `exec.approval.request` with `twoPhase: true` for immediate registration, plus new `exec.approval.waitDecision` method. `ExecApprovalManager` (`src/gateway/exec-approval-manager.ts`) gains `register()` (separation of registration from waiting), `awaitDecision()`, 15-second grace period, and double-resolve protection. `src/agents/bash-tools.exec.ts` now calls the request with `expectFinal: false` before entering the decision loop. Also modified: `src/gateway/server-methods.ts` (new APPROVAL_METHODS entry), `src/gateway/protocol/schema/exec-approvals.ts`, `src/gateway/server-methods/exec-approval.ts`. Strengthens Audit 1 Claim 4 (race condition) and Audit 2 Claim 5 (agent self-approval).

### Critical: Nodes-Tool Exec Approval Flow

- **`6bc6cdad9`** (PR [#4726](https://github.com/openclaw/openclaw/pull/4726)) — **Add exec approval for agent tool run action:** Previously `nodes-tool.ts` `system.run` action had NO approval flow — commands were sent directly to nodes without user consent. Now implements try-catch pattern: first attempt without approval, and if node returns `SYSTEM_RUN_DENIED: approval required`, creates a gateway-side approval request, waits for user decision (120s timeout), retries with `approved: true`. Files: `src/agents/tools/nodes-tool.ts`, `src/agents/openclaw-tools.camera.e2e.test.ts`, `src/config/io.write-config.test.ts`. Directly addresses Audit 2 Claim 5 (self-approving agent) and partially mitigates Legitimate Gap 3 (outPath in nodes-tool — same file now has approval gating for `system.run`).

### High: Bounded Webhook Body Handling

- **`3cbcba10c`** — **Enforce bounded webhook body handling:** Creates centralized `readRequestBodyWithLimit`/`readJsonBodyWithLimit`/`installRequestBodyLimitGuard` infrastructure in new file `src/infra/http-body.ts` (347 lines). Adds Content-Length pre-check, configurable timeout (default 30s), `CONNECTION_CLOSED` detection, and `req.destroy()` on violation. Refactors ALL webhook monitors (10+ extensions: BlueBubbles, Feishu, Google Chat, MS Teams, Nextcloud Talk, Nostr, Voice Call, Zalo, LINE, Slack, Telegram) to use centralized module. Exports via `src/plugin-sdk/index.ts` for extension authors. Gateway `src/gateway/hooks.ts` delegates to `readJsonBodyWithLimit`; `src/gateway/server-http.ts` and `src/gateway/http-common.ts` gain 413/408 status differentiation. Strengthens defense against Audit 1 Claim 7 (webhook DoS before signature checks).

### High: SSRF Blocklist in Link Understanding

- **`649826e43`** (PR [#15604](https://github.com/openclaw/openclaw/pull/15604)) — **Block private/loopback/metadata IPs in link-understanding URL detection:** Previously only blocked `127.0.0.1`. Now imports `isBlockedHostname` and `isPrivateIpAddress` from `src/infra/net/ssrf.ts` and adds `localhost.localdomain`. Blocks all loopback, private (RFC 1918), link-local (169.254.x.x), and cloud metadata (169.254.169.254) addresses. Files: `src/link-understanding/detect.ts`, `src/link-understanding/detect.test.ts`. Directly addresses Audit 2 Claim 4 (DNS rebinding SSRF via web-fetch) — closes a bypass path where link-understanding only checked one IP.

### Moderate: Config Env Var Reference Preservation

- **`f59df9589`** (PR [#15600](https://github.com/openclaw/openclaw/pull/15600)) — **Preserve env var references on write:** When writing config to disk, `${API_KEY}` style references were being resolved to plaintext values. Now tracks which config paths contain env var references, detects which paths actually changed, and restores `${...}` syntax for unchanged paths. Files: `src/config/io.ts` (+135 lines), `src/config/env-substitution.ts`, `src/config/io.write-config.test.ts`. Addresses Audit 1 Claim 1 (plaintext token storage) and Claim 3 (hardcoded secrets) by preventing credential leakage through config round-trips.

### Moderate: Lightweight File Locks Replace proper-lockfile

- **`201ac2b72`** — **Replace proper-lockfile with lightweight file locks:** Custom implementation in new `src/infra/file-lock.ts` using `fs.open` with `'wx'` (exclusive create), PID+timestamp payload, stale lock detection (PID liveness via `process.kill(pid, 0)` + mtime age), reentrant locking (reference counting). OAuth token refresh in `src/agents/auth-profiles/oauth.ts` now uses `withFileLock()`. MS Teams extension gains `extensions/msteams/src/file-lock.ts`. Pairing store uses new locks. Strengthens Audit 1 Claim 4 (token refresh race condition) with better stale detection.

### Moderate: Control-Char Regex Replacement

- **`e84318e4b`** — **Replace control-char regex with explicit sanitizer:** `src/gateway/server/ws-connection.ts` replaces `/[\\u0000-\\u001f\\u007f-\\u009f]/g` regex with character-by-character `replaceControlChars()` using `codePointAt()`. Avoids potential regex edge cases with surrogate pairs. Tangentially related to Audit 2 Claim 7 (shell injection via incomplete regex).

### Low: Additional Hardening

- **`be18f5f0f`** — Windows exec env overrides: `src/process/exec.ts` uses `shell: false` for `.exe` files, reducing shell injection surface on Windows.
- **`a49dd83b1`** + **`a5ccfa57a`** — Command queue promise rejection: `src/process/command-queue.ts` now rejects pending promises with `CommandLaneClearedError` when clearing command lane, preventing silent drops.
- **`f7e2b8ff5`** — Discord autoThread race condition: `src/discord/monitor/threading.ts` re-fetches message on thread creation failure.
- **`fdfc34fa1`** — Session write lock robustness: `src/agents/session-write-lock.ts` uses `Symbol.for()` for lock map, adds handler deduplication.

### Commit Chains

1. **Exec approval chain:** `1af0edf7f` (two-phase protocol) + `6bc6cdad9` (nodes-tool flow) — both fix approval gaps.
2. **steipete security batch:** `3cbcba10c` (webhook body) + `e84318e4b` (control-char sanitizer) + `201ac2b72` (file locks) — same author, all security-relevant.
3. **Discord voice message feature:** `a09e4fac3` → `36525a974` → `b9da2c467` → `77df8b110` → `385eed14f` → `b4359c84f` → `76ab377a1` → `1c9c01ff4` → `c87e481ec` → `a15033876` — not security-relevant.

### Line Number Shifts

Major shifts from `config/io.ts` env var preservation (+135 lines) and `server-http.ts` bounded body handling (+7 lines):

| File | Old Reference | New Reference | Reason |
|------|--------------|---------------|--------|
| `src/gateway/server-methods.ts` | `:95-165` | `:99-169` | APPROVAL_METHODS expanded (+`exec.approval.waitDecision`) |
| `src/agents/auth-profiles/oauth.ts` | `:43-105` (proper-lockfile) | `:43-92` (withFileLock) | Locking mechanism replaced |
| `src/gateway/hooks.ts` | `:176-222` (readJsonBody) | `:177-194` | Delegates to `readJsonBodyWithLimit` |
| `src/gateway/server-http.ts` | `:236-243` | `:243-249` | +7 from http-body changes |
| `src/gateway/server-http.ts` | `:247` (safeEqual) | `:254` | +7 |
| `src/gateway/server-http.ts` | `:472-485` | `:484-497` | +12 cumulative |
| `src/gateway/server-http.ts` | `:514-531` | `:527-539` | +13 cumulative |
| `src/gateway/server-http.ts` | `:584` | `:596` | +12 |
| `src/config/io.ts` | `:95-112` (rotateConfigBackups) | `:273-290` | +178 from env ref tracking |
| `src/config/io.ts` | `:317-321` (fail-open) | `:505-510` | +188 |
| `src/config/io.ts` | `:482-539` (writeConfigFile) | `:681-753` | +199 |
| `src/config/io.ts` | `:497` (0o700) | `:720` | +223 |
| `src/config/io.ts` | `:509,521` (0o600) | `:736,753` | +227,+232 |

**Gap status: 1 closed (env var blocklist), 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
