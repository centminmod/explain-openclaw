> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

## Post-Merge Hardening (Feb 17 sync 6 — 60 commits)

**Merge commit:** `ff2e790e0` | **Range:** `7d94df01e..ff2e790e0`

60 upstream commits. 3 security-relevant: configurable tool loop detection (DoS defense), Windows bind mount parsing fix (sandbox escape prevention), and skills prompt bloat guard (prompt injection defense-in-depth).

### Security-Relevant Commits

| SHA | Message | Files | Audit Ref |
|-----|---------|-------|-----------|
| `076df941a` | feat: add configurable tool loop detection | 9 prod + 2 test + 3 doc | — |
| `dacffd7ac` | fix(sandbox): parse Windows bind mounts in fs-path mapping | 1 prod + 1 test | — |
| `5b3873add` | fix(skills): guard against skills prompt bloat | 3 prod + 1 test | — |

1. **`076df941a`** — **feat: add configurable tool loop detection:** Runtime protection against infinite tool-call loops with configurable thresholds. Defense-in-depth against agent-side DoS via resource exhaustion loops. Supports three detector types (generic repeat, known-poll-no-progress, ping-pong).
   - `src/agents/pi-tools.ts:128-153` — `resolveToolLoopDetectionConfig()` merges global and per-agent loop detection settings
   - `src/config/zod-schema.agent-runtime.ts:370-401` — `ToolLoopDetectionSchema` validates thresholds (warningThreshold < criticalThreshold < globalCircuitBreakerThreshold)

2. **`dacffd7ac`** — **fix(sandbox): parse Windows bind mounts in fs-path mapping:** New `splitBindSpec()` at `src/agents/sandbox/fs-paths.ts:63-92` handles Windows drive-letter paths (`C:\path:/container`) via regex `/^[A-Za-z]:[\\/]/` at line 65. Previous `:`-split logic failed on Windows paths containing drive letters. `parseSandboxBindMount()` at `fs-paths.ts:32-61` refactored to call `splitBindSpec()`. Prevents malformed bind mounts from causing incorrect path mapping in sandboxed environments.

3. **`5b3873add`** — **fix(skills): guard against skills prompt bloat:** Enforces 5 configurable limits via `resolveSkillsLimits()` at `src/agents/skills/workspace.ts:118-128`: `maxCandidatesPerRoot` (default 300), `maxSkillsLoadedPerSource` (200), `maxSkillsInPrompt` (150), `maxSkillsPromptChars` (30,000), `maxSkillFileBytes` (256KB). `listChildDirectories()` at `workspace.ts:130-156` provides safe directory enumeration with `.`-prefix and `node_modules` exclusion. Zod validation at `src/config/zod-schema.ts:600-609` enforces positive integer constraints. Prevents prompt injection via skill bloat and directory scan bombs. Causes +260 line shift in `src/agents/skills/workspace.ts` affecting `buildWorkspaceSkillSnapshot()` (was ~200 → now 426), `disableModelInvocation` filter (was 230 → now 447/497), and `resolveSyncedSkillDestinationPath()` (was 302 → now 566).

### Non-Security Commits (57)

| SHA | Message | Files | Reason |
|-----|---------|-------|--------|
| `ff2e790e0` | CI: increase stale operations per run | 1 prod | CI config |
| `4088c0b89` | refactor(core): dedupe schema and command parsing helpers | 3 prod | Code deduplication |
| `c55e017c1` | refactor(daemon): dedupe user bin path assembly helpers | 2 prod | Code deduplication |
| `345115917` | refactor(channels): share draft stream loop across slack and telegram | 3 prod | Code deduplication |
| `f6111622e` | refactor(commands): share system prompt bundle for context and export | 3 prod | Code deduplication |
| `32e2c369d` | refactor(agents): extract shared session dir resolver | 3 prod | Code deduplication |
| `82c4f8ca2` | chore(ci): align lint and format checks for templated exports | 2 prod | CI alignment |
| `170e6f33b` | docs(commands): add export-session aliases to slash command list | 1 doc | Docs |
| `b3d0e0cb4` | fix(cron): preserve overrides and harden next-run calculation | 2 prod + 1 test | Cron scheduling |
| `968bba5c1` | refactor(telegram): remove duplicate poll dispatch branch | 1 prod | Code cleanup |
| `0a188ee49` | test(ci): stabilize update and discord process tests | 2 test | Test stability |
| `a186ce215` | fix(ci): preserve whatsapp send API compatibility | 1 prod | API compatibility |
| `94e463117` | refactor(onboarding): simplify zalo allowFrom merge paths | 1 prod | Onboarding cleanup |
| `d89d951c3` | refactor(onboarding): reuse allowFrom merge helper in matrix | 1 prod | Onboarding cleanup |
| `7632e60d7` | refactor(onboarding): reuse allowFrom merge helper in extensions | 1 prod | Onboarding cleanup |
| `12a947223` | fix(ci): restore main checks after bulk merges | 5 prod + 3 test | CI restoration |
| `8c241449f` | fix(protocol): sync generated gateway swift models | 2 prod | Protocol sync |
| `83a8b78a4` | fix(ci): guard loop detection integer parsing | 1 prod | Type safety |
| `eaa2f7a7b` | fix(ci): restore main lint/typecheck after direct merges | 27 prod + 2 test | Formatting/linting |
| `3f617e33b` | style(discord): format provider after proxy fetch changes | 1 prod | Formatting |
| `e997545d4` | fix(discord): apply proxy to app-id and allowlist REST lookups | 2 prod + 1 test | Proxy config |
| `bc2e02bb3` | fix(ui/usage): remove remaining timeSeriesCursor reference in renderContextPanel | 1 prod | UI cleanup |
| `647d69881` | fix(ui/usage): align client log limit with server cap (1000) and remove unused param | 2 prod | Config alignment |
| `0302cf89b` | feat(timeline): dual-handle range selection on Usage Over Time chart | 1 prod | UI feature |
| `86517b8e3` | feat(feishu): add bitable create app and create field tools | 2 prod | Feishu feature |
| `84383b5e0` | fix(tts): show all provider errors instead of only the last one | 1 prod | Error reporting |
| `de6cc05e7` | fix(cron): prevent spin loop when job completes within firing second (#17821) | 1 prod + 1 test | Cron scheduling |
| `531f735c8` | Update extensions/openclaw-zh-cn-ui/README.md | 1 doc | Docs |
| `aeadeffa1` | Update README.md | 1 doc | Docs |
| `967efc8e1` | Update README.md | 1 doc | Docs |
| `c88a90c7c` | Create README.md | 1 doc | Docs |
| `bdbb872c0` | fix(ui/usage): replace undefined --text-muted CSS variable with --muted | 3 prod | CSS fix |
| `16ddbbc62` | fix(sessions): skip cache when initializing session state | 1 prod | Session correctness |
| `4f5b9da50` | Update docs/reference/templates/SOUVENIR.md | 1 doc | Docs |
| `8a3f3a49a` | Update docs/reference/templates/GOALS.md | 1 doc | Docs |
| `bf1b4386d` | Update docs/reference/templates/GOALS.md | 1 doc | Docs |
| `1a9a2e396` | feat: Add GOALS.md and SOUVENIR.md template files | 2 doc | Docs |
| `b4a90bb74` | fix(telegram): suppress message_thread_id for private chat sends (#17242) | 1 prod + 1 test | Telegram fix |
| `2ed43fd7b` | fix(cron): resolve accountId from agent bindings in isolated sessions | 1 prod + 1 test | Account resolution |
| `e9f2e6a82` | fix(heartbeat): prune transcript for HEARTBEAT_OK turns | 1 prod + 1 test | Transcript cleanup |
| `7bb9a7dcf` | fix(telegram): wire sendPollTelegram into channel action handler (#16977) | 3 prod + 1 test | Telegram polls |
| `068b9c974` | feat: wrap compaction generateSummary in retryAsync | 1 prod + 1 test | Compaction retry |
| `990cf2d22` | fix(extensions): address greptile review comments for openai-codex-auth | 1 prod | Code review |
| `45b3c883b` | fix: regenerate pnpm lockfile | 1 prod | Lockfile |
| `24569d093` | style: fix import ordering in openai-codex-auth | 1 prod | Import ordering |
| `3ac422fe2` | feat(extensions): add OpenAI Codex CLI auth provider | 4 prod | New auth provider |
| `f82a3d3e2` | fix: use resolveUserPath utility for tilde expansion | 1 prod | Path resolution |
| `4cd75d5d0` | fix: remove accidental openclaw link dependency | 2 prod | Dependency cleanup |
| `f70b3a2e6` | refactor: bundle export-html templates instead of reading from node_modules | 6 prod + 1 script | Template bundling |
| `1eb1a33f3` | chore: remove --open option (not useful for remote sessions) | 2 prod | Option removal |
| `ffe700bf9` | fix: use proper pi-mono dark theme colors for export HTML | 1 prod | Theme fix |
| `add3afb74` | feat: add /export-session command | 4 prod | New command |
| `3c3a39d16` | fix(test): use path.resolve for cross-platform Windows compatibility | 1 test | Test fix |
| `90774c098` | fix(sessions): allow cross-agent session file paths in multi-agent setups | 1 prod + 1 test | Session paths |
| `e20b87f1b` | fix: handle forum/topics in Telegram DM thread routing (#17980) | 1 prod + 1 test | Telegram routing |
| `c25c276e0` | refactor: remove unnecessary optional chaining from agent meta usage in reply and cron modules | 3 prod | Code cleanup |
| `d64906918` | fix: add optional chaining to runResult.meta accesses to prevent crashes on aborted runs | 3 prod | Null safety |

### Audit Cross-Reference

**Audit 1 (Issue #1796) — 8 claims:** Unaffected. No changes to OAuth flows, token storage, CSRF state handling, or credential management.

**Audit 2 (Medium article) — 8 claims:** Unaffected. No changes to `setupCommand` handling (Claim 1), `outPath` validation (Claim 2), `logs.tail` schema (Claim 3), SSRF guards (Claim 4), approval RBAC (Claim 5), token format (Claim 6), shell injection patterns (Claim 7), or env variable injection (Claim 8).

**Legitimate Gaps:**
- **Gap 1 (Gateway-side env var blocklist):** Already CLOSED in PR #12. Not affected.
- **Gap 2 (Pipe-delimited token format):** Not addressed. RSA signing prevents exploitation.
- **Gap 3 (outPath validation in screen_record):** Not addressed.
- **Gap 4 (Bootstrap/memory .md content scanning):** Not addressed. Skills prompt bloat guard (`5b3873add`) adds limits on skill file sizes but does not scan `.md` content for injections.

### Line Number Shifts

| File | Old | New | Symbol |
|------|-----|-----|--------|
| `src/agents/skills/workspace.ts` | 230 | 447 | `disableModelInvocation` filter |
| `src/agents/skills/workspace.ts` | 302-346 | 566-612 | `resolveSyncedSkillDestinationPath()` |

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
