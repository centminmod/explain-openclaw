## Feb 15 sync 8 (30 commits, 6 security-relevant)

> [Back to Post-Merge Hardening Index](../post-merge-hardening.md) | [Legitimate Gaps](../post-merge-hardening.md#legitimate-gaps-status)

**Merge commit:** 2b9a501b7 | **Range:** 6d8ea53d6..2b9a501b7
**Sync date:** 2026-02-15

### Executive Summary

This 30-commit sync introduces **6 security-hardening commits** addressing path traversal in apply_patch, shell injection via safeBins, PATH manipulation hardening, exec environment isolation for node hosts, iMessage pairing-store identity leakage, and session lock deadlock prevention. Four audit claims are directly addressed; one legitimate gap receives further hardening.

### Security-Relevant Commits

#### `5544646a0` — Block apply_patch path traversal outside workspace (#16405)

**Files:** `src/agents/apply-patch.ts`, `src/agents/apply-patch.e2e.test.ts`, `CHANGELOG.md`

Integrates sandboxing via `assertSandboxPath()` (from `src/agents/sandbox-paths.ts:49`) into `resolvePatchPath()` at `apply-patch.ts:264`. Previously, when `sandboxRoot` was undefined (default non-sandbox mode), `resolvePatchPath()` fell through to `resolvePathFromCwd()` with no containment — accepting absolute paths and normalizing `../` via `path.resolve()`. Now all paths are validated against the workspace root regardless of sandbox mode. E2e tests added for: relative path escape, absolute path outside cwd, absolute path within cwd, and symlink escape.

**Audit mapping:** Audit 1 #1796 claim (6): Path traversal in agent dirs — **REMEDIATED**
**Issue tracking:** Closes [#12173](https://github.com/openclaw/openclaw/issues/12173)

---

#### `24d2c6292` — Refine safeBins hardening

**Files:** `src/agents/bash-tools.exec.ts`, `src/infra/exec-approvals-allowlist.ts`, `src/infra/exec-approvals-analysis.ts`, `src/infra/exec-approvals.test.ts`, `SECURITY.md`, `docs/tools/exec-approvals.md`

Introduces `buildSafeBinsShellCommand()` (`exec-approvals-analysis.ts:784`) which applies separate quoting logic for exec commands approved only via safeBins (vs allowlist or skills). New `hasGlobToken()` helper (`exec-approvals-allowlist.ts:58`) blocks glob characters (`*?[]`) in safeBins tokens — historical bypass vector. `evaluateSegments()` (`exec-approvals-allowlist.ts:190`) now returns `segmentSatisfiedBy` metadata tracking whether each segment was approved via allowlist, safeBins, or skills. In `bash-tools.exec.ts:823`, the exec tool routes through the appropriate sanitizer based on segment approval source.

**Audit mapping:** Audit 2 Medium claim (7): Shell injection via incomplete regex — **further hardened**

---

#### `013e8f6b3` — Harden exec PATH handling

**Files:** `src/acp/client.ts`, `src/infra/path-env.ts`, `src/infra/path-env.test.ts`, `src/node-host/invoke.ts`, `src/node-host/invoke.sanitize-env.test.ts`, `CHANGELOG.md`

Two critical PATH hardening improvements:

1. **ACP self-discovery** (`acp/client.ts:266`): New `resolveSelfEntryPath()` resolves the embedded entry point via `import.meta.url` before falling back to PATH — prevents PATH-injection attacks on ACP server discovery.
2. **Project-local bin opt-in** (`path-env.ts:52-77`): Refactored `candidateBinDirs()` now separates prepend/append arrays; disables project-local `node_modules/.bin` by default. Only appended when `allowProjectLocalBin===true` or env var `OPENCLAW_ALLOW_PROJECT_LOCAL_BIN` is set. `sanitizeEnv()` in `node-host/invoke.ts:138-165` also blocks PATH overrides from agent-supplied env.

**Audit mapping:**
- Audit 1 claim (5): Insufficient file permission checks — **further hardened** (PATH isolation)
- Audit 2 claim (8): Env variable injection — **further hardened** (project-local bin filtering)
- Legitimate Gap (1): Gateway-side env var blocklist — **further hardened** (project-local bin now opt-in; LD_*/DYLD_* blocklist in exec-runtime.ts already closed this in PR #12)

---

#### `e4d63818f` — Ignore tools.exec.pathPrepend for node hosts

**Files:** `src/agents/bash-tools.exec.ts`, `docs/cli/nodes.md`, `docs/tools/exec.md`

Explicit suppression of `tools.exec.pathPrepend` for node host execution (`bash-tools.exec.ts:320-327`). When host="node", logs warning ("tools.exec.pathPrepend is ignored for host=node") and skips `applyPathPrepend()` call. Prevents unintended PATH pollution on remote hosts. Removes stale duplicate `applyPathPrepend()` that was attempting to apply prepends to node-host exec environments.

**Audit mapping:** Audit 1 claim (5): Insufficient file permission checks — **further hardened** (removes duplicate PATH manipulation for node hosts)

---

#### `872079d42` — Keep DM pairing-store identities out of group allowlist auth

**Files:** `src/imessage/monitor/monitor-provider.ts`, `src/imessage/monitor.skips-group-messages-without-mention-by-default.test.ts`

Adds comprehensive input validation via `parseIMessageNotification()` (`monitor-provider.ts:163`) which validates all 15 fields of `IMessagePayload` using type guards (`isOptionalString`, `isOptionalNumber`, `isOptionalBoolean`, `isOptionalAttachments`). Prevents injection of pairing-store identities (DM allowlist) into group-level allowlist evaluation. Test confirms pairing-store identity rejected when `groupPolicy="allowlist"`.

**Audit mapping:** Improves identity isolation in iMessage channel — no direct audit claim, but strengthens group authorization boundaries.

---

#### `e6f67d5f3` — Prevent session lock deadlock on timeout during compaction (#9855)

**Files:** `src/agents/pi-embedded-runner/run/attempt.ts`, `src/agents/pi-embedded-runner/run/compaction-timeout.ts` (NEW), `src/agents/pi-embedded-runner/run/types.ts`, `src/agents/pi-embedded-runner/run.ts`, `src/agents/pi-embedded-subscribe.ts`, `src/agents/pi-embedded-subscribe.handlers.types.ts`, test files, `CHANGELOG.md`

Adds `timedOutDuringCompaction` flag (`attempt.ts:672`) to distinguish model-level timeouts from post-prompt compaction timeouts. New `shouldFlagCompactionTimeout()` (`compaction-timeout.ts:9`) checks subscription state to detect compaction hangs. Prevents incorrect auth profile rotation when compaction times out (`run.ts:998`: only rotates if `timedOut && !timedOutDuringCompaction`). Captures message snapshot before compaction wait to avoid race conditions.

**Audit mapping:** No direct security audit claim; improves reliability (prevents deadlock + profile thrashing during compaction).

---

### Non-Security Commits (24)

| SHA | Category | Summary |
|-----|----------|---------|
| 2b9a501b7 | test refactor | Dedupe directive behavior e2e setup (14 files) |
| 994bcbf67 | code clarification | Refactor restoreTerminalState stdin resume option |
| e03dc987e | test config | Keep gateway vitest on forks |
| 5b7a33272 | test stability | Stabilize vitest mocks and harness typing (14 files) |
| b8b7a6e0f | test refactor | Dedupe web monitor inbox test setup |
| c60844931 | bug fix | Prevent cron list/status from silently skipping recurring jobs (#16201) |
| 4734f9910 | type safety | Add type safety to models status command (#16395) |
| 01ec81dae | test refactor | Migrate web auto-reply tests to harness |
| 222b2d7c3 | test refactor | Trim pi-embedded-runner e2e scaffolding |
| eb594a090 | test refactor | Dedupe trigger-handling e2e setup (15 files) |
| b4e406b6c | test refactor | Share iMessage monitor test harness |
| 5faba6a48 | test refactor | Reuse web auto-reply harness in more tests |
| 0e824a178 | test refactor | Share runReplyAgent typing heartbeat harness |
| 4d8a4fbb4 | test refactor | Share runReplyAgent memory flush harness |
| 95b077ad2 | test refactor | Reuse web auto-reply harness |
| 186ecd216 | test refactor | Reuse browser control server harness |
| 03ff4960b | test refactor | Share web auto-reply harness |
| f537bd179 | bug fix | Exclude plugin commands from setMyCommands when native=false (#15164) |
| 2fa78c17d | changelog | Credit cron delivery fix |
| 64b7f3455 | changelog | Fix changelog attribution |
| 90d1e9cd7 | changelog | Note iMessage group allowlist auth fix |
| 65eefd65e | docs | Clarify node host PATH override behavior |
| eed611335 | skills | Stabilize watcher targets and include agents skills |
| 53af46ffb | docs | Note WhatsApp per-account dmPolicy override |

### Line Number Shifts

| Symbol | Old location | New location | Verification |
|--------|-------------|-------------|--------------|
| `resolvePatchPath()` | `apply-patch.ts:215-236` | `apply-patch.ts:254-285` | `grep -n 'resolvePatchPath' src/agents/apply-patch.ts` → line 254 |
| `elevatedMode` | `bash-tools.exec.ts:199-207` | `bash-tools.exec.ts:202-210` | `grep -n 'elevatedMode' src/agents/bash-tools.exec.ts` → line 202 |
| `bypassApprovals` | `bash-tools.exec.ts:269-271` | `bash-tools.exec.ts:272-274` | `grep -n 'bypassApprovals' src/agents/bash-tools.exec.ts` → line 272 |
| `coerceEnv(process.env)` | `bash-tools.exec.ts:290` | `bash-tools.exec.ts:293` | `grep -n 'coerceEnv' src/agents/bash-tools.exec.ts` → line 293 |
| `validateHostEnv` call | `bash-tools.exec.ts:295-297` | `bash-tools.exec.ts:298` | `grep -n 'validateHostEnv' src/agents/bash-tools.exec.ts` → line 298 |
| `mergedEnv` | `bash-tools.exec.ts:298` | `bash-tools.exec.ts:301` | `grep -n 'mergedEnv' src/agents/bash-tools.exec.ts` → line 301 |
| `evaluateExecAllowlist` | `exec-approvals-allowlist.ts:157-197` | `exec-approvals-allowlist.ts:190` | `grep -n 'evaluateExecAllowlist' src/infra/exec-approvals-allowlist.ts` → line 190 |
| `buildSafeBinsShellCommand` | N/A (new) | `exec-approvals-analysis.ts:784` | `grep -n 'buildSafeBinsShellCommand' src/infra/exec-approvals-analysis.ts` → line 784 |
| `hasGlobToken` | N/A (new) | `exec-approvals-allowlist.ts:58` | `grep -n 'hasGlobToken' src/infra/exec-approvals-allowlist.ts` → line 58 |
| `parseIMessageNotification` | N/A (new) | `monitor-provider.ts:163` | `grep -n 'parseIMessageNotification' src/imessage/monitor/monitor-provider.ts` → line 163 |
| `shouldFlagCompactionTimeout` | N/A (new) | `compaction-timeout.ts:9` | NEW file |
| `resolveSelfEntryPath` | N/A (new) | `acp/client.ts:266` | `grep -n 'resolveSelfEntryPath' src/acp/client.ts` → line 266 |
| `candidateBinDirs` | N/A (new sig) | `path-env.ts:52` | `grep -n 'candidateBinDirs' src/infra/path-env.ts` → line 52 |

### Audit Claims Coverage

| Audit | Claim | Status |
|-------|-------|--------|
| Audit 1 #1796 (5) | Insufficient file permission checks | **Further hardened** by `013e8f6b3`, `e4d63818f` |
| Audit 1 #1796 (6) | Path traversal in agent dirs | **REMEDIATED** by `5544646a0` |
| Audit 2 Medium (7) | Shell injection via incomplete regex | **Further hardened** by `24d2c6292` |
| Audit 2 Medium (8) | Env variable injection (LD_PRELOAD) | **Further hardened** by `013e8f6b3` |

### New CVEs/GHSAs Published

5 new advisories published on Feb 14 (see [Official Security Advisories](../official-security-advisories.md)):

| ID | Severity | Summary |
|----|----------|---------|
| GHSA-4rj2-gpmh-qq5x | CRITICAL | Inbound allowlist policy bypass in voice-call extension |
| CVE-2026-25474 / GHSA-mp5h-m6qj-6292 | HIGH | Telegram webhook secret verification bypass |
| GHSA-7vwx-582j-j332 | HIGH | MS Teams attachment downloader leaks bearer tokens |
| GHSA-r5h9-vjqc-hq3r | HIGH | Nextcloud Talk allowlist bypass via actor.name spoofing |
| GHSA-33rq-m5x2-fvgf | HIGH | Twitch allowFrom not enforced in optional plugin |

Additionally, GHSA-fhvm-j76f-qmjv was updated from "Telegram Webhook Auth Bypass" to "Access-group authorization bypass if channel type lookup fails".

**Gap status: 1 closed, 3 remain open** — see [Legitimate Gaps Status](../post-merge-hardening.md#legitimate-gaps-status).
